"use strict";(()=>{var lP=Object.create;var xp=Object.defineProperty;var cP=Object.getOwnPropertyDescriptor;var pP=Object.getOwnPropertyNames;var dP=Object.getPrototypeOf,fP=Object.prototype.hasOwnProperty;var g=(r,e)=>()=>(r&&(e=r(r=0)),e);var S=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),mn=(r,e)=>{for(var t in e)xp(r,t,{get:e[t],enumerable:!0})},mP=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of pP(e))!fP.call(r,i)&&i!==t&&xp(r,i,{get:()=>e[i],enumerable:!(n=cP(e,i))||n.enumerable});return r};var pe=(r,e,t)=>(t=r!=null?lP(dP(r)):{},mP(e||!r||!r.__esModule?xp(t,"default",{value:r,enumerable:!0}):t,r));var _t=S((Ap,qh)=>{(function(r,e){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],e);else if(typeof Ap<"u")e(qh);else{var t={exports:{}};e(t),r.browser=t.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:Ap,function(r){"use strict";if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)r.exports=globalThis.browser;else{let e="The message port closed before a response was received.",t=n=>{let i={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(i).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class a extends WeakMap{constructor(x,C=void 0){super(C),this.createItem=x}get(x){return this.has(x)||this.set(x,this.createItem(x)),super.get(x)}}let s=v=>v&&typeof v=="object"&&typeof v.then=="function",o=(v,x)=>(...C)=>{n.runtime.lastError?v.reject(new Error(n.runtime.lastError.message)):x.singleCallbackArg||C.length<=1&&x.singleCallbackArg!==!1?v.resolve(C[0]):v.resolve(C)},u=v=>v==1?"argument":"arguments",l=(v,x)=>function(R,...q){if(q.length<x.minArgs)throw new Error(`Expected at least ${x.minArgs} ${u(x.minArgs)} for ${v}(), got ${q.length}`);if(q.length>x.maxArgs)throw new Error(`Expected at most ${x.maxArgs} ${u(x.maxArgs)} for ${v}(), got ${q.length}`);return new Promise((re,Q)=>{if(x.fallbackToNoCallback)try{R[v](...q,o({resolve:re,reject:Q},x))}catch($){console.warn(`${v} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,$),R[v](...q),x.fallbackToNoCallback=!1,x.noCallback=!0,re()}else x.noCallback?(R[v](...q),re()):R[v](...q,o({resolve:re,reject:Q},x))})},c=(v,x,C)=>new Proxy(x,{apply(R,q,re){return C.call(q,v,...re)}}),p=Function.call.bind(Object.prototype.hasOwnProperty),d=(v,x={},C={})=>{let R=Object.create(null),q={has(Q,$){return $ in v||$ in R},get(Q,$,Qe){if($ in R)return R[$];if(!($ in v))return;let he=v[$];if(typeof he=="function")if(typeof x[$]=="function")he=c(v,v[$],x[$]);else if(p(C,$)){let dn=l($,C[$]);he=c(v,v[$],dn)}else he=he.bind(v);else if(typeof he=="object"&&he!==null&&(p(x,$)||p(C,$)))he=d(he,x[$],C[$]);else if(p(C,"*"))he=d(he,x[$],C["*"]);else return Object.defineProperty(R,$,{configurable:!0,enumerable:!0,get(){return v[$]},set(dn){v[$]=dn}}),he;return R[$]=he,he},set(Q,$,Qe,he){return $ in R?R[$]=Qe:v[$]=Qe,!0},defineProperty(Q,$,Qe){return Reflect.defineProperty(R,$,Qe)},deleteProperty(Q,$){return Reflect.deleteProperty(R,$)}},re=Object.create(v);return new Proxy(re,q)},f=v=>({addListener(x,C,...R){x.addListener(v.get(C),...R)},hasListener(x,C){return x.hasListener(v.get(C))},removeListener(x,C){x.removeListener(v.get(C))}}),m=new a(v=>typeof v!="function"?v:function(C){let R=d(C,{},{getContent:{minArgs:0,maxArgs:0}});v(R)}),h=new a(v=>typeof v!="function"?v:function(C,R,q){let re=!1,Q,$=new Promise(fn=>{Q=function(cr){re=!0,fn(cr)}}),Qe;try{Qe=v(C,R,Q)}catch(fn){Qe=Promise.reject(fn)}let he=Qe!==!0&&s(Qe);if(Qe!==!0&&!he&&!re)return!1;let dn=fn=>{fn.then(cr=>{q(cr)},cr=>{let vp;cr&&(cr instanceof Error||typeof cr.message=="string")?vp=cr.message:vp="An unexpected error occurred",q({__mozWebExtensionPolyfillReject__:!0,message:vp})}).catch(cr=>{console.error("Failed to send onMessage rejected reply",cr)})};return dn(he?Qe:$),!0}),y=({reject:v,resolve:x},C)=>{n.runtime.lastError?n.runtime.lastError.message===e?x():v(new Error(n.runtime.lastError.message)):C&&C.__mozWebExtensionPolyfillReject__?v(new Error(C.message)):x(C)},_=(v,x,C,...R)=>{if(R.length<x.minArgs)throw new Error(`Expected at least ${x.minArgs} ${u(x.minArgs)} for ${v}(), got ${R.length}`);if(R.length>x.maxArgs)throw new Error(`Expected at most ${x.maxArgs} ${u(x.maxArgs)} for ${v}(), got ${R.length}`);return new Promise((q,re)=>{let Q=y.bind(null,{resolve:q,reject:re});R.push(Q),C.sendMessage(...R)})},b={devtools:{network:{onRequestFinished:f(m)}},runtime:{onMessage:f(h),onMessageExternal:f(h),sendMessage:_.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:_.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},O={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return i.privacy={network:{"*":O},services:{"*":O},websites:{"*":O}},d(n,b,i)};r.exports=t(chrome)}})});var Zh=S((bL,Wh)=>{"use strict";Wh.exports=()=>{let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}});var Yh=S((wL,Jh)=>{"use strict";var AP=Zh();function PP(r,e="maxAge"){let t,n,i,a=async()=>{if(t!==void 0)return;let u=async l=>{i=AP();let c=l[1][e]-Date.now();if(c<=0){r.delete(l[0]),i.resolve();return}return t=l[0],n=setTimeout(()=>{r.delete(l[0]),i&&i.resolve()},c),typeof n.unref=="function"&&n.unref(),i.promise};try{for(let l of r)await u(l)}catch{}t=void 0},s=()=>{t=void 0,n!==void 0&&(clearTimeout(n),n=void 0),i!==void 0&&(i.reject(void 0),i=void 0)},o=r.set.bind(r);return r.set=(u,l)=>{r.has(u)&&r.delete(u);let c=o(u,l);return t&&t===u&&s(),a(),c},a(),r}Jh.exports=PP});var Qh=S((_L,Xh)=>{"use strict";var OP=Yh(),Ep=class{constructor(e,t){if(this.maxAge=e,this[Symbol.toStringTag]="Map",this.data=new Map,OP(this.data),t)for(let[n,i]of t)this.set(n,i)}get size(){return this.data.size}clear(){this.data.clear()}delete(e){return this.data.delete(e)}has(e){return this.data.has(e)}get(e){let t=this.data.get(e);if(t)return t.data}set(e,t){return this.data.set(e,{maxAge:Date.now()+this.maxAge,data:t}),this}values(){return this.createIterator(e=>e[1].data)}keys(){return this.data.keys()}entries(){return this.createIterator(e=>[e[0],e[1].data])}forEach(e,t){for(let[n,i]of this.entries())e.apply(t,[i,n,this])}[Symbol.iterator](){return this.entries()}*createIterator(e){for(let t of this.data.entries())yield e(t)}};Xh.exports=Ep});function NP(r){lg=r}function Eu(){return lg}function P(r,e){let t=Eu(),n=Iu({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===oa?void 0:oa].filter(i=>!!i)});r.common.issues.push(n)}function Tu(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}function cg(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t}function K(r){if(!r)return{};let{errorMap:e,invalid_type_error:t,required_error:n,description:i}=r;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:i}:{errorMap:(s,o)=>{var u,l;let{message:c}=r;return s.code==="invalid_enum_value"?{message:c??o.defaultError}:typeof o.data>"u"?{message:(u=c??n)!==null&&u!==void 0?u:o.defaultError}:s.code!=="invalid_type"?{message:o.defaultError}:{message:(l=c??t)!==null&&l!==void 0?l:o.defaultError}},description:i}}function dg(r){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`),e}function GP(r){return new RegExp(`^${dg(r)}$`)}function fg(r){let e=`${pg}T${dg(r)}`,t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function WP(r,e){return!!((e==="v4"||!e)&&BP.test(r)||(e==="v6"||!e)&&KP.test(r))}function ZP(r,e){let t=(r.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,i=t>n?t:n,a=parseInt(r.toFixed(i).replace(".","")),s=parseInt(e.toFixed(i).replace(".",""));return a%s/Math.pow(10,i)}function aa(r){if(r instanceof ut){let e={};for(let t in r.shape){let n=r.shape[t];e[t]=St.create(aa(n))}return new ut({...r._def,shape:()=>e})}else return r instanceof qr?new qr({...r._def,type:aa(r.element)}):r instanceof St?St.create(aa(r.unwrap())):r instanceof dr?dr.create(aa(r.unwrap())):r instanceof pr?pr.create(r.items.map(e=>aa(e))):r}function Fp(r,e){let t=hn(r),n=hn(e);if(r===e)return{valid:!0,data:r};if(t===E.object&&n===E.object){let i=ne.objectKeys(e),a=ne.objectKeys(r).filter(o=>i.indexOf(o)!==-1),s={...r,...e};for(let o of a){let u=Fp(r[o],e[o]);if(!u.valid)return{valid:!1};s[o]=u.data}return{valid:!0,data:s}}else if(t===E.array&&n===E.array){if(r.length!==e.length)return{valid:!1};let i=[];for(let a=0;a<r.length;a++){let s=r[a],o=e[a],u=Fp(s,o);if(!u.valid)return{valid:!1};i.push(u.data)}return{valid:!0,data:i}}else return t===E.date&&n===E.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}function mg(r,e){return new ni({values:r,typeName:w.ZodEnum,...K(e)})}function hg(r,e={},t){return r?yn.create().superRefine((n,i)=>{var a,s;if(!r(n)){let o=typeof e=="function"?e(n):typeof e=="string"?{message:e}:e,u=(s=(a=o.fatal)!==null&&a!==void 0?a:t)!==null&&s!==void 0?s:!0,l=typeof o=="string"?{message:o}:o;i.addIssue({code:"custom",...l,fatal:u})}}):yn.create()}var ne,$p,E,hn,A,RP,At,oa,lg,Iu,MP,Ue,U,sa,et,Lp,Dp,qs,Us,N,Ds,Fs,kt,og,V,jP,$P,LP,DP,FP,qP,UP,zP,jp,BP,KP,VP,pg,HP,gn,Gn,Wn,Zn,Jn,ua,Yn,Xn,yn,Fr,Vt,la,qr,ut,Qn,Dr,Cu,ei,pr,Su,ca,pa,ku,ti,ri,ni,ii,bn,Pt,St,dr,ai,si,da,JP,zs,Bs,oi,YP,w,XP,gg,yg,QP,eO,bg,tO,rO,nO,iO,aO,sO,oO,uO,lO,cO,pO,dO,fO,mO,hO,gO,yO,bO,wO,_O,vO,xO,AO,PO,ug,OO,EO,IO,TO,CO,SO,kO,RO,NO,Rt,fr=g(()=>{(function(r){r.assertEqual=i=>i;function e(i){}r.assertIs=e;function t(i){throw new Error}r.assertNever=t,r.arrayToEnum=i=>{let a={};for(let s of i)a[s]=s;return a},r.getValidEnumValues=i=>{let a=r.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),s={};for(let o of a)s[o]=i[o];return r.objectValues(s)},r.objectValues=i=>r.objectKeys(i).map(function(a){return i[a]}),r.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{let a=[];for(let s in i)Object.prototype.hasOwnProperty.call(i,s)&&a.push(s);return a},r.find=(i,a)=>{for(let s of i)if(a(s))return s},r.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&isFinite(i)&&Math.floor(i)===i;function n(i,a=" | "){return i.map(s=>typeof s=="string"?`'${s}'`:s).join(a)}r.joinValues=n,r.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(ne||(ne={}));(function(r){r.mergeShapes=(e,t)=>({...e,...t})})($p||($p={}));E=ne.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),hn=r=>{switch(typeof r){case"undefined":return E.undefined;case"string":return E.string;case"number":return isNaN(r)?E.nan:E.number;case"boolean":return E.boolean;case"function":return E.function;case"bigint":return E.bigint;case"symbol":return E.symbol;case"object":return Array.isArray(r)?E.array:r===null?E.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?E.promise:typeof Map<"u"&&r instanceof Map?E.map:typeof Set<"u"&&r instanceof Set?E.set:typeof Date<"u"&&r instanceof Date?E.date:E.object;default:return E.unknown}},A=ne.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),RP=r=>JSON.stringify(r,null,2).replace(/"([^"]+)":/g,"$1:"),At=class r extends Error{constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){let t=e||function(a){return a.message},n={_errors:[]},i=a=>{for(let s of a.issues)if(s.code==="invalid_union")s.unionErrors.map(i);else if(s.code==="invalid_return_type")i(s.returnTypeError);else if(s.code==="invalid_arguments")i(s.argumentsError);else if(s.path.length===0)n._errors.push(t(s));else{let o=n,u=0;for(;u<s.path.length;){let l=s.path[u];u===s.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(s))):o[l]=o[l]||{_errors:[]},o=o[l],u++}}};return i(this),n}static assert(e){if(!(e instanceof r))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ne.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},n=[];for(let i of this.issues)i.path.length>0?(t[i.path[0]]=t[i.path[0]]||[],t[i.path[0]].push(e(i))):n.push(e(i));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}};At.create=r=>new At(r);oa=(r,e)=>{let t;switch(r.code){case A.invalid_type:r.received===E.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case A.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,ne.jsonStringifyReplacer)}`;break;case A.unrecognized_keys:t=`Unrecognized key(s) in object: ${ne.joinValues(r.keys,", ")}`;break;case A.invalid_union:t="Invalid input";break;case A.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ne.joinValues(r.options)}`;break;case A.invalid_enum_value:t=`Invalid enum value. Expected ${ne.joinValues(r.options)}, received '${r.received}'`;break;case A.invalid_arguments:t="Invalid function arguments";break;case A.invalid_return_type:t="Invalid function return type";break;case A.invalid_date:t="Invalid date";break;case A.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:ne.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case A.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case A.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case A.custom:t="Invalid input";break;case A.invalid_intersection_types:t="Intersection results could not be merged";break;case A.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case A.not_finite:t="Number must be finite";break;default:t=e.defaultError,ne.assertNever(r)}return{message:t}},lg=oa;Iu=r=>{let{data:e,path:t,errorMaps:n,issueData:i}=r,a=[...t,...i.path||[]],s={...i,path:a};if(i.message!==void 0)return{...i,path:a,message:i.message};let o="",u=n.filter(l=>!!l).slice().reverse();for(let l of u)o=l(s,{data:e,defaultError:o}).message;return{...i,path:a,message:o}},MP=[];Ue=class r{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let n=[];for(let i of t){if(i.status==="aborted")return U;i.status==="dirty"&&e.dirty(),n.push(i.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){let n=[];for(let i of t){let a=await i.key,s=await i.value;n.push({key:a,value:s})}return r.mergeObjectSync(e,n)}static mergeObjectSync(e,t){let n={};for(let i of t){let{key:a,value:s}=i;if(a.status==="aborted"||s.status==="aborted")return U;a.status==="dirty"&&e.dirty(),s.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof s.value<"u"||i.alwaysSet)&&(n[a.value]=s.value)}return{status:e.value,value:n}}},U=Object.freeze({status:"aborted"}),sa=r=>({status:"dirty",value:r}),et=r=>({status:"valid",value:r}),Lp=r=>r.status==="aborted",Dp=r=>r.status==="dirty",qs=r=>r.status==="valid",Us=r=>typeof Promise<"u"&&r instanceof Promise;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e?.message})(N||(N={}));kt=class{constructor(e,t,n,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=i}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},og=(r,e)=>{if(qs(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new At(r.common.issues);return this._error=t,this._error}}};V=class{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return hn(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:hn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Ue,ctx:{common:e.parent.common,data:e.data,parsedType:hn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(Us(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;let i={common:{issues:[],async:(n=t?.async)!==null&&n!==void 0?n:!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:hn(e)},a=this._parseSync({data:e,path:i.path,parent:i});return og(i,a)}async parseAsync(e,t){let n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){let n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:hn(e)},i=this._parse({data:e,path:n.path,parent:n}),a=await(Us(i)?i:Promise.resolve(i));return og(n,a)}refine(e,t){let n=i=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(i):t;return this._refinement((i,a)=>{let s=e(i),o=()=>a.addIssue({code:A.custom,...n(i)});return typeof Promise<"u"&&s instanceof Promise?s.then(u=>u?!0:(o(),!1)):s?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,i)=>e(n)?!0:(i.addIssue(typeof t=="function"?t(n,i):t),!1))}_refinement(e){return new Pt({schema:this,typeName:w.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return St.create(this,this._def)}nullable(){return dr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return qr.create(this,this._def)}promise(){return bn.create(this,this._def)}or(e){return Qn.create([this,e],this._def)}and(e){return ei.create(this,e,this._def)}transform(e){return new Pt({...K(this._def),schema:this,typeName:w.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new ai({...K(this._def),innerType:this,defaultValue:t,typeName:w.ZodDefault})}brand(){return new zs({typeName:w.ZodBranded,type:this,...K(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new si({...K(this._def),innerType:this,catchValue:t,typeName:w.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Bs.create(this,e)}readonly(){return oi.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},jP=/^c[^\s-]{8,}$/i,$P=/^[0-9a-z]+$/,LP=/^[0-9A-HJKMNP-TV-Z]{26}$/,DP=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,FP=/^[a-z0-9_-]{21}$/i,qP=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,UP=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,zP="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",BP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,KP=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,VP=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,pg="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",HP=new RegExp(`^${pg}$`);gn=class r extends V{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==E.string){let a=this._getOrReturnCtx(e);return P(a,{code:A.invalid_type,expected:E.string,received:a.parsedType}),U}let n=new Ue,i;for(let a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(i=this._getOrReturnCtx(e,i),P(i,{code:A.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="max")e.data.length>a.value&&(i=this._getOrReturnCtx(e,i),P(i,{code:A.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if(a.kind==="length"){let s=e.data.length>a.value,o=e.data.length<a.value;(s||o)&&(i=this._getOrReturnCtx(e,i),s?P(i,{code:A.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&P(i,{code:A.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),n.dirty())}else if(a.kind==="email")UP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"email",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="emoji")jp||(jp=new RegExp(zP,"u")),jp.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"emoji",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="uuid")DP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"uuid",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="nanoid")FP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"nanoid",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid")jP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"cuid",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="cuid2")$P.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"cuid2",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="ulid")LP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"ulid",code:A.invalid_string,message:a.message}),n.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{i=this._getOrReturnCtx(e,i),P(i,{validation:"url",code:A.invalid_string,message:a.message}),n.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"regex",code:A.invalid_string,message:a.message}),n.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(i=this._getOrReturnCtx(e,i),P(i,{code:A.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),n.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(i=this._getOrReturnCtx(e,i),P(i,{code:A.invalid_string,validation:{startsWith:a.value},message:a.message}),n.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(i=this._getOrReturnCtx(e,i),P(i,{code:A.invalid_string,validation:{endsWith:a.value},message:a.message}),n.dirty()):a.kind==="datetime"?fg(a).test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{code:A.invalid_string,validation:"datetime",message:a.message}),n.dirty()):a.kind==="date"?HP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{code:A.invalid_string,validation:"date",message:a.message}),n.dirty()):a.kind==="time"?GP(a).test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{code:A.invalid_string,validation:"time",message:a.message}),n.dirty()):a.kind==="duration"?qP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"duration",code:A.invalid_string,message:a.message}),n.dirty()):a.kind==="ip"?WP(e.data,a.version)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"ip",code:A.invalid_string,message:a.message}),n.dirty()):a.kind==="base64"?VP.test(e.data)||(i=this._getOrReturnCtx(e,i),P(i,{validation:"base64",code:A.invalid_string,message:a.message}),n.dirty()):ne.assertNever(a);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(i=>e.test(i),{validation:t,code:A.invalid_string,...N.errToObj(n)})}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...N.errToObj(e)})}url(e){return this._addCheck({kind:"url",...N.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...N.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...N.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...N.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...N.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...N.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...N.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...N.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...N.errToObj(e)})}datetime(e){var t,n;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:(t=e?.offset)!==null&&t!==void 0?t:!1,local:(n=e?.local)!==null&&n!==void 0?n:!1,...N.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...N.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...N.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...N.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...N.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...N.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...N.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...N.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...N.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...N.errToObj(t)})}nonempty(e){return this.min(1,N.errToObj(e))}trim(){return new r({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new r({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new r({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};gn.create=r=>{var e;return new gn({checks:[],typeName:w.ZodString,coerce:(e=r?.coerce)!==null&&e!==void 0?e:!1,...K(r)})};Gn=class r extends V{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==E.number){let a=this._getOrReturnCtx(e);return P(a,{code:A.invalid_type,expected:E.number,received:a.parsedType}),U}let n,i=new Ue;for(let a of this._def.checks)a.kind==="int"?ne.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),P(n,{code:A.invalid_type,expected:"integer",received:"float",message:a.message}),i.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),P(n,{code:A.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),i.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),P(n,{code:A.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),i.dirty()):a.kind==="multipleOf"?ZP(e.data,a.value)!==0&&(n=this._getOrReturnCtx(e,n),P(n,{code:A.not_multiple_of,multipleOf:a.value,message:a.message}),i.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),P(n,{code:A.not_finite,message:a.message}),i.dirty()):ne.assertNever(a);return{status:i.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,N.toString(t))}gt(e,t){return this.setLimit("min",e,!1,N.toString(t))}lte(e,t){return this.setLimit("max",e,!0,N.toString(t))}lt(e,t){return this.setLimit("max",e,!1,N.toString(t))}setLimit(e,t,n,i){return new r({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:N.toString(i)}]})}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:N.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:N.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:N.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:N.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:N.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:N.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:N.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:N.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:N.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ne.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}};Gn.create=r=>new Gn({checks:[],typeName:w.ZodNumber,coerce:r?.coerce||!1,...K(r)});Wn=class r extends V{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==E.bigint){let a=this._getOrReturnCtx(e);return P(a,{code:A.invalid_type,expected:E.bigint,received:a.parsedType}),U}let n,i=new Ue;for(let a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),P(n,{code:A.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),i.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),P(n,{code:A.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),i.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),P(n,{code:A.not_multiple_of,multipleOf:a.value,message:a.message}),i.dirty()):ne.assertNever(a);return{status:i.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,N.toString(t))}gt(e,t){return this.setLimit("min",e,!1,N.toString(t))}lte(e,t){return this.setLimit("max",e,!0,N.toString(t))}lt(e,t){return this.setLimit("max",e,!1,N.toString(t))}setLimit(e,t,n,i){return new r({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:N.toString(i)}]})}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:N.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:N.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:N.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:N.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:N.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};Wn.create=r=>{var e;return new Wn({checks:[],typeName:w.ZodBigInt,coerce:(e=r?.coerce)!==null&&e!==void 0?e:!1,...K(r)})};Zn=class extends V{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==E.boolean){let n=this._getOrReturnCtx(e);return P(n,{code:A.invalid_type,expected:E.boolean,received:n.parsedType}),U}return et(e.data)}};Zn.create=r=>new Zn({typeName:w.ZodBoolean,coerce:r?.coerce||!1,...K(r)});Jn=class r extends V{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==E.date){let a=this._getOrReturnCtx(e);return P(a,{code:A.invalid_type,expected:E.date,received:a.parsedType}),U}if(isNaN(e.data.getTime())){let a=this._getOrReturnCtx(e);return P(a,{code:A.invalid_date}),U}let n=new Ue,i;for(let a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(i=this._getOrReturnCtx(e,i),P(i,{code:A.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),n.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(i=this._getOrReturnCtx(e,i),P(i,{code:A.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),n.dirty()):ne.assertNever(a);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:N.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:N.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};Jn.create=r=>new Jn({checks:[],coerce:r?.coerce||!1,typeName:w.ZodDate,...K(r)});ua=class extends V{_parse(e){if(this._getType(e)!==E.symbol){let n=this._getOrReturnCtx(e);return P(n,{code:A.invalid_type,expected:E.symbol,received:n.parsedType}),U}return et(e.data)}};ua.create=r=>new ua({typeName:w.ZodSymbol,...K(r)});Yn=class extends V{_parse(e){if(this._getType(e)!==E.undefined){let n=this._getOrReturnCtx(e);return P(n,{code:A.invalid_type,expected:E.undefined,received:n.parsedType}),U}return et(e.data)}};Yn.create=r=>new Yn({typeName:w.ZodUndefined,...K(r)});Xn=class extends V{_parse(e){if(this._getType(e)!==E.null){let n=this._getOrReturnCtx(e);return P(n,{code:A.invalid_type,expected:E.null,received:n.parsedType}),U}return et(e.data)}};Xn.create=r=>new Xn({typeName:w.ZodNull,...K(r)});yn=class extends V{constructor(){super(...arguments),this._any=!0}_parse(e){return et(e.data)}};yn.create=r=>new yn({typeName:w.ZodAny,...K(r)});Fr=class extends V{constructor(){super(...arguments),this._unknown=!0}_parse(e){return et(e.data)}};Fr.create=r=>new Fr({typeName:w.ZodUnknown,...K(r)});Vt=class extends V{_parse(e){let t=this._getOrReturnCtx(e);return P(t,{code:A.invalid_type,expected:E.never,received:t.parsedType}),U}};Vt.create=r=>new Vt({typeName:w.ZodNever,...K(r)});la=class extends V{_parse(e){if(this._getType(e)!==E.undefined){let n=this._getOrReturnCtx(e);return P(n,{code:A.invalid_type,expected:E.void,received:n.parsedType}),U}return et(e.data)}};la.create=r=>new la({typeName:w.ZodVoid,...K(r)});qr=class r extends V{_parse(e){let{ctx:t,status:n}=this._processInputParams(e),i=this._def;if(t.parsedType!==E.array)return P(t,{code:A.invalid_type,expected:E.array,received:t.parsedType}),U;if(i.exactLength!==null){let s=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(s||o)&&(P(t,{code:s?A.too_big:A.too_small,minimum:o?i.exactLength.value:void 0,maximum:s?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),n.dirty())}if(i.minLength!==null&&t.data.length<i.minLength.value&&(P(t,{code:A.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),n.dirty()),i.maxLength!==null&&t.data.length>i.maxLength.value&&(P(t,{code:A.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((s,o)=>i.type._parseAsync(new kt(t,s,t.path,o)))).then(s=>Ue.mergeArray(n,s));let a=[...t.data].map((s,o)=>i.type._parseSync(new kt(t,s,t.path,o)));return Ue.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new r({...this._def,minLength:{value:e,message:N.toString(t)}})}max(e,t){return new r({...this._def,maxLength:{value:e,message:N.toString(t)}})}length(e,t){return new r({...this._def,exactLength:{value:e,message:N.toString(t)}})}nonempty(e){return this.min(1,e)}};qr.create=(r,e)=>new qr({type:r,minLength:null,maxLength:null,exactLength:null,typeName:w.ZodArray,...K(e)});ut=class r extends V{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=ne.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==E.object){let l=this._getOrReturnCtx(e);return P(l,{code:A.invalid_type,expected:E.object,received:l.parsedType}),U}let{status:n,ctx:i}=this._processInputParams(e),{shape:a,keys:s}=this._getCached(),o=[];if(!(this._def.catchall instanceof Vt&&this._def.unknownKeys==="strip"))for(let l in i.data)s.includes(l)||o.push(l);let u=[];for(let l of s){let c=a[l],p=i.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new kt(i,p,i.path,l)),alwaysSet:l in i.data})}if(this._def.catchall instanceof Vt){let l=this._def.unknownKeys;if(l==="passthrough")for(let c of o)u.push({key:{status:"valid",value:c},value:{status:"valid",value:i.data[c]}});else if(l==="strict")o.length>0&&(P(i,{code:A.unrecognized_keys,keys:o}),n.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let l=this._def.catchall;for(let c of o){let p=i.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new kt(i,p,i.path,c)),alwaysSet:c in i.data})}}return i.common.async?Promise.resolve().then(async()=>{let l=[];for(let c of u){let p=await c.key,d=await c.value;l.push({key:p,value:d,alwaysSet:c.alwaysSet})}return l}).then(l=>Ue.mergeObjectSync(n,l)):Ue.mergeObjectSync(n,u)}get shape(){return this._def.shape()}strict(e){return N.errToObj,new r({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{var i,a,s,o;let u=(s=(a=(i=this._def).errorMap)===null||a===void 0?void 0:a.call(i,t,n).message)!==null&&s!==void 0?s:n.defaultError;return t.code==="unrecognized_keys"?{message:(o=N.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new r({...this._def,unknownKeys:"strip"})}passthrough(){return new r({...this._def,unknownKeys:"passthrough"})}extend(e){return new r({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new r({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:w.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new r({...this._def,catchall:e})}pick(e){let t={};return ne.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])}),new r({...this._def,shape:()=>t})}omit(e){let t={};return ne.objectKeys(this.shape).forEach(n=>{e[n]||(t[n]=this.shape[n])}),new r({...this._def,shape:()=>t})}deepPartial(){return aa(this)}partial(e){let t={};return ne.objectKeys(this.shape).forEach(n=>{let i=this.shape[n];e&&!e[n]?t[n]=i:t[n]=i.optional()}),new r({...this._def,shape:()=>t})}required(e){let t={};return ne.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])t[n]=this.shape[n];else{let a=this.shape[n];for(;a instanceof St;)a=a._def.innerType;t[n]=a}}),new r({...this._def,shape:()=>t})}keyof(){return mg(ne.objectKeys(this.shape))}};ut.create=(r,e)=>new ut({shape:()=>r,unknownKeys:"strip",catchall:Vt.create(),typeName:w.ZodObject,...K(e)});ut.strictCreate=(r,e)=>new ut({shape:()=>r,unknownKeys:"strict",catchall:Vt.create(),typeName:w.ZodObject,...K(e)});ut.lazycreate=(r,e)=>new ut({shape:r,unknownKeys:"strip",catchall:Vt.create(),typeName:w.ZodObject,...K(e)});Qn=class extends V{_parse(e){let{ctx:t}=this._processInputParams(e),n=this._def.options;function i(a){for(let o of a)if(o.result.status==="valid")return o.result;for(let o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let s=a.map(o=>new At(o.ctx.common.issues));return P(t,{code:A.invalid_union,unionErrors:s}),U}if(t.common.async)return Promise.all(n.map(async a=>{let s={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:s}),ctx:s}})).then(i);{let a,s=[];for(let u of n){let l={...t,common:{...t.common,issues:[]},parent:null},c=u._parseSync({data:t.data,path:t.path,parent:l});if(c.status==="valid")return c;c.status==="dirty"&&!a&&(a={result:c,ctx:l}),l.common.issues.length&&s.push(l.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;let o=s.map(u=>new At(u));return P(t,{code:A.invalid_union,unionErrors:o}),U}}get options(){return this._def.options}};Qn.create=(r,e)=>new Qn({options:r,typeName:w.ZodUnion,...K(e)});Dr=r=>r instanceof ti?Dr(r.schema):r instanceof Pt?Dr(r.innerType()):r instanceof ri?[r.value]:r instanceof ni?r.options:r instanceof ii?ne.objectValues(r.enum):r instanceof ai?Dr(r._def.innerType):r instanceof Yn?[void 0]:r instanceof Xn?[null]:r instanceof St?[void 0,...Dr(r.unwrap())]:r instanceof dr?[null,...Dr(r.unwrap())]:r instanceof zs||r instanceof oi?Dr(r.unwrap()):r instanceof si?Dr(r._def.innerType):[],Cu=class r extends V{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.object)return P(t,{code:A.invalid_type,expected:E.object,received:t.parsedType}),U;let n=this.discriminator,i=t.data[n],a=this.optionsMap.get(i);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(P(t,{code:A.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),U)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){let i=new Map;for(let a of t){let s=Dr(a.shape[e]);if(!s.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of s){if(i.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);i.set(o,a)}}return new r({typeName:w.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:i,...K(n)})}};ei=class extends V{_parse(e){let{status:t,ctx:n}=this._processInputParams(e),i=(a,s)=>{if(Lp(a)||Lp(s))return U;let o=Fp(a.value,s.value);return o.valid?((Dp(a)||Dp(s))&&t.dirty(),{status:t.value,value:o.data}):(P(n,{code:A.invalid_intersection_types}),U)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,s])=>i(a,s)):i(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}};ei.create=(r,e,t)=>new ei({left:r,right:e,typeName:w.ZodIntersection,...K(t)});pr=class r extends V{_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==E.array)return P(n,{code:A.invalid_type,expected:E.array,received:n.parsedType}),U;if(n.data.length<this._def.items.length)return P(n,{code:A.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),U;!this._def.rest&&n.data.length>this._def.items.length&&(P(n,{code:A.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let a=[...n.data].map((s,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new kt(n,s,n.path,o)):null}).filter(s=>!!s);return n.common.async?Promise.all(a).then(s=>Ue.mergeArray(t,s)):Ue.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new r({...this._def,rest:e})}};pr.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new pr({items:r,typeName:w.ZodTuple,rest:null,...K(e)})};Su=class r extends V{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==E.object)return P(n,{code:A.invalid_type,expected:E.object,received:n.parsedType}),U;let i=[],a=this._def.keyType,s=this._def.valueType;for(let o in n.data)i.push({key:a._parse(new kt(n,o,n.path,o)),value:s._parse(new kt(n,n.data[o],n.path,o)),alwaysSet:o in n.data});return n.common.async?Ue.mergeObjectAsync(t,i):Ue.mergeObjectSync(t,i)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof V?new r({keyType:e,valueType:t,typeName:w.ZodRecord,...K(n)}):new r({keyType:gn.create(),valueType:e,typeName:w.ZodRecord,...K(t)})}},ca=class extends V{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==E.map)return P(n,{code:A.invalid_type,expected:E.map,received:n.parsedType}),U;let i=this._def.keyType,a=this._def.valueType,s=[...n.data.entries()].map(([o,u],l)=>({key:i._parse(new kt(n,o,n.path,[l,"key"])),value:a._parse(new kt(n,u,n.path,[l,"value"]))}));if(n.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of s){let l=await u.key,c=await u.value;if(l.status==="aborted"||c.status==="aborted")return U;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of s){let l=u.key,c=u.value;if(l.status==="aborted"||c.status==="aborted")return U;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}}}};ca.create=(r,e,t)=>new ca({valueType:e,keyType:r,typeName:w.ZodMap,...K(t)});pa=class r extends V{_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==E.set)return P(n,{code:A.invalid_type,expected:E.set,received:n.parsedType}),U;let i=this._def;i.minSize!==null&&n.data.size<i.minSize.value&&(P(n,{code:A.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),i.maxSize!==null&&n.data.size>i.maxSize.value&&(P(n,{code:A.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());let a=this._def.valueType;function s(u){let l=new Set;for(let c of u){if(c.status==="aborted")return U;c.status==="dirty"&&t.dirty(),l.add(c.value)}return{status:t.value,value:l}}let o=[...n.data.values()].map((u,l)=>a._parse(new kt(n,u,n.path,l)));return n.common.async?Promise.all(o).then(u=>s(u)):s(o)}min(e,t){return new r({...this._def,minSize:{value:e,message:N.toString(t)}})}max(e,t){return new r({...this._def,maxSize:{value:e,message:N.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};pa.create=(r,e)=>new pa({valueType:r,minSize:null,maxSize:null,typeName:w.ZodSet,...K(e)});ku=class r extends V{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.function)return P(t,{code:A.invalid_type,expected:E.function,received:t.parsedType}),U;function n(o,u){return Iu({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Eu(),oa].filter(l=>!!l),issueData:{code:A.invalid_arguments,argumentsError:u}})}function i(o,u){return Iu({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Eu(),oa].filter(l=>!!l),issueData:{code:A.invalid_return_type,returnTypeError:u}})}let a={errorMap:t.common.contextualErrorMap},s=t.data;if(this._def.returns instanceof bn){let o=this;return et(async function(...u){let l=new At([]),c=await o._def.args.parseAsync(u,a).catch(f=>{throw l.addIssue(n(u,f)),l}),p=await Reflect.apply(s,this,c);return await o._def.returns._def.type.parseAsync(p,a).catch(f=>{throw l.addIssue(i(p,f)),l})})}else{let o=this;return et(function(...u){let l=o._def.args.safeParse(u,a);if(!l.success)throw new At([n(u,l.error)]);let c=Reflect.apply(s,this,l.data),p=o._def.returns.safeParse(c,a);if(!p.success)throw new At([i(c,p.error)]);return p.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new r({...this._def,args:pr.create(e).rest(Fr.create())})}returns(e){return new r({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new r({args:e||pr.create([]).rest(Fr.create()),returns:t||Fr.create(),typeName:w.ZodFunction,...K(n)})}},ti=class extends V{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};ti.create=(r,e)=>new ti({getter:r,typeName:w.ZodLazy,...K(e)});ri=class extends V{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return P(t,{received:t.data,code:A.invalid_literal,expected:this._def.value}),U}return{status:"valid",value:e.data}}get value(){return this._def.value}};ri.create=(r,e)=>new ri({value:r,typeName:w.ZodLiteral,...K(e)});ni=class r extends V{constructor(){super(...arguments),Ds.set(this,void 0)}_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),n=this._def.values;return P(t,{expected:ne.joinValues(n),received:t.parsedType,code:A.invalid_type}),U}if(Tu(this,Ds,"f")||cg(this,Ds,new Set(this._def.values),"f"),!Tu(this,Ds,"f").has(e.data)){let t=this._getOrReturnCtx(e),n=this._def.values;return P(t,{received:t.data,code:A.invalid_enum_value,options:n}),U}return et(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return r.create(e,{...this._def,...t})}exclude(e,t=this._def){return r.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}};Ds=new WeakMap;ni.create=mg;ii=class extends V{constructor(){super(...arguments),Fs.set(this,void 0)}_parse(e){let t=ne.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==E.string&&n.parsedType!==E.number){let i=ne.objectValues(t);return P(n,{expected:ne.joinValues(i),received:n.parsedType,code:A.invalid_type}),U}if(Tu(this,Fs,"f")||cg(this,Fs,new Set(ne.getValidEnumValues(this._def.values)),"f"),!Tu(this,Fs,"f").has(e.data)){let i=ne.objectValues(t);return P(n,{received:n.data,code:A.invalid_enum_value,options:i}),U}return et(e.data)}get enum(){return this._def.values}};Fs=new WeakMap;ii.create=(r,e)=>new ii({values:r,typeName:w.ZodNativeEnum,...K(e)});bn=class extends V{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==E.promise&&t.common.async===!1)return P(t,{code:A.invalid_type,expected:E.promise,received:t.parsedType}),U;let n=t.parsedType===E.promise?t.data:Promise.resolve(t.data);return et(n.then(i=>this._def.type.parseAsync(i,{path:t.path,errorMap:t.common.contextualErrorMap})))}};bn.create=(r,e)=>new bn({type:r,typeName:w.ZodPromise,...K(e)});Pt=class extends V{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===w.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:n}=this._processInputParams(e),i=this._def.effect||null,a={addIssue:s=>{P(n,s),s.fatal?t.abort():t.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),i.type==="preprocess"){let s=i.transform(n.data,a);if(n.common.async)return Promise.resolve(s).then(async o=>{if(t.value==="aborted")return U;let u=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return u.status==="aborted"?U:u.status==="dirty"||t.value==="dirty"?sa(u.value):u});{if(t.value==="aborted")return U;let o=this._def.schema._parseSync({data:s,path:n.path,parent:n});return o.status==="aborted"?U:o.status==="dirty"||t.value==="dirty"?sa(o.value):o}}if(i.type==="refinement"){let s=o=>{let u=i.refinement(o,a);if(n.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){let o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?U:(o.status==="dirty"&&t.dirty(),s(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?U:(o.status==="dirty"&&t.dirty(),s(o.value).then(()=>({status:t.value,value:o.value}))))}if(i.type==="transform")if(n.common.async===!1){let s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!qs(s))return s;let o=i.transform(s.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(s=>qs(s)?Promise.resolve(i.transform(s.value,a)).then(o=>({status:t.value,value:o})):s);ne.assertNever(i)}};Pt.create=(r,e,t)=>new Pt({schema:r,typeName:w.ZodEffects,effect:e,...K(t)});Pt.createWithPreprocess=(r,e,t)=>new Pt({schema:e,effect:{type:"preprocess",transform:r},typeName:w.ZodEffects,...K(t)});St=class extends V{_parse(e){return this._getType(e)===E.undefined?et(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};St.create=(r,e)=>new St({innerType:r,typeName:w.ZodOptional,...K(e)});dr=class extends V{_parse(e){return this._getType(e)===E.null?et(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};dr.create=(r,e)=>new dr({innerType:r,typeName:w.ZodNullable,...K(e)});ai=class extends V{_parse(e){let{ctx:t}=this._processInputParams(e),n=t.data;return t.parsedType===E.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};ai.create=(r,e)=>new ai({innerType:r,typeName:w.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...K(e)});si=class extends V{_parse(e){let{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Us(i)?i.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new At(n.common.issues)},input:n.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new At(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}};si.create=(r,e)=>new si({innerType:r,typeName:w.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...K(e)});da=class extends V{_parse(e){if(this._getType(e)!==E.nan){let n=this._getOrReturnCtx(e);return P(n,{code:A.invalid_type,expected:E.nan,received:n.parsedType}),U}return{status:"valid",value:e.data}}};da.create=r=>new da({typeName:w.ZodNaN,...K(r)});JP=Symbol("zod_brand"),zs=class extends V{_parse(e){let{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}},Bs=class r extends V{_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{let a=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?U:a.status==="dirty"?(t.dirty(),sa(a.value)):this._def.out._parseAsync({data:a.value,path:n.path,parent:n})})();{let i=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?U:i.status==="dirty"?(t.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:n.path,parent:n})}}static create(e,t){return new r({in:e,out:t,typeName:w.ZodPipeline})}},oi=class extends V{_parse(e){let t=this._def.innerType._parse(e),n=i=>(qs(i)&&(i.value=Object.freeze(i.value)),i);return Us(t)?t.then(i=>n(i)):n(t)}unwrap(){return this._def.innerType}};oi.create=(r,e)=>new oi({innerType:r,typeName:w.ZodReadonly,...K(e)});YP={object:ut.lazycreate};(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(w||(w={}));XP=(r,e={message:`Input not instance of ${r.name}`})=>hg(t=>t instanceof r,e),gg=gn.create,yg=Gn.create,QP=da.create,eO=Wn.create,bg=Zn.create,tO=Jn.create,rO=ua.create,nO=Yn.create,iO=Xn.create,aO=yn.create,sO=Fr.create,oO=Vt.create,uO=la.create,lO=qr.create,cO=ut.create,pO=ut.strictCreate,dO=Qn.create,fO=Cu.create,mO=ei.create,hO=pr.create,gO=Su.create,yO=ca.create,bO=pa.create,wO=ku.create,_O=ti.create,vO=ri.create,xO=ni.create,AO=ii.create,PO=bn.create,ug=Pt.create,OO=St.create,EO=dr.create,IO=Pt.createWithPreprocess,TO=Bs.create,CO=()=>gg().optional(),SO=()=>yg().optional(),kO=()=>bg().optional(),RO={string:r=>gn.create({...r,coerce:!0}),number:r=>Gn.create({...r,coerce:!0}),boolean:r=>Zn.create({...r,coerce:!0}),bigint:r=>Wn.create({...r,coerce:!0}),date:r=>Jn.create({...r,coerce:!0})},NO=U,Rt=Object.freeze({__proto__:null,defaultErrorMap:oa,setErrorMap:NP,getErrorMap:Eu,makeIssue:Iu,EMPTY_PATH:MP,addIssueToContext:P,ParseStatus:Ue,INVALID:U,DIRTY:sa,OK:et,isAborted:Lp,isDirty:Dp,isValid:qs,isAsync:Us,get util(){return ne},get objectUtil(){return $p},ZodParsedType:E,getParsedType:hn,ZodType:V,datetimeRegex:fg,ZodString:gn,ZodNumber:Gn,ZodBigInt:Wn,ZodBoolean:Zn,ZodDate:Jn,ZodSymbol:ua,ZodUndefined:Yn,ZodNull:Xn,ZodAny:yn,ZodUnknown:Fr,ZodNever:Vt,ZodVoid:la,ZodArray:qr,ZodObject:ut,ZodUnion:Qn,ZodDiscriminatedUnion:Cu,ZodIntersection:ei,ZodTuple:pr,ZodRecord:Su,ZodMap:ca,ZodSet:pa,ZodFunction:ku,ZodLazy:ti,ZodLiteral:ri,ZodEnum:ni,ZodNativeEnum:ii,ZodPromise:bn,ZodEffects:Pt,ZodTransformer:Pt,ZodOptional:St,ZodNullable:dr,ZodDefault:ai,ZodCatch:si,ZodNaN:da,BRAND:JP,ZodBranded:zs,ZodPipeline:Bs,ZodReadonly:oi,custom:hg,Schema:V,ZodSchema:V,late:YP,get ZodFirstPartyTypeKind(){return w},coerce:RO,any:aO,array:lO,bigint:eO,boolean:bg,date:tO,discriminatedUnion:fO,effect:ug,enum:xO,function:wO,instanceof:XP,intersection:mO,lazy:_O,literal:vO,map:yO,nan:QP,nativeEnum:AO,never:oO,null:iO,nullable:EO,number:yg,object:cO,oboolean:kO,onumber:SO,optional:OO,ostring:CO,pipeline:TO,preprocess:IO,promise:PO,record:gO,set:bO,strictObject:pO,string:gg,symbol:rO,transformer:ug,tuple:hO,undefined:nO,union:dO,unknown:sO,void:uO,NEVER:NO,ZodIssueCode:A,quotelessJson:RP,ZodError:At})});var _g=S((GL,wg)=>{function Nt(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}wg.exports=Nt;Nt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Nt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Nt.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Nt.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Nt.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Nt.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Nt.prototype.start=Nt.prototype.try;Nt.prototype.errors=function(){return this._errors};Nt.prototype.attempts=function(){return this._attempts};Nt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],a=i.message,s=(r[a]||0)+1;r[a]=s,s>=t&&(e=i,t=s)}return e}});var vg=S(ui=>{var MO=_g();ui.operation=function(r){var e=ui.timeouts(r);return new MO(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};ui.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],i=0;i<e.retries;i++)n.push(this.createTimeout(i,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(i,e)),n.sort(function(a,s){return a-s}),n};ui.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};ui.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var i=0;i<t.length;i++){var a=t[i],s=r[a];r[a]=function(u){var l=ui.operation(e),c=Array.prototype.slice.call(arguments,1),p=c.pop();c.push(function(d){l.retry(d)||(d&&(arguments[0]=l.mainError()),p.apply(this,arguments))}),l.attempt(function(){u.apply(r,c)})}.bind(r,s),r[a].options=e}}});var Ag=S((ZL,xg)=>{xg.exports=vg()});var Mu=S((JL,Nu)=>{"use strict";var jO=Ag(),$O=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],Ru=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},LO=(r,e,t)=>{let n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r},DO=r=>$O.includes(r),Pg=(r,e)=>new Promise((t,n)=>{e={onFailedAttempt:()=>{},retries:10,...e};let i=jO.operation(e);i.attempt(async a=>{try{t(await r(a))}catch(s){if(!(s instanceof Error)){n(new TypeError(`Non-error was thrown: "${s}". You should only throw errors.`));return}if(s instanceof Ru)i.stop(),n(s.originalError);else if(s instanceof TypeError&&!DO(s.message))i.stop(),n(s);else{LO(s,a,e);try{await e.onFailedAttempt(s)}catch(o){n(o);return}i.retry(s)||n(i.mainError())}}})});Nu.exports=Pg;Nu.exports.default=Pg;Nu.exports.AbortError=Ru});var Og,Eg=g(()=>{Og=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function FO(r){return typeof r=="string"&&Og.test(r)}var Ks,Ig=g(()=>{Eg();Ks=FO});function Tg(r,e=0){return(Le[r[e+0]]+Le[r[e+1]]+Le[r[e+2]]+Le[r[e+3]]+"-"+Le[r[e+4]]+Le[r[e+5]]+"-"+Le[r[e+6]]+Le[r[e+7]]+"-"+Le[r[e+8]]+Le[r[e+9]]+"-"+Le[r[e+10]]+Le[r[e+11]]+Le[r[e+12]]+Le[r[e+13]]+Le[r[e+14]]+Le[r[e+15]]).toLowerCase()}var Le,ju,Cg=g(()=>{Le=[];for(ju=0;ju<256;++ju)Le.push((ju+256).toString(16).slice(1))});function qp(){if(!$u&&($u=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!$u))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return $u(qO)}var $u,qO,Sg=g(()=>{qO=new Uint8Array(16)});var UO,Up,kg=g(()=>{UO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Up={randomUUID:UO}});function zO(r,e,t){if(Up.randomUUID&&!e&&!r)return Up.randomUUID();r=r||{};var n=r.random||(r.rng||qp)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(var i=0;i<16;++i)e[t+i]=n[i];return e}return Tg(n)}var lt,Rg=g(()=>{kg();Sg();Cg();lt=zO});var Vs=g(()=>{Rg();Ig()});var Ng,Mg=g(()=>{Ng=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function KO(r){return typeof r=="string"&&Ng.test(r)}var zp,jg=g(()=>{Mg();zp=KO});function $g(r,e=0){return(De[r[e+0]]+De[r[e+1]]+De[r[e+2]]+De[r[e+3]]+"-"+De[r[e+4]]+De[r[e+5]]+"-"+De[r[e+6]]+De[r[e+7]]+"-"+De[r[e+8]]+De[r[e+9]]+"-"+De[r[e+10]]+De[r[e+11]]+De[r[e+12]]+De[r[e+13]]+De[r[e+14]]+De[r[e+15]]).toLowerCase()}var De,Lu,Lg=g(()=>{De=[];for(Lu=0;Lu<256;++Lu)De.push((Lu+256).toString(16).slice(1))});function Bp(){if(!Du&&(Du=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Du))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Du(VO)}var Du,VO,Dg=g(()=>{VO=new Uint8Array(16)});var HO,Kp,Fg=g(()=>{HO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Kp={randomUUID:HO}});function GO(r,e,t){if(Kp.randomUUID&&!e&&!r)return Kp.randomUUID();r=r||{};var n=r.random||(r.rng||Bp)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(var i=0;i<16;++i)e[t+i]=n[i];return e}return $g(n)}var li,qg=g(()=>{Fg();Dg();Lg();li=GO});var Fu=g(()=>{qg();jg()});var zg=S((vD,Hp)=>{"use strict";var WO=Object.prototype.hasOwnProperty,tt="~";function Hs(){}Object.create&&(Hs.prototype=Object.create(null),new Hs().__proto__||(tt=!1));function ZO(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function Ug(r,e,t,n,i){if(typeof t!="function")throw new TypeError("The listener must be a function");var a=new ZO(t,n||r,i),s=tt?tt+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],a]:r._events[s].push(a):(r._events[s]=a,r._eventsCount++),r}function qu(r,e){--r._eventsCount===0?r._events=new Hs:delete r._events[e]}function ze(){this._events=new Hs,this._eventsCount=0}ze.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)WO.call(t,n)&&e.push(tt?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};ze.prototype.listeners=function(e){var t=tt?tt+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,a=n.length,s=new Array(a);i<a;i++)s[i]=n[i].fn;return s};ze.prototype.listenerCount=function(e){var t=tt?tt+e:e,n=this._events[t];return n?n.fn?1:n.length:0};ze.prototype.emit=function(e,t,n,i,a,s){var o=tt?tt+e:e;if(!this._events[o])return!1;var u=this._events[o],l=arguments.length,c,p;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,i),!0;case 5:return u.fn.call(u.context,t,n,i,a),!0;case 6:return u.fn.call(u.context,t,n,i,a,s),!0}for(p=1,c=new Array(l-1);p<l;p++)c[p-1]=arguments[p];u.fn.apply(u.context,c)}else{var d=u.length,f;for(p=0;p<d;p++)switch(u[p].once&&this.removeListener(e,u[p].fn,void 0,!0),l){case 1:u[p].fn.call(u[p].context);break;case 2:u[p].fn.call(u[p].context,t);break;case 3:u[p].fn.call(u[p].context,t,n);break;case 4:u[p].fn.call(u[p].context,t,n,i);break;default:if(!c)for(f=1,c=new Array(l-1);f<l;f++)c[f-1]=arguments[f];u[p].fn.apply(u[p].context,c)}}return!0};ze.prototype.on=function(e,t,n){return Ug(this,e,t,n,!1)};ze.prototype.once=function(e,t,n){return Ug(this,e,t,n,!0)};ze.prototype.removeListener=function(e,t,n,i){var a=tt?tt+e:e;if(!this._events[a])return this;if(!t)return qu(this,a),this;var s=this._events[a];if(s.fn)s.fn===t&&(!i||s.once)&&(!n||s.context===n)&&qu(this,a);else{for(var o=0,u=[],l=s.length;o<l;o++)(s[o].fn!==t||i&&!s[o].once||n&&s[o].context!==n)&&u.push(s[o]);u.length?this._events[a]=u.length===1?u[0]:u:qu(this,a)}return this};ze.prototype.removeAllListeners=function(e){var t;return e?(t=tt?tt+e:e,this._events[t]&&qu(this,t)):(this._events=new Hs,this._eventsCount=0),this};ze.prototype.off=ze.prototype.removeListener;ze.prototype.addListener=ze.prototype.on;ze.prefixed=tt;ze.EventEmitter=ze;typeof Hp<"u"&&(Hp.exports=ze)});var Kg=S((xD,Bg)=>{"use strict";Bg.exports=(r,e)=>(e=e||(()=>{}),r.then(t=>new Promise(n=>{n(e())}).then(()=>t),t=>new Promise(n=>{n(e())}).then(()=>{throw t})))});var Hg=S((AD,zu)=>{"use strict";var JO=Kg(),Uu=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Vg=(r,e,t)=>new Promise((n,i)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){n(r);return}let a=setTimeout(()=>{if(typeof t=="function"){try{n(t())}catch(u){i(u)}return}let s=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new Uu(s);typeof r.cancel=="function"&&r.cancel(),i(o)},e);JO(r.then(n,i),()=>{clearTimeout(a)})});zu.exports=Vg;zu.exports.default=Vg;zu.exports.TimeoutError=Uu});var Gg=S(Gp=>{"use strict";Object.defineProperty(Gp,"__esModule",{value:!0});function YO(r,e,t){let n=0,i=r.length;for(;i>0;){let a=i/2|0,s=n+a;t(r[s],e)<=0?(n=++s,i-=a+1):i=a}return n}Gp.default=YO});var Wg=S(Zp=>{"use strict";Object.defineProperty(Zp,"__esModule",{value:!0});var XO=Gg(),Wp=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let n={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(n);return}let i=XO.default(this._queue,n,(a,s)=>s.priority-a.priority);this._queue.splice(i,0,n)}dequeue(){let e=this._queue.shift();return e?.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};Zp.default=Wp});var Ku=S(Yp=>{"use strict";Object.defineProperty(Yp,"__esModule",{value:!0});var QO=zg(),Zg=Hg(),eE=Wg(),Bu=()=>{},tE=new Zg.TimeoutError,Jp=class extends QO{constructor(e){var t,n,i,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Bu,this._resolveIdle=Bu,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:eE.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(i=e.interval)===null||i===void 0?void 0:i.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Bu,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=Bu,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((n,i)=>{let a=async()=>{this._pendingCount++,this._intervalCount++;try{let s=this._timeout===void 0&&t.timeout===void 0?e():Zg.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&i(tE)});n(await s)}catch(s){i(s)}this._next()};this._queue.enqueue(a,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Yp.default=Jp});var rE,nE,L,Vu=g(()=>{rE=(...r)=>fetch(...r),nE=Symbol.for("ls:fetch_implementation"),L=()=>globalThis[nE]??rE});var Jg,Hu,iE,aE,Gs,Yg=g(()=>{Jg=pe(Mu(),1),Hu=pe(Ku(),1);Vu();iE=[400,401,403,404,405,406,407,408],aE=[409],Gs=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Hu.default?this.queue=new Hu.default.default({concurrency:this.maxConcurrency}):this.queue=new Hu.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let n=this.onFailedResponseHook;return this.queue.add(()=>(0,Jg.default)(()=>e(...t).catch(i=>{throw i instanceof Error?i:new Error(i)}),{async onFailedAttempt(i){if(i.message.startsWith("Cancel")||i.message.startsWith("TimeoutError")||i.message.startsWith("AbortError")||i?.code==="ECONNABORTED")throw i;let a=i?.response,s=a?.status;if(s){if(iE.includes(+s))throw i;if(aE.includes(+s))return;n&&await n(a)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((i,a)=>{e.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>L()(...e).then(t=>t.ok?t:Promise.reject(t)))}}});function Xp(r){return typeof r?._getType=="function"}function Qp(r){let e={type:r._getType(),data:{content:r.content}};return r?.additional_kwargs&&Object.keys(r.additional_kwargs).length>0&&(e.data.additional_kwargs={...r.additional_kwargs}),e}var Xg=g(()=>{});function Y(r,e){if(!zp(r)){let t=e!==void 0?`Invalid UUID for ${e}: ${r}`:`Invalid UUID: ${r}`;throw new Error(t)}return r}var Qg=g(()=>{Fu()});function Gu(r){ey[r]||(console.warn(r),ey[r]=!0)}var ey,ed=g(()=>{ey={}});var Ws=S((ND,ty)=>{var sE="2.0.0",oE=Number.MAX_SAFE_INTEGER||9007199254740991,uE=16,lE=250,cE=["major","premajor","minor","preminor","patch","prepatch","prerelease"];ty.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:uE,MAX_SAFE_BUILD_LENGTH:lE,MAX_SAFE_INTEGER:oE,RELEASE_TYPES:cE,SEMVER_SPEC_VERSION:sE,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}});var Zs=S((MD,ry)=>{var pE=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{};ry.exports=pE});var fa=S((Ur,ny)=>{var{MAX_SAFE_COMPONENT_LENGTH:td,MAX_SAFE_BUILD_LENGTH:dE,MAX_LENGTH:fE}=Ws(),mE=Zs();Ur=ny.exports={};var hE=Ur.re=[],gE=Ur.safeRe=[],I=Ur.src=[],T=Ur.t={},yE=0,rd="[a-zA-Z0-9-]",bE=[["\\s",1],["\\d",fE],[rd,dE]],wE=r=>{for(let[e,t]of bE)r=r.split(`${e}*`).join(`${e}{0,${t}}`).split(`${e}+`).join(`${e}{1,${t}}`);return r},B=(r,e,t)=>{let n=wE(e),i=yE++;mE(r,i,e),T[r]=i,I[i]=e,hE[i]=new RegExp(e,t?"g":void 0),gE[i]=new RegExp(n,t?"g":void 0)};B("NUMERICIDENTIFIER","0|[1-9]\\d*");B("NUMERICIDENTIFIERLOOSE","\\d+");B("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${rd}*`);B("MAINVERSION",`(${I[T.NUMERICIDENTIFIER]})\\.(${I[T.NUMERICIDENTIFIER]})\\.(${I[T.NUMERICIDENTIFIER]})`);B("MAINVERSIONLOOSE",`(${I[T.NUMERICIDENTIFIERLOOSE]})\\.(${I[T.NUMERICIDENTIFIERLOOSE]})\\.(${I[T.NUMERICIDENTIFIERLOOSE]})`);B("PRERELEASEIDENTIFIER",`(?:${I[T.NUMERICIDENTIFIER]}|${I[T.NONNUMERICIDENTIFIER]})`);B("PRERELEASEIDENTIFIERLOOSE",`(?:${I[T.NUMERICIDENTIFIERLOOSE]}|${I[T.NONNUMERICIDENTIFIER]})`);B("PRERELEASE",`(?:-(${I[T.PRERELEASEIDENTIFIER]}(?:\\.${I[T.PRERELEASEIDENTIFIER]})*))`);B("PRERELEASELOOSE",`(?:-?(${I[T.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${I[T.PRERELEASEIDENTIFIERLOOSE]})*))`);B("BUILDIDENTIFIER",`${rd}+`);B("BUILD",`(?:\\+(${I[T.BUILDIDENTIFIER]}(?:\\.${I[T.BUILDIDENTIFIER]})*))`);B("FULLPLAIN",`v?${I[T.MAINVERSION]}${I[T.PRERELEASE]}?${I[T.BUILD]}?`);B("FULL",`^${I[T.FULLPLAIN]}$`);B("LOOSEPLAIN",`[v=\\s]*${I[T.MAINVERSIONLOOSE]}${I[T.PRERELEASELOOSE]}?${I[T.BUILD]}?`);B("LOOSE",`^${I[T.LOOSEPLAIN]}$`);B("GTLT","((?:<|>)?=?)");B("XRANGEIDENTIFIERLOOSE",`${I[T.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`);B("XRANGEIDENTIFIER",`${I[T.NUMERICIDENTIFIER]}|x|X|\\*`);B("XRANGEPLAIN",`[v=\\s]*(${I[T.XRANGEIDENTIFIER]})(?:\\.(${I[T.XRANGEIDENTIFIER]})(?:\\.(${I[T.XRANGEIDENTIFIER]})(?:${I[T.PRERELEASE]})?${I[T.BUILD]}?)?)?`);B("XRANGEPLAINLOOSE",`[v=\\s]*(${I[T.XRANGEIDENTIFIERLOOSE]})(?:\\.(${I[T.XRANGEIDENTIFIERLOOSE]})(?:\\.(${I[T.XRANGEIDENTIFIERLOOSE]})(?:${I[T.PRERELEASELOOSE]})?${I[T.BUILD]}?)?)?`);B("XRANGE",`^${I[T.GTLT]}\\s*${I[T.XRANGEPLAIN]}$`);B("XRANGELOOSE",`^${I[T.GTLT]}\\s*${I[T.XRANGEPLAINLOOSE]}$`);B("COERCEPLAIN",`(^|[^\\d])(\\d{1,${td}})(?:\\.(\\d{1,${td}}))?(?:\\.(\\d{1,${td}}))?`);B("COERCE",`${I[T.COERCEPLAIN]}(?:$|[^\\d])`);B("COERCEFULL",I[T.COERCEPLAIN]+`(?:${I[T.PRERELEASE]})?(?:${I[T.BUILD]})?(?:$|[^\\d])`);B("COERCERTL",I[T.COERCE],!0);B("COERCERTLFULL",I[T.COERCEFULL],!0);B("LONETILDE","(?:~>?)");B("TILDETRIM",`(\\s*)${I[T.LONETILDE]}\\s+`,!0);Ur.tildeTrimReplace="$1~";B("TILDE",`^${I[T.LONETILDE]}${I[T.XRANGEPLAIN]}$`);B("TILDELOOSE",`^${I[T.LONETILDE]}${I[T.XRANGEPLAINLOOSE]}$`);B("LONECARET","(?:\\^)");B("CARETTRIM",`(\\s*)${I[T.LONECARET]}\\s+`,!0);Ur.caretTrimReplace="$1^";B("CARET",`^${I[T.LONECARET]}${I[T.XRANGEPLAIN]}$`);B("CARETLOOSE",`^${I[T.LONECARET]}${I[T.XRANGEPLAINLOOSE]}$`);B("COMPARATORLOOSE",`^${I[T.GTLT]}\\s*(${I[T.LOOSEPLAIN]})$|^$`);B("COMPARATOR",`^${I[T.GTLT]}\\s*(${I[T.FULLPLAIN]})$|^$`);B("COMPARATORTRIM",`(\\s*)${I[T.GTLT]}\\s*(${I[T.LOOSEPLAIN]}|${I[T.XRANGEPLAIN]})`,!0);Ur.comparatorTrimReplace="$1$2$3";B("HYPHENRANGE",`^\\s*(${I[T.XRANGEPLAIN]})\\s+-\\s+(${I[T.XRANGEPLAIN]})\\s*$`);B("HYPHENRANGELOOSE",`^\\s*(${I[T.XRANGEPLAINLOOSE]})\\s+-\\s+(${I[T.XRANGEPLAINLOOSE]})\\s*$`);B("STAR","(<|>)?=?\\s*\\*");B("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$");B("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});var Wu=S((jD,iy)=>{var _E=Object.freeze({loose:!0}),vE=Object.freeze({}),xE=r=>r?typeof r!="object"?_E:r:vE;iy.exports=xE});var nd=S(($D,oy)=>{var ay=/^[0-9]+$/,sy=(r,e)=>{let t=ay.test(r),n=ay.test(e);return t&&n&&(r=+r,e=+e),r===e?0:t&&!n?-1:n&&!t?1:r<e?-1:1},AE=(r,e)=>sy(e,r);oy.exports={compareIdentifiers:sy,rcompareIdentifiers:AE}});var Be=S((LD,py)=>{var Zu=Zs(),{MAX_LENGTH:uy,MAX_SAFE_INTEGER:Ju}=Ws(),{safeRe:ly,t:cy}=fa(),PE=Wu(),{compareIdentifiers:ma}=nd(),id=class r{constructor(e,t){if(t=PE(t),e instanceof r){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>uy)throw new TypeError(`version is longer than ${uy} characters`);Zu("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let n=e.trim().match(t.loose?ly[cy.LOOSE]:ly[cy.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>Ju||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Ju||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Ju||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map(i=>{if(/^[0-9]+$/.test(i)){let a=+i;if(a>=0&&a<Ju)return a}return i}):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(Zu("SemVer.compare",this.version,this.options,e),!(e instanceof r)){if(typeof e=="string"&&e===this.version)return 0;e=new r(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof r||(e=new r(e,this.options)),ma(this.major,e.major)||ma(this.minor,e.minor)||ma(this.patch,e.patch)}comparePre(e){if(e instanceof r||(e=new r(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let n=this.prerelease[t],i=e.prerelease[t];if(Zu("prerelease compare",t,n,i),n===void 0&&i===void 0)return 0;if(i===void 0)return 1;if(n===void 0)return-1;if(n===i)continue;return ma(n,i)}while(++t)}compareBuild(e){e instanceof r||(e=new r(e,this.options));let t=0;do{let n=this.build[t],i=e.build[t];if(Zu("build compare",t,n,i),n===void 0&&i===void 0)return 0;if(i===void 0)return 1;if(n===void 0)return-1;if(n===i)continue;return ma(n,i)}while(++t)}inc(e,t,n){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let i=Number(n)?1:0;if(!t&&n===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[i];else{let a=this.prerelease.length;for(;--a>=0;)typeof this.prerelease[a]=="number"&&(this.prerelease[a]++,a=-2);if(a===-1){if(t===this.prerelease.join(".")&&n===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(i)}}if(t){let a=[t,i];n===!1&&(a=[t]),ma(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};py.exports=id});var ci=S((DD,fy)=>{var dy=Be(),OE=(r,e,t=!1)=>{if(r instanceof dy)return r;try{return new dy(r,e)}catch(n){if(!t)return null;throw n}};fy.exports=OE});var hy=S((FD,my)=>{var EE=ci(),IE=(r,e)=>{let t=EE(r,e);return t?t.version:null};my.exports=IE});var yy=S((qD,gy)=>{var TE=ci(),CE=(r,e)=>{let t=TE(r.trim().replace(/^[=v]+/,""),e);return t?t.version:null};gy.exports=CE});var _y=S((UD,wy)=>{var by=Be(),SE=(r,e,t,n,i)=>{typeof t=="string"&&(i=n,n=t,t=void 0);try{return new by(r instanceof by?r.version:r,t).inc(e,n,i).version}catch{return null}};wy.exports=SE});var Ay=S((zD,xy)=>{var vy=ci(),kE=(r,e)=>{let t=vy(r,null,!0),n=vy(e,null,!0),i=t.compare(n);if(i===0)return null;let a=i>0,s=a?t:n,o=a?n:t,u=!!s.prerelease.length;if(!!o.prerelease.length&&!u)return!o.patch&&!o.minor?"major":s.patch?"patch":s.minor?"minor":"major";let c=u?"pre":"";return t.major!==n.major?c+"major":t.minor!==n.minor?c+"minor":t.patch!==n.patch?c+"patch":"prerelease"};xy.exports=kE});var Oy=S((BD,Py)=>{var RE=Be(),NE=(r,e)=>new RE(r,e).major;Py.exports=NE});var Iy=S((KD,Ey)=>{var ME=Be(),jE=(r,e)=>new ME(r,e).minor;Ey.exports=jE});var Cy=S((VD,Ty)=>{var $E=Be(),LE=(r,e)=>new $E(r,e).patch;Ty.exports=LE});var ky=S((HD,Sy)=>{var DE=ci(),FE=(r,e)=>{let t=DE(r,e);return t&&t.prerelease.length?t.prerelease:null};Sy.exports=FE});var Mt=S((GD,Ny)=>{var Ry=Be(),qE=(r,e,t)=>new Ry(r,t).compare(new Ry(e,t));Ny.exports=qE});var jy=S((WD,My)=>{var UE=Mt(),zE=(r,e,t)=>UE(e,r,t);My.exports=zE});var Ly=S((ZD,$y)=>{var BE=Mt(),KE=(r,e)=>BE(r,e,!0);$y.exports=KE});var Yu=S((JD,Fy)=>{var Dy=Be(),VE=(r,e,t)=>{let n=new Dy(r,t),i=new Dy(e,t);return n.compare(i)||n.compareBuild(i)};Fy.exports=VE});var Uy=S((YD,qy)=>{var HE=Yu(),GE=(r,e)=>r.sort((t,n)=>HE(t,n,e));qy.exports=GE});var By=S((XD,zy)=>{var WE=Yu(),ZE=(r,e)=>r.sort((t,n)=>WE(n,t,e));zy.exports=ZE});var Js=S((QD,Ky)=>{var JE=Mt(),YE=(r,e,t)=>JE(r,e,t)>0;Ky.exports=YE});var Xu=S((e2,Vy)=>{var XE=Mt(),QE=(r,e,t)=>XE(r,e,t)<0;Vy.exports=QE});var ad=S((t2,Hy)=>{var eI=Mt(),tI=(r,e,t)=>eI(r,e,t)===0;Hy.exports=tI});var sd=S((r2,Gy)=>{var rI=Mt(),nI=(r,e,t)=>rI(r,e,t)!==0;Gy.exports=nI});var Qu=S((n2,Wy)=>{var iI=Mt(),aI=(r,e,t)=>iI(r,e,t)>=0;Wy.exports=aI});var el=S((i2,Zy)=>{var sI=Mt(),oI=(r,e,t)=>sI(r,e,t)<=0;Zy.exports=oI});var od=S((a2,Jy)=>{var uI=ad(),lI=sd(),cI=Js(),pI=Qu(),dI=Xu(),fI=el(),mI=(r,e,t,n)=>{switch(e){case"===":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r===t;case"!==":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r!==t;case"":case"=":case"==":return uI(r,t,n);case"!=":return lI(r,t,n);case">":return cI(r,t,n);case">=":return pI(r,t,n);case"<":return dI(r,t,n);case"<=":return fI(r,t,n);default:throw new TypeError(`Invalid operator: ${e}`)}};Jy.exports=mI});var Xy=S((s2,Yy)=>{var hI=Be(),gI=ci(),{safeRe:tl,t:rl}=fa(),yI=(r,e)=>{if(r instanceof hI)return r;if(typeof r=="number"&&(r=String(r)),typeof r!="string")return null;e=e||{};let t=null;if(!e.rtl)t=r.match(e.includePrerelease?tl[rl.COERCEFULL]:tl[rl.COERCE]);else{let u=e.includePrerelease?tl[rl.COERCERTLFULL]:tl[rl.COERCERTL],l;for(;(l=u.exec(r))&&(!t||t.index+t[0].length!==r.length);)(!t||l.index+l[0].length!==t.index+t[0].length)&&(t=l),u.lastIndex=l.index+l[1].length+l[2].length;u.lastIndex=-1}if(t===null)return null;let n=t[2],i=t[3]||"0",a=t[4]||"0",s=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return gI(`${n}.${i}.${a}${s}${o}`,e)};Yy.exports=yI});var eb=S((o2,Qy)=>{var ud=class{constructor(){this.max=1e3,this.map=new Map}get(e){let t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){let i=this.map.keys().next().value;this.delete(i)}this.map.set(e,t)}return this}};Qy.exports=ud});var jt=S((u2,ib)=>{var bI=/\s+/g,ld=class r{constructor(e,t){if(t=_I(t),e instanceof r)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new r(e.raw,t);if(e instanceof cd)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(bI," "),this.set=this.raw.split("||").map(n=>this.parseRange(n.trim())).filter(n=>n.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let n=this.set[0];if(this.set=this.set.filter(i=>!rb(i[0])),this.set.length===0)this.set=[n];else if(this.set.length>1){for(let i of this.set)if(i.length===1&&II(i[0])){this.set=[i];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");let t=this.set[e];for(let n=0;n<t.length;n++)n>0&&(this.formatted+=" "),this.formatted+=t[n].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let n=((this.options.includePrerelease&&OI)|(this.options.loose&&EI))+":"+e,i=tb.get(n);if(i)return i;let a=this.options.loose,s=a?ct[rt.HYPHENRANGELOOSE]:ct[rt.HYPHENRANGE];e=e.replace(s,LI(this.options.includePrerelease)),le("hyphen replace",e),e=e.replace(ct[rt.COMPARATORTRIM],xI),le("comparator trim",e),e=e.replace(ct[rt.TILDETRIM],AI),le("tilde trim",e),e=e.replace(ct[rt.CARETTRIM],PI),le("caret trim",e);let o=e.split(" ").map(p=>TI(p,this.options)).join(" ").split(/\s+/).map(p=>$I(p,this.options));a&&(o=o.filter(p=>(le("loose invalid filter",p,this.options),!!p.match(ct[rt.COMPARATORLOOSE])))),le("range list",o);let u=new Map,l=o.map(p=>new cd(p,this.options));for(let p of l){if(rb(p))return[p];u.set(p.value,p)}u.size>1&&u.has("")&&u.delete("");let c=[...u.values()];return tb.set(n,c),c}intersects(e,t){if(!(e instanceof r))throw new TypeError("a Range is required");return this.set.some(n=>nb(n,t)&&e.set.some(i=>nb(i,t)&&n.every(a=>i.every(s=>a.intersects(s,t)))))}test(e){if(!e)return!1;if(typeof e=="string")try{e=new vI(e,this.options)}catch{return!1}for(let t=0;t<this.set.length;t++)if(DI(this.set[t],e,this.options))return!0;return!1}};ib.exports=ld;var wI=eb(),tb=new wI,_I=Wu(),cd=Ys(),le=Zs(),vI=Be(),{safeRe:ct,t:rt,comparatorTrimReplace:xI,tildeTrimReplace:AI,caretTrimReplace:PI}=fa(),{FLAG_INCLUDE_PRERELEASE:OI,FLAG_LOOSE:EI}=Ws(),rb=r=>r.value==="<0.0.0-0",II=r=>r.value==="",nb=(r,e)=>{let t=!0,n=r.slice(),i=n.pop();for(;t&&n.length;)t=n.every(a=>i.intersects(a,e)),i=n.pop();return t},TI=(r,e)=>(le("comp",r,e),r=kI(r,e),le("caret",r),r=CI(r,e),le("tildes",r),r=NI(r,e),le("xrange",r),r=jI(r,e),le("stars",r),r),nt=r=>!r||r.toLowerCase()==="x"||r==="*",CI=(r,e)=>r.trim().split(/\s+/).map(t=>SI(t,e)).join(" "),SI=(r,e)=>{let t=e.loose?ct[rt.TILDELOOSE]:ct[rt.TILDE];return r.replace(t,(n,i,a,s,o)=>{le("tilde",r,n,i,a,s,o);let u;return nt(i)?u="":nt(a)?u=`>=${i}.0.0 <${+i+1}.0.0-0`:nt(s)?u=`>=${i}.${a}.0 <${i}.${+a+1}.0-0`:o?(le("replaceTilde pr",o),u=`>=${i}.${a}.${s}-${o} <${i}.${+a+1}.0-0`):u=`>=${i}.${a}.${s} <${i}.${+a+1}.0-0`,le("tilde return",u),u})},kI=(r,e)=>r.trim().split(/\s+/).map(t=>RI(t,e)).join(" "),RI=(r,e)=>{le("caret",r,e);let t=e.loose?ct[rt.CARETLOOSE]:ct[rt.CARET],n=e.includePrerelease?"-0":"";return r.replace(t,(i,a,s,o,u)=>{le("caret",r,i,a,s,o,u);let l;return nt(a)?l="":nt(s)?l=`>=${a}.0.0${n} <${+a+1}.0.0-0`:nt(o)?a==="0"?l=`>=${a}.${s}.0${n} <${a}.${+s+1}.0-0`:l=`>=${a}.${s}.0${n} <${+a+1}.0.0-0`:u?(le("replaceCaret pr",u),a==="0"?s==="0"?l=`>=${a}.${s}.${o}-${u} <${a}.${s}.${+o+1}-0`:l=`>=${a}.${s}.${o}-${u} <${a}.${+s+1}.0-0`:l=`>=${a}.${s}.${o}-${u} <${+a+1}.0.0-0`):(le("no pr"),a==="0"?s==="0"?l=`>=${a}.${s}.${o}${n} <${a}.${s}.${+o+1}-0`:l=`>=${a}.${s}.${o}${n} <${a}.${+s+1}.0-0`:l=`>=${a}.${s}.${o} <${+a+1}.0.0-0`),le("caret return",l),l})},NI=(r,e)=>(le("replaceXRanges",r,e),r.split(/\s+/).map(t=>MI(t,e)).join(" ")),MI=(r,e)=>{r=r.trim();let t=e.loose?ct[rt.XRANGELOOSE]:ct[rt.XRANGE];return r.replace(t,(n,i,a,s,o,u)=>{le("xRange",r,n,i,a,s,o,u);let l=nt(a),c=l||nt(s),p=c||nt(o),d=p;return i==="="&&d&&(i=""),u=e.includePrerelease?"-0":"",l?i===">"||i==="<"?n="<0.0.0-0":n="*":i&&d?(c&&(s=0),o=0,i===">"?(i=">=",c?(a=+a+1,s=0,o=0):(s=+s+1,o=0)):i==="<="&&(i="<",c?a=+a+1:s=+s+1),i==="<"&&(u="-0"),n=`${i+a}.${s}.${o}${u}`):c?n=`>=${a}.0.0${u} <${+a+1}.0.0-0`:p&&(n=`>=${a}.${s}.0${u} <${a}.${+s+1}.0-0`),le("xRange return",n),n})},jI=(r,e)=>(le("replaceStars",r,e),r.trim().replace(ct[rt.STAR],"")),$I=(r,e)=>(le("replaceGTE0",r,e),r.trim().replace(ct[e.includePrerelease?rt.GTE0PRE:rt.GTE0],"")),LI=r=>(e,t,n,i,a,s,o,u,l,c,p,d)=>(nt(n)?t="":nt(i)?t=`>=${n}.0.0${r?"-0":""}`:nt(a)?t=`>=${n}.${i}.0${r?"-0":""}`:s?t=`>=${t}`:t=`>=${t}${r?"-0":""}`,nt(l)?u="":nt(c)?u=`<${+l+1}.0.0-0`:nt(p)?u=`<${l}.${+c+1}.0-0`:d?u=`<=${l}.${c}.${p}-${d}`:r?u=`<${l}.${c}.${+p+1}-0`:u=`<=${u}`,`${t} ${u}`.trim()),DI=(r,e,t)=>{for(let n=0;n<r.length;n++)if(!r[n].test(e))return!1;if(e.prerelease.length&&!t.includePrerelease){for(let n=0;n<r.length;n++)if(le(r[n].semver),r[n].semver!==cd.ANY&&r[n].semver.prerelease.length>0){let i=r[n].semver;if(i.major===e.major&&i.minor===e.minor&&i.patch===e.patch)return!0}return!1}return!0}});var Ys=S((l2,cb)=>{var Xs=Symbol("SemVer ANY"),fd=class r{static get ANY(){return Xs}constructor(e,t){if(t=ab(t),e instanceof r){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),dd("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===Xs?this.value="":this.value=this.operator+this.semver.version,dd("comp",this)}parse(e){let t=this.options.loose?sb[ob.COMPARATORLOOSE]:sb[ob.COMPARATOR],n=e.match(t);if(!n)throw new TypeError(`Invalid comparator: ${e}`);this.operator=n[1]!==void 0?n[1]:"",this.operator==="="&&(this.operator=""),n[2]?this.semver=new ub(n[2],this.options.loose):this.semver=Xs}toString(){return this.value}test(e){if(dd("Comparator.test",e,this.options.loose),this.semver===Xs||e===Xs)return!0;if(typeof e=="string")try{e=new ub(e,this.options)}catch{return!1}return pd(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof r))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new lb(e.value,t).test(this.value):e.operator===""?e.value===""?!0:new lb(this.value,t).test(e.semver):(t=ab(t),t.includePrerelease&&(this.value==="<0.0.0-0"||e.value==="<0.0.0-0")||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||pd(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||pd(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}};cb.exports=fd;var ab=Wu(),{safeRe:sb,t:ob}=fa(),pd=od(),dd=Zs(),ub=Be(),lb=jt()});var Qs=S((c2,pb)=>{var FI=jt(),qI=(r,e,t)=>{try{e=new FI(e,t)}catch{return!1}return e.test(r)};pb.exports=qI});var fb=S((p2,db)=>{var UI=jt(),zI=(r,e)=>new UI(r,e).set.map(t=>t.map(n=>n.value).join(" ").trim().split(" "));db.exports=zI});var hb=S((d2,mb)=>{var BI=Be(),KI=jt(),VI=(r,e,t)=>{let n=null,i=null,a=null;try{a=new KI(e,t)}catch{return null}return r.forEach(s=>{a.test(s)&&(!n||i.compare(s)===-1)&&(n=s,i=new BI(n,t))}),n};mb.exports=VI});var yb=S((f2,gb)=>{var HI=Be(),GI=jt(),WI=(r,e,t)=>{let n=null,i=null,a=null;try{a=new GI(e,t)}catch{return null}return r.forEach(s=>{a.test(s)&&(!n||i.compare(s)===1)&&(n=s,i=new HI(n,t))}),n};gb.exports=WI});var _b=S((m2,wb)=>{var md=Be(),ZI=jt(),bb=Js(),JI=(r,e)=>{r=new ZI(r,e);let t=new md("0.0.0");if(r.test(t)||(t=new md("0.0.0-0"),r.test(t)))return t;t=null;for(let n=0;n<r.set.length;++n){let i=r.set[n],a=null;i.forEach(s=>{let o=new md(s.semver.version);switch(s.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!a||bb(o,a))&&(a=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${s.operator}`)}}),a&&(!t||bb(t,a))&&(t=a)}return t&&r.test(t)?t:null};wb.exports=JI});var xb=S((h2,vb)=>{var YI=jt(),XI=(r,e)=>{try{return new YI(r,e).range||"*"}catch{return null}};vb.exports=XI});var nl=S((g2,Eb)=>{var QI=Be(),Ob=Ys(),{ANY:eT}=Ob,tT=jt(),rT=Qs(),Ab=Js(),Pb=Xu(),nT=el(),iT=Qu(),aT=(r,e,t,n)=>{r=new QI(r,n),e=new tT(e,n);let i,a,s,o,u;switch(t){case">":i=Ab,a=nT,s=Pb,o=">",u=">=";break;case"<":i=Pb,a=iT,s=Ab,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(rT(r,e,n))return!1;for(let l=0;l<e.set.length;++l){let c=e.set[l],p=null,d=null;if(c.forEach(f=>{f.semver===eT&&(f=new Ob(">=0.0.0")),p=p||f,d=d||f,i(f.semver,p.semver,n)?p=f:s(f.semver,d.semver,n)&&(d=f)}),p.operator===o||p.operator===u||(!d.operator||d.operator===o)&&a(r,d.semver))return!1;if(d.operator===u&&s(r,d.semver))return!1}return!0};Eb.exports=aT});var Tb=S((y2,Ib)=>{var sT=nl(),oT=(r,e,t)=>sT(r,e,">",t);Ib.exports=oT});var Sb=S((b2,Cb)=>{var uT=nl(),lT=(r,e,t)=>uT(r,e,"<",t);Cb.exports=lT});var Nb=S((w2,Rb)=>{var kb=jt(),cT=(r,e,t)=>(r=new kb(r,t),e=new kb(e,t),r.intersects(e,t));Rb.exports=cT});var jb=S((_2,Mb)=>{var pT=Qs(),dT=Mt();Mb.exports=(r,e,t)=>{let n=[],i=null,a=null,s=r.sort((c,p)=>dT(c,p,t));for(let c of s)pT(c,e,t)?(a=c,i||(i=c)):(a&&n.push([i,a]),a=null,i=null);i&&n.push([i,null]);let o=[];for(let[c,p]of n)c===p?o.push(c):!p&&c===s[0]?o.push("*"):p?c===s[0]?o.push(`<=${p}`):o.push(`${c} - ${p}`):o.push(`>=${c}`);let u=o.join(" || "),l=typeof e.raw=="string"?e.raw:String(e);return u.length<l.length?u:e}});var Ub=S((v2,qb)=>{var $b=jt(),gd=Ys(),{ANY:hd}=gd,eo=Qs(),yd=Mt(),fT=(r,e,t={})=>{if(r===e)return!0;r=new $b(r,t),e=new $b(e,t);let n=!1;e:for(let i of r.set){for(let a of e.set){let s=hT(i,a,t);if(n=n||s!==null,s)continue e}if(n)return!1}return!0},mT=[new gd(">=0.0.0-0")],Lb=[new gd(">=0.0.0")],hT=(r,e,t)=>{if(r===e)return!0;if(r.length===1&&r[0].semver===hd){if(e.length===1&&e[0].semver===hd)return!0;t.includePrerelease?r=mT:r=Lb}if(e.length===1&&e[0].semver===hd){if(t.includePrerelease)return!0;e=Lb}let n=new Set,i,a;for(let f of r)f.operator===">"||f.operator===">="?i=Db(i,f,t):f.operator==="<"||f.operator==="<="?a=Fb(a,f,t):n.add(f.semver);if(n.size>1)return null;let s;if(i&&a){if(s=yd(i.semver,a.semver,t),s>0)return null;if(s===0&&(i.operator!==">="||a.operator!=="<="))return null}for(let f of n){if(i&&!eo(f,String(i),t)||a&&!eo(f,String(a),t))return null;for(let m of e)if(!eo(f,String(m),t))return!1;return!0}let o,u,l,c,p=a&&!t.includePrerelease&&a.semver.prerelease.length?a.semver:!1,d=i&&!t.includePrerelease&&i.semver.prerelease.length?i.semver:!1;p&&p.prerelease.length===1&&a.operator==="<"&&p.prerelease[0]===0&&(p=!1);for(let f of e){if(c=c||f.operator===">"||f.operator===">=",l=l||f.operator==="<"||f.operator==="<=",i){if(d&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===d.major&&f.semver.minor===d.minor&&f.semver.patch===d.patch&&(d=!1),f.operator===">"||f.operator===">="){if(o=Db(i,f,t),o===f&&o!==i)return!1}else if(i.operator===">="&&!eo(i.semver,String(f),t))return!1}if(a){if(p&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===p.major&&f.semver.minor===p.minor&&f.semver.patch===p.patch&&(p=!1),f.operator==="<"||f.operator==="<="){if(u=Fb(a,f,t),u===f&&u!==a)return!1}else if(a.operator==="<="&&!eo(a.semver,String(f),t))return!1}if(!f.operator&&(a||i)&&s!==0)return!1}return!(i&&l&&!a&&s!==0||a&&c&&!i&&s!==0||d||p)},Db=(r,e,t)=>{if(!r)return e;let n=yd(r.semver,e.semver,t);return n>0?r:n<0||e.operator===">"&&r.operator===">="?e:r},Fb=(r,e,t)=>{if(!r)return e;let n=yd(r.semver,e.semver,t);return n<0?r:n>0||e.operator==="<"&&r.operator==="<="?e:r};qb.exports=fT});var Vb=S((x2,Kb)=>{var bd=fa(),zb=Ws(),gT=Be(),Bb=nd(),yT=ci(),bT=hy(),wT=yy(),_T=_y(),vT=Ay(),xT=Oy(),AT=Iy(),PT=Cy(),OT=ky(),ET=Mt(),IT=jy(),TT=Ly(),CT=Yu(),ST=Uy(),kT=By(),RT=Js(),NT=Xu(),MT=ad(),jT=sd(),$T=Qu(),LT=el(),DT=od(),FT=Xy(),qT=Ys(),UT=jt(),zT=Qs(),BT=fb(),KT=hb(),VT=yb(),HT=_b(),GT=xb(),WT=nl(),ZT=Tb(),JT=Sb(),YT=Nb(),XT=jb(),QT=Ub();Kb.exports={parse:yT,valid:bT,clean:wT,inc:_T,diff:vT,major:xT,minor:AT,patch:PT,prerelease:OT,compare:ET,rcompare:IT,compareLoose:TT,compareBuild:CT,sort:ST,rsort:kT,gt:RT,lt:NT,eq:MT,neq:jT,gte:$T,lte:LT,cmp:DT,coerce:FT,Comparator:qT,Range:UT,satisfies:zT,toComparators:BT,maxSatisfying:KT,minSatisfying:VT,minVersion:HT,validRange:GT,outside:WT,gtr:ZT,ltr:JT,intersects:YT,simplifyRange:XT,subset:QT,SemVer:gT,re:bd.re,src:bd.src,tokens:bd.t,SEMVER_SPEC_VERSION:zb.SEMVER_SPEC_VERSION,RELEASE_TYPES:zb.RELEASE_TYPES,compareIdentifiers:Bb.compareIdentifiers,rcompareIdentifiers:Bb.rcompareIdentifiers}});function Hb(r,e){let t=(0,wd.parse)(r),n=(0,wd.parse)(e);if(!t||!n)throw new Error("Invalid version format.");return t.compare(n)>=0}function zr(r){if(!r||r.split("/").length>2||r.startsWith("/")||r.endsWith("/")||r.split(":").length>2)throw new Error(`Invalid identifier format: ${r}`);let[e,t]=r.split(":"),n=t||"latest";if(e.includes("/")){let[i,a]=e.split("/",2);if(!i||!a)throw new Error(`Invalid identifier format: ${r}`);return[i,a,n]}else{if(!e)throw new Error(`Invalid identifier format: ${r}`);return["-",e,n]}}var wd,Gb=g(()=>{wd=pe(Vb(),1)});async function J(r,e,t){let n;if(r.ok){t&&(n=await r.text());return}n=await r.text();let i=`Failed to ${e}. Received status [${r.status}]: ${r.statusText}. Server response: ${n}`;throw r.status===409?new _d(i):new Error(i)}var _d,Wb=g(()=>{_d=class extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}});function tC(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function pi(r,e,t,n){try{return JSON.stringify(r,e,t)}catch(s){if(!s.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof n>"u"&&(n=tC()),xd(r,"",0,[],void 0,0,n);var i;try{ha.length===0?i=JSON.stringify(r,e,t):i=JSON.stringify(r,rC(e),t)}catch{return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;il.length!==0;){var a=il.pop();a.length===4?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return i}}function vd(r,e,t,n){var i=Object.getOwnPropertyDescriptor(n,t);i.get!==void 0?i.configurable?(Object.defineProperty(n,t,{value:r}),il.push([n,t,e,i])):ha.push([e,t,r]):(n[t]=r,il.push([n,t,e]))}function xd(r,e,t,n,i,a,s){a+=1;var o;if(typeof r=="object"&&r!==null){for(o=0;o<n.length;o++)if(n[o]===r){vd(eC,r,e,i);return}if(typeof s.depthLimit<"u"&&a>s.depthLimit){vd(Zb,r,e,i);return}if(typeof s.edgesLimit<"u"&&t+1>s.edgesLimit){vd(Zb,r,e,i);return}if(n.push(r),Array.isArray(r))for(o=0;o<r.length;o++)xd(r[o],o,o,n,r,a,s);else{var u=Object.keys(r);for(o=0;o<u.length;o++){var l=u[o];xd(r[l],l,o,n,r,a,s)}}n.pop()}}function rC(r){return r=typeof r<"u"?r:function(e,t){return t},function(e,t){if(ha.length>0)for(var n=0;n<ha.length;n++){var i=ha[n];if(i[1]===e&&i[0]===t){t=i[2],ha.splice(n,1);break}}return r.call(this,e,t)}}var Zb,eC,il,ha,Jb=g(()=>{Zb="[...]",eC={result:"[Circular]"},il=[],ha=[]});function Yb(r){let e=ol(),t=Xb(),n=r.extra??{},i=n.metadata;return r.extra={...n,runtime:{...e,...n?.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:r.revision_id??t.revision_id}:{},...i}},r}async function aC(r){let e=[];for await(let t of r)e.push(t);return e}function Ad(r){if(r!==void 0)return r.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var nC,iC,sC,Pd,oC,uC,di,Od=g(()=>{Fu();Yg();Xg();ul();sl();Qg();ed();Gb();Wb();Vu();Jb();nC=()=>{let r=Br("TRACING_SAMPLING_RATE");if(r===void 0)return;let e=parseFloat(r);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},iC=r=>{let t=r.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};sC=async r=>{if(r?.status===429){let e=parseInt(r.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1},Pd=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,n=new Promise(a=>{t=a}),i=pi(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:n,size:i}),this.sizeBytes+=i,n}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");let t=[],n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0;){let i=this.items.shift();i&&(t.push(i),n+=i.size,this.sizeBytes-=i.size)}if(t.length===0&&this.items.length>0){let i=this.items.shift();t.push(i),n+=i.size,this.sizeBytes-=i.size}return[t.map(i=>({action:i.action,item:i.payload})),()=>t.forEach(i=>i.itemPromiseResolve())]}},oC=20971520,uC=1e3,di=class r{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Pd}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=r.getDefaultClientConfig();this.tracingSampleRate=nC(),this.apiUrl=Ad(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Ad(e.apiKey??t.apiKey),this.webUrl=Ad(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??12e3,this.caller=new Gs(e.callerOptions??{}),this.batchIngestCaller=new Gs({...e.callerOptions??{},onFailedResponseHook:sC}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){let e=Br("API_KEY"),t=Br("ENDPOINT")??"https://api.smith.langchain.com",n=Br("HIDE_INPUTS")==="true",i=Br("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:i}}getHostUrl(){return this.webUrl?this.webUrl:iC(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${al}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){let n=t?.toString()??"",i=`${this.apiUrl}${e}?${n}`,a=await this.caller.call(L(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(a,`Failed to fetch ${e}`),a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let i=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(i)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(L(),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(o,`Failed to fetch ${e}`);let u=n?n(await o.json()):await o.json();if(u.length===0||(yield u,u.length<a))break;i+=u.length}}async*_getCursorPaginatedList(e,t=null,n="POST",i="runs"){let a=t?{...t}:{};for(;;){let o=await(await this.caller.call(L(),`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)})).json();if(!o||!o[i])break;yield o[i];let u=o.cursors;if(!u||!u.next)break;a.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let n=[];for(let i of e)this.filteredPostUuids.has(i.id)?this.filteredPostUuids.delete(i.id):n.push(i);return n}else{let n=[];for(let i of e)i.id!==i.trace_id&&!this.filteredPostUuids.has(i.trace_id)||Math.random()<this.tracingSampleRate?n.push(i):this.filteredPostUuids.add(i.id);return n}}async _getBatchSizeLimitBytes(){let e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??oC}async drainAutoBatchQueue(){for(;this.autoBatchQueue.items.length>=0;){let[e,t]=this.autoBatchQueue.pop(await this._getBatchSizeLimitBytes());if(!e.length){t();return}try{let n={runCreates:e.filter(a=>a.action==="create").map(a=>a.item),runUpdates:e.filter(a=>a.action==="update").map(a=>a.item)};(await this._ensureServerInfo())?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(n):await this.batchIngestRuns(n)}finally{t()}}}async processRunOperation(e,t){let n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=Yb(e.item));let i=this.autoBatchQueue.push(e),a=await this._getBatchSizeLimitBytes();return(t||this.autoBatchQueue.sizeBytes>a)&&await this.drainAutoBatchQueue().catch(console.error),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),i}async _getServerInfo(){let e=await L()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(uC),...this.fetchOptions});return await J(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch{console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to single calls and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;let i=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){this.processRunOperation({action:"create",item:i}).catch(console.error);return}let a=Yb(i),s=await this.caller.call(L(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:pi(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(s,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let n=e?.map(u=>this.prepareRunCreateOrUpdateInputs(u))??[],i=t?.map(u=>this.prepareRunCreateOrUpdateInputs(u))??[];if(n.length>0&&i.length>0){let u=n.reduce((c,p)=>(p.id&&(c[p.id]=p),c),{}),l=[];for(let c of i)c.id!==void 0&&u[c.id]?u[c.id]={...u[c.id],...c}:l.push(c);n=Object.values(u),i=l}let a={post:this._filterForSampling(n),patch:this._filterForSampling(i,!0)};if(!a.post.length&&!a.patch.length)return;if((await this._ensureServerInfo()).version===void 0){this.autoBatchTracing=!1;for(let u of a.post)await this.createRun(u);for(let u of a.patch)u.id!==void 0&&await this.updateRun(u.id,u);return}let o={post:[],patch:[]};for(let u of["post","patch"]){let l=u,c=a[l].reverse(),p=c.pop();for(;p!==void 0;)o[l].push(p),p=c.pop()}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(pi(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(L(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(n,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let n={},i=[];for(let c of e??[]){let p=this.prepareRunCreateOrUpdateInputs(c);p.id!==void 0&&p.attachments!==void 0&&(n[p.id]=p.attachments),delete p.attachments,i.push(p)}let a=[];for(let c of t??[])a.push(this.prepareRunCreateOrUpdateInputs(c));if(i.find(c=>c.trace_id===void 0||c.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(c=>c.trace_id===void 0||c.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){let c=i.reduce((d,f)=>(f.id&&(d[f.id]=f),d),{}),p=[];for(let d of a)d.id!==void 0&&c[d.id]?c[d.id]={...c[d.id],...d}:p.push(d);i=Object.values(c),a=p}if(i.length===0&&a.length===0)return;let u=[],l=[];for(let[c,p]of[["post",i],["patch",a]])for(let d of p){let{inputs:f,outputs:m,events:h,...y}=d,_={inputs:f,outputs:m,events:h},b=pi(y);l.push({name:`${c}.${y.id}`,payload:new Blob([b],{type:`application/json; length=${b.length}`})});for(let[O,v]of Object.entries(_)){if(v===void 0)continue;let x=pi(v);l.push({name:`${c}.${y.id}.${O}`,payload:new Blob([x],{type:`application/json; length=${x.length}`})})}if(y.id!==void 0){let O=n[y.id];if(O){delete n[y.id];for(let[v,[x,C]]of Object.entries(O))l.push({name:`attachment.${y.id}.${v}`,payload:new Blob([C],{type:`${x}; length=${C.length}`})})}}u.push(`trace=${y.trace_id},id=${y.id}`)}await this._sendMultipartRequest(l,u.join("; "))}async _sendMultipartRequest(e,t){try{let n=new FormData;for(let i of e)n.append(i.name,i.payload);await this.batchIngestCaller.call(L(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers},body:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})}catch(n){let i="Failed to multipart ingest runs";n instanceof Error?i+=`: ${n.stack||n.message}`:i+=`: ${String(n)}`,console.warn(`${i.trim()}

Context: ${t}`)}}async updateRun(e,t){Y(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&n.trace_id!==void 0&&n.dotted_order!==void 0){if(t.end_time!==void 0&&n.parent_run_id===void 0&&this.blockOnRootRunFinalization){await this.processRunOperation({action:"update",item:n},!0);return}else this.processRunOperation({action:"update",item:n}).catch(console.error);return}let i={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(L(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,body:pi(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(a,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Y(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(t!==void 0){let i;t.session_id?i=t.session_id:n?.projectName?i=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?i=n?.projectId:i=(await this.readProject({projectName:Br("PROJECT")||"default"})).id;let a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${i}/r/${t.id}?poll=true`}else if(e!==void 0){let i=await this.readRun(e);if(!i.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${i.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await aC(this.listRuns({id:e.child_run_ids})),n={},i={};t.sort((a,s)=>(a?.dotted_order??"").localeCompare(s?.dotted_order??""));for(let a of t){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in n||(n[a.parent_run_id]=[]),n[a.parent_run_id].push(a),i[a.id]=a}e.child_runs=n[e.id]||[];for(let a in n)a!==e.id&&(i[a].child_runs=n[a]);return e}async*listRuns(e){let{projectId:t,projectName:n,parentRunId:i,traceId:a,referenceExampleId:s,startTime:o,executionOrder:u,isRoot:l,runType:c,error:p,id:d,query:f,filter:m,traceFilter:h,treeFilter:y,limit:_,select:b}=e,O=[];if(t&&(O=Array.isArray(t)?t:[t]),n){let R=Array.isArray(n)?n:[n],q=await Promise.all(R.map(re=>this.readProject({projectName:re}).then(Q=>Q.id)));O.push(...q)}let v=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],x={session:O.length?O:null,run_type:c,reference_example:s,query:f,filter:m,trace_filter:h,tree_filter:y,execution_order:u,parent_run:i,start_time:o?o.toISOString():null,error:p,id:d,limit:_,trace:a,select:b||v,is_root:l},C=0;for await(let R of this._getCursorPaginatedList("/runs/query",x))if(_){if(C>=_)break;if(R.length+C>_){yield*R.slice(0,_-C);break}C+=R.length,yield*R}else yield*R}async getRunStats({id:e,trace:t,parentRun:n,runType:i,projectNames:a,projectIds:s,referenceExampleIds:o,startTime:u,endTime:l,error:c,query:p,filter:d,traceFilter:f,treeFilter:m,isRoot:h,dataSourceType:y}){let _=s||[];a&&(_=[...s||[],...await Promise.all(a.map(C=>this.readProject({projectName:C}).then(R=>R.id)))]);let O=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:n,run_type:i,session:_,reference_example:o,start_time:u,end_time:l,error:c,query:p,filter:d,trace_filter:f,tree_filter:m,is_root:h,data_source_type:y}).filter(([C,R])=>R!==void 0));return await(await this.caller.call(L(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(O),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){let n={run_id:e,share_token:t||li()};Y(e);let a=await(await this.caller.call(L(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Y(e);let t=await this.caller.call(L(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(t,"unshare run",!0)}async readRunSharedLink(e){Y(e);let n=await(await this.caller.call(L(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let n=new URLSearchParams({share_token:e});if(t!==void 0)for(let s of t)n.append("id",s);return Y(e),await(await this.caller.call(L(),`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Y(e);let i=await(await this.caller.call(L(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let n={dataset_id:e};Y(e);let a=await(await this.caller.call(L(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Y(e);let t=await this.caller.call(L(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(t,"unshare dataset",!0)}async readSharedDataset(e){return Y(e),await(await this.caller.call(L(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){let n={};t?.exampleIds&&(n.id=t.exampleIds);let i=new URLSearchParams;Object.entries(n).forEach(([o,u])=>{Array.isArray(u)?u.forEach(l=>i.append(o,l)):i.append(o,u)});let a=await this.caller.call(L(),`${this.apiUrl}/public/${e}/examples?${i.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await a.json();if(!a.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${a.status}
Message: ${s.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:i=!1,projectExtra:a=null,referenceDatasetId:s=null}){let o=i?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=a||{};n&&(l.metadata=n);let c={name:e,extra:l,description:t};s!==null&&(c.reference_dataset_id=s);let p=await this.caller.call(L(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(p,"create project"),await p.json()}async updateProject(e,{name:t=null,description:n=null,metadata:i=null,projectExtra:a=null,endTime:s=null}){let o=`${this.apiUrl}/sessions/${e}`,u=a;i&&(u={...u||{},metadata:i});let l={name:t,extra:u,description:n,end_time:s?new Date(s).toISOString():null},c=await this.caller.call(L(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(c,"update project"),await c.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions",i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),n+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");let a=await this.caller.call(L(),`${this.apiUrl}${n}?${i}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let s=await a.json();return a.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let i="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),i+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");n!==void 0&&a.append("include_stats",n.toString());let s=await this._get(i,a),o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let n=await this.readProject({projectId:e,projectName:t}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let n=await this.readDataset({datasetId:e,datasetName:t}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:i,referenceDatasetName:a,referenceFree:s,metadata:o}={}){let u=new URLSearchParams;if(e!==void 0)for(let l of e)u.append("id",l);if(t!==void 0&&u.append("name",t),n!==void 0&&u.append("name_contains",n),i!==void 0)u.append("reference_dataset",i);else if(a!==void 0){let l=await this.readDataset({datasetName:a});u.append("reference_dataset",l.id)}s!==void 0&&u.append("reference_free",s.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(let l of this._getPaginated("/sessions",u))yield*l}async deleteProject({projectId:e,projectName:t}){let n;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:t})).id:n=e,Y(n);let i=await this.caller.call(L(),`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(i,`delete session ${n} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:i,description:a,dataType:s,name:o}){let u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),n.forEach(d=>{l.append("input_keys",d)}),i.forEach(d=>{l.append("output_keys",d)}),a&&l.append("description",a),s&&l.append("data_type",s),o&&l.append("name",o);let c=await this.caller.call(L(),u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(c,"upload CSV"),await c.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:i,outputsSchema:a,metadata:s}={}){let o={name:e,description:t,extra:s?{metadata:s}:void 0};n&&(o.data_type=n),i&&(o.inputs_schema_definition=i),a&&(o.outputs_schema_definition=a);let u=await this.caller.call(L(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets",i=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)Y(e),n+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide datasetName or datasetId");let a=await this._get(n,i),s;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=a[0]}else s=a;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:i}){let a=e;if(a===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:t})).id);let s=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof i=="string"?i:i.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let n="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:i,datasetNameContains:a,metadata:s}={}){let o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(n!==void 0)for(let l of n)u.append("id",l);i!==void 0&&u.append("name",i),a!==void 0&&u.append("name_contains",a),s!==void 0&&u.append("metadata",JSON.stringify(s));for await(let l of this._getPaginated(o,u))yield*l}async updateDataset(e){let{datasetId:t,datasetName:n,...i}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");let a=t??(await this.readDataset({datasetName:n})).id;Y(a);let s=await this.caller.call(L(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(s,"update dataset"),await s.json()}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",i=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(i=(await this.readDataset({datasetName:t})).id),i!==void 0)Y(i),n+=`/${i}`;else throw new Error("Must provide datasetName or datasetId");let a=await this.caller.call(L(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(a,`delete ${n}`),await a.json()}async indexDataset({datasetId:e,datasetName:t,tag:n}){let i=e;if(!i&&!t)throw new Error("Must provide either datasetName or datasetId");if(i&&t)throw new Error("Must provide either datasetName or datasetId, not both");i||(i=(await this.readDataset({datasetName:t})).id),Y(i);let a={tag:n},s=await this.caller.call(L(),`${this.apiUrl}/datasets/${i}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(s,"index dataset"),await s.json()}async similarExamples(e,t,n,{filter:i}={}){let a={limit:n,inputs:e};i!==void 0&&(a.filter=i),Y(t);let s=await this.caller.call(L(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(s,"fetch similar examples"),(await s.json()).examples}async createExample(e,t,{datasetId:n,datasetName:i,createdAt:a,exampleId:s,metadata:o,split:u,sourceRunId:l}){let c=n;if(c===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:i})).id);let d={dataset_id:c,inputs:e,outputs:t,created_at:(a||new Date)?.toISOString(),id:s,metadata:o,split:u,source_run_id:l},f=await this.caller.call(L(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(f,"create example"),await f.json()}async createExamples(e){let{inputs:t,outputs:n,metadata:i,sourceRunIds:a,exampleIds:s,datasetId:o,datasetName:u}=e,l=o;if(l===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:u})).id);let c=t.map((f,m)=>({dataset_id:l,inputs:f,outputs:n?n[m]:void 0,metadata:i?i[m]:void 0,split:e.splits?e.splits[m]:void 0,id:s?s[m]:void 0,source_run_id:a?a[m]:void 0})),p=await this.caller.call(L(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(p,"create examples"),await p.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){let i=e.map(s=>Xp(s)?Qp(s):s),a=Xp(t)?Qp(t):t;return this.createExample({input:i},{output:a},n)}async readExample(e){Y(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:i,splits:a,inlineS3Urls:s,metadata:o,limit:u,offset:l,filter:c}={}){let p;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)p=e;else if(t!==void 0)p=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let d=new URLSearchParams({dataset:p}),f=i?typeof i=="string"?i:i?.toISOString():void 0;f&&d.append("as_of",f);let m=s??!0;if(d.append("inline_s3_urls",m.toString()),n!==void 0)for(let y of n)d.append("id",y);if(a!==void 0)for(let y of a)d.append("splits",y);if(o!==void 0){let y=JSON.stringify(o);d.append("metadata",y)}u!==void 0&&d.append("limit",u.toString()),l!==void 0&&d.append("offset",l.toString()),c!==void 0&&d.append("filter",c);let h=0;for await(let y of this._getPaginated("/examples",d)){for(let _ of y)yield _,h++;if(u!==void 0&&h>=u)break}}async deleteExample(e){Y(e);let t=`/examples/${e}`,n=await this.caller.call(L(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(n,`delete ${t}`),await n.json()}async updateExample(e,t){Y(e);let n=await this.caller.call(L(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(n,"update example"),await n.json()}async updateExamples(e){let t=await this.caller.call(L(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,Y(i);let a=new URLSearchParams,s=n?typeof n=="string"?n:n?.toISOString():void 0;return s&&a.append("as_of",s),await this._get(`/datasets/${i}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:i,remove:a=!1}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,Y(s);let o={split_name:n,examples:i.map(l=>(Y(l),l)),remove:a},u=await this.caller.call(L(),`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(u,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:i,referenceExample:a}={loadChildRuns:!1}){Gu("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let s;if(typeof e=="string")s=await this.readRun(e,{loadChildRuns:i});else if(typeof e=="object"&&"id"in e)s=e;else throw new Error(`Invalid run type: ${typeof e}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(a=await this.readExample(s.reference_example_id));let o=await t.evaluateRun(s,a),[u,l]=await this._logEvaluationFeedback(o,s,n);return l[0]}async createFeedback(e,t,{score:n,value:i,correction:a,comment:s,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:p,projectId:d,comparativeExperimentId:f}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");let m={type:u??"api",metadata:o??{}};l!==void 0&&m?.metadata!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:l}),m?.metadata!==void 0&&m.metadata.__run?.run_id!==void 0&&Y(m.metadata.__run.run_id);let h={id:c??li(),run_id:e,key:t,score:n,value:i,correction:a,comment:s,feedback_source:m,comparative_experiment_id:f,feedbackConfig:p,session_id:d},y=`${this.apiUrl}/feedback`,_=await this.caller.call(L(),y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(_,"create feedback",!0),h}async updateFeedback(e,{score:t,value:n,correction:i,comment:a}){let s={};t!=null&&(s.score=t),n!=null&&(s.value=n),i!=null&&(s.correction=i),a!=null&&(s.comment=a),Y(e);let o=await this.caller.call(L(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(o,"update feedback",!0)}async readFeedback(e){Y(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Y(e);let t=`/feedback/${e}`,n=await this.caller.call(L(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(n,`delete ${t}`),await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){let i=new URLSearchParams;if(e&&i.append("run",e.join(",")),t)for(let a of t)i.append("key",a);if(n)for(let a of n)i.append("source",a);for await(let a of this._getPaginated("/feedback",i))yield*a}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:i}={}){let a={run_id:e,feedback_key:t,feedback_config:i};return n?typeof n=="string"?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3},await(await this.caller.call(L(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:i,description:a,metadata:s,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:n,description:a,created_at:(i??new Date)?.toISOString(),extra:{}};return s&&(u.extra.metadata=s),await(await this.caller.call(L(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){Y(e);let t=new URLSearchParams({run_id:e});for await(let n of this._getPaginated("/feedback/tokens",t))yield*n}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,n){let i=this._selectEvalResults(e),a=[];for(let s of i){let o=n||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let u=null;s.targetRunId?u=s.targetRunId:t&&(u=t.id),a.push(await this.createFeedback(u,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"}))}return[i,a]}async logEvaluationFeedback(e,t,n){let[i]=await this._logEvaluationFeedback(e,t,n);return i}async*listAnnotationQueues(e={}){let{queueIds:t,name:n,nameContains:i,limit:a}=e,s=new URLSearchParams;t&&t.forEach((u,l)=>{Y(u,`queueIds[${l}]`),s.append("ids",u)}),n&&s.append("name",n),i&&s.append("name_contains",i),s.append("limit",(a!==void 0?Math.min(a,100):100).toString());let o=0;for await(let u of this._getPaginated("/annotation-queues",s))if(yield*u,o++,a!==void 0&&o>=a)break}async createAnnotationQueue(e){let{name:t,description:n,queueId:i}=e,a={name:t,description:n,id:i||li()},s=await this.caller.call(L(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter(([u,l])=>l!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(s,"create annotation queue"),await s.json()}async readAnnotationQueue(e){let t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){let{name:n,description:i}=t,a=await this.caller.call(L(),`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:n,description:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(a,"update annotation queue")}async deleteAnnotationQueue(e){let t=await this.caller.call(L(),`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){let n=await this.caller.call(L(),`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((i,a)=>Y(i,`runIds[${a}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(n,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){let n=`/annotation-queues/${Y(e,"queueId")}/run`,i=await this.caller.call(L(),`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(i,"get run from annotation queue"),await i.json()}async _currentTenantIsOwner(e){let t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){let n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){let t=await this.caller.call(L(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(!t.ok){let i=typeof n.detail=="string"?n.detail:JSON.stringify(n.detail),a=new Error(`Error ${t.status}: ${t.statusText}
${i}`);throw a.statusCode=t.status,a}if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){let[n,i,a]=zr(e),s=await this.caller.call(L(),`${this.apiUrl}/likes/${n}/${i}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(s,`${t?"like":"unlike"} prompt`),await s.json()}async _getPromptUrl(e){let[t,n,i]=zr(e);if(await this._currentTenantIsOwner(t)){let a=await this._getSettings();return i!=="latest"?`${this.getHostUrl()}/prompts/${n}/${i.substring(0,8)}?organizationId=${a.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${a.id}`}else return i!=="latest"?`${this.getHostUrl()}/hub/${t}/${n}/${i.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(let t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*t}async*listPrompts(e){let t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(let n of this._getPaginated("/repos",t,i=>i.repos))yield*n}async getPrompt(e){let[t,n,i]=zr(e),a=await this.caller.call(L(),`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(a.status===404)return null;await J(a,"get prompt");let s=await a.json();return s.repo?s.repo:null}async createPrompt(e,t){let n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[i,a,s]=zr(e);if(!await this._currentTenantIsOwner(i))throw await this._ownerConflictError("create a prompt",i);let o={repo_handle:a,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},u=await this.caller.call(L(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(u,"create prompt");let{repo:l}=await u.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[i,a,s]=zr(e),o=n?.parentCommitHash==="latest"||!n?.parentCommitHash?await this._getLatestCommitHash(`${i}/${a}`):n?.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},l=await this.caller.call(L(),`${this.apiUrl}/commits/${i}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(l,"create commit");let c=await l.json();return this._getPromptUrl(`${i}/${a}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[n,i]=zr(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);let a={};if(t?.description!==void 0&&(a.description=t.description),t?.readme!==void 0&&(a.readme=t.readme),t?.tags!==void 0&&(a.tags=t.tags),t?.isPublic!==void 0&&(a.is_public=t.isPublic),t?.isArchived!==void 0&&(a.is_archived=t.isArchived),Object.keys(a).length===0)throw new Error("No valid update options provided");let s=await this.caller.call(L(),`${this.apiUrl}/repos/${n}/${i}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await J(s,"update prompt"),s.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[t,n,i]=zr(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(L(),`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){let[n,i,a]=zr(e),s=await this._getServerInfo(),o=Hb(s.version,"0.5.23"),u=a;if(!o&&a==="latest"){let p=await this._getLatestCommitHash(`${n}/${i}`);if(p)u=p;else throw new Error("No commits found")}let l=await this.caller.call(L(),`${this.apiUrl}/commits/${n}/${i}/${u}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await J(l,"pull prompt commit");let c=await l.json();return{owner:n,repo:i,commit_hash:c.commit_hash,manifest:c.manifest,examples:c.examples}}async _pullPrompt(e,t){let n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(i=>i!=="object")&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){let{sourceApiUrl:n=this.apiUrl,datasetName:i}=t,[a,s]=this.parseTokenOrUrl(e,n),o=new r({apiUrl:a,apiKey:"placeholder"}),u=await o.readSharedDataset(s),l=i||u.name;try{if(await this.hasDataset({datasetId:l})){console.log(`Dataset ${l} already exists in your tenant. Skipping.`);return}}catch{}let c=await o.listSharedExamples(s),p=await this.createDataset(l,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map(d=>d.inputs),outputs:c.flatMap(d=>d.outputs?[d.outputs]:[]),datasetId:p.id})}catch(d){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),d}}parseTokenOrUrl(e,t,n=2,i="dataset"){try{return Y(e),[t,e]}catch{}try{let s=new URL(e).pathname.split("/").filter(o=>o!=="");if(s.length>=n){let o=s[s.length-n];return[t,o]}else throw new Error(`Invalid public ${i} URL: ${e}`)}catch{throw new Error(`Invalid public ${i} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all(this.autoBatchQueue.items.map(({itemPromise:e})=>e))}}});var al,sl=g(()=>{Od();ll();Vu();al="0.1.68"});function ol(){if(Ed===void 0){let r=fC(),e=hC();Ed={library:"langsmith",runtime:r,sdk:"langsmith-js",sdk_version:al,...e}}return Ed}function Xb(){let r=mC()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[n,i]of Object.entries(r))n.startsWith("LANGCHAIN_")&&typeof i=="string"&&!t.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=i:e[n]=i);return e}function mC(){try{return typeof process<"u"&&process.env?Object.entries(process.env).reduce((r,[e,t])=>(r[e]=String(t),r),{}):void 0}catch{return}}function _n(r){try{return typeof process<"u"?process.env?.[r]:void 0}catch{return}}function Br(r){return _n(`LANGSMITH_${r}`)||_n(`LANGCHAIN_${r}`)}function hC(){if(Id!==void 0)return Id;let r=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of r){let n=_n(t);n!==void 0&&(e[t]=n)}return Id=e,e}var Kr,lC,cC,pC,Qb,dC,fC,Ed,Id,ul=g(()=>{sl();lC=()=>typeof window<"u"&&typeof window.document<"u",cC=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",pC=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Qb=()=>typeof Deno<"u",dC=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Qb(),fC=()=>Kr||(lC()?Kr="browser":dC()?Kr="node":cC()?Kr="webworker":pC()?Kr="jsdom":Qb()?Kr="deno":Kr="other",Kr)});var ew,tw=g(()=>{ul();ew=r=>r!==void 0?r:!!["TRACING_V2","TRACING"].find(t=>Br(t)==="true")});var cl,rw=g(()=>{cl=Symbol.for("lc:context_variables")});function gC(r){return r.replace(/[-:.]/g,"")}function yC(r,e,t=1){let n=t.toFixed(0).slice(0,3).padStart(3,"0");return gC(`${new Date(r).toISOString().slice(0,-1)}${n}Z`)+e}function Td(r){return r!==void 0&&typeof r.createChild=="function"&&typeof r.postRun=="function"}function iw(r){return typeof r=="object"&&r!=null&&typeof r.name=="string"&&r.name==="langchain_tracer"}function nw(r){return Array.isArray(r)&&r.some(e=>iw(e))}function bC(r){return typeof r=="object"&&r!=null&&Array.isArray(r.handlers)}function wC(r){return r!==void 0&&typeof r.callbacks=="object"&&(nw(r.callbacks?.handlers)||nw(r.callbacks))}var pl,wn,ll=g(()=>{Fu();ul();Od();tw();ed();rw();pl=class r{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){let t=e.split(","),n={},i=[];for(let a of t){let[s,o]=a.split("="),u=decodeURIComponent(o);s==="langsmith-metadata"?n=JSON.parse(u):s==="langsmith-tags"&&(i=u.split(","))}return new r(n,i)}toHeader(){let e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}},wn=class r{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Td(e)){Object.assign(this,{...e});return}let t=r.getDefaultConfig(),{metadata:n,...i}=e,a=i.client??r.getSharedClient(),s={...n,...i?.extra?.metadata};if(i.extra={...i.extra,metadata:s},Object.assign(this,{...t,...i,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){let o=yC(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o}}static getDefaultConfig(){return{id:li(),run_type:"chain",project_name:_n("LANGCHAIN_PROJECT")??_n("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:_n("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:_n("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return r.sharedClient||(r.sharedClient=new di),r.sharedClient}createChild(e){let t=this.child_execution_order+1,n=new r({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});cl in this&&(n[cl]=this[cl]);let i=Symbol.for("lc:child_config"),a=e.extra?.[i]??this.extra[i];if(wC(a)){let u={...a},l=bC(u.callbacks)?u.callbacks.copy?.():void 0;l&&(Object.assign(l,{_parentRunId:n.id}),l.handlers?.find(iw)?.updateFromRunTree?.(n),u.callbacks=l),n.extra[i]=u}let s=new Set,o=this;for(;o!=null&&!s.has(o.id);)s.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(n),n}async end(e,t,n=Date.now(),i){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,i&&Object.keys(i).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...i}}:{metadata:i})}_convertToCreate(e,t,n=!0){let i=e.extra??{};if(i.runtime||(i.runtime={}),t)for(let[u,l]of Object.entries(t))i.runtime[u]||(i.runtime[u]=l);let a,s;return n?(s=e.parent_run?.id,a=[]):(a=e.child_runs.map(u=>this._convertToCreate(u,t,n)),s=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:i,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:s,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags}}async postRun(e=!0){try{let t=ol(),n=await this._convertToCreate(this,t,!0);if(await this.client.createRun(n),!e){Gu("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(let i of this.child_runs)await i.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){try{let e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){let n=e?.callbacks,i,a,s,o=ew();if(n){let l=n?.getParentRunId?.()??"",c=n?.handlers?.find(p=>p?.name=="langchain_tracer");i=c?.getRun?.(l),a=c?.projectName,s=c?.client,o=o||!!c}return i?new r({name:i.name,id:i.id,trace_id:i.trace_id,dotted_order:i.dotted_order,client:s,tracingEnabled:o,project_name:a,tags:[...new Set((i?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...i?.extra?.metadata,...e?.metadata}}}).createChild(t):new r({...t,client:s,tracingEnabled:o,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){let n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,i=n["langsmith-trace"];if(!i||typeof i!="string")return;let a=i.trim(),s=a.split(".").map(l=>{let[c,p]=l.split("Z");return{strTime:c,time:Date.parse(c+"Z"),uuid:p}}),o=s[0].uuid,u={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:a};if(n.baggage&&typeof n.baggage=="string"){let l=pl.fromHeader(n.baggage);u.metadata=l.metadata,u.tags=l.tags}return new r(u)}toHeaders(e){let t={"langsmith-trace":this.dotted_order,baggage:new pl(this.extra?.metadata,this.tags).toHeader()};if(e)for(let[n,i]of Object.entries(t))e.set(n,i);return t}};Object.defineProperty(wn,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})});function dl(r){return typeof r=="function"&&"langsmith:traceable"in r}var Sd,Cd,_C,kd,vC,aw,eF,sw=g(()=>{ll();Sd=class{getStore(){}run(e,t){return t()}},Cd=Symbol.for("ls:tracing_async_local_storage"),_C=new Sd,kd=class{getInstance(){return globalThis[Cd]??_C}initializeGlobalInstance(e){globalThis[Cd]===void 0&&(globalThis[Cd]=e)}},vC=new kd,aw=()=>{let r=vC.getInstance().getStore();if(!Td(r))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join(`
`));return r},eF=Symbol.for("langsmith:traceable:root")});var Rd=g(()=>{sw()});function ml(r,e){return xC.call(r,e)}function hl(r){if(Array.isArray(r)){let t=new Array(r.length);for(let n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(r);let e=[];for(let t in r)ml(r,t)&&e.push(t);return e}function Ke(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function gl(r){let e=0,t=r.length,n;for(;e<t;){if(n=r.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function mr(r){return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}function to(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function fl(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(fl(r[t]))return!0}else if(typeof r=="object"){let t=hl(r),n=t.length;for(var e=0;e<n;e++)if(fl(r[t[e]]))return!0}}return!1}function ow(r,e){let t=[r];for(let n in e){let i=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof i<"u"&&t.push(`${n}: ${i}`)}return t.join(`
`)}var xC,fi,ro=g(()=>{xC=Object.prototype.hasOwnProperty;fi=class extends Error{constructor(e,t,n,i,a){super(ow(e,{name:t,index:n,operation:i,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=ow(e,{name:t,index:n,operation:i,tree:a})}}});var Nd={};mn(Nd,{JsonPatchError:()=>ge,_areEquals:()=>no,applyOperation:()=>mi,applyPatch:()=>vn,applyReducer:()=>OC,deepClone:()=>AC,getValueByPointer:()=>yl,validate:()=>uw,validator:()=>bl});function yl(r,e){if(e=="")return r;var t={op:"_get",path:e};return mi(r,t),t.value}function mi(r,e,t=!1,n=!0,i=!0,a=0){if(t&&(typeof t=="function"?t(e,0,r,e.path):bl(e,0)),e.path===""){let s={newDocument:r};if(e.op==="add")return s.newDocument=e.value,s;if(e.op==="replace")return s.newDocument=e.value,s.removed=r,s;if(e.op==="move"||e.op==="copy")return s.newDocument=yl(r,e.from),e.op==="move"&&(s.removed=r),s;if(e.op==="test"){if(s.test=no(r,e.value),s.test===!1)throw new ge("Test operation failed","TEST_OPERATION_FAILED",a,e,r);return s.newDocument=r,s}else{if(e.op==="remove")return s.removed=r,s.newDocument=null,s;if(e.op==="_get")return e.value=r,s;if(t)throw new ge("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,r);return s}}else{n||(r=Ke(r));let o=(e.path||"").split("/"),u=r,l=1,c=o.length,p,d,f;for(typeof t=="function"?f=t:f=bl;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=to(d)),i&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&p===void 0&&(u[d]===void 0?p=o.slice(0,l).join("/"):l==c-1&&(p=e.path),p!==void 0&&f(e,0,r,p)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!gl(d))throw new ge("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,r);gl(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new ge("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,r);let m=PC[e.op].call(e,u,d,r);if(m.test===!1)throw new ge("Test operation failed","TEST_OPERATION_FAILED",a,e,r);return m}}else if(l>=c){let m=ga[e.op].call(e,u,d,r);if(m.test===!1)throw new ge("Test operation failed","TEST_OPERATION_FAILED",a,e,r);return m}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new ge("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,r)}}}function vn(r,e,t,n=!0,i=!0){if(t&&!Array.isArray(e))throw new ge("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(r=Ke(r));let a=new Array(e.length);for(let s=0,o=e.length;s<o;s++)a[s]=mi(r,e[s],t,!0,i,s),r=a[s].newDocument;return a.newDocument=r,a}function OC(r,e,t){let n=mi(r,e);if(n.test===!1)throw new ge("Test operation failed","TEST_OPERATION_FAILED",t,e,r);return n.newDocument}function bl(r,e,t,n){if(typeof r!="object"||r===null||Array.isArray(r))throw new ge("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(ga[r.op]){if(typeof r.path!="string")throw new ge("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new ge('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new ge("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new ge("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&fl(r.value))throw new ge("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var i=r.path.split("/").length,a=n.split("/").length;if(i!==a+1&&i!==a)throw new ge("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==n)throw new ge("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var s={op:"_get",path:r.from,value:void 0},o=uw([s],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ge("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new ge("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function uw(r,e,t){try{if(!Array.isArray(r))throw new ge("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)vn(Ke(e),Ke(r),t||!0);else{t=t||bl;for(var n=0;n<r.length;n++)t(r[n],n,e,void 0)}}catch(i){if(i instanceof ge)return i;throw i}}function no(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),n=Array.isArray(e),i,a,s;if(t&&n){if(a=r.length,a!=e.length)return!1;for(i=a;i--!==0;)if(!no(r[i],e[i]))return!1;return!0}if(t!=n)return!1;var o=Object.keys(r);if(a=o.length,a!==Object.keys(e).length)return!1;for(i=a;i--!==0;)if(!e.hasOwnProperty(o[i]))return!1;for(i=a;i--!==0;)if(s=o[i],!no(r[s],e[s]))return!1;return!0}return r!==r&&e!==e}var ge,AC,ga,PC,wl=g(()=>{ro();ge=fi,AC=Ke,ga={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var n=r[e];return delete r[e],{newDocument:t,removed:n}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:function(r,e,t){let n=yl(t,this.path);n&&(n=Ke(n));let i=mi(t,{op:"remove",path:this.from}).removed;return mi(t,{op:"add",path:this.path,value:i}),{newDocument:t,removed:n}},copy:function(r,e,t){let n=yl(t,this.from);return mi(t,{op:"add",path:this.path,value:Ke(n)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:no(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}},PC={add:function(r,e,t){return gl(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var n=r.splice(e,1);return{newDocument:t,removed:n[0]}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:ga.move,copy:ga.copy,test:ga.test,_get:ga._get}});function lw(r,e,t,n,i){if(e!==r){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=hl(e),s=hl(r),o=!1,u=!1,l=s.length-1;l>=0;l--){var c=s[l],p=r[c];if(ml(e,c)&&!(e[c]===void 0&&p!==void 0&&Array.isArray(e)===!1)){var d=e[c];typeof p=="object"&&p!=null&&typeof d=="object"&&d!=null&&Array.isArray(p)===Array.isArray(d)?lw(p,d,t,n+"/"+mr(c),i):p!==d&&(o=!0,i&&t.push({op:"test",path:n+"/"+mr(c),value:Ke(p)}),t.push({op:"replace",path:n+"/"+mr(c),value:Ke(d)}))}else Array.isArray(r)===Array.isArray(e)?(i&&t.push({op:"test",path:n+"/"+mr(c),value:Ke(p)}),t.push({op:"remove",path:n+"/"+mr(c)}),u=!0):(i&&t.push({op:"test",path:n,value:r}),t.push({op:"replace",path:n,value:e}),o=!0)}if(!(!u&&a.length==s.length))for(var l=0;l<a.length;l++){var c=a[l];!ml(r,c)&&e[c]!==void 0&&t.push({op:"add",path:n+"/"+mr(c),value:Ke(e[c])})}}}function io(r,e,t=!1){var n=[];return lw(r,e,n,"",t),n}var cw=g(()=>{ro();wl();});var cF,Md=g(()=>{wl();cw();ro();wl();ro();cF={...Nd,JsonPatchError:fi,deepClone:Ke,escapePathComponent:mr,unescapePathComponent:to}});var dw=S((hF,pw)=>{"use strict";pw.exports=function(r,e){if(typeof r!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,r.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var ww=S((gF,jd)=>{"use strict";var EC=/[\p{Lu}]/u,IC=/[\p{Ll}]/u,fw=/^[\p{Lu}](?![\p{Lu}])/gu,gw=/([\p{Alpha}\p{N}_]|$)/u,yw=/[_.\- ]+/,TC=new RegExp("^"+yw.source),mw=new RegExp(yw.source+gw.source,"gu"),hw=new RegExp("\\d+"+gw.source,"gu"),CC=(r,e,t)=>{let n=!1,i=!1,a=!1;for(let s=0;s<r.length;s++){let o=r[s];n&&EC.test(o)?(r=r.slice(0,s)+"-"+r.slice(s),n=!1,a=i,i=!0,s++):i&&a&&IC.test(o)?(r=r.slice(0,s-1)+"-"+r.slice(s-1),a=i,i=!1,n=!0):(n=e(o)===o&&t(o)!==o,a=i,i=t(o)===o&&e(o)!==o)}return r},SC=(r,e)=>(fw.lastIndex=0,r.replace(fw,t=>e(t))),kC=(r,e)=>(mw.lastIndex=0,hw.lastIndex=0,r.replace(mw,(t,n)=>e(n)).replace(hw,t=>e(t))),bw=(r,e)=>{if(!(typeof r=="string"||Array.isArray(r)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(r)?r=r.map(a=>a.trim()).filter(a=>a.length).join("-"):r=r.trim(),r.length===0)return"";let t=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),n=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return r.length===1?e.pascalCase?n(r):t(r):(r!==t(r)&&(r=CC(r,t,n)),r=r.replace(TC,""),e.preserveConsecutiveUppercase?r=SC(r,t):r=t(r),e.pascalCase&&(r=n(r.charAt(0))+r.slice(1)),kC(r,n))};jd.exports=bw;jd.exports.default=bw});function vw(r,e){return e?.[r]||(0,_w.default)(r)}function xw(r,e,t){let n={};for(let i in r)Object.hasOwn(r,i)&&(n[e(i,t)]=r[i]);return n}var _w,RC,Aw=g(()=>{_w=pe(dw(),1),RC=pe(ww(),1)});function Pw(r){return Array.isArray(r)?[...r]:{...r}}function NC(r,e){let t=Pw(r);for(let[n,i]of Object.entries(e)){let[a,...s]=n.split(".").reverse(),o=t;for(let u of s.reverse()){if(o[u]===void 0)break;o[u]=Pw(o[u]),o=o[u]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[i]})}return t}function $d(r){let e=Object.getPrototypeOf(r);return typeof r.lc_name=="function"&&(typeof e.lc_name!="function"||r.lc_name()!==e.lc_name())?r.lc_name():r.name}var Fe,Vr=g(()=>{Aw();Fe=class r{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,$d(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof r||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},n=Object.keys(this.lc_kwargs).reduce((i,a)=>(i[a]=a in this?this[a]:this.lc_kwargs[a],i),{});for(let i=Object.getPrototypeOf(this);i;i=Object.getPrototypeOf(i))Object.assign(e,Reflect.get(i,"lc_aliases",this)),Object.assign(t,Reflect.get(i,"lc_secrets",this)),Object.assign(n,Reflect.get(i,"lc_attributes",this));return Object.keys(t).forEach(i=>{let a=this,s=n,[o,...u]=i.split(".").reverse();for(let l of u.reverse()){if(!(l in a)||a[l]===void 0)return;(!(l in s)||s[l]===void 0)&&(typeof a[l]=="object"&&a[l]!=null?s[l]={}:Array.isArray(a[l])&&(s[l]=[])),a=a[l],s=s[l]}o in a&&a[o]!==void 0&&(s[o]=s[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:xw(Object.keys(t).length?NC(n,t):n,vw,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}});async function Ew(){return Ld===void 0&&(Ld={library:"langchain-js",runtime:DC()}),Ld}function ie(r){try{return typeof process<"u"?process.env?.[r]:void 0}catch{return}}var MC,jC,$C,Ow,LC,DC,Ld,ya=g(()=>{MC=()=>typeof window<"u"&&typeof window.document<"u",jC=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",$C=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Ow=()=>typeof Deno<"u",LC=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Ow(),DC=()=>{let r;return MC()?r="browser":LC()?r="node":jC()?r="webworker":$C()?r="jsdom":Ow()?r="deno":r="other",r}});var Dd,hi,Fd=g(()=>{Vs();Vr();ya();Dd=class{},hi=class r extends Dd{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,$d(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:ie("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Fe.prototype.toJSON.call(this)}toJSONNotImplemented(){return Fe.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends r{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:lt()}),Object.assign(this,e)}}return new t}}});function qd(r,e){return r&&!Array.isArray(r)&&typeof r=="object"?r:{[e]:r}}function FC(r){return r.replace(/[-:.]/g,"")}function qC(r,e,t){let n=t.toFixed(0).slice(0,3).padStart(3,"0");return FC(`${new Date(r).toISOString().slice(0,-1)}${n}Z`)+e}function ba(r){return typeof r._addRunToRunMap=="function"}var $t,gi=g(()=>{Fd();$t=class extends hi{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let t=qC(e.start_time,e.id,e.execution_order),n={...e};if(n.parent_run_id!==void 0){let i=this.runMap.get(n.parent_run_id);i&&(this._addChildRun(i,n),i.child_execution_order=Math.max(i.child_execution_order,n.child_execution_order),n.trace_id=i.trace_id,i.dotted_order!==void 0&&(n.dotted_order=[i.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;return this.runMap.set(n.id,n),n}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,i,a,s,o,u){let l=this._getExecutionOrder(i),c=Date.now(),p=o?{...a,metadata:o}:a,d={id:n,name:u??e.id[e.id.length-1],parent_run_id:i,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:p??{},tags:s||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,n,i,a,s,o,u){let l=this.runMap.get(n)??this._createRunForLLMStart(e,t,n,i,a,s,o,u);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,n,i,a,s,o,u){let l=this._getExecutionOrder(i),c=Date.now(),p=o?{...a,metadata:o}:a,d={id:n,name:u??e.id[e.id.length-1],parent_run_id:i,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:p??{},tags:s||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,n,i,a,s,o,u){let l=this.runMap.get(n)??this._createRunForChatModelStart(e,t,n,i,a,s,o,u);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onLLMEnd?.(n),await this._endTrace(n),n}async handleLLMError(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onLLMError?.(n),await this._endTrace(n),n}_createRunForChainStart(e,t,n,i,a,s,o,u){let l=this._getExecutionOrder(i),c=Date.now(),p={id:n,name:u??e.id[e.id.length-1],parent_run_id:i,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(p)}async handleChainStart(e,t,n,i,a,s,o,u){let l=this.runMap.get(n)??this._createRunForChainStart(e,t,n,i,a,s,o,u);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,n,i,a){let s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=qd(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),a?.inputs!==void 0&&(s.inputs=qd(a.inputs,"input")),await this.onChainEnd?.(s),await this._endTrace(s),s}async handleChainError(e,t,n,i,a){let s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),a?.inputs!==void 0&&(s.inputs=qd(a.inputs,"input")),await this.onChainError?.(s),await this._endTrace(s),s}_createRunForToolStart(e,t,n,i,a,s,o){let u=this._getExecutionOrder(i),l=Date.now(),c={id:n,name:o??e.id[e.id.length-1],parent_run_id:i,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(c)}async handleToolStart(e,t,n,i,a,s,o){let u=this.runMap.get(n)??this._createRunForToolStart(e,t,n,i,a,s,o);return await this.onRunCreate?.(u),await this.onToolStart?.(u),u}async handleToolEnd(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onToolEnd?.(n),await this._endTrace(n),n}async handleToolError(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onToolError?.(n),await this._endTrace(n),n}async handleAgentAction(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="chain")return;let i=n;i.actions=i.actions||[],i.actions.push(e),i.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(n)}async handleAgentEnd(e,t){let n=this.runMap.get(t);!n||n?.run_type!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(n))}_createRunForRetrieverStart(e,t,n,i,a,s,o){let u=this._getExecutionOrder(i),l=Date.now(),c={id:n,name:o??e.id[e.id.length-1],parent_run_id:i,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(c)}async handleRetrieverStart(e,t,n,i,a,s,o){let u=this.runMap.get(n)??this._createRunForRetrieverStart(e,t,n,i,a,s,o);return await this.onRunCreate?.(u),await this.onRetrieverStart?.(u),u}async handleRetrieverEnd(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onRetrieverEnd?.(n),await this._endTrace(n),n}async handleRetrieverError(e,t){let n=this.runMap.get(t);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onRetrieverError?.(n),await this._endTrace(n),n}async handleText(e,t){let n=this.runMap.get(t);!n||n?.run_type!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(n))}async handleLLMNewToken(e,t,n,i,a,s){let o=this.runMap.get(n);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:s?.chunk}),o}}});var Ud=g(()=>{sl()});var Sw=S((TF,Cw)=>{"use strict";var Iw=(r=0)=>e=>`\x1B[${38+r};5;${e}m`,Tw=(r=0)=>(e,t,n)=>`\x1B[${38+r};2;${e};${t};${n}m`;function UC(){let r=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,n]of Object.entries(e)){for(let[i,a]of Object.entries(n))e[i]={open:`\x1B[${a[0]}m`,close:`\x1B[${a[1]}m`},n[i]=e[i],r.set(a[0],a[1]);Object.defineProperty(e,t,{value:n,enumerable:!1})}return Object.defineProperty(e,"codes",{value:r,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=Iw(),e.color.ansi16m=Tw(),e.bgColor.ansi256=Iw(10),e.bgColor.ansi16m=Tw(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,n,i)=>t===n&&n===i?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5),enumerable:!1},hexToRgb:{value:t=>{let n=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!n)return[0,0,0];let{colorString:i}=n.groups;i.length===3&&(i=i.split("").map(s=>s+s).join(""));let a=Number.parseInt(i,16);return[a>>16&255,a>>8&255,a&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(Cw,"exports",{enumerable:!0,get:UC})});function it(r,e){return`${r.open}${e}${r.close}`}function Lt(r,e){try{return JSON.stringify(r,null,2)}catch{return e}}function kw(r){return typeof r=="string"?r.trim():r==null?r:Lt(r,r.toString())}function xn(r){if(!r.end_time)return"";let e=r.end_time-r.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var zd,pt,ao,Rw=g(()=>{zd=pe(Sw(),1);gi();({color:pt}=zd.default),ao=class extends $t{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],n=e;for(;n.parent_run_id;){let i=this.runMap.get(n.parent_run_id);if(i)t.push(i),n=i;else break}return t}getBreadcrumbs(e){let n=[...this.getParents(e).reverse(),e].map((i,a,s)=>{let o=`${i.execution_order}:${i.run_type}:${i.name}`;return a===s.length-1?it(zd.default.bold,o):o}).join(" > ");return it(pt.grey,n)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Lt(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.cyan,"[chain/end]")} [${t}] [${xn(e)}] Exiting Chain run with output: ${Lt(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.red,"[chain/error]")} [${t}] [${xn(e)}] Chain run errored with error: ${Lt(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(i=>i.trim())}:e.inputs;console.log(`${it(pt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Lt(n,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.cyan,"[llm/end]")} [${t}] [${xn(e)}] Exiting LLM run with output: ${Lt(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.red,"[llm/error]")} [${t}] [${xn(e)}] LLM run errored with error: ${Lt(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${kw(e.inputs.input)}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.cyan,"[tool/end]")} [${t}] [${xn(e)}] Exiting Tool run with output: "${kw(e.outputs?.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.red,"[tool/error]")} [${t}] [${xn(e)}] Tool run errored with error: ${Lt(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Lt(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.cyan,"[retriever/end]")} [${t}] [${xn(e)}] Exiting Retriever run with output: ${Lt(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${it(pt.red,"[retriever/error]")} [${t}] [${xn(e)}] Retriever run errored with error: ${Lt(e.error,"[error]")}`)}onAgentAction(e){let t=e,n=this.getBreadcrumbs(e);console.log(`${it(pt.blue,"[agent/action]")} [${n}] Agent selected action: ${Lt(t.actions[t.actions.length-1],"[action]")}`)}}});function _a(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="tool_call")}var wa,_l=g(()=>{wa=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}});function Bd(r,e=yi){r=r.trim();let t=/```(json)?(.*)```/s.exec(r);return e(t?t[2]:r)}function yi(r){if(typeof r>"u")return null;try{return JSON.parse(r)}catch{}let e="",t=[],n=!1,i=!1;for(let a of r){if(n)a==='"'&&!i?n=!1:a===`
`&&!i?a="\\n":a==="\\"?i=!i:i=!1;else if(a==='"')n=!0,i=!1;else if(a==="{")t.push("}");else if(a==="[")t.push("]");else if(a==="}"||a==="]")if(t&&t[t.length-1]===a)t.pop();else return null;e+=a}n&&(e+='"');for(let a=t.length-1;a>=0;a-=1)e+=t[a];try{return JSON.parse(e)}catch{return null}}var Kd=g(()=>{});function Dt(r,e){return typeof r=="string"?typeof e=="string"?r+e:[{type:"text",text:r},...e]:Array.isArray(e)?so(r,e)??[...r,...e]:[...r,{type:"text",text:e}]}function Nw(r,e){return r==="error"||e==="error"?"error":"success"}function zC(r,e){function t(n,i){if(typeof n!="object"||n===null||n===void 0)return n;if(i>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(s=>t(s,i+1));let a={};for(let s of Object.keys(n))a[s]=t(n[s],i+1);return a}return JSON.stringify(t(r,0),null,2)}function ye(r,e){let t={...r};for(let[n,i]of Object.entries(e))if(t[n]==null)t[n]=i;else{if(i==null)continue;if(typeof t[n]!=typeof i||Array.isArray(t[n])!==Array.isArray(i))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof t[n]=="string"){if(n==="type")continue;t[n]+=i}else if(typeof t[n]=="object"&&!Array.isArray(t[n]))t[n]=ye(t[n],i);else if(Array.isArray(t[n]))t[n]=so(t[n],i);else{if(t[n]===i)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return t}function so(r,e){if(!(r===void 0&&e===void 0)){if(r===void 0||e===void 0)return r||e;{let t=[...r];for(let n of e)if(typeof n=="object"&&"index"in n&&typeof n.index=="number"){let i=t.findIndex(a=>a.index===n.index);i!==-1?t[i]=ye(t[i],n):t.push(n)}else{if(typeof n=="object"&&"text"in n&&n.text==="")continue;t.push(n)}return t}}}function Mw(r,e){if(!r&&!e)throw new Error("Cannot merge two undefined objects.");if(!r||!e)return r||e;if(typeof r!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof r}
Right ${typeof e}`);if(typeof r=="string"&&typeof e=="string")return r+e;if(Array.isArray(r)&&Array.isArray(e))return so(r,e);if(typeof r=="object"&&typeof e=="object")return ye(r,e);if(r===e)return r;throw new Error(`Can not merge objects of different types.
Left ${r}
Right ${e}`)}function jw(r){return typeof r.role=="string"}function An(r){return typeof r?._getType=="function"}function $w(r){return An(r)&&typeof r.concat=="function"}var Ee,dt,Ht=g(()=>{Vr();Ee=class extends Fe{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=zC(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};dt=class extends Ee{}});function Lw(r){let e=[],t=[];for(let n of r)if(n.function){let i=n.function.name;try{let a=JSON.parse(n.function.arguments),s={name:i||"",args:a||{},id:n.id};e.push(s)}catch{t.push({name:i,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,t]}var Hr,va,xa=g(()=>{Ht();Hr=class extends Ee{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,n){typeof e=="string"&&(e={content:e,name:n,tool_call_id:t}),super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},va=class r extends dt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new r({content:Dt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),artifact:Mw(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Nw(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}});function oo(r){return r._getType()==="ai"}var ke,Ot,bi=g(()=>{Kd();Ht();xa();ke=class extends Ee{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if(typeof e=="string")n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;let i=n.additional_kwargs?.tool_calls,a=n.tool_calls;i!=null&&i.length>0&&(a===void 0||a.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(i!=null&&a===void 0){let[s,o]=Lw(i);n.tool_calls=s??[],n.invalid_tool_calls=o??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch{n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof n!="string"&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};Ot=class r extends dt{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{let n=[],i=[];for(let a of e.tool_call_chunks){let s={};try{if(s=yi(a.args||"{}"),s===null||typeof s!="object"||Array.isArray(s))throw new Error("Malformed tool call chunk args.");n.push({name:a.name??"",args:s,id:a.id,type:"tool_call"})}catch{i.push({name:a.name,args:a.args,id:a.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:n,invalid_tool_calls:i}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:Dt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let n=so(this.tool_call_chunks,e.tool_call_chunks);n!==void 0&&n.length>0&&(t.tool_call_chunks=n)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let n=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a={input_tokens:n.input_tokens+i.input_tokens,output_tokens:n.output_tokens+i.output_tokens,total_tokens:n.total_tokens+i.total_tokens};t.usage_metadata=a}return new r(t)}}});var Gt,wi,vl=g(()=>{Ht();Gt=class r extends Ee{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return r}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},wi=class r extends dt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new r({content:Dt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}});var _i,xl=g(()=>{Ht();_i=class r extends dt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new r({content:Dt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}});var Re,vi,uo=g(()=>{Ht();Re=class extends Ee{static lc_name(){return"HumanMessage"}_getType(){return"human"}},vi=class r extends dt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new r({content:Dt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),id:this.id??e.id})}}});var Pn,xi,Al=g(()=>{Ht();Pn=class extends Ee{static lc_name(){return"SystemMessage"}_getType(){return"system"}},xi=class r extends dt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new r({content:Dt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),id:this.id??e.id})}}});function KC(r){return _a(r)?r:typeof r.id=="string"&&r.type==="function"&&typeof r.function=="object"&&r.function!==null&&"arguments"in r.function&&typeof r.function.arguments=="string"&&"name"in r.function&&typeof r.function.name=="string"?{id:r.id,args:JSON.parse(r.function.arguments),name:r.function.name,type:"tool_call"}:r}function Vd(r){let{type:e,...t}=r;if(e==="human"||e==="user")return new Re(t);if(e==="ai"||e==="assistant"){let{tool_calls:n,...i}=t;if(!Array.isArray(n))return new ke(t);let a=n.map(KC);return new ke({...i,tool_calls:a})}else{if(e==="system")return new Pn(t);if(e==="tool"&&"tool_call_id"in t)return new Hr({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}}function Wt(r){if(typeof r=="string")return new Re(r);if(An(r))return r;if(Array.isArray(r)){let[e,t]=r;return Vd({type:e,content:t})}else if(jw(r)){let{role:e,...t}=r;return Vd({...t,type:e})}else return Vd(r)}function ft(r,e="Human",t="AI"){let n=[];for(let i of r){let a;if(i._getType()==="human")a=e;else if(i._getType()==="ai")a=t;else if(i._getType()==="system")a="System";else if(i._getType()==="function")a="Function";else if(i._getType()==="tool")a="Tool";else if(i._getType()==="generic")a=i.role;else throw new Error(`Got unsupported message type: ${i._getType()}`);let s=i.name?`${i.name}, `:"",o=typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2);n.push(`${a}: ${s}${o}`)}return n.join(`
`)}function lo(r){let e=r._getType();if(e==="human")return new vi({...r});if(e==="ai"){let t={...r};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(n=>({...n,type:"tool_call_chunk",index:void 0,args:JSON.stringify(n.args)}))}),new Ot({...t})}else{if(e==="system")return new xi({...r});if(e==="function")return new _i({...r});if(Gt.isInstance(r))return new wi({...r});throw new Error("Unknown message type.")}}var On=g(()=>{_l();bi();Ht();vl();xl();uo();Al();xa()});var Dw=g(()=>{ll()});var Aa,Fw=g(()=>{Ud();Dw();Rd();ya();gi();Aa=class r extends $t{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:n,client:i}=e;this.projectName=n??ie("LANGCHAIN_PROJECT")??ie("LANGCHAIN_SESSION"),this.exampleId=t,this.client=i??new di({});let a=r.getTraceableRunTree();a&&this.updateFromRunTree(a)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Ew()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e,n=new Set;for(;t.parent_run&&!(n.has(t.id)||(n.add(t.id),!t.parent_run));)t=t.parent_run;n.clear();let i=[t];for(;i.length>0;){let a=i.shift();!a||n.has(a.id)||(n.add(a.id),this.runMap.set(a.id,a),a.child_runs&&i.push(...a.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){let t={},n=[];for(let[i,a]of this.runMap){let s=new wn({...a,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[i]=s,n.push([i,a.dotted_order])}n.sort((i,a)=>!i[1]||!a[1]?0:i[1].localeCompare(a[1]));for(let[i]of n){let a=this.runMap.get(i),s=t[i];if(!(!a||!s)&&a.parent_run_id){let o=t[a.parent_run_id];o&&(o.child_runs.push(s),s.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return aw()}catch{return}}}});function VC(){let r="default"in Pl.default?Pl.default.default:Pl.default;return new r({autoStart:!0,concurrency:1})}async function _e(r,e){e===!0?await r():(typeof Hd>"u"&&(Hd=VC()),Hd.add(r))}var Pl,Hd,qw=g(()=>{Pl=pe(Ku(),1)});var Gd,Uw=g(()=>{ya();Gd=r=>r!==void 0?r:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>ie(t)==="true")});function Oa(r){return r?Array.isArray(r)||"name"in r?{callbacks:r}:r:{}}function co(r){return"name"in r?r:hi.fromMethods(r)}var Wd,Pa,Zd,Ol,Jd,Yd,be,En=g(()=>{Vs();Fd();Rw();On();ya();Fw();qw();Uw();gi();Gd()&&ie("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);Wd=class{setHandler(e){return this.setHandlers([e])}},Pa=class{constructor(e,t,n,i,a,s,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>_e(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleCustomEvent(e,t,n,i,a){await Promise.all(this.handlers.map(s=>_e(async()=>{try{await s.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}},Zd=class extends Pa{getChild(e){let t=new be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw n}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}},t.awaitHandlers)))}},Ol=class extends Pa{async handleLLMNewToken(e,t,n,i,a,s){await Promise.all(this.handlers.map(o=>_e(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s)}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}},Jd=class extends Pa{getChild(e){let t=new be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,i,a){await Promise.all(this.handlers.map(s=>_e(async()=>{if(!s.ignoreChain)try{await s.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainError: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleChainEnd(e,t,n,i,a){await Promise.all(this.handlers.map(s=>_e(async()=>{if(!s.ignoreChain)try{await s.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainEnd: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}},Yd=class extends Pa{getChild(e){let t=new be(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>_e(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}},be=class r extends Wd{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let p=c===0&&n?n:lt();return await Promise.all(this.handlers.map(d=>{if(!d.ignoreLLM)return ba(d)&&d._createRunForLLMStart(e,[l],p,this._parentRunId,a,this.tags,this.metadata,u),_e(async()=>{try{await d.handleLLMStart?.(e,[l],p,this._parentRunId,a,this.tags,this.metadata,u)}catch(f){if((d.raiseError?console.error:console.warn)(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`),d.raiseError)throw f}},d.awaitHandlers)})),new Ol(p,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,n=void 0,i=void 0,a=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{let p=c===0&&n?n:lt();return await Promise.all(this.handlers.map(d=>{if(!d.ignoreLLM)return ba(d)&&d._createRunForChatModelStart(e,[l],p,this._parentRunId,a,this.tags,this.metadata,u),_e(async()=>{try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],p,this._parentRunId,a,this.tags,this.metadata,u);else if(d.handleLLMStart){let f=ft(l);await d.handleLLMStart?.(e,[f],p,this._parentRunId,a,this.tags,this.metadata,u)}}catch(f){if((d.raiseError?console.error:console.warn)(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`),d.raiseError)throw f}},d.awaitHandlers)})),new Ol(p,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,n=lt(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return ba(u)&&u._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,i,o),_e(async()=>{try{await u.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,i,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Jd(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=lt(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return ba(u)&&u._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,o),_e(async()=>{try{await u.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Yd(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=lt(),i=void 0,a=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return ba(u)&&u._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,o),_e(async()=>{try{await u.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Zd(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,i,a){await Promise.all(this.handlers.map(s=>_e(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(e,t,n,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let n=new r(this._parentRunId);for(let i of this.handlers){let a=this.inheritableHandlers.includes(i);n.addHandler(i,a)}for(let i of this.tags){let a=this.inheritableTags.includes(i);n.addTags([i],a)}for(let i of Object.keys(this.metadata)){let a=Object.keys(this.inheritableMetadata).includes(i);n.addMetadata({[i]:this.metadata[i]},a)}for(let i of e)n.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||n.addHandler(i,t);return n}static fromHandlers(e){class t extends hi{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:lt()}),Object.assign(this,e)}}let n=new this;return n.addHandler(new t),n}static async configure(e,t,n,i,a,s,o){return this._configureSync(e,t,n,i,a,s,o)}static _configureSync(e,t,n,i,a,s,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new r,u.setHandlers(e?.map(co)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(co):t?.handlers,!1));let l=ie("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=Aa.getTraceableRunTree()?.tracingEnabled||Gd(),p=c||(ie("LANGCHAIN_TRACING")??!1);if(l||p){if(u||(u=new r),l&&!u.handlers.some(d=>d.name===ao.prototype.name)){let d=new ao;u.addHandler(d,!0)}if(p&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){let d=new Aa;u.addHandler(d,!0),u._parentRunId=Aa.getTraceableRunTree()?.id??u._parentRunId}}return(n||i)&&u&&(u.addTags(n??[]),u.addTags(i??[],!1)),(a||s)&&u&&(u.addMetadata(a??{}),u.addMetadata(s??{},!1)),u}}});var Qd,HC,Xd,zw,ef,Ft,Ea=g(()=>{Ud();En();Qd=class{getStore(){}run(e,t){return t()}},HC=new Qd,Xd=Symbol.for("ls:tracing_async_local_storage"),zw=Symbol.for("lc:child_config"),ef=class{getInstance(){return globalThis[Xd]??HC}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[zw]}runWithConfig(e,t,n){let i=be._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),a=this.getInstance(),s=i?.getParentRunId(),o=i?.handlers?.find(l=>l?.name==="langchain_tracer"),u;return o&&s?u=o.convertToRunTree(s):n||(u=new wn({name:"<runnable_lambda>",tracingEnabled:!1})),u&&(u.extra={...u.extra,[zw]:e}),a.run(u,t)}initializeGlobalInstance(e){globalThis[Xd]===void 0&&(globalThis[Xd]=e)}},Ft=new ef});async function hr(r,e){if(e===void 0)return r;let t;return Promise.race([r.catch(n=>{if(!e?.aborted)throw n}),new Promise((n,i)=>{t=()=>{i(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&i(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}var tf=g(()=>{});function rf(r,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(i){for(;;)if(i.length===0){let a=await r.next();for(let s of t)s.push(a)}else{if(i[0].done)return;yield i.shift().value}})}function He(r,e){if(Array.isArray(r)&&Array.isArray(e))return r.concat(e);if(typeof r=="string"&&typeof e=="string")return r+e;if(typeof r=="number"&&typeof e=="number")return r+e;if("concat"in r&&typeof r.concat=="function")return r.concat(e);if(typeof r=="object"&&typeof e=="object"){let t={...r};for(let[n,i]of Object.entries(e))n in t&&!Array.isArray(t[n])?t[n]=He(t[n],i):t[n]=i;return t}else throw new Error(`Cannot concat ${typeof r} and ${typeof e}`)}async function Bw(r,e,t,n,...i){let a=new Gr({generator:e,startSetup:t,signal:n}),s=await a.setup;return{output:r(a,s,...i),setup:s}}var Ve,Gr,Wr=g(()=>{Ea();tf();Ve=class r extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){let t=e.getReader();return new r({start(n){return i();function i(){return t.read().then(({done:a,value:s})=>{if(a){n.close();return}return n.enqueue(s),i()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new r({async pull(t){let{value:n,done:i}=await e.next();i&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}};Gr=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,n)=>{Ft.runWithConfig(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then(i=>t(void 0),n)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?Ft.runWithConfig(this.config,this.signal?async()=>hr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}});async function Kw(r,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=r;if(["retriever","llm","prompt"].includes(r.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function Vw(r,e){let{outputs:t}=r;return e==="original"||["retriever","llm","prompt"].includes(r.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function GC(r){return r!==void 0&&r.message!==void 0}var Zt,po,mo,fo,El=g(()=>{Md();gi();Wr();bi();Zt=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),n=vn({},t);return new po({ops:t,state:n[n.length-1].newDocument})}},po=class r extends Zt{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),n=vn(this.state,e.ops);return new r({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){let t=vn({},e.ops);return new r({ops:e.ops,state:t[t.length-1].newDocument})}},mo=r=>r.name==="log_stream_tracer";fo=class extends $t{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ve.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||t.find(i=>this.includeTags?.includes(i))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&t.every(i=>!this.excludeTags?.includes(i))),n}async*tapOutputIterable(e,t){for await(let n of t){if(e!==this.rootId){let i=this.keyMapByRunId[e];i&&await this.writer.write(new Zt({ops:[{op:"add",path:`/logs/${i}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Zt({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await Kw(e,this._schemaFormat)),await this.writer.write(new Zt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await Kw(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Vw(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let i=new Zt({ops:n});await this.writer.write(i)}finally{if(e.id===this.rootId){let t=new Zt({ops:[{op:"replace",path:"/final_output",value:await Vw(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){let i=this.keyMapByRunId[e.id];if(i===void 0)return;let a=e.inputs.messages!==void 0,s;a?GC(n?.chunk)?s=n?.chunk:s=new Ot({id:`run-${e.id}`,content:t}):s=t;let o=new Zt({ops:[{op:"add",path:`/logs/${i}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${i}/streamed_output/-`,value:s}]});await this.writer.write(o)}}});var Ia,Jt,gr,Ta=g(()=>{Ia="__run",Jt=class r{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new r({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},gr=class r extends Jt{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new r({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}});function Il({name:r,serialized:e}){return r!==void 0?r:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var ho,Tl,Cl=g(()=>{gi();Wr();bi();Ta();ho=r=>r.name==="event_stream_tracer",Tl=class extends $t{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ve.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(n=n||t.find(i=>this.includeTags?.includes(i))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(n=n&&t.every(i=>!this.excludeTags?.includes(i))),n}async*tapOutputIterable(e,t){let n=await t.next();if(n.done)return;let i=this.runInfoMap.get(e);if(i===void 0){yield n.value;return}function a(o,u){return o==="llm"&&typeof u=="string"?new Jt({text:u}):u}let s=this.tappedPromises.get(e);if(s===void 0){let o;s=new Promise(u=>{o=u}),this.tappedPromises.set(e,s);try{let u={event:`on_${i.runType}_stream`,run_id:e,name:i.name,tags:i.tags,metadata:i.metadata,data:{}};await this.send({...u,data:{chunk:a(i.runType,n.value)}},i),yield n.value;for await(let l of t)i.runType!=="tool"&&i.runType!=="retriever"&&await this.send({...u,data:{chunk:a(i.runType,l)}},i),yield l}finally{o()}}else{yield n.value;for await(let o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let n=this.tappedPromises.get(e.run_id);n!==void 0?n.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Il(e),n=e.inputs.messages!==void 0?"chat_model":"llm",i={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,i);let a=`on_${n}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},i)}async onLLMNewToken(e,t,n){let i=this.runInfoMap.get(e.id),a,s;if(i===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(i.runType==="chat_model")s="on_chat_model_stream",n?.chunk===void 0?a=new Ot({content:t,id:`run-${e.id}`}):a=n.chunk.message;else if(i.runType==="llm")s="on_llm_stream",n?.chunk===void 0?a=new Jt({text:t}):a=n.chunk;else throw new Error(`Unexpected run type ${i.runType}`);await this.send({event:s,data:{chunk:a},run_id:e.id,name:i.name,tags:i.tags,metadata:i.metadata},i)}}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let n;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let i=e.outputs?.generations,a;if(t.runType==="chat_model"){for(let s of i??[]){if(a!==void 0)break;a=s[0]?.message}n="on_chat_model_end"}else if(t.runType==="llm")a={generations:i?.map(s=>s.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:n,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Il(e),n=e.run_type??"chain",i={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},a={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(a={},i.inputs={}):e.inputs.input!==void 0?(a.input=e.inputs.input,i.inputs=e.inputs.input):(a.input=e.inputs,i.inputs=e.inputs),this.runInfoMap.set(e.id,i),await this.send({event:`on_${n}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},i)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let n=`on_${e.run_type}_end`,i=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:i};i.input&&Object.keys(i).length===1&&(s.input=i.input,t.inputs=i.input),await this.sendEndEvent({event:n,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Il(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let n=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Il(e),i={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,i),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},i)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){let i=this.runInfoMap.get(n);if(i===void 0)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:i.tags,metadata:i.metadata,data:t},i)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}});async function mt(r){return be._configureSync(r?.callbacks,void 0,r?.tags,void 0,r?.metadata)}function kl(...r){let e={};for(let t of r.filter(n=>!!n))for(let n of Object.keys(t))if(n==="metadata")e[n]={...e[n],...t[n]};else if(n==="tags"){let i=e[n]??[];e[n]=[...new Set(i.concat(t[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...t[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(n==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(n==="callbacks"){let i=e.callbacks,a=t.callbacks;if(Array.isArray(a))if(!i)e.callbacks=a;else if(Array.isArray(i))e.callbacks=i.concat(a);else{let s=i.copy();for(let o of a)s.addHandler(co(o),!0);e.callbacks=s}else if(a)if(!i)e.callbacks=a;else if(Array.isArray(i)){let s=a.copy();for(let o of i)s.addHandler(co(o),!0);e.callbacks=s}else e.callbacks=new be(a._parentRunId,{handlers:i.handlers.concat(a.handlers),inheritableHandlers:i.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(i.tags.concat(a.tags))),inheritableTags:Array.from(new Set(i.inheritableTags.concat(a.inheritableTags))),metadata:{...i.metadata,...a.metadata}})}else{let i=n;e[i]=t[i]??e[i]}return e}function G(r){let e=Ft.getRunnableConfig(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:n,runName:i,...a}=e;t=Object.entries(a).reduce((s,[o,u])=>(u!==void 0&&(s[o]=u),s),t)}if(r&&(t=Object.entries(r).reduce((n,[i,a])=>(a!==void 0&&(n[i]=a),n),t)),t?.configurable)for(let n of Object.keys(t.configurable))WC.has(typeof t.configurable[n])&&!t.metadata?.[n]&&(t.metadata||(t.metadata={}),t.metadata[n]=t.configurable[n]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");let n=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,n])):t.signal=n,delete t.timeout}return t}function ve(r={},{callbacks:e,maxConcurrency:t,recursionLimit:n,runName:i,configurable:a,runId:s}={}){let o=G(r);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),t!==void 0&&(o.maxConcurrency=t),i!==void 0&&(o.runName=i),a!==void 0&&(o.configurable={...o.configurable,...a}),s!==void 0&&delete o.runId,o}var Sl,WC,In=g(()=>{En();Ea();Sl=25;WC=new Set(["string","number","boolean"])});var Hw,Rl,ZC,JC,Yt,Ca=g(()=>{Hw=pe(Mu(),1),Rl=pe(Ku(),1),ZC=[400,401,402,403,404,405,406,407,409],JC=r=>{if(r.message.startsWith("Cancel")||r.message.startsWith("AbortError")||r.name==="AbortError"||r?.code==="ECONNABORTED")throw r;let e=r?.response?.status??r?.status;if(e&&ZC.includes(+e))throw r;if(r?.error?.code==="insufficient_quota"){let t=new Error(r?.message);throw t.name="InsufficientQuotaError",t}},Yt=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??JC;let t="default"in Rl.default?Rl.default.default:Rl.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Hw.default)(()=>e(...t).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((i,a)=>{e.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var go,Gw=g(()=>{gi();go=class extends $t{constructor({config:e,onStart:t,onEnd:n,onError:i}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=i}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}});function yo(r){return r?r.lc_runnable:!1}var Nl,nf=g(()=>{Nl=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,i=e.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(t)),this.includeTags!==void 0&&(n=n||i.some(a=>this.includeTags?.includes(a))),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(n=n&&i.every(a=>!this.excludeTags?.includes(a))),n}}});var Zw,Ww,Jw,Ml=g(()=>{Zw=Symbol("Let zodToJsonSchema decide on which parser to use"),Ww={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Jw=r=>typeof r=="string"?{...Ww,name:r}:{...Ww,...r}});var Yw,af=g(()=>{Ml();Yw=r=>{let e=Jw(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,i])=>[i._def,{def:i._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}}});function sf(r,e,t,n){n?.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function ee(r,e,t,n,i){r[e]=t,sf(r,e,n,i)}var Tn=g(()=>{});function Xw(){return{}}var of=g(()=>{});function Qw(r,e){let t={type:"array"};return r.type?._def&&r.type?._def?.typeName!==w.ZodAny&&(t.items=D(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&ee(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&ee(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(ee(t,"minItems",r.exactLength.value,r.exactLength.message,e),ee(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}var uf=g(()=>{fr();Tn();xe()});function e_(r,e){let t={type:"integer",format:"int64"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?ee(t,"minimum",n.value,n.message,e):ee(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),ee(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?ee(t,"maximum",n.value,n.message,e):ee(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),ee(t,"maximum",n.value,n.message,e));break;case"multipleOf":ee(t,"multipleOf",n.value,n.message,e);break}return t}var lf=g(()=>{Tn()});function t_(){return{type:"boolean"}}var cf=g(()=>{});function jl(r,e){return D(r.type._def,e)}var $l=g(()=>{xe()});var r_,pf=g(()=>{xe();r_=(r,e)=>D(r.innerType._def,e)});function df(r,e,t){let n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((i,a)=>df(r,e,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return YC(r,e)}}var YC,ff=g(()=>{Tn();YC=(r,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let n of r.checks)switch(n.kind){case"min":ee(t,"minimum",n.value,n.message,e);break;case"max":ee(t,"maximum",n.value,n.message,e);break}return t}});function n_(r,e){return{...D(r.innerType._def,e),default:r.defaultValue()}}var mf=g(()=>{xe()});function i_(r,e){return e.effectStrategy==="input"?D(r.schema._def,e):{}}var hf=g(()=>{xe()});function a_(r){return{type:"string",enum:r.values}}var gf=g(()=>{});function s_(r,e){let t=[D(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),D(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a),n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,i=[];return t.forEach(a=>{if(XC(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let s=a;if("additionalProperties"in a&&a.additionalProperties===!1){let{additionalProperties:o,...u}=a;s=u}else n=void 0;i.push(s)}}),i.length?{allOf:i,...n}:void 0}var XC,yf=g(()=>{xe();XC=r=>"type"in r&&r.type==="string"?!1:"allOf"in r});function o_(r,e){let t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}var bf=g(()=>{});function Ll(r,e){let t={type:"string"};function n(i){return e.patternStrategy==="escape"?QC(i):i}if(r.checks)for(let i of r.checks)switch(i.kind){case"min":ee(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e);break;case"max":ee(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Xt(t,"email",i.message,e);break;case"format:idn-email":Xt(t,"idn-email",i.message,e);break;case"pattern:zod":Qt(t,Ai.email,i.message,e);break}break;case"url":Xt(t,"uri",i.message,e);break;case"uuid":Xt(t,"uuid",i.message,e);break;case"regex":Qt(t,i.regex,i.message,e);break;case"cuid":Qt(t,Ai.cuid,i.message,e);break;case"cuid2":Qt(t,Ai.cuid2,i.message,e);break;case"startsWith":Qt(t,RegExp(`^${n(i.value)}`),i.message,e);break;case"endsWith":Qt(t,RegExp(`${n(i.value)}$`),i.message,e);break;case"datetime":Xt(t,"date-time",i.message,e);break;case"date":Xt(t,"date",i.message,e);break;case"time":Xt(t,"time",i.message,e);break;case"duration":Xt(t,"duration",i.message,e);break;case"length":ee(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e),ee(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"includes":{Qt(t,RegExp(n(i.value)),i.message,e);break}case"ip":{i.version!=="v6"&&Xt(t,"ipv4",i.message,e),i.version!=="v4"&&Xt(t,"ipv6",i.message,e);break}case"emoji":Qt(t,Ai.emoji,i.message,e);break;case"ulid":{Qt(t,Ai.ulid,i.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Xt(t,"binary",i.message,e);break}case"contentEncoding:base64":{ee(t,"contentEncoding","base64",i.message,e);break}case"pattern:zod":{Qt(t,Ai.base64,i.message,e);break}}break}case"nanoid":Qt(t,Ai.nanoid,i.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var wf,Ai,QC,Xt,Qt,u_,Dl=g(()=>{Tn();Ai={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(wf===void 0&&(wf=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),wf),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};QC=r=>Array.from(r).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Xt=(r,e,t,n)=>{r.format||r.anyOf?.some(i=>i.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):ee(r,"format",e,t,n)},Qt=(r,e,t,n)=>{r.pattern||r.allOf?.some(i=>i.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:u_(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):ee(r,"pattern",u_(e,n),t,n)},u_=(r,e)=>{let t=typeof r=="function"?r():r;if(!e.applyRegexFlags||!t.flags)return t.source;let n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},i=n.i?t.source.toLowerCase():t.source,a="",s=!1,o=!1,u=!1;for(let l=0;l<i.length;l++){if(s){a+=i[l],s=!1;continue}if(n.i){if(o){if(i[l].match(/[a-z]/)){u?(a+=i[l],a+=`${i[l-2]}-${i[l]}`.toUpperCase(),u=!1):i[l+1]==="-"&&i[l+2]?.match(/[a-z]/)?(a+=i[l],u=!0):a+=`${i[l]}${i[l].toUpperCase()}`;continue}}else if(i[l].match(/[a-z]/)){a+=`[${i[l]}${i[l].toUpperCase()}]`;continue}}if(n.m){if(i[l]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(i[l]==="$"){a+=`($|(?=[\r
]))`;continue}}if(n.s&&i[l]==="."){a+=o?`${i[l]}\r
`:`[${i[l]}\r
]`;continue}a+=i[l],i[l]==="\\"?s=!0:o&&i[l]==="]"?o=!1:!o&&i[l]==="["&&(o=!0)}try{let l=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return a}});function Fl(r,e){if(e.target==="openApi3"&&r.keyType?._def.typeName===w.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((n,i)=>({...n,[i]:D(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",i]})??{}}),{}),additionalProperties:!1};let t={type:"object",additionalProperties:D(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(r.keyType?._def.typeName===w.ZodString&&r.keyType._def.checks?.length){let{type:n,...i}=Ll(r.keyType._def,e);return{...t,propertyNames:i}}else{if(r.keyType?._def.typeName===w.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};if(r.keyType?._def.typeName===w.ZodBranded&&r.keyType._def.type._def.typeName===w.ZodString&&r.keyType._def.type._def.checks?.length){let{type:n,...i}=jl(r.keyType._def,e);return{...t,propertyNames:i}}}return t}var ql=g(()=>{fr();xe();Dl();$l()});function l_(r,e){if(e.mapStrategy==="record")return Fl(r,e);let t=D(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=D(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}var _f=g(()=>{xe();ql()});function c_(r){let e=r.values,n=Object.keys(r.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),i=Array.from(new Set(n.map(a=>typeof a)));return{type:i.length===1?i[0]==="string"?"string":"number":["string","number"],enum:n}}var vf=g(()=>{});function p_(){return{not:{}}}var xf=g(()=>{});function d_(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Af=g(()=>{});function m_(r,e){if(e.target==="openApi3")return f_(r,e);let t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in bo&&(!n._def.checks||!n._def.checks.length))){let n=t.reduce((i,a)=>{let s=bo[a._def.typeName];return s&&!i.includes(s)?[...i,s]:i},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){let n=t.reduce((i,a)=>{let s=typeof a._def.value;switch(s){case"string":case"number":case"boolean":return[...i,s];case"bigint":return[...i,"integer"];case"object":if(a._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(n.length===t.length){let i=n.filter((a,s,o)=>o.indexOf(a)===s);return{type:i.length>1?i:i[0],enum:t.reduce((a,s)=>a.includes(s._def.value)?a:[...a,s._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return f_(r,e)}var bo,f_,Ul=g(()=>{xe();bo={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};f_=(r,e)=>{let t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,i)=>D(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0}});function h_(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"?{type:bo[r.innerType._def.typeName],nullable:!0}:{type:[bo[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let n=D(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}let t=D(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}var Pf=g(()=>{xe();Ul()});function g_(r,e){let t={type:"number"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"int":t.type="integer",sf(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?ee(t,"minimum",n.value,n.message,e):ee(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),ee(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?ee(t,"maximum",n.value,n.message,e):ee(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),ee(t,"maximum",n.value,n.message,e));break;case"multipleOf":ee(t,"multipleOf",n.value,n.message,e);break}return t}var Of=g(()=>{Tn()});function eS(r,e){return e.removeAdditionalStrategy==="strict"?r.catchall._def.typeName==="ZodNever"?r.unknownKeys!=="strict":D(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:r.catchall._def.typeName==="ZodNever"?r.unknownKeys==="passthrough":D(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function y_(r,e){let t={type:"object",...Object.entries(r.shape()).reduce((n,[i,a])=>{if(a===void 0||a._def===void 0)return n;let s=D(a._def,{...e,currentPath:[...e.currentPath,"properties",i],propertyPath:[...e.currentPath,"properties",i]});return s===void 0?n:{properties:{...n.properties,[i]:s},required:a.isOptional()?n.required:[...n.required,i]}},{properties:{},required:[]}),additionalProperties:eS(r,e)};return t.required.length||delete t.required,t}var Ef=g(()=>{xe()});var b_,If=g(()=>{xe();b_=(r,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return D(r.innerType._def,e);let t=D(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}}});var w_,Tf=g(()=>{xe();w_=(r,e)=>{if(e.pipeStrategy==="input")return D(r.in._def,e);if(e.pipeStrategy==="output")return D(r.out._def,e);let t=D(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=D(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(i=>i!==void 0)}}});function __(r,e){return D(r.type._def,e)}var Cf=g(()=>{xe()});function v_(r,e){let n={type:"array",uniqueItems:!0,items:D(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&ee(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&ee(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}var Sf=g(()=>{Tn();xe()});function x_(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>D(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:D(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>D(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}var kf=g(()=>{xe()});function A_(){return{not:{}}}var Rf=g(()=>{});function P_(){return{}}var Nf=g(()=>{});var O_,Mf=g(()=>{xe();O_=(r,e)=>D(r.innerType._def,e)});function D(r,e,t=!1){let n=e.seen.get(r);if(e.override){let s=e.override?.(r,e,n,t);if(s!==Zw)return s}if(n&&!t){let s=tS(n,e);if(s!==void 0)return s}let i={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,i);let a=nS(r,r.typeName,e);return a&&iS(r,e,a),i.jsonSchema=a,a}var tS,rS,nS,iS,xe=g(()=>{fr();of();uf();lf();cf();$l();pf();ff();mf();hf();gf();yf();bf();_f();vf();xf();Af();Pf();Of();Ef();If();Tf();Cf();ql();Sf();Dl();kf();Rf();Ul();Nf();Mf();Ml();tS=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"relative":return{$ref:rS(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((t,n)=>e.currentPath[n]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},rS=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")},nS=(r,e,t)=>{switch(e){case w.ZodString:return Ll(r,t);case w.ZodNumber:return g_(r,t);case w.ZodObject:return y_(r,t);case w.ZodBigInt:return e_(r,t);case w.ZodBoolean:return t_();case w.ZodDate:return df(r,t);case w.ZodUndefined:return A_();case w.ZodNull:return d_(t);case w.ZodArray:return Qw(r,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return m_(r,t);case w.ZodIntersection:return s_(r,t);case w.ZodTuple:return x_(r,t);case w.ZodRecord:return Fl(r,t);case w.ZodLiteral:return o_(r,t);case w.ZodEnum:return a_(r);case w.ZodNativeEnum:return c_(r);case w.ZodNullable:return h_(r,t);case w.ZodOptional:return b_(r,t);case w.ZodMap:return l_(r,t);case w.ZodSet:return v_(r,t);case w.ZodLazy:return D(r.getter()._def,t);case w.ZodPromise:return __(r,t);case w.ZodNaN:case w.ZodNever:return p_();case w.ZodEffects:return i_(r,t);case w.ZodAny:return Xw();case w.ZodUnknown:return P_();case w.ZodDefault:return n_(r,t);case w.ZodBranded:return jl(r,t);case w.ZodReadonly:return O_(r,t);case w.ZodCatch:return r_(r,t);case w.ZodPipeline:return w_(r,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(n=>{})(e)}},iS=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t)});var at,jf=g(()=>{xe();af();at=(r,e)=>{let t=Yw(e),n=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[l,c])=>({...u,[l]:D(c._def,{...t,currentPath:[...t.basePath,t.definitionPath,l]},!0)??{}}),{}):void 0,i=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,a=D(r._def,i===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,i]},!1)??{},s=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;s!==void 0&&(a.title=s);let o=i===void 0?n?{...a,[t.definitionPath]:n}:a:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,i].join("/"),[t.definitionPath]:{...n,[i]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o}});var yr=g(()=>{Ml();af();Tn();xe();of();uf();lf();cf();$l();pf();ff();mf();hf();gf();yf();bf();_f();vf();xf();Af();Pf();Of();Ef();If();Tf();Cf();Mf();ql();Sf();Dl();kf();Rf();Ul();Nf();jf();jf()});function $f(r){return r.replace(/[^a-zA-Z-_0-9]/g,"_")}function aS(r,e){let t=e[r.source]??r.source,n=e[r.target]??r.target;return[t,n]}function sS(r){let e="";for(let[t,n]of Object.entries(r))e+=`	classDef ${t}class fill:${n};
`;return e}function E_(r,e,t){let{firstNodeLabel:n,lastNodeLabel:i,nodeColors:a,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{},l=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){let p="default",d={[p]:"{0}([{1}]):::otherclass"};n!==void 0&&(d[n]="{0}[{0}]:::startclass"),i!==void 0&&(d[i]="{0}[{0}]:::endclass");for(let f of Object.values(r)){let m=d[f]??d[p],h=$f(f),y=f.split(":"),_=y[y.length-1];l+=`	${m.replace(/\{0\}/g,h).replace(/\{1\}/g,_)};
`}}let c="";for(let p of e){let d=p.source.includes(":")?p.source.split(":")[0]:void 0,f=p.target.includes(":")?p.target.split(":")[0]:void 0;c!==""&&(c!==d||c!==f)&&(l+=`	end
`,c=""),c===""&&d!==void 0&&d===f&&(l=`	subgraph ${d}
`,c=d);let[m,h]=aS(p,r),y="";if(p.data!==void 0){let _=p.data,b=_.split(" ");b.length>u&&(_=b.reduce((O,v,x)=>(x%u===0&&O.push(""),O[O.length-1]+=` ${v}`,O),[]).join("<br>")),p.conditional?y=` -. ${_} .-> `:y=` -- ${_} --> `}else p.conditional?y=" -.-> ":y=" --> ";l+=`	${$f(m)}${y}${$f(h)};
`}return c!==""&&(l+=`end
`),s&&a!==void 0&&(l+=sS(a)),l}async function I_(r,e){let{backgroundColor:t="white"}=e??{},n=btoa(r);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let i=`https://mermaid.ink/img/${n}?bgColor=${t}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}var T_=g(()=>{});function Lf(r){if(Ks(r.id))if(yo(r.data))try{let e=r.data.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e.length>C_&&(e=`${e.substring(0,C_)}...`),e}catch{return r.data.getName()}else return r.data.name??"UnknownSchema";else return r.id}function oS(r){return yo(r.data)?{type:"runnable",data:{id:r.data.lc_id,name:r.data.getName()}}:{type:"schema",data:{...at(r.data.schema),title:r.data.name}}}var C_,wo,S_=g(()=>{yr();Vs();nf();T_();C_=42;wo=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,n)=>{e[t.id]=Ks(t.id)?n:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...oS(t)})),edges:this.edges.map(t=>{let n={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(n.data=t.data),typeof t.conditional<"u"&&(n.conditional=t.conditional),n})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let n=t||lt(),i={id:n,data:e};return this.nodes[n]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,n,i){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let a={source:e.id,target:t.id,data:n,conditional:i};return this.edges.push(a),a}firstNode(){let e=new Set(this.edges.map(n=>n.target)),t=[];return Object.values(this.nodes).forEach(n=>{e.has(n.id)||t.push(n)}),t[0]}lastNode(){let e=new Set(this.edges.map(n=>n.source)),t=[];return Object.values(this.nodes).forEach(n=>{e.has(n.id)||t.push(n)}),t[0]}extend(e,t=""){let n=t;Object.values(e.nodes).map(l=>l.id).every(Ks)&&(n="");let a=l=>n?`${n}:${l}`:l;Object.entries(e.nodes).forEach(([l,c])=>{this.nodes[a(l)]={...c,id:a(l)}});let s=e.edges.map(l=>({...l,source:a(l.source),target:a(l.target)}));this.edges=[...this.edges,...s];let o=e.firstNode(),u=e.lastNode();return[o?{id:a(o.id),data:o.data}:void 0,u?{id:a(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(n=>n.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(n=>n.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}drawMermaid(e){let{withStyles:t,curveStyle:n,nodeColors:i={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:a}=e??{},s={};for(let p of Object.values(this.nodes))s[p.id]=Lf(p);let o=this.firstNode(),u=o?Lf(o):void 0,l=this.lastNode(),c=l?Lf(l):void 0;return E_(s,this.edges,{firstNodeLabel:u,lastNodeLabel:c,withStyles:t,curveStyle:n,nodeColors:i,wrapLabelNWords:a})}async drawMermaidPng(e){let t=this.drawMermaid(e);return I_(t,{backgroundColor:e?.backgroundColor})}}});function k_(r){let e=new TextEncoder,t=new ReadableStream({async start(n){for await(let i of r)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(i)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return Ve.fromReadableStream(t)}var R_=g(()=>{Wr()});function Df(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.iterator]=="function"&&typeof r.next=="function"}function zl(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.asyncIterator]=="function"}function*Ff(r,e){for(;;){let{value:t,done:n}=Ft.runWithConfig(r,e.next.bind(e),!0);if(n)break;yield t}}async function*qf(r,e){let t=e[Symbol.asyncIterator]();for(;;){let{value:n,done:i}=await Ft.runWithConfig(r,t.next.bind(e),!0);if(i)break;yield n}}var N_,M_=g(()=>{Ea();N_=r=>r!=null&&typeof r=="object"&&"next"in r&&typeof r.next=="function"});function Ie(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}function uS(r){if(dl(r))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}function Zr(r){if(typeof r=="function")return new Xr({func:r});if(Z.isRunnable(r))return r;if(!Array.isArray(r)&&typeof r=="object"){let e={};for(let[t,n]of Object.entries(r))e[t]=Zr(n);return new Cn({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}function lS(r,e){let t=e.name??r.getName(),n=e.description??e.schema?.description;return e.schema.constructor===Rt.ZodString?new _o({name:t,description:n,schema:Rt.object({input:Rt.string()}).transform(i=>i.input),bound:r}):new _o({name:t,description:n,schema:e.schema,bound:r})}var Uf,Z,Jr,Bl,Kl,Yr,Cn,zf,Xr,Vl,Sa,Hl,_o,ht=g(()=>{fr();Uf=pe(Mu(),1);Vs();Rd();El();Cl();Vr();Wr();tf();In();Ca();Gw();nf();Ea();S_();R_();M_();_l();Z=class extends Fe{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Jr({bound:this,kwargs:e,config:{}})}map(){return new Bl({bound:this})}withRetry(e){return new Kl({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Jr({bound:this,config:e,kwargs:{}})}withFallbacks(e){let t=Array.isArray(e)?e:e.fallbacks;return new Vl({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(G);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let n=Object.fromEntries(Object.entries(e).filter(([i])=>i!=="runId"));return Array.from({length:t},(i,a)=>G(a===0?e:n))}return Array.from({length:t},()=>G(e))}async batch(e,t,n){let i=this._getOptionsList(t??{},e.length),a=i[0]?.maxConcurrency??n?.maxConcurrency,s=new Yt({maxConcurrency:a,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>s.call(async()=>{try{return await this.invoke(u,i[l])}catch(c){if(n?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let n=G(t),i=new Gr({generator:this._streamIterator(e,n),config:n});return await i.setup,Ve.fromAsyncGenerator(i)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=G(e):t=G({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){let i=G(n),s=await(await mt(i))?.handleChainStart(this.toJSON(),Ie(t,"input"),i.runId,i?.runType,void 0,void 0,i?.runName??this.getName());delete i.runId;let o;try{let u=e.call(this,t,i,s);o=await hr(u,n?.signal)}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(Ie(o,"output")),o}async _batchWithConfig(e,t,n,i){let a=this._getOptionsList(n??{},t.length),s=await Promise.all(a.map(mt)),o=await Promise.all(s.map(async(l,c)=>{let p=await l?.handleChainStart(this.toJSON(),Ie(t[c],"input"),a[c].runId,a[c].runType,void 0,void 0,a[c].runName??this.getName());return delete a[c].runId,p})),u;try{let l=e.call(this,t,a,o,i);u=await hr(l,a?.[0]?.signal)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(Ie(u,"output")))),u}async*_transformStreamWithConfig(e,t,n){let i,a=!0,s,o=!0,u=G(n),l=await mt(u);async function*c(){for await(let d of e){if(a)if(i===void 0)i=d;else try{i=He(i,d)}catch{i=void 0,a=!1}yield d}}let p;try{let d=await Bw(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),n?.signal,u);delete u.runId,p=d.setup;let f=p?.handlers.find(ho),m=d.output;f!==void 0&&p!==void 0&&(m=f.tapOutputIterable(p.runId,m));let h=p?.handlers.find(mo);h!==void 0&&p!==void 0&&(m=h.tapOutputIterable(p.runId,m));for await(let y of m)if(yield y,o)if(s===void 0)s=y;else try{s=He(s,y)}catch{s=void 0,o=!1}}catch(d){throw await p?.handleChainError(d,void 0,void 0,void 0,{inputs:Ie(i,"input")}),d}await p?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:Ie(i,"input")})}getGraph(e){let t=new wo,n=t.addNode({name:`${this.getName()}Input`,schema:Rt.any()}),i=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:Rt.any()});return t.addEdge(n,i),t.addEdge(i,a),t}pipe(e){return new Yr({first:this,last:Zr(e)})}pick(e){return this.pipe(new Hl(e))}assign(e){return this.pipe(new Sa(new Cn({steps:e})))}async*transform(e,t){let n;for await(let i of e)n===void 0?n=i:n=He(n,i);yield*this._streamIterator(n,G(t))}async*streamLog(e,t,n){let i=new fo({...n,autoClose:!1,_schemaFormat:"original"}),a=G(t);yield*this._streamLog(e,i,a)}async*_streamLog(e,t,n){let{callbacks:i}=n;if(i===void 0)n.callbacks=[t];else if(Array.isArray(i))n.callbacks=i.concat([t]);else{let u=i.copy();u.addHandler(t,!0),n.callbacks=u}let a=this.stream(e,n);async function s(){try{let u=await a;for await(let l of u){let c=new Zt({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}let o=s();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,n){let i;if(t.version==="v1")i=this._streamEventsV1(e,t,n);else if(t.version==="v2")i=this._streamEventsV2(e,t,n);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?k_(i):Ve.fromAsyncGenerator(i)}async*_streamEventsV2(e,t,n){let i=new Tl({...n,autoClose:!1}),a=G(t),s=a.runId??lt();a.runId=s;let o=a.callbacks;if(o===void 0)a.callbacks=[i];else if(Array.isArray(o))a.callbacks=o.concat(i);else{let f=o.copy();f.addHandler(i,!0),a.callbacks=f}let u=this;async function l(){try{let f=await u.stream(e,a),m=i.tapOutputIterable(s,f);for await(let h of m);}finally{await i.finish()}}let c=l(),p=!1,d;try{for await(let f of i){if(!p){f.data.input=e,p=!0,d=f.run_id,yield f;continue}f.run_id===d&&f.event.endsWith("_end")&&f.data?.input&&delete f.data.input,yield f}}finally{await c}}async*_streamEventsV1(e,t,n){let i,a=!1,s=G(t),o=s.tags??[],u=s.metadata??{},l=s.runName??this.getName(),c=new fo({...n,autoClose:!1,_schemaFormat:"streaming_events"}),p=new Nl({...n}),d=this._streamLog(e,c,s);for await(let m of d){if(i?i=i.concat(m):i=po.fromRunLogPatch(m),i.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;let b={...i.state},O={run_id:b.id,event:`on_${b.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};p.includeEvent(O,b.type)&&(yield O)}let h=m.ops.filter(b=>b.path.startsWith("/logs/")).map(b=>b.path.split("/")[2]),y=[...new Set(h)];for(let b of y){let O,v={},x=i.state.logs[b];if(x.end_time===void 0?x.streamed_output.length>0?O="stream":O="start":O="end",O==="start")x.inputs!==void 0&&(v.input=x.inputs);else if(O==="end")x.inputs!==void 0&&(v.input=x.inputs),v.output=x.final_output;else if(O==="stream"){let C=x.streamed_output.length;if(C!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${C} instead. Encountered in: "${x.name}"`);v={chunk:x.streamed_output[0]},x.streamed_output=[]}yield{event:`on_${x.type}_${O}`,name:x.name,run_id:x.id,tags:x.tags,metadata:x.metadata,data:v}}let{state:_}=i;if(_.streamed_output.length>0){let b=_.streamed_output.length;if(b!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${b} instead. Encountered in: "${_.name}"`);let O={chunk:_.streamed_output[0]};_.streamed_output=[];let v={event:`on_${_.type}_stream`,run_id:_.id,tags:o,metadata:u,name:l,data:O};p.includeEvent(v,_.type)&&(yield v)}}let f=i?.state;if(f!==void 0){let m={event:`on_${f.type}_end`,name:l,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};p.includeEvent(m,f.type)&&(yield m)}}static isRunnable(e){return yo(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Jr({bound:this,config:{},configFactories:[i=>({callbacks:[new go({config:i,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return lS(this,e)}},Jr=class r extends Z{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=kl(this.config,...e);return kl(t,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(G(t),this.kwargs))}async batch(e,t,n){let i=Array.isArray(t)?await Promise.all(t.map(async a=>this._mergeConfig(G(a),this.kwargs))):await this._mergeConfig(G(t),this.kwargs);return this.bound.batch(e,i,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(G(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(G(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(G(t),this.kwargs))}streamEvents(e,t,n){let i=this,a=async function*(){yield*i.bound.streamEvents(e,{...await i._mergeConfig(G(t),i.kwargs),version:t.version},n)};return Ve.fromAsyncGenerator(a())}static isRunnableBinding(e){return e.bound&&Z.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new r({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new go({config:i,onStart:e,onEnd:t,onError:n})]})]})}},Bl=class r extends Z{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new r({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,ve(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new r({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}},Kl=class extends Jr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){let i=e>1?`retry:attempt:${e}`:void 0;return ve(t,{callbacks:n?.getChild(i)})}async _invoke(e,t,n){return(0,Uf.default)(i=>super.invoke(e,this._patchConfigForRetry(i,t,n)),{onFailedAttempt:i=>this.onFailedAttempt(i,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,i){let a={};try{await(0,Uf.default)(async s=>{let o=e.map((d,f)=>f).filter(d=>a[d.toString()]===void 0||a[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(s,t?.[d],n?.[d])),c=await super.batch(u,l,{...i,returnExceptions:!0}),p;for(let d=0;d<c.length;d+=1){let f=c[d],m=o[d];f instanceof Error&&p===void 0&&(p=f,p.input=u[d]),a[m.toString()]=f}if(p)throw p;return c},{onFailedAttempt:s=>this.onFailedAttempt(s,s.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(s){if(i?.returnExceptions!==!0)throw s}return Object.keys(a).sort((s,o)=>parseInt(s,10)-parseInt(o,10)).map(s=>a[parseInt(s,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}},Yr=class r extends Z{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let n=G(t),a=await(await mt(n))?.handleChainStart(this.toJSON(),Ie(e,"input"),n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let s=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1){let p=u[l].invoke(s,ve(n,{callbacks:a?.getChild(`seq:step:${l+1}`)}));s=await hr(p,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(s,ve(n,{callbacks:a?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await a?.handleChainError(u),u}return await a?.handleChainEnd(Ie(o,"output")),o}async batch(e,t,n){let i=this._getOptionsList(t??{},e.length),a=await Promise.all(i.map(mt)),s=await Promise.all(a.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),Ie(e[l],"input"),i[l].runId,void 0,void 0,void 0,i[l].runName);return delete i[l].runId,c})),o=e;try{for(let u=0;u<this.steps.length;u+=1){let c=this.steps[u].batch(o,s.map((p,d)=>{let f=p?.getChild(`seq:step:${u+1}`);return ve(i[d],{callbacks:f})}),n);o=await hr(c,i[0]?.signal)}}catch(u){throw await Promise.all(s.map(l=>l?.handleChainError(u))),u}return await Promise.all(s.map(u=>u?.handleChainEnd(Ie(o,"output")))),o}async*_streamIterator(e,t){let n=await mt(t),{runId:i,...a}=t??{},s=await n?.handleChainStart(this.toJSON(),Ie(e,"input"),i,void 0,void 0,void 0,a?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*c(){yield e}try{let p=o[0].transform(c(),ve(a,{callbacks:s?.getChild("seq:step:1")}));for(let d=1;d<o.length;d+=1)p=await o[d].transform(p,ve(a,{callbacks:s?.getChild(`seq:step:${d+1}`)}));for await(let d of p)if(t?.signal?.throwIfAborted(),yield d,u)if(l===void 0)l=d;else try{l=He(l,d)}catch{l=void 0,u=!1}}catch(p){throw await s?.handleChainError(p),p}await s?.handleChainEnd(Ie(l,"output"))}getGraph(e){let t=new wo,n=null;return this.steps.forEach((i,a)=>{let s=i.getGraph(e);a!==0&&s.trimFirstNode(),a!==this.steps.length-1&&s.trimLastNode(),t.extend(s);let o=s.firstNode();if(!o)throw new Error(`Runnable ${i} has no first node`);n&&t.addEdge(n,o),n=s.lastNode()}),t}pipe(e){return r.isRunnableSequence(e)?new r({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new r({first:this.first,middle:[...this.middle,this.last],last:Zr(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Z.isRunnable(e)}static from([e,...t],n){return new r({first:Zr(e),middle:t.slice(0,-1).map(Zr),last:Zr(t[t.length-1]),name:n})}},Cn=class r extends Z{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,n]of Object.entries(e.steps))this.steps[t]=Zr(n)}static from(e){return new r({steps:e})}async invoke(e,t){let n=G(t),a=await(await mt(n))?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let s={};try{let o=Object.entries(this.steps).map(async([u,l])=>{s[u]=await l.invoke(e,ve(n,{callbacks:a?.getChild(`map:key:${u}`)}))});await hr(Promise.all(o),t?.signal)}catch(o){throw await a?.handleChainError(o),o}return await a?.handleChainEnd(s),s}async*_transform(e,t,n){let i={...this.steps},a=rf(e,Object.keys(i).length),s=new Map(Object.entries(i).map(([o,u],l)=>{let c=u.transform(a[l],ve(n,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(p=>({key:o,gen:c,result:p}))]}));for(;s.size;){let o=Promise.race(s.values()),{key:u,result:l,gen:c}=await hr(o,n?.signal);s.delete(u),l.done||(yield{[u]:l.value},s.set(u,c.next().then(p=>({key:u,gen:c,result:p}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let i=G(t),a=new Gr({generator:this.transform(n(),i),config:i});return await a.setup,Ve.fromAsyncGenerator(a)}},zf=class r extends Z{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!dl(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[n]=this._getOptionsList(t??{},1),i=await mt(n),a=this.func(ve(n,{callbacks:i}),e);return hr(a,n?.signal)}async*_streamIterator(e,t){let[n]=this._getOptionsList(t??{},1),i=await this.invoke(e,t);if(zl(i)){for await(let a of i)n?.signal?.throwIfAborted(),yield a;return}if(N_(i)){for(;;){n?.signal?.throwIfAborted();let a=i.next();if(a.done)break;yield a.value}return}yield i}static from(e){return new r({func:e})}};Xr=class r extends Z{static lc_name(){return"RunnableLambda"}constructor(e){if(dl(e.func))return zf.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),uS(e.func),this.func=e.func}static from(e){return new r({func:e})}async _invoke(e,t,n){return new Promise((i,a)=>{let s=ve(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??Sl)-1});Ft.runWithConfig(s,async()=>{try{let o=await this.func(e,{...s,config:s});if(o&&Z.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...s,recursionLimit:(s.recursionLimit??Sl)-1})}else if(zl(o)){let u;for await(let l of qf(s,o))if(t?.signal?.throwIfAborted(),u===void 0)u=l;else try{u=He(u,l)}catch{u=l}o=u}else if(Df(o)){let u;for(let l of Ff(s,o))if(t?.signal?.throwIfAborted(),u===void 0)u=l;else try{u=He(u,l)}catch{u=l}o=u}i(o)}catch(o){a(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let i;for await(let o of e)if(i===void 0)i=o;else try{i=He(i,o)}catch{i=o}let a=ve(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??Sl)-1}),s=await new Promise((o,u)=>{Ft.runWithConfig(a,async()=>{try{let l=await this.func(i,{...a,config:a});o(l)}catch(l){u(l)}})});if(s&&Z.isRunnable(s)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await s.stream(i,a);for await(let u of o)yield u}else if(zl(s))for await(let o of qf(a,s))n?.signal?.throwIfAborted(),yield o;else if(Df(s))for(let o of Ff(a,s))n?.signal?.throwIfAborted(),yield o;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let i=G(t),a=new Gr({generator:this.transform(n(),i),config:i});return await a.setup,Ve.fromAsyncGenerator(a)}},Vl=class extends Z{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let n=G(t),i=await mt(t),{runId:a,...s}=n,o=await i?.handleChainStart(this.toJSON(),Ie(e,"input"),a,void 0,void 0,void 0,s?.runName),u;for(let l of this.runnables()){n?.signal?.throwIfAborted();try{let c=await l.invoke(e,ve(s,{callbacks:o?.getChild()}));return await o?.handleChainEnd(Ie(c,"output")),c}catch(c){u===void 0&&(u=c)}}throw u===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(u),u)}async*_streamIterator(e,t){let n=G(t),i=await mt(t),{runId:a,...s}=n,o=await i?.handleChainStart(this.toJSON(),Ie(e,"input"),a,void 0,void 0,void 0,s?.runName),u,l;for(let p of this.runnables()){n?.signal?.throwIfAborted();let d=ve(s,{callbacks:o?.getChild()});try{l=await p.stream(e,d);break}catch(f){u===void 0&&(u=f)}}if(l===void 0){let p=u??new Error("No error stored at end of fallback.");throw await o?.handleChainError(p),p}let c;try{for await(let p of l){yield p;try{c=c===void 0?c:He(c,p)}catch{c=void 0}}}catch(p){throw await o?.handleChainError(p),p}await o?.handleChainEnd(Ie(c,"output"))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");let i=this._getOptionsList(t??{},e.length),a=await Promise.all(i.map(u=>mt(u))),s=await Promise.all(a.map(async(u,l)=>{let c=await u?.handleChainStart(this.toJSON(),Ie(e[l],"input"),i[l].runId,void 0,void 0,void 0,i[l].runName);return delete i[l].runId,c})),o;for(let u of this.runnables()){i[0].signal?.throwIfAborted();try{let l=await u.batch(e,s.map((c,p)=>ve(i[p],{callbacks:c?.getChild()})),n);return await Promise.all(s.map((c,p)=>c?.handleChainEnd(Ie(l[p],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(s.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};Sa=class extends Z{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Cn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){let i=this.mapper.getStepsKeys(),[a,s]=rf(e),o=this.mapper.transform(s,ve(n,{callbacks:t?.getChild()})),u=o.next();for await(let l of a){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let c=Object.fromEntries(Object.entries(l).filter(([p])=>!i.includes(p)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let i=G(t),a=new Gr({generator:this.transform(n(),i),config:i});return await a.setup,Ve.fromAsyncGenerator(a)}},Hl=class extends Z{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let n=await this._pick(t);n!==void 0&&(yield n)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let i=G(t),a=new Gr({generator:this.transform(n(),i),config:i});return await a.setup,Ve.fromAsyncGenerator(a)}},_o=class extends Jr{constructor(e){let t=Yr.from([Xr.from(async n=>{let i;if(_a(n))try{i=await this.schema.parseAsync(n.args)}catch{throw new wa("Received tool input did not match expected schema",JSON.stringify(n.args))}else i=n;return i}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}});var vo,ka,Ra,Gl,xo=g(()=>{Vr();uo();On();vo=class extends Fe{},ka=class extends vo{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Re(this.value)]}},Ra=class extends vo{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return ft(this.messages)}toChatMessages(){return this.messages}},Gl=class extends vo{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new Re({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}});var Qr,Ao=g(()=>{xo();Na();Qr=class extends er{async formatPromptValue(e){let t=await this.format(e);return new ka(t)}}});function Kf(r){return typeof r=="function"}function pS(r){return ja(r)?"array":typeof r}function Bf(r){return r.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function j_(r,e){return r!=null&&typeof r=="object"&&e in r}function dS(r,e){return r!=null&&typeof r!="object"&&r.hasOwnProperty&&r.hasOwnProperty(e)}function mS(r,e){return fS.call(r,e)}function gS(r){return!mS(hS,r)}function bS(r){return String(r).replace(/[&<>"'`=\/]/g,function(t){return yS[t]})}function AS(r,e){if(!r)return[];var t=!1,n=[],i=[],a=[],s=!1,o=!1,u="",l=0;function c(){if(s&&!o)for(;a.length;)delete i[a.pop()];else a=[];s=!1,o=!1}var p,d,f;function m(q){if(typeof q=="string"&&(q=q.split(_S,2)),!ja(q)||q.length!==2)throw new Error("Invalid tags: "+q);p=new RegExp(Bf(q[0])+"\\s*"),d=new RegExp("\\s*"+Bf(q[1])),f=new RegExp("\\s*"+Bf("}"+q[1]))}m(e||qt.tags);for(var h=new Oo(r),y,_,b,O,v,x;!h.eos();){if(y=h.pos,b=h.scanUntil(p),b)for(var C=0,R=b.length;C<R;++C)O=b.charAt(C),gS(O)?(a.push(i.length),u+=O):(o=!0,t=!0,u+=" "),i.push(["text",O,y,y+1]),y+=1,O===`
`&&(c(),u="",l=0,t=!1);if(!h.scan(p))break;if(s=!0,_=h.scan(xS)||"name",h.scan(wS),_==="="?(b=h.scanUntil($_),h.scan($_),h.scanUntil(d)):_==="{"?(b=h.scanUntil(f),h.scan(vS),h.scanUntil(d),_="&"):b=h.scanUntil(d),!h.scan(d))throw new Error("Unclosed tag at "+h.pos);if(_==">"?v=[_,b,y,h.pos,u,l,t]:v=[_,b,y,h.pos],l++,i.push(v),_==="#"||_==="^")n.push(v);else if(_==="/"){if(x=n.pop(),!x)throw new Error('Unopened section "'+b+'" at '+y);if(x[1]!==b)throw new Error('Unclosed section "'+x[1]+'" at '+y)}else _==="name"||_==="{"||_==="&"?o=!0:_==="="&&m(b)}if(c(),x=n.pop(),x)throw new Error('Unclosed section "'+x[1]+'" at '+h.pos);return OS(PS(i))}function PS(r){for(var e=[],t,n,i=0,a=r.length;i<a;++i)t=r[i],t&&(t[0]==="text"&&n&&n[0]==="text"?(n[1]+=t[1],n[3]=t[3]):(e.push(t),n=t));return e}function OS(r){for(var e=[],t=e,n=[],i,a,s=0,o=r.length;s<o;++s)switch(i=r[s],i[0]){case"#":case"^":t.push(i),n.push(i),t=i[4]=[];break;case"/":a=n.pop(),a[5]=i[2],t=n.length>0?n[n.length-1][4]:e;break;default:t.push(i)}return e}function Oo(r){this.string=r,this.tail=r,this.pos=0}function Ma(r,e){this.view=r,this.cache={".":this.view},this.parent=e}function st(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}var cS,ja,fS,hS,yS,wS,_S,$_,vS,xS,qt,Po,Wl,L_=g(()=>{cS=Object.prototype.toString,ja=Array.isArray||function(e){return cS.call(e)==="[object Array]"};fS=RegExp.prototype.test;hS=/\S/;yS={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};wS=/\s*/,_S=/\s+/,$_=/\s*=/,vS=/\s*\}/,xS=/#|\^|\/|>|\{|&|=|!/;Oo.prototype.eos=function(){return this.tail===""};Oo.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};Oo.prototype.scanUntil=function(e){var t=this.tail.search(e),n;switch(t){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=n.length,n};Ma.prototype.push=function(e){return new Ma(e,this)};Ma.prototype.lookup=function(e){var t=this.cache,n;if(t.hasOwnProperty(e))n=t[e];else{for(var i=this,a,s,o,u=!1;i;){if(e.indexOf(".")>0)for(a=i.view,s=e.split("."),o=0;a!=null&&o<s.length;)o===s.length-1&&(u=j_(a,s[o])||dS(a,s[o])),a=a[s[o++]];else a=i.view[e],u=j_(i.view,e);if(u){n=a;break}i=i.parent}t[e]=n}return Kf(n)&&(n=n.call(this.view)),n};st.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};st.prototype.parse=function(e,t){var n=this.templateCache,i=e+":"+(t||qt.tags).join(":"),a=typeof n<"u",s=a?n.get(i):void 0;return s==null&&(s=AS(e,t),a&&n.set(i,s)),s};st.prototype.render=function(e,t,n,i){var a=this.getConfigTags(i),s=this.parse(e,a),o=t instanceof Ma?t:new Ma(t,void 0);return this.renderTokens(s,o,n,e,i)};st.prototype.renderTokens=function(e,t,n,i,a){for(var s="",o,u,l,c=0,p=e.length;c<p;++c)l=void 0,o=e[c],u=o[0],u==="#"?l=this.renderSection(o,t,n,i,a):u==="^"?l=this.renderInverted(o,t,n,i,a):u===">"?l=this.renderPartial(o,t,n,a):u==="&"?l=this.unescapedValue(o,t):u==="name"?l=this.escapedValue(o,t,a):u==="text"&&(l=this.rawValue(o)),l!==void 0&&(s+=l);return s};st.prototype.renderSection=function(e,t,n,i,a){var s=this,o="",u=t.lookup(e[1]);function l(d){return s.render(d,t,n,a)}if(u){if(ja(u))for(var c=0,p=u.length;c<p;++c)o+=this.renderTokens(e[4],t.push(u[c]),n,i,a);else if(typeof u=="object"||typeof u=="string"||typeof u=="number")o+=this.renderTokens(e[4],t.push(u),n,i,a);else if(Kf(u)){if(typeof i!="string")throw new Error("Cannot use higher-order sections without the original template");u=u.call(t.view,i.slice(e[3],e[5]),l),u!=null&&(o+=u)}else o+=this.renderTokens(e[4],t,n,i,a);return o}};st.prototype.renderInverted=function(e,t,n,i,a){var s=t.lookup(e[1]);if(!s||ja(s)&&s.length===0)return this.renderTokens(e[4],t,n,i,a)};st.prototype.indentPartial=function(e,t,n){for(var i=t.replace(/[^ \t]/g,""),a=e.split(`
`),s=0;s<a.length;s++)a[s].length&&(s>0||!n)&&(a[s]=i+a[s]);return a.join(`
`)};st.prototype.renderPartial=function(e,t,n,i){if(n){var a=this.getConfigTags(i),s=Kf(n)?n(e[1]):n[e[1]];if(s!=null){var o=e[6],u=e[5],l=e[4],c=s;u==0&&l&&(c=this.indentPartial(s,l,o));var p=this.parse(c,a);return this.renderTokens(p,t,n,c,i)}}};st.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(n!=null)return n};st.prototype.escapedValue=function(e,t,n){var i=this.getConfigEscape(n)||qt.escape,a=t.lookup(e[1]);if(a!=null)return typeof a=="number"&&i===qt.escape?String(a):i(a)};st.prototype.rawValue=function(e){return e[1]};st.prototype.getConfigTags=function(e){return ja(e)?e:e&&typeof e=="object"?e.tags:void 0};st.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!ja(e))return e.escape};qt={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(r){Po.templateCache=r},get templateCache(){return Po.templateCache}},Po=new st;qt.clearCache=function(){return Po.clearCache()};qt.parse=function(e,t){return Po.parse(e,t)};qt.render=function(e,t,n,i){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+pS(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Po.render(e,t,n,i)};qt.escape=bS;qt.Scanner=Oo;qt.Context=Ma;qt.Writer=st;Wl=qt});function D_(){Wl.escape=r=>r}var Eo,ES,Zl,Hf,IS,Vf,TS,tr,F_,Pi,$a=g(()=>{L_();Eo=r=>{let e=r.split(""),t=[],n=(a,s)=>{for(let o=s;o<e.length;o+=1)if(a.includes(e[o]))return o;return-1},i=0;for(;i<e.length;)if(e[i]==="{"&&i+1<e.length&&e[i+1]==="{")t.push({type:"literal",text:"{"}),i+=2;else if(e[i]==="}"&&i+1<e.length&&e[i+1]==="}")t.push({type:"literal",text:"}"}),i+=2;else if(e[i]==="{"){let a=n("}",i);if(a<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(i+1,a).join("")}),i=a+1}else{if(e[i]==="}")throw new Error("Single '}' in template.");{let a=n("{}",i),s=(a<0?e.slice(i):e.slice(i,a)).join("");t.push({type:"literal",text:s}),i=a<0?e.length:a}}return t},ES=r=>r.map(e=>e[0]==="name"?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}),Zl=r=>{D_();let e=Wl.parse(r);return ES(e)},Hf=(r,e)=>Eo(r).reduce((t,n)=>{if(n.type==="variable"){if(n.name in e)return t+e[n.name];throw new Error(`(f-string) Missing value for input ${n.name}`)}return t+n.text},""),IS=(r,e)=>(D_(),Wl.render(r,e)),Vf={"f-string":Hf,mustache:IS},TS={"f-string":Eo,mustache:Zl},tr=(r,e,t)=>Vf[e](r,t),F_=(r,e)=>TS[e](r),Pi=(r,e,t)=>{if(!(e in Vf)){let n=Object.keys(Vf);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${n}`)}try{let n=t.reduce((i,a)=>(i[a]="foo",i),{});Array.isArray(r)?r.forEach(i=>{if(i.type==="text")tr(i.text,e,n);else if(i.type==="image_url")if(typeof i.image_url=="string")tr(i.image_url,e,n);else{let a=i.image_url.url;tr(a,e,n)}else throw new Error(`Invalid message template received. ${JSON.stringify(i,null,2)}`)}):tr(r,e,n)}catch(n){throw new Error(`Invalid prompt schema: ${n.message}`)}}});var Gf={};mn(Gf,{PromptTemplate:()=>X});var X,La=g(()=>{Ao();$a();X=class r extends Qr{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Pi(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return tr(this.template,this.templateFormat,t)}static fromExamples(e,t,n,i=`

`,a=""){let s=[a,...e,t].join(i);return new r({inputVariables:n,template:s})}static fromTemplate(e,t){let{templateFormat:n="f-string",...i}=t??{},a=new Set;return F_(e,n).forEach(s=>{s.type==="variable"&&a.add(s.name)}),new r({inputVariables:[...a],templateFormat:n,template:e,...i})}async partial(e){let t=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},i={...this,inputVariables:t,partialVariables:n};return new r(i)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new r({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}});var Wf=g(()=>{Ht()});var q_=g(()=>{ht();bi();vl();xl();uo();Wf();Al();xa();On()});var Oi=g(()=>{bi();Ht();vl();xl();uo();Al();On();q_();Wf();xa()});var Da,Zf=g(()=>{xo();Na();$a();Da=class r extends er{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Pi([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}async partial(e){let t=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},i={...this,inputVariables:t,partialVariables:n};return new r(i)}async format(e){let t={};for(let[s,o]of Object.entries(this.template))typeof o=="string"?t[s]=tr(o,this.templateFormat,e):t[s]=o;let n=e.url||t.url,i=e.detail||t.detail;if(!n)throw new Error("Must provide either an image URL.");if(typeof n!="string")throw new Error("url must be a string.");let a={url:n};return i&&(a.detail=i),a}async formatPromptValue(e){let t=await this.format(e);return new Gl(t)}}});function CS(r){return typeof r.formatMessages=="function"}function SS(r,e){if(CS(r)||An(r))return r;if(Array.isArray(r)&&r[0]==="placeholder"){let i=r[1];if(typeof i!="string"||i[0]!=="{"||i[i.length-1]!=="}")throw new Error(`Invalid placeholder template: "${r[1]}". Expected a variable name surrounded by curly braces.`);let a=i.slice(1,-1);return new Jf({variableName:a,optional:!0})}let t=Wt(r),n;if(typeof t.content=="string"?n=t.content:n=t.content.map(i=>"text"in i?{...i,text:i.text}:"image_url"in i?{...i,image_url:i.image_url}:i),t._getType()==="human")return Ge.fromTemplate(n,e);if(t._getType()==="ai")return So.fromTemplate(n,e);if(t._getType()==="system")return Ut.fromTemplate(n,e);if(Gt.isInstance(t))return Xf.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function kS(r){return r.constructor.lc_name()==="MessagesPlaceholder"}var Io,Jf,Yf,To,Xf,Co,Ge,So,Ut,ot,ko=g(()=>{Oi();xo();ht();Ao();Na();La();Zf();$a();Io=class extends Z{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(n=>this.formatMessages(n),e,{...t,runType:"prompt"})}},Jf=class extends Io{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let i=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw i.name="InputFormatError",i}let n;try{Array.isArray(t)?n=t.map(Wt):n=[Wt(t)]}catch(i){let a=typeof t=="string"?t:JSON.stringify(t,null,2),s=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${a}`,`Additional message: ${i.message}`].join(`

`));throw s.name="InputFormatError",s}return n}},Yf=class extends Io{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},To=class extends er{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new Ra(t)}},Xf=class extends Yf{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new Gt(await this.prompt.format(e),this.role)}static fromTemplate(e,t,n){return new this(X.fromTemplate(e,{templateFormat:n?.templateFormat}),t)}},Co=class extends Io{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let n=[];this.prompt.forEach(i=>{"inputVariables"in i&&(n=n.concat(i.inputVariables))}),this.inputVariables=n}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let n=t._messageClass();return new n({content:e})}else if(t.chatMessageClass){let n=t.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(X.fromTemplate(e,t));let n=[];for(let i of e)if(typeof i=="string"||typeof i=="object"&&"text"in i){let a="";typeof i=="string"?a=i:typeof i.text=="string"&&(a=i.text??"");let s={...t,...typeof i!="string"?{additionalContentFields:i}:{}};n.push(X.fromTemplate(a,s))}else if(typeof i=="object"&&"image_url"in i){let a=i.image_url??"",s,o=[];if(typeof a=="string"){let u;t?.templateFormat==="mustache"?u=Zl(a):u=Eo(a);let l=u.flatMap(c=>c.type==="variable"?[c.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${a}`);o=[l[0]]}else o=[];a={url:a},s=new Da({template:a,inputVariables:o,templateFormat:t?.templateFormat,additionalContentFields:i})}else if(typeof a=="object"){if("url"in a){let u;t?.templateFormat==="mustache"?u=Zl(a.url):u=Eo(a.url),o=u.flatMap(l=>l.type==="variable"?[l.name]:[])}else o=[];s=new Da({template:a,inputVariables:o,templateFormat:t?.templateFormat,additionalContentFields:i})}else throw new Error("Invalid image template");n.push(s)}return new this({prompt:n,additionalOptions:t})}async format(e){if(this.prompt instanceof Qr){let t=await this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let n of this.prompt){let i={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(let a of n.inputVariables)i||(i={[a]:e[a]}),i={...i,[a]:e[a]};if(n instanceof Qr){let a=await n.format(i),s;"additionalContentFields"in n&&(s=n.additionalContentFields),t.push({...s,type:"text",text:a})}else if(n instanceof Da){let a=await n.format(i),s;"additionalContentFields"in n&&(s=n.additionalContentFields),t.push({...s,type:"image_url",image_url:a})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},Ge=class extends Co{static _messageClass(){return Re}static lc_name(){return"HumanMessagePromptTemplate"}},So=class extends Co{static _messageClass(){return ke}static lc_name(){return"AIMessagePromptTemplate"}},Ut=class extends Co{static _messageClass(){return Pn}static lc_name(){return"SystemMessagePromptTemplate"}};ot=class r extends To{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let o of this.promptMessages)if(!(o instanceof Ee))for(let u of o.inputVariables)t.add(u);let n=this.inputVariables,i=new Set(this.partialVariables?n.concat(Object.keys(this.partialVariables)):n),a=new Set([...i].filter(o=>!t.has(o)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);let s=new Set([...t].filter(o=>!i.has(o)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;let n=await Promise.all(e.content.map(async i=>{if(i.type!=="image_url")return i;let a="";typeof i.image_url=="string"?a=i.image_url:a=i.image_url.url;let o=await X.fromTemplate(a,{templateFormat:this.templateFormat}).format(t);return typeof i.image_url!="string"&&"url"in i.image_url?i.image_url.url=o:i.image_url=o,i}));return e.content=n,e}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),n=[];for(let i of this.promptMessages)if(i instanceof Ee)n.push(await this._parseImagePrompts(i,t));else{let a=i.inputVariables.reduce((o,u)=>{if(!(u in t)&&!(kS(i)&&i.optional))throw new Error(`Missing value for input variable \`${u.toString()}\``);return o[u]=t[u],o},{}),s=await i.formatMessages(a);n=n.concat(s)}return n}async partial(e){let t=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},i={...this,inputVariables:t,partialVariables:n};return new r(i)}static fromTemplate(e,t){let n=X.fromTemplate(e,t),i=new Ge({prompt:n});return this.fromMessages([i])}static fromMessages(e,t){let n=e.reduce((s,o)=>s.concat(o instanceof r?o.promptMessages:[SS(o,t)]),[]),i=e.reduce((s,o)=>o instanceof r?Object.assign(s,o.partialVariables):s,Object.create(null)),a=new Set;for(let s of n)if(!(s instanceof Ee))for(let o of s.inputVariables)o in i||a.add(o);return new this({...t,inputVariables:[...a],promptMessages:n,partialVariables:i,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}});var U_={};mn(U_,{FewShotChatMessagePromptTemplate:()=>Qf,FewShotPromptTemplate:()=>Jl});var Jl,Qf,em=g(()=>{Ao();$a();La();ko();Jl=class r extends Qr{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Pi(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},i={...this,inputVariables:t,partialVariables:n};return new r(i)}async format(e){let t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),i=await Promise.all(n.map(s=>this.examplePrompt.format(s))),a=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return tr(a,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let n=await X.deserialize(t),i;if(Array.isArray(e.examples))i=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new r({inputVariables:e.input_variables,examplePrompt:n,examples:i,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}},Qf=class r extends To{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Pi(this.prefix+this.suffix,this.templateFormat,t)}}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t);n=n.map(a=>{let s={};return this.examplePrompt.inputVariables.forEach(o=>{s[o]=a[o]}),s});let i=[];for(let a of n){let s=await this.examplePrompt.formatMessages(a);i.push(...s)}return i}async format(e){let t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),a=(await Promise.all(n.map(o=>this.examplePrompt.formatMessages(o)))).flat().map(o=>o.content),s=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return tr(s,this.templateFormat,t)}async partial(e){let t=this.inputVariables.filter(a=>!(a in e)),n={...this.partialVariables??{},...e},i={...this,inputVariables:t,partialVariables:n};return new r(i)}}});var er,Na=g(()=>{ht();er=class extends Z{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},n={};for(let[a,s]of Object.entries(t))typeof s=="string"?n[a]=s:n[a]=await s();return{...n,...e}}async invoke(e,t){return this._callWithConfig(n=>this.formatPromptValue(n),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(La(),Gf));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(La(),Gf));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(em(),U_));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var z_=g(()=>{Na();ko()});var B_=g(()=>{});var K_=g(()=>{ko()});var V_=g(()=>{Na();ko();em();z_();La();B_();Ao();$a();Zf();K_()});var Ae=g(()=>{V_()});var Go=g(()=>{Ta()});function sr(r){r?(Me[0]=Me[16]=Me[1]=Me[2]=Me[3]=Me[4]=Me[5]=Me[6]=Me[7]=Me[8]=Me[9]=Me[10]=Me[11]=Me[12]=Me[13]=Me[14]=Me[15]=0,this.blocks=Me):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}var $k,W,Lk,ar,Me,Dm,Nv=g(()=>{"use strict";$k=typeof window=="object"?window:{},W="0123456789abcdef".split(""),Lk=[-2147483648,8388608,32768,128],ar=[24,16,8,0],Me=[];sr.prototype.update=function(r){if(!this.finalized){var e=typeof r!="string";e&&r.constructor===$k.ArrayBuffer&&(r=new Uint8Array(r));for(var t,n=0,i,a=r.length||0,s=this.blocks;n<a;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),e)for(i=this.start;n<a&&i<64;++n)s[i>>2]|=r[n]<<ar[i++&3];else for(i=this.start;n<a&&i<64;++n)t=r.charCodeAt(n),t<128?s[i>>2]|=t<<ar[i++&3]:t<2048?(s[i>>2]|=(192|t>>6)<<ar[i++&3],s[i>>2]|=(128|t&63)<<ar[i++&3]):t<55296||t>=57344?(s[i>>2]|=(224|t>>12)<<ar[i++&3],s[i>>2]|=(128|t>>6&63)<<ar[i++&3],s[i>>2]|=(128|t&63)<<ar[i++&3]):(t=65536+((t&1023)<<10|r.charCodeAt(++n)&1023),s[i>>2]|=(240|t>>18)<<ar[i++&3],s[i>>2]|=(128|t>>12&63)<<ar[i++&3],s[i>>2]|=(128|t>>6&63)<<ar[i++&3],s[i>>2]|=(128|t&63)<<ar[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=s[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};sr.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var r=this.blocks,e=this.lastByteIndex;r[16]=this.block,r[e>>2]|=Lk[e&3],this.block=r[16],e>=56&&(this.hashed||this.hash(),r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),r[14]=this.hBytes<<3|this.bytes>>>29,r[15]=this.bytes<<3,this.hash()}};sr.prototype.hash=function(){var r=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4,a,s,o,u=this.blocks;for(s=16;s<80;++s)o=u[s-3]^u[s-8]^u[s-14]^u[s-16],u[s]=o<<1|o>>>31;for(s=0;s<20;s+=5)a=e&t|~e&n,o=r<<5|r>>>27,i=o+a+i+1518500249+u[s]<<0,e=e<<30|e>>>2,a=r&e|~r&t,o=i<<5|i>>>27,n=o+a+n+1518500249+u[s+1]<<0,r=r<<30|r>>>2,a=i&r|~i&e,o=n<<5|n>>>27,t=o+a+t+1518500249+u[s+2]<<0,i=i<<30|i>>>2,a=n&i|~n&r,o=t<<5|t>>>27,e=o+a+e+1518500249+u[s+3]<<0,n=n<<30|n>>>2,a=t&n|~t&i,o=e<<5|e>>>27,r=o+a+r+1518500249+u[s+4]<<0,t=t<<30|t>>>2;for(;s<40;s+=5)a=e^t^n,o=r<<5|r>>>27,i=o+a+i+1859775393+u[s]<<0,e=e<<30|e>>>2,a=r^e^t,o=i<<5|i>>>27,n=o+a+n+1859775393+u[s+1]<<0,r=r<<30|r>>>2,a=i^r^e,o=n<<5|n>>>27,t=o+a+t+1859775393+u[s+2]<<0,i=i<<30|i>>>2,a=n^i^r,o=t<<5|t>>>27,e=o+a+e+1859775393+u[s+3]<<0,n=n<<30|n>>>2,a=t^n^i,o=e<<5|e>>>27,r=o+a+r+1859775393+u[s+4]<<0,t=t<<30|t>>>2;for(;s<60;s+=5)a=e&t|e&n|t&n,o=r<<5|r>>>27,i=o+a+i-1894007588+u[s]<<0,e=e<<30|e>>>2,a=r&e|r&t|e&t,o=i<<5|i>>>27,n=o+a+n-1894007588+u[s+1]<<0,r=r<<30|r>>>2,a=i&r|i&e|r&e,o=n<<5|n>>>27,t=o+a+t-1894007588+u[s+2]<<0,i=i<<30|i>>>2,a=n&i|n&r|i&r,o=t<<5|t>>>27,e=o+a+e-1894007588+u[s+3]<<0,n=n<<30|n>>>2,a=t&n|t&i|n&i,o=e<<5|e>>>27,r=o+a+r-1894007588+u[s+4]<<0,t=t<<30|t>>>2;for(;s<80;s+=5)a=e^t^n,o=r<<5|r>>>27,i=o+a+i-899497514+u[s]<<0,e=e<<30|e>>>2,a=r^e^t,o=i<<5|i>>>27,n=o+a+n-899497514+u[s+1]<<0,r=r<<30|r>>>2,a=i^r^e,o=n<<5|n>>>27,t=o+a+t-899497514+u[s+2]<<0,i=i<<30|i>>>2,a=n^i^r,o=t<<5|t>>>27,e=o+a+e-899497514+u[s+3]<<0,n=n<<30|n>>>2,a=t^n^i,o=e<<5|e>>>27,r=o+a+r-899497514+u[s+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+r<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+i<<0};sr.prototype.hex=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4;return W[r>>28&15]+W[r>>24&15]+W[r>>20&15]+W[r>>16&15]+W[r>>12&15]+W[r>>8&15]+W[r>>4&15]+W[r&15]+W[e>>28&15]+W[e>>24&15]+W[e>>20&15]+W[e>>16&15]+W[e>>12&15]+W[e>>8&15]+W[e>>4&15]+W[e&15]+W[t>>28&15]+W[t>>24&15]+W[t>>20&15]+W[t>>16&15]+W[t>>12&15]+W[t>>8&15]+W[t>>4&15]+W[t&15]+W[n>>28&15]+W[n>>24&15]+W[n>>20&15]+W[n>>16&15]+W[n>>12&15]+W[n>>8&15]+W[n>>4&15]+W[n&15]+W[i>>28&15]+W[i>>24&15]+W[i>>20&15]+W[i>>16&15]+W[i>>12&15]+W[i>>8&15]+W[i>>4&15]+W[i&15]};sr.prototype.toString=sr.prototype.hex;sr.prototype.digest=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4;return[r>>24&255,r>>16&255,r>>8&255,r&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,i>>24&255,i>>16&255,i>>8&255,i&255]};sr.prototype.array=sr.prototype.digest;sr.prototype.arrayBuffer=function(){this.finalize();var r=new ArrayBuffer(20),e=new DataView(r);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),r};Dm=r=>new sr(!0).update(r).hex()});var Mv=g(()=>{Nv()});var jv,Fm,Dk,_c,$v=g(()=>{Mv();On();jv=(...r)=>Dm(r.join("_")),Fm=class{},Dk=new Map,_c=class r extends Fm{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(jv(e,t))??null)}async update(e,t,n){this.cache.set(jv(e,t),n)}static global(){return new r(Dk)}}});var Fv=S(vc=>{"use strict";vc.byteLength=qk;vc.toByteArray=zk;vc.fromByteArray=Vk;var Tr=[],Kt=[],Fk=typeof Uint8Array<"u"?Uint8Array:Array,qm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Vi=0,Lv=qm.length;Vi<Lv;++Vi)Tr[Vi]=qm[Vi],Kt[qm.charCodeAt(Vi)]=Vi;var Vi,Lv;Kt[45]=62;Kt[95]=63;function Dv(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function qk(r){var e=Dv(r),t=e[0],n=e[1];return(t+n)*3/4-n}function Uk(r,e,t){return(e+t)*3/4-t}function zk(r){var e,t=Dv(r),n=t[0],i=t[1],a=new Fk(Uk(r,n,i)),s=0,o=i>0?n-4:n,u;for(u=0;u<o;u+=4)e=Kt[r.charCodeAt(u)]<<18|Kt[r.charCodeAt(u+1)]<<12|Kt[r.charCodeAt(u+2)]<<6|Kt[r.charCodeAt(u+3)],a[s++]=e>>16&255,a[s++]=e>>8&255,a[s++]=e&255;return i===2&&(e=Kt[r.charCodeAt(u)]<<2|Kt[r.charCodeAt(u+1)]>>4,a[s++]=e&255),i===1&&(e=Kt[r.charCodeAt(u)]<<10|Kt[r.charCodeAt(u+1)]<<4|Kt[r.charCodeAt(u+2)]>>2,a[s++]=e>>8&255,a[s++]=e&255),a}function Bk(r){return Tr[r>>18&63]+Tr[r>>12&63]+Tr[r>>6&63]+Tr[r&63]}function Kk(r,e,t){for(var n,i=[],a=e;a<t;a+=3)n=(r[a]<<16&16711680)+(r[a+1]<<8&65280)+(r[a+2]&255),i.push(Bk(n));return i.join("")}function Vk(r){for(var e,t=r.length,n=t%3,i=[],a=16383,s=0,o=t-n;s<o;s+=a)i.push(Kk(r,s,s+a>o?o:s+a));return n===1?(e=r[t-1],i.push(Tr[e>>2]+Tr[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],i.push(Tr[e>>10]+Tr[e>>4&63]+Tr[e<<2&63]+"=")),i.join("")}});function Zk(r,e){let t=Array.from({length:r.length},(n,i)=>({start:i,end:i+1}));for(;t.length>1;){let n=null;for(let i=0;i<t.length-1;i++){let a=r.slice(t[i].start,t[i+1].end),s=e.get(a.join(","));s!=null&&(n==null||s<n[0])&&(n=[s,i])}if(n!=null){let i=n[1];t[i]={start:t[i].start,end:t[i+1].end},t.splice(i+1,1)}else break}return t}function Jk(r,e){return r.length===1?[e.get(r.join(","))]:Zk(r,e).map(t=>e.get(r.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Yk(r){return r.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}function zm(r){switch(r){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":return"o200k_base";default:throw new Error("Unknown model")}}var qv,Hk,Gk,Wk,Um,xc,Uv=g(()=>{qv=pe(Fv(),1),Hk=Object.defineProperty,Gk=(r,e,t)=>e in r?Hk(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Wk=(r,e,t)=>(Gk(r,typeof e!="symbol"?e+"":e,t),t);Um=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(r,e){this.patStr=r.pat_str;let t=r.bpe_ranks.split(`
`).filter(Boolean).reduce((n,i)=>{let[a,s,...o]=i.split(" "),u=Number.parseInt(s,10);return o.forEach((l,c)=>n[l]=u+c),n},{});for(let[n,i]of Object.entries(t)){let a=qv.default.toByteArray(n);this.rankMap.set(a.join(","),i),this.textMap.set(i,a)}this.specialTokens={...r.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[i,a])=>(n[a]=this.textEncoder.encode(i),n),{})}encode(r,e=[],t="all"){let n=new RegExp(this.patStr,"ug"),i=Um.specialTokenRegex(Object.keys(this.specialTokens)),a=[],s=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!s.has(l)):t);if(o.size>0){let l=Um.specialTokenRegex([...o]),c=r.match(l);if(c!=null)throw new Error(`The text contains a special token that is not allowed: ${c[0]}`)}let u=0;for(;;){let l=null,c=u;for(;i.lastIndex=c,l=i.exec(r),!(l==null||s.has(l[0]));)c=l.index+1;let p=l?.index??r.length;for(let f of r.substring(u,p).matchAll(n)){let m=this.textEncoder.encode(f[0]),h=this.rankMap.get(m.join(","));if(h!=null){a.push(h);continue}a.push(...Jk(m,this.rankMap))}if(l==null)break;let d=this.specialTokens[l[0]];a.push(d),u=l.index+l[0].length}return a}decode(r){let e=[],t=0;for(let a=0;a<r.length;++a){let s=r[a],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(e.push(o),t+=o.length)}let n=new Uint8Array(t),i=0;for(let a of e)n.set(a,i),i+=a.length;return this.textDecoder.decode(n)}},xc=Um;Wk(xc,"specialTokenRegex",r=>new RegExp(r.map(e=>Yk(e)).join("|"),"g"))});var zv=g(()=>{Uv()});async function Bv(r){return r in Ac||(Ac[r]=Xk.fetch(`https://tiktoken.pages.dev/js/${r}.json`).then(e=>e.json()).then(e=>new xc(e)).catch(e=>{throw delete Ac[r],e})),await Ac[r]}async function Kv(r){return Bv(zm(r))}var Ac,Xk,Bm=g(()=>{zv();Ca();Ac={},Xk=new Yt({})});function Vv(r){return typeof r!="object"||!r?!1:!!("type"in r&&r.type==="function"&&"function"in r&&typeof r.function=="object"&&r.function&&"name"in r.function&&"parameters"in r.function)}var Qk,eR,Hi,Gi,Wo=g(()=>{$v();xo();On();Ca();Bm();ht();Qk=r=>r.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r.startsWith("gpt-4o")?"gpt-4o":r;eR=()=>!1,Hi=class extends Z{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??eR(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},Gi=class extends Hi{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof n.cache=="object"?this.cache=n.cache:n.cache?this.cache=_c.global():this.cache=void 0,this.caller=new Yt(n??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Kv("modelName"in this?Qk(this.modelName):"gpt2")}catch(n){console.warn("Failed to calculate number of tokens, falling back to approximate count",n)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(n){console.warn("Failed to calculate number of tokens, falling back to approximate count",n)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new ka(e):Array.isArray(e)?new Ra(e.map(Wt)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([s,o])=>o!==void 0).map(([s,o])=>`${s}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}});var Cr,Pc=g(()=>{Wr();ht();In();Cr=class extends Z{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let n=G(t);return this.func&&await this.func(e,n),this._callWithConfig(i=>Promise.resolve(i),e,n)}async*transform(e,t){let n=G(t),i,a=!0;for await(let s of this._transformStreamWithConfig(e,o=>o,n))if(yield s,a)if(i===void 0)i=s;else try{i=He(i,s)}catch{i=void 0,a=!1}this.func&&i!==void 0&&await this.func(i,n)}static assign(e){return new Sa(new Cn({steps:e}))}}});var Jo=g(()=>{Wo()});var Hv=g(()=>{ht();In()});var Gv=g(()=>{ht();In();Wr()});var Wv=g(()=>{Oi();ht();Pc()});var Km=g(()=>{ht();In();Pc();Hv();Gv();Wv()});var Ec=g(()=>{Km()});var Ic,sn,Sr,bs=g(()=>{Km();Ic=class extends Z{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(n,i)=>this.parseResult([{text:n}],i?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(n,i)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],i?.callbacks),e,{...t,runType:"parser"})}},sn=class extends Ic{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}},Sr=class extends Error{constructor(e,t,n,i=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=i,i&&(n===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}});function Yo(r,e){let t=typeof r;if(t!==typeof e)return!1;if(Array.isArray(r)){if(!Array.isArray(e))return!1;let n=r.length;if(n!==e.length)return!1;for(let i=0;i<n;i++)if(!Yo(r[i],e[i]))return!1;return!0}if(t==="object"){if(!r||!e)return r===e;let n=Object.keys(r),i=Object.keys(e);if(n.length!==i.length)return!1;for(let s of n)if(!Yo(r[s],e[s]))return!1;return!0}return r===e}var Vm=g(()=>{});var Tc=g(()=>{});var dG,Cc=g(()=>{Tc();dG=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker")});function yt(r){return r.test.bind(r)}function AR(r){return r%4===0&&(r%100!==0||r%400===0)}function Zv(r){let e=r.match(rR);if(!e)return!1;let t=+e[1],n=+e[2],i=+e[3];return n>=1&&n<=12&&i>=1&&i<=(n==2&&AR(t)?29:nR[n])}function Jv(r,e){let t=e.match(iR);if(!t)return!1;let n=+t[1],i=+t[2],a=+t[3],s=!!t[5];return(n<=23&&i<=59&&a<=59||n==23&&i==59&&a==60)&&(!r||s)}function OR(r){let e=r.split(PR);return e.length==2&&Zv(e[0])&&Jv(!0,e[1])}function TR(r){return ER.test(r)&&IR.test(r)}function SR(r){if(CR.test(r))return!1;try{return new RegExp(r),!0}catch{return!1}}var rR,nR,iR,aR,sR,oR,uR,lR,cR,pR,dR,fR,mR,hR,gR,yR,bR,wR,_R,vR,xR,PR,ER,IR,CR,Hm=g(()=>{rR=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,nR=[0,31,28,31,30,31,30,31,31,30,31,30,31],iR=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,aR=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,sR=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,oR=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,uR=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,lR=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,cR=/^(?:\/(?:[^~/]|~0|~1)*)*$/,pR=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,dR=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,fR=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,mR=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,hR=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,gR=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,yR=r=>{if(r[0]==='"')return!1;let[e,t,...n]=r.split("@");return!e||!t||n.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(i=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(i))},bR=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,wR=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,_R=r=>r.length>1&&r.length<80&&(/^P\d+([.,]\d+)?W$/.test(r)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(r)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(r));vR={date:Zv,time:Jv.bind(void 0,!1),"date-time":OR,duration:_R,uri:TR,"uri-reference":yt(sR),"uri-template":yt(oR),url:yt(uR),email:yR,hostname:yt(aR),ipv4:yt(bR),ipv6:yt(wR),regex:SR,uuid:yt(lR),"json-pointer":yt(cR),"json-pointer-uri-fragment":yt(pR),"relative-json-pointer":yt(dR)},xR={...vR,date:yt(fR),time:yt(mR),"date-time":yt(hR),"uri-reference":yt(gR)};PR=/t|\s/i;ER=/\/|:/,IR=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;CR=/[^\\]\\Z/});var Yv=g(()=>{});var Gm=g(()=>{});var Wm=g(()=>{Vm();Cc();Hm();Tc();Gm()});var Xv=g(()=>{Cc();Wm()});var Qv=g(()=>{Vm();Cc();Hm();Tc();Yv();Gm();Wm();Xv()});var ex=g(()=>{Qv()});var ws,Dn,Fn=g(()=>{bs();Ht();On();Ta();ex();ws=class extends sn{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Dn=class extends ws{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(let i of e){if(typeof i!="string"&&typeof i.content!="string")throw new Error("Cannot handle non-string output.");let a;if($w(i)){if(typeof i.content!="string")throw new Error("Cannot handle non-string message output.");a=new gr({message:i,text:i.content})}else if(An(i)){if(typeof i.content!="string")throw new Error("Cannot handle non-string message output.");a=new gr({message:lo(i),text:i.content})}else a=new Jt({text:i});n===void 0?n=a:n=n.concat(a);let s=await this.parsePartialResult([n]);s!=null&&!Yo(s,t)&&(this.diff?yield this._diff(t,s):yield s,t=s)}}getFormatInstructions(){return""}}});var tx=g(()=>{Fn()});var rx=g(()=>{bs();Fn()});var nx=g(()=>{Fn()});var Xo,ix=g(()=>{fr();yr();bs();Xo=class extends sn{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=Rt.object(Object.fromEntries(Object.entries(e).map(([n,i])=>[n,Rt.string().describe(i)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(at(this.schema))}
\`\`\`
`}async parse(e){try{let n=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(i,a)=>`"${a.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(n))}catch(t){throw new Sr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}});var Sc=g(()=>{Md()});var Qo,Zm=g(()=>{Fn();Sc();Kd();Qo=class extends Dn{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?io(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Bd(e[0].text)}async parse(e){return Bd(e,JSON.parse)}getFormatInstructions(){return""}}});var ax=g(()=>{});var sx=g(()=>{Fn();Sc();ax()});var ox=g(()=>{bs();tx();rx();nx();ix();Fn();Zm();sx()});var Wi=g(()=>{ox()});var r0=g(()=>{En()});var Lc,n0=g(()=>{Wi();Lc=class extends sn{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","default"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"NoOpOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}}});var i0={};mn(i0,{LLMChain:()=>ae});function JR(r){return typeof r._llmType=="function"}function Dc(r){if(JR(r))return r;if("bound"in r&&Z.isRunnable(r.bound))return Dc(r.bound);if("runnable"in r&&"fallbacks"in r&&Z.isRunnable(r.runnable))return Dc(r.runnable);if("default"in r&&Z.isRunnable(r.default))return Dc(r.default);throw new Error("Unable to extract BaseLanguageModel from llmLike object.")}var ae,je=g(()=>{Jo();Ae();Ec();Ze();n0();ae=class r extends se{static lc_name(){return"LLMChain"}get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llmKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.llmKwargs=e.llmKwargs,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??new Lc,this.prompt.outputParser){if(e.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}getCallKeys(){return"callKeys"in this.llm?this.llm.callKeys:[]}_selectMemoryInputs(e){let t=super._selectMemoryInputs(e),n=this.getCallKeys();for(let i of n)i in e&&delete t[i];return t}async _getFinalOutput(e,t,n){let i;return this.outputParser?i=await this.outputParser.parseResultWithPrompt(e,t,n?.getChild()):i=e[0].text,i}call(e,t){return super.call(e,t)}async _call(e,t){let n={...e},i={...this.llmKwargs},a=this.getCallKeys();for(let l of a)l in e&&i&&(i[l]=e[l],delete n[l]);let s=await this.prompt.formatPromptValue(n);if("generatePrompt"in this.llm){let{generations:l}=await this.llm.generatePrompt([s],i,t?.getChild());return{[this.outputKey]:await this._getFinalOutput(l[0],s,t)}}let u=await(this.outputParser?this.llm.pipe(this.outputParser):this.llm).invoke(s,t?.getChild());return{[this.outputKey]:u}}async predict(e,t){return(await this.call(e,t))[this.outputKey]}_chainType(){return"llm"}static async deserialize(e){let{llm:t,prompt:n}=e;if(!t)throw new Error("LLMChain must have llm");if(!n)throw new Error("LLMChain must have prompt");return new r({llm:await Gi.deserialize(t),prompt:await er.deserialize(n)})}serialize(){let e="serialize"in this.llm?this.llm.serialize():void 0;return{_type:`${this._chainType()}_chain`,llm:e,prompt:this.prompt.serialize()}}_getNumTokens(e){return Dc(this.llm).getNumTokens(e)}}});function ah(r,e){let t=new Set;for(let n of e)r.has(n)&&t.add(n);return t}function a0(r,e){let t=new Set(r);for(let n of e)t.add(n);return t}function iu(r,e){let t=new Set(r);for(let n of e)t.delete(n);return t}var s0=g(()=>{});var sh={};mn(sh,{SequentialChain:()=>su,SimpleSequentialChain:()=>Fc});function au(r){return Array.from(r).map(e=>`"${e}"`).join(", ")}var su,Fc,ou=g(()=>{Ze();s0();su=class r extends se{static lc_name(){return"SequentialChain"}get inputKeys(){return this.inputVariables}get outputKeys(){return this.outputVariables}constructor(e){if(super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.inputVariables=e.inputVariables,this.outputVariables=e.outputVariables??[],this.outputVariables.length>0&&e.returnAll)throw new Error("Either specify variables to return using `outputVariables` or use `returnAll` param. Cannot apply both conditions at the same time.");this.returnAll=e.returnAll??!1,this._validateChains()}_validateChains(){if(this.chains.length===0)throw new Error("Sequential chain must have at least one chain.");let e=this.memory?.memoryKeys??[],t=new Set(this.inputKeys),n=new Set(e),i=ah(t,n);if(i.size>0)throw new Error(`The following keys: ${au(i)} are overlapping between memory and input keys of the chain variables. This can lead to unexpected behaviour. Please use input and memory keys that don't overlap.`);let a=a0(t,n);for(let s of this.chains){let o=iu(new Set(s.inputKeys),a);if(s.memory&&(o=iu(o,new Set(s.memory.memoryKeys))),o.size>0)throw new Error(`Missing variables for chain "${s._chainType()}": ${au(o)}. Only got the following variables: ${au(a)}.`);let u=new Set(s.outputKeys),l=ah(a,u);if(l.size>0)throw new Error(`The following output variables for chain "${s._chainType()}" are overlapping: ${au(l)}. This can lead to unexpected behaviour.`);for(let c of u)a.add(c)}if(this.outputVariables.length===0)if(this.returnAll){let s=iu(a,t);this.outputVariables=Array.from(s)}else this.outputVariables=this.chains[this.chains.length-1].outputKeys;else{let s=iu(new Set(this.outputVariables),new Set(a));if(s.size>0)throw new Error(`The following output variables were expected to be in the final chain output but were not found: ${au(s)}.`)}}async _call(e,t){let n={},i=e,a=0;for(let o of this.chains){a+=1,n=await o.call(i,t?.getChild(`step_${a}`));for(let u of Object.keys(n))i[u]=n[u]}let s={};for(let o of this.outputVariables)s[o]=i[o];return s}_chainType(){return"sequential_chain"}static async deserialize(e){let t=[],n=e.input_variables,i=e.output_variables,a=e.chains;for(let s of a){let o=await se.deserialize(s);t.push(o)}return new r({chains:t,inputVariables:n,outputVariables:i})}serialize(){let e=[];for(let t of this.chains)e.push(t.serialize());return{_type:this._chainType(),input_variables:this.inputVariables,output_variables:this.outputVariables,chains:e}}},Fc=class r extends se{static lc_name(){return"SimpleSequentialChain"}get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),Object.defineProperty(this,"trimOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.trimOutputs=e.trimOutputs??!1,this._validateChains()}_validateChains(){for(let e of this.chains){if(e.inputKeys.filter(t=>!e.memory?.memoryKeys.includes(t)).length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one input, got ${e.inputKeys.length} for ${e._chainType()}.`);if(e.outputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one output, got ${e.outputKeys.length} for ${e._chainType()}.`)}}async _call(e,t){let n=e[this.inputKey],i=0;for(let a of this.chains)i+=1,n=(await a.call({[a.inputKeys[0]]:n,signal:e.signal},t?.getChild(`step_${i}`)))[a.outputKeys[0]],this.trimOutputs&&(n=n.trim()),await t?.handleText(n);return{[this.outputKey]:n}}_chainType(){return"simple_sequential_chain"}static async deserialize(e){let t=[],n=e.chains;for(let i of n){let a=await se.deserialize(i);t.push(a)}return new r({chains:t})}serialize(){let e=[];for(let t of this.chains)e.push(t.serialize());return{_type:this._chainType(),chains:e}}}});var qc={};mn(qc,{MapReduceDocumentsChain:()=>Yi,RefineDocumentsChain:()=>Xi,StuffDocumentsChain:()=>un});var un,Yi,Xi,Qi=g(()=>{Ae();Ze();je();un=class r extends se{static lc_name(){return"StuffDocumentsChain"}get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys].filter(e=>e!==this.documentVariableName)}get outputKeys(){return this.llmChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey}_prepInputs(e){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:t,...n}=e,a=t.map(({pageContent:s})=>s).join(`

`);return{...n,[this.documentVariableName]:a}}async _call(e,t){return await this.llmChain.call(this._prepInputs(e),t?.getChild("combine_documents"))}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");return new r({llmChain:await ae.deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}},Yi=class r extends se{static lc_name(){return"MapReduceDocumentsChain"}get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.ensureMapStep=e.ensureMapStep??this.ensureMapStep,this.inputKey=e.inputKey??this.inputKey,this.maxTokens=e.maxTokens??this.maxTokens,this.maxIterations=e.maxIterations??this.maxIterations,this.returnIntermediateSteps=e.returnIntermediateSteps??!1}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:n,...i}=e,a=n,s=[];for(let l=0;l<this.maxIterations;l+=1){let c=a.map(m=>({[this.documentVariableName]:m.pageContent,...i}));if(l!==0||!this.ensureMapStep){let m=await this.combineDocumentChain.llmChain.prompt.format(this.combineDocumentChain._prepInputs({[this.combineDocumentChain.inputKey]:a,...i}));if(await this.combineDocumentChain.llmChain._getNumTokens(m)<this.maxTokens)break}let d=await this.llmChain.apply(c,t?Array.from({length:c.length},(m,h)=>t.getChild(`map_${h+1}`)):void 0),{outputKey:f}=this.llmChain;this.returnIntermediateSteps&&(s=s.concat(d.map(m=>m[f]))),a=d.map(m=>({pageContent:m[f],metadata:{}}))}let o={[this.combineDocumentChain.inputKey]:a,...i},u=await this.combineDocumentChain.call(o,t?.getChild("combine_documents"));return this.returnIntermediateSteps?{...u,intermediateSteps:s}:u}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");if(!e.combine_document_chain)throw new Error("Missing combine_document_chain");return new r({llmChain:await ae.deserialize(e.llm_chain),combineDocumentChain:await un.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}},Xi=class r extends se{static lc_name(){return"RefineDocumentsChain"}get defaultDocumentPrompt(){return new X({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[...new Set([this.inputKey,...this.llmChain.inputKeys,...this.refineLLMChain.inputKeys])].filter(e=>e!==this.documentVariableName&&e!==this.initialResponseName)}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.documentPrompt=e.documentPrompt??this.documentPrompt,this.initialResponseName=e.initialResponseName??this.initialResponseName}async _constructInitialInputs(e,t){let n={page_content:e.pageContent,...e.metadata},i={};return this.documentPrompt.inputVariables.forEach(o=>{i[o]=n[o]}),{...{[this.documentVariableName]:await this.documentPrompt.format({...i})},...t}}async _constructRefineInputs(e,t){let n={page_content:e.pageContent,...e.metadata},i={};this.documentPrompt.inputVariables.forEach(o=>{i[o]=n[o]});let a={[this.documentVariableName]:await this.documentPrompt.format({...i})};return{[this.initialResponseName]:t,...a}}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);let{[this.inputKey]:n,...i}=e,a=n,s=await this._constructInitialInputs(a[0],i),o=await this.llmChain.predict({...s},t?.getChild("answer")),u=[o];for(let l=1;l<a.length;l+=1){let p={...await this._constructRefineInputs(a[l],o),...i};o=await this.refineLLMChain.predict({...p},t?.getChild("refine")),u.push(o)}return{[this.outputKey]:o}}_chainType(){return"refine_documents_chain"}static async deserialize(e){let t=e.llm_chain;if(!t)throw new Error("Missing llm_chain");let n=e.refine_llm_chain;if(!n)throw new Error("Missing refine_llm_chain");return new r({llmChain:await ae.deserialize(t),refineLLMChain:await ae.deserialize(n)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}}});var Uc=g(()=>{Vr()});function Un(r){return r._modelType()==="base_chat_model"}var oh,kr,o0=g(()=>{oh=class{async getPromptAsync(e,t){return this.getPrompt(e).partial(t?.partialVariables??{})}},kr=class extends oh{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(let[t,n]of this.conditionals)if(t(e))return n;return this.defaultPrompt}}});var u0=g(()=>{Uc()});var lr,uh=g(()=>{lr=class{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent!==void 0?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}});var l0=g(()=>{uh();Uc()});var c0=g(()=>{Uc();o0();u0();l0()});var zc=g(()=>{c0()});var XR,QR,eN,tN,p0,d0=g(()=>{Ae();zc();XR=new X({template:`Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.

{context}

Question: {question}
Helpful Answer:`,inputVariables:["context","question"]}),QR=`Use the following pieces of context to answer the users question. 
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}`,eN=[Ut.fromTemplate(QR),Ge.fromTemplate("{question}")],tN=ot.fromMessages(eN),p0=new kr(XR,[[Un,tN]])});var rN,nN,iN,aN,sN,f0,oN,uN,lN,cN,pN,m0,h0=g(()=>{Ae();zc();rN=`Use the following portion of a long document to see if any of the text is relevant to answer the question. 
Return any relevant text verbatim.
{context}
Question: {question}
Relevant text, if any:`,nN=X.fromTemplate(rN),iN=`Use the following portion of a long document to see if any of the text is relevant to answer the question. 
Return any relevant text verbatim.
----------------
{context}`,aN=[Ut.fromTemplate(iN),Ge.fromTemplate("{question}")],sN=ot.fromMessages(aN),f0=new kr(nN,[[Un,sN]]),oN=`Given the following extracted parts of a long document and a question, create a final answer. 
If you don't know the answer, just say that you don't know. Don't try to make up an answer.

QUESTION: Which state/country's law governs the interpretation of the contract?
=========
Content: This Agreement is governed by English law and the parties submit to the exclusive jurisdiction of the English courts in  relation to any dispute (contractual or non-contractual) concerning this Agreement save that either party may apply to any court for an  injunction or other relief to protect its Intellectual Property Rights.

Content: No Waiver. Failure or delay in exercising any right or remedy under this Agreement shall not constitute a waiver of such (or any other)  right or remedy.

11.7 Severability. The invalidity, illegality or unenforceability of any term (or part of a term) of this Agreement shall not affect the continuation  in force of the remainder of the term (if any) and this Agreement.

11.8 No Agency. Except as expressly stated otherwise, nothing in this Agreement shall create an agency, partnership or joint venture of any  kind between the parties.

11.9 No Third-Party Beneficiaries.

Content: (b) if Google believes, in good faith, that the Distributor has violated or caused Google to violate any Anti-Bribery Laws (as  defined in Clause 8.5) or that such a violation is reasonably likely to occur,
=========
FINAL ANSWER: This Agreement is governed by English law.

QUESTION: What did the president say about Michael Jackson?
=========
Content: Madam Speaker, Madam Vice President, our First Lady and Second Gentleman. Members of Congress and the Cabinet. Justices of the Supreme Court. My fellow Americans.  

Last year COVID-19 kept us apart. This year we are finally together again. 

Tonight, we meet as Democrats Republicans and Independents. But most importantly as Americans. 

With a duty to one another to the American people to the Constitution. 

And with an unwavering resolve that freedom will always triumph over tyranny. 

Six days ago, Russia\u2019s Vladimir Putin sought to shake the foundations of the free world thinking he could make it bend to his menacing ways. But he badly miscalculated. 

He thought he could roll into Ukraine and the world would roll over. Instead he met a wall of strength he never imagined. 

He met the Ukrainian people. 

From President Zelenskyy to every Ukrainian, their fearlessness, their courage, their determination, inspires the world. 

Groups of citizens blocking tanks with their bodies. Everyone from students to retirees teachers turned soldiers defending their homeland.

Content: And we won\u2019t stop. 

We have lost so much to COVID-19. Time with one another. And worst of all, so much loss of life. 

Let\u2019s use this moment to reset. Let\u2019s stop looking at COVID-19 as a partisan dividing line and see it for what it is: A God-awful disease.  

Let\u2019s stop seeing each other as enemies, and start seeing each other for who we really are: Fellow Americans.  

We can\u2019t change how divided we\u2019ve been. But we can change how we move forward\u2014on COVID-19 and other issues we must face together. 

I recently visited the New York City Police Department days after the funerals of Officer Wilbert Mora and his partner, Officer Jason Rivera. 

They were responding to a 9-1-1 call when a man shot and killed them with a stolen gun. 

Officer Mora was 27 years old. 

Officer Rivera was 22. 

Both Dominican Americans who\u2019d grown up on the same streets they later chose to patrol as police officers. 

I spoke with their families and told them that we are forever in debt for their sacrifice, and we will carry on their mission to restore the trust and safety every community deserves.

Content: And a proud Ukrainian people, who have known 30 years  of independence, have repeatedly shown that they will not tolerate anyone who tries to take their country backwards.  

To all Americans, I will be honest with you, as I\u2019ve always promised. A Russian dictator, invading a foreign country, has costs around the world. 

And I\u2019m taking robust action to make sure the pain of our sanctions  is targeted at Russia\u2019s economy. And I will use every tool at our disposal to protect American businesses and consumers. 

Tonight, I can announce that the United States has worked with 30 other countries to release 60 Million barrels of oil from reserves around the world.  

America will lead that effort, releasing 30 Million barrels from our own Strategic Petroleum Reserve. And we stand ready to do more if necessary, unified with our allies.  

These steps will help blunt gas prices here at home. And I know the news about what\u2019s happening can seem alarming. 

But I want you to know that we are going to be okay.

Content: More support for patients and families. 

To get there, I call on Congress to fund ARPA-H, the Advanced Research Projects Agency for Health. 

It\u2019s based on DARPA\u2014the Defense Department project that led to the Internet, GPS, and so much more.  

ARPA-H will have a singular purpose\u2014to drive breakthroughs in cancer, Alzheimer\u2019s, diabetes, and more. 

A unity agenda for the nation. 

We can do this. 

My fellow Americans\u2014tonight , we have gathered in a sacred space\u2014the citadel of our democracy. 

In this Capitol, generation after generation, Americans have debated great questions amid great strife, and have done great things. 

We have fought for freedom, expanded liberty, defeated totalitarianism and terror. 

And built the strongest, freest, and most prosperous nation the world has ever known. 

Now is the hour. 

Our moment of responsibility. 

Our test of resolve and conscience, of history itself. 

It is in this moment that our character is formed. Our purpose is found. Our future is forged. 

Well I know this nation.
=========
FINAL ANSWER: The president did not mention Michael Jackson.

QUESTION: {question}
=========
{summaries}
=========
FINAL ANSWER:`,uN=X.fromTemplate(oN),lN=`Given the following extracted parts of a long document and a question, create a final answer. 
If you don't know the answer, just say that you don't know. Don't try to make up an answer.
----------------
{summaries}`,cN=[Ut.fromTemplate(lN),Ge.fromTemplate("{question}")],pN=ot.fromMessages(cN),m0=new kr(uN,[[Un,pN]])});var dN,fN,mN,hN,gN,g0,yN,bN,wN,_N,vN,y0,b0=g(()=>{Ae();zc();dN=`The original question is as follows: {question}
We have provided an existing answer: {existing_answer}
We have the opportunity to refine the existing answer
(only if needed) with some more context below.
------------
{context}
------------
Given the new context, refine the original answer to better answer the question. 
If the context isn't useful, return the original answer.`,fN=new X({inputVariables:["question","existing_answer","context"],template:dN}),mN=`The original question is as follows: {question}
We have provided an existing answer: {existing_answer}
We have the opportunity to refine the existing answer
(only if needed) with some more context below.
------------
{context}
------------
Given the new context, refine the original answer to better answer the question. 
If the context isn't useful, return the original answer.`,hN=[Ge.fromTemplate("{question}"),So.fromTemplate("{existing_answer}"),Ge.fromTemplate(mN)],gN=ot.fromMessages(hN),g0=new kr(fN,[[Un,gN]]),yN=`Context information is below. 
---------------------
{context}
---------------------
Given the context information and no prior knowledge, answer the question: {question}`,bN=new X({inputVariables:["context","question"],template:yN}),wN=`Context information is below. 
---------------------
{context}
---------------------
Given the context information and no prior knowledge, answer any questions`,_N=[Ut.fromTemplate(wN),Ge.fromTemplate("{question}")],vN=ot.fromMessages(_N),y0=new kr(bN,[[Un,vN]])});function _s(r,e={}){let{prompt:t=p0.getPrompt(r),verbose:n}=e,i=new ae({prompt:t,llm:r,verbose:n});return new un({llmChain:i,verbose:n})}function w0(r,e={}){let{combineMapPrompt:t=f0.getPrompt(r),combinePrompt:n=m0.getPrompt(r),verbose:i,combineLLM:a,returnIntermediateSteps:s}=e,o=new ae({prompt:t,llm:r,verbose:i}),u=new ae({prompt:n,llm:a??r,verbose:i}),l=new un({llmChain:u,documentVariableName:"summaries",verbose:i});return new Yi({llmChain:o,combineDocumentChain:l,returnIntermediateSteps:s,verbose:i})}function _0(r,e={}){let{questionPrompt:t=y0.getPrompt(r),refinePrompt:n=g0.getPrompt(r),refineLLM:i,verbose:a}=e,s=new ae({prompt:t,llm:r,verbose:a}),o=new ae({prompt:n,llm:i??r,verbose:a});return new Xi({llmChain:s,refineLLMChain:o,verbose:a})}var lh,vs=g(()=>{je();Qi();d0();h0();b0();lh=(r,e={type:"stuff"})=>{let{type:t}=e;if(t==="stuff")return _s(r,e);if(t==="map_reduce")return w0(r,e);if(t==="refine")return _0(r,e);throw new Error(`Invalid _type: ${t}`)}});var v0={};mn(v0,{VectorDBQAChain:()=>Bc});var Bc,ch=g(()=>{Ze();vs();Bc=class r extends se{static lc_name(){return"VectorDBQAChain"}get inputKeys(){return[this.inputKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){super(e),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"vectorstore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.vectorstore=e.vectorstore,this.combineDocumentsChain=e.combineDocumentsChain,this.inputKey=e.inputKey??this.inputKey,this.k=e.k??this.k,this.returnSourceDocuments=e.returnSourceDocuments??this.returnSourceDocuments}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Question key ${this.inputKey} not found.`);let n=e[this.inputKey],i=await this.vectorstore.similaritySearch(n,this.k,e.filter,t?.getChild("vectorstore")),a={question:n,input_documents:i},s=await this.combineDocumentsChain.call(a,t?.getChild("combine_documents"));return this.returnSourceDocuments?{...s,sourceDocuments:i}:s}_chainType(){return"vector_db_qa"}static async deserialize(e,t){if(!("vectorstore"in t))throw new Error("Need to pass in a vectorstore to deserialize VectorDBQAChain");let{vectorstore:n}=t;if(!e.combine_documents_chain)throw new Error("VectorDBQAChain must have combine_documents_chain in serialized data");return new r({combineDocumentsChain:await se.deserialize(e.combine_documents_chain),k:e.k,vectorstore:n})}serialize(){return{_type:this._chainType(),combine_documents_chain:this.combineDocumentsChain.serialize(),k:this.k}}static fromLLM(e,t,n){let i=_s(e);return new this({vectorstore:t,combineDocumentsChain:i,...n})}}});var x0,A0,xN,P0,O0=g(()=>{Ae();x0=`You are given the below API Documentation:
{api_docs}
Using this documentation, generate the full API url to call for answering the user question.
You should build the API url in order to get a response that is as short as possible, while still getting the necessary information to answer the question. Pay attention to deliberately exclude any unnecessary pieces of data in the API call.

Question:{question}
API url:`,A0=new X({inputVariables:["api_docs","question"],template:x0}),xN=`${x0} {api_url}

Here is the response from the API:

{api_response}

Summarize this response to answer the original question.

Summary:`,P0=new X({inputVariables:["api_docs","question","api_url","api_response"],template:xN})});var E0={};mn(E0,{APIChain:()=>Kc});var Kc,ph=g(()=>{Ze();je();O0();Kc=class r extends se{get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"apiAnswerChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiRequestChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiDocs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"question"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),this.apiRequestChain=e.apiRequestChain,this.apiAnswerChain=e.apiAnswerChain,this.apiDocs=e.apiDocs,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.headers=e.headers??this.headers}async _call(e,t){let n=e[this.inputKey],i=await this.apiRequestChain.predict({question:n,api_docs:this.apiDocs},t?.getChild("request")),s=await(await fetch(i,{headers:this.headers})).text(),o=await this.apiAnswerChain.predict({question:n,api_docs:this.apiDocs,api_url:i,api_response:s},t?.getChild("response"));return{[this.outputKey]:o}}_chainType(){return"api_chain"}static async deserialize(e){let{api_request_chain:t,api_answer_chain:n,api_docs:i}=e;if(!t)throw new Error("LLMChain must have api_request_chain");if(!n)throw new Error("LLMChain must have api_answer_chain");if(!i)throw new Error("LLMChain must have api_docs");return new r({apiAnswerChain:await ae.deserialize(n),apiRequestChain:await ae.deserialize(t),apiDocs:i})}serialize(){return{_type:this._chainType(),api_answer_chain:this.apiAnswerChain.serialize(),api_request_chain:this.apiRequestChain.serialize(),api_docs:this.apiDocs}}static fromLLMAndAPIDocs(e,t,n={}){let{apiUrlPrompt:i=A0,apiResponsePrompt:a=P0}=n,s=new ae({prompt:i,llm:e}),o=new ae({prompt:a,llm:e});return new this({apiAnswerChain:o,apiRequestChain:s,apiDocs:t,...n})}}});var se,Ze=g(()=>{Go();r0();Ec();Jo();se=class extends Hi{get lc_namespace(){return["langchain","chains",this._chainType()]}constructor(e,t,n){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:i,callbackManager:a,...s}=e;super({...s,callbacks:a??s.callbacks}),this.memory=i}else super({verbose:t,callbacks:n}),this.memory=e}_selectMemoryInputs(e){let t={...e};return"signal"in t&&delete t.signal,"timeout"in t&&delete t.timeout,t}async invoke(e,t){let n=G(t),i=await this._formatValues(e),s=await(await be.configure(n?.callbacks,this.callbacks,n?.tags,this.tags,n?.metadata,this.metadata,{verbose:this.verbose}))?.handleChainStart(this.toJSON(),i,void 0,void 0,void 0,void 0,n?.runName),o;try{o=await(i.signal?Promise.race([this._call(i,s,n),new Promise((u,l)=>{i.signal?.addEventListener("abort",()=>{l(new Error("AbortError"))})})]):this._call(i,s,n))}catch(u){throw await s?.handleChainError(u),u}return this.memory!=null&&await this.memory.saveContext(this._selectMemoryInputs(e),o),await s?.handleChainEnd(o),Object.defineProperty(o,Ia,{value:s?{runId:s?.runId}:void 0,configurable:!0}),o}_validateOutputs(e){let t=this.outputKeys.filter(n=>!(n in e));if(t.length)throw new Error(`Missing output keys: ${t.join(", ")} from chain ${this._chainType()}`)}async prepOutputs(e,t,n=!1){return this._validateOutputs(t),this.memory&&await this.memory.saveContext(e,t),n?t:{...e,...t}}serialize(){throw new Error("Method not implemented.")}async run(e,t){let n=this.inputKeys.filter(u=>!this.memory?.memoryKeys.includes(u));if(!(n.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let a=n.length?{[n[0]]:e}:{},s=await this.call(a,t),o=Object.keys(s);if(o.length===1)return s[o[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async _formatValues(e){let t={...e};if(t.timeout&&!t.signal&&(t.signal=AbortSignal.timeout(t.timeout),delete t.timeout),this.memory!=null){let n=await this.memory.loadMemoryVariables(this._selectMemoryInputs(e));for(let[i,a]of Object.entries(n))t[i]=a}return t}async call(e,t,n){let i={tags:n,...Oa(t)};return this.invoke(e,i)}async apply(e,t){return Promise.all(e.map(async(n,i)=>this.call(n,t?.[i])))}static async deserialize(e,t={}){switch(e._type){case"llm_chain":{let{LLMChain:n}=await Promise.resolve().then(()=>(je(),i0));return n.deserialize(e)}case"sequential_chain":{let{SequentialChain:n}=await Promise.resolve().then(()=>(ou(),sh));return n.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:n}=await Promise.resolve().then(()=>(ou(),sh));return n.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:n}=await Promise.resolve().then(()=>(Qi(),qc));return n.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:n}=await Promise.resolve().then(()=>(Qi(),qc));return n.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:n}=await Promise.resolve().then(()=>(Qi(),qc));return n.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:n}=await Promise.resolve().then(()=>(ch(),v0));return n.deserialize(e,t)}case"api_chain":{let{APIChain:n}=await Promise.resolve().then(()=>(ph(),E0));return n.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var de=pe(_t());var Tt="https://chatgpt.com",$r={title:"ChatGPT Interface",endpoint:Tt,loginUrl:"https://chatgpt.com/auth/login",modelsUrl:Tt+"/backend-api/models",authType:"token",instructionsMessage:"authenticateChatGPT",welcomeMessage:"chatGPTwelcome",perksMessage:"chatGPTperks",updateLoginMessage:"refreshOpenAILogin",needAPIKey:!1,preferredModels:["gpt-4o","gpt-o3-mini","gpt-o1","gpt-4","text-davinci-002-render-sha"],fallbackModel:"text-davinci-002-render-sha",models:[{title:"Default (GPT-3.5)",model:"text-davinci-002-render-sha",defaultSelected:!0,maxTokens:8191,description:"Optimized for speed, currently available to Plus users",endpoint:Tt+"/backend-api/conversation"},{title:"Legacy (GPT-3.5)",model:"text-davinci-002-render-paid",defaultSelected:!1,maxTokens:4097,description:"The previous ChatGPT Plus model",endpoint:Tt+"/backend-api/conversation"},{title:"GPT-4",model:"gpt-4",defaultSelected:!1,maxTokens:32767,description:`Our most advanced model, available to Plus subscribers.

GPT-4 excels at tasks that require advanced reasoning, complex instruction understanding, and more creativity.`,endpoint:Tt+"/backend-api/conversation"},{title:"GPT-4o",model:"gpt-4o",defaultSelected:!1,maxTokens:32767,description:"Newest and most advanced model",endpoint:Tt+"/backend-api/conversation"},{title:"GPT-4o mini",model:"gpt-4o-mini",defaultSelected:!1,maxTokens:32767,description:"Browsing, Advanced Data Analysis, and DALL\xB7E are now built into GPT-4",endpoint:Tt+"/backend-api/conversation"},{title:"GPT-o1 mini",model:"gpt-o1-mini",defaultSelected:!1,maxTokens:98304,description:"Our most capable model, great for tasks that require creativity and advanced reasoning.",endpoint:Tt+"/backend-api/conversation"},{title:"GPT-4o with scheduled tasks",model:"gpt-4o-jawbone",defaultSelected:!1,maxTokens:32767,description:"Newest and most advanced model",endpoint:Tt+"/backend-api/conversation"},{title:"o1",model:"o1",defaultSelected:!1,maxTokens:196608,description:"Our most capable model, great for tasks that require creativity and advanced reasoning.",endpoint:Tt+"/backend-api/conversation"},{title:"o3-mini",model:"o3-mini",defaultSelected:!1,maxTokens:196608,description:"Our most capable model, great for tasks that require creativity and advanced reasoning.",endpoint:Tt+"/backend-api/conversation"},{title:"o3-mini-high",model:"o3-mini-high",defaultSelected:!1,maxTokens:196608,description:"Our most capable model, great for tasks that require creativity and advanced reasoning.",endpoint:Tt+"/backend-api/conversation"}],mapModelsResponse:r=>r.models?.map(e=>({slug:e.slug,title:e.title}))};var Pp="https://api.deepseek.com/chat/completions",Uh={title:"DeepSeek API",endpoint:Pp,loginUrl:"https://platform.deepseek.com/api_keys",modelsUrl:"https://api.deepseek.com/models",authType:"apikey",instructionsMessage:"addDeepSeekAPIKey",welcomeMessage:"DeepSeekAPIwelcome",perksMessage:"DeepSeekAPIperks",preferredModels:["deepseek-chat","deepseek-reasoner"],fallbackModel:"deepseek-chat",needAPIKey:!0,models:[{title:"DeepSeek-V3",model:"deepseek-chat",defaultSelected:!0,maxTokens:64e3,endpoint:Pp,inputCost:27e-5,outputCost:.0011},{title:"DeepSeek-R1",model:"deepseek-reasoner",defaultSelected:!1,maxTokens:64e3,endpoint:Pp,inputCost:55e-5,outputCost:.00219}],mapModelsResponse:r=>r.data?.map(e=>({slug:e.id,title:e.id}))};var wu="https://chat.deepseek.com/",Rs={authType:"login",endpoint:wu,fallbackModel:"deepseek-chat",instructionsMessage:"",updateLoginMessage:"refreshDeepSeekChatLogin",loginUrl:wu+"api/v0/users/login",models:[{title:"DeepSeek-V3",model:"deepseek-chat",defaultSelected:!0,maxTokens:64e3,endpoint:wu},{title:"DeepSeek-R1 (Reasoning model)",model:"deepseek-reasoner",defaultSelected:!1,maxTokens:64e3,endpoint:wu}],modelsUrl:"local",needAPIKey:!1,perksMessage:"DeepSeekChatPerks",preferredModels:["deepseek-reasoner","deepseek-chat"],title:"DeepSeek Chat",welcomeMessage:"DeepSeekChatWelcome",mapModelsResponse(r){return Promise.resolve(Rs.models.map(e=>({slug:e.model,title:e.title})))}};var vt="https://api.openai.com/v1/chat/completions",zh={title:"OpenAI API",endpoint:vt,loginUrl:"https://platform.openai.com/account/api-keys",modelsUrl:"https://api.openai.com/v1/models",authType:"apikey",instructionsMessage:"addOpenAIKey",welcomeMessage:"OpenAIwelcome",perksMessage:"OpenAIperks",preferredModels:["gpt-4o","gpt-o3-mini","gpt-4-turbo","gpt-4-1106-preview","gpt-4","gpt-3.5-turbo"],fallbackModel:"gpt-3.5-turbo",needAPIKey:!0,models:[{title:"gpt-4-1106-preview",model:"gpt-4-1106-preview",defaultSelected:!1,description:"The latest GPT-4 model with improved instruction following, JSON mode, reproducible outputs, parallel function calling, and more. Returns a maximum of 4,096 output tokens. This preview model is not yet suited for production traffic.",maxTokens:128e3,trainingData:"Up to Apr 2023",endpoint:vt,inputCost:.01,outputCost:.03},{title:"gpt-4",model:"gpt-4",defaultSelected:!1,description:"More capable than any GPT-3.5 model, able to do more complex tasks, and optimized for chat. Will be updated with our latest model iteration.",maxTokens:8192,trainingData:"Up to Sep 2021",endpoint:vt,inputCost:.03,outputCost:.06},{title:"gpt-4-turbo",model:"gpt-4-turbo",defaultSelected:!1,description:"The latest GPT-4 Turbo model with vision capabilities. Vision requests can now use JSON mode and function calling. Currently points to gpt-4-turbo-2024-04-09.",maxTokens:128e3,trainingData:"Up to Dec 2023",endpoint:vt,inputCost:.01,outputCost:.03},{title:"gpt-4-0314",model:"gpt-4-0314",defaultSelected:!1,description:"Snapshot of gpt-4 from March 14th 2023. Unlike gpt-4, this model will not receive updates, and will only be supported for a three month period ending on June 14th 2023.",maxTokens:8192,trainingData:"Up to Sep 2021",endpoint:vt},{title:"gpt-4-32k",model:"gpt-4-32k",defaultSelected:!1,description:"Same capabilities as the base gpt-4 mode but with 4x the context length. Will be updated with our latest model iteration.",maxTokens:32768,trainingData:"Up to Sep 2021",endpoint:vt},{title:"gpt-4-32k-0314",model:"gpt-4-32k-0314",defaultSelected:!1,description:"Snapshot of gpt-4-32 from March 14th 2023. Unlike gpt-4-32k, this model will not receive updates, and will only be supported for a three month period ending on June 14th 2023.",maxTokens:32768,trainingData:"Up to Sep 2021",endpoint:vt},{title:"gpt-3.5-turbo",model:"gpt-3.5-turbo",defaultSelected:!0,description:"Most capable GPT-3.5 model and optimized for chat at 1/10th the cost of text-davinci-003. Will be updated with our latest model iteration.",maxTokens:16385,trainingData:"Up to Sep 2021",endpoint:vt,inputCost:5e-4,outputCost:.0015},{title:"gpt-3.5-turbo-0301",model:"gpt-3.5-turbo-0301",defaultSelected:!1,description:"Snapshot of gpt-3.5-turbo from March 1st 2023. Unlike gpt-3.5-turbo, this model will not receive updates, and will only be supported for a three month period ending on June 1st 2023.",maxTokens:4096,trainingData:"Up to Sep 2021",endpoint:vt},{title:"text-davinci-003",model:"text-davinci-003",defaultSelected:!1,description:"Can do any language task with better quality, longer output, and consistent instruction-following than the curie, babbage, or ada models. Also supports inserting completions within text.",maxTokens:4097,trainingData:"Up to Jun 2021",endpoint:"https://api.openai.com/v1/completions"},{title:"text-davinci-002",model:"text-davinci-002",defaultSelected:!1,description:"Similar capabilities to text-davinci-003 but trained with supervised fine-tuning instead of reinforcement learning",maxTokens:4097,trainingData:"Up to Jun 2021",endpoint:"https://api.openai.com/v1/completions"},{title:"code-davinci-002",model:"code-davinci-002",defaultSelected:!1,description:"Optimized for code-completion tasks",maxTokens:8001,trainingData:"Up to Jun 2021",endpoint:"https://api.openai.com/v1/completions"},{title:"GPT-4o",model:"gpt-4o",defaultSelected:!1,maxTokens:128e3,description:"Our most advanced, multimodal flagship model that\u2019s cheaper and faster than GPT-4 Turbo. Currently points to gpt-4o-2024-05-13.",endpoint:vt,inputCost:.0025,outputCost:.01},{title:"GPT-4o mini",model:"gpt-4o-mini",defaultSelected:!1,maxTokens:128e3,description:"GPT-4o mini is our most cost-efficient small model that\u2019s smarter and cheaper than GPT-3.5 Turbo, and has vision capabilities. The model has 128K context and an October 2023 knowledge cutoff.",endpoint:vt,inputCost:15e-5,outputCost:6e-4},{title:"o3-mini",model:"o3-mini",defaultSelected:!1,maxTokens:2e5,description:"o3-mini is our cost-efficient reasoning model that\u2019s optimized for coding, math, and science, and supports tools and Structured Outputs.",endpoint:vt,inputCost:.0011,outputCost:.0044},{title:"o1",model:"o1",defaultSelected:!1,maxTokens:2e5,description:"o1 is our frontier reasoning model that supports tools, Structured Outputs, and vision. The model has 200K context and an October 2023 knowledge cutoff.",endpoint:vt,inputCost:.015,outputCost:.06}],mapModelsResponse:r=>r.data?.map(e=>({slug:e.id,title:e.id}))};var Ct=class{static{this.configs={web:$r,api:zh,"deepseek-api":Uh,"deepseek-chat":Rs}}static getConfig(e){return this.configs[e]}static getList(){return Object.entries(this.configs).map(([e,t])=>({id:e,title:t.title}))}static getDefaultModel(e,t){let{models:n}=t||{},{preferredModels:i}=this.getConfig(e);if(!n)return i[i.length-1];for(let a of i)if(n?.some(s=>s.slug===a))return a;throw new Error(`No available models for provider: ${e}`)}static findModel(e,t){return this.configs[t].models.find(n=>n.model===e)}};var Vn=pe(_t());var Ns=pe(_t());var Bh=navigator.userAgent.indexOf("Edg/")>-1,hP=Bh?`https://microsoftedge.microsoft.com/addons/detail/${Ns.default.runtime.id}`:`https://chrome.google.com/webstore/detail/${Ns.default.runtime.id}`,Kh=Bh?`https://chrome.google.com/webstore/detail/${Ns.default.runtime.id}/support`:hP;async function Ms(){return Ns.default.storage.local.get({provider:"web",model:$r.fallbackModel,apiKey:""})}var Vh=pe(_t());async function Lr(r){let e=new TextEncoder().encode(r),t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(a=>a.toString(16).padStart(2,"0")).join("")}function Hh(r){return new Intl.DisplayNames(["en"],{type:"language"}).of(r)}function Gh(){return(Vh.default.i18n.getUILanguage()||navigator.language||"en").replace(/-.*/,"")}var gP="https://www.google-analytics.com/mp/collect",yP="https://www.google-analytics.com/debug/mp/collect",bP="G-FCQ8WJYLXW",wP="chVoA6g7TqSkTyhEV08ekg",_P=100,vP=30,Op=class r{constructor(e){this.debug=e}static getInstance(e=!1){return r.instance||(r.instance=new r(e)),r.instance}async initClientId(){let{clientId:e}=await Vn.default.storage.local.get("clientId");e?this.clientId=e:(this.clientId=crypto.randomUUID(),await Vn.default.storage.local.set({clientId:this.clientId}))}async getOrCreateClientId(){return this.clientId||await this.initClientId(),this.clientId}async getOrCreateSessionId(){let{sessionData:e}=await Vn.default.storage.session.get("sessionData"),t=Date.now();return e&&"timestamp"in e&&((t-Number(e.timestamp))/6e4>vP?e=void 0:(e.timestamp=t,await Vn.default.storage.session.set({sessionData:e}))),e||(e={session_id:t.toString(),timestamp:t.toString()},await Vn.default.storage.session.set({sessionData:e})),e.session_id}async fireEvent(e,t={}){t.session_id||(t.session_id=await this.getOrCreateSessionId()),t.engagement_time_msec||(t.engagement_time_msec=_P);try{let i=Vn.default.runtime.getManifest().version,{provider:a,model:s}=await Ms();t={...t,provider:a,model:s,language:Gh(),version:i};let o=await fetch(`${this.debug?yP:gP}?measurement_id=${bP}&api_secret=${wP}`,{method:"POST",body:JSON.stringify({client_id:await this.getOrCreateClientId(),events:[{name:e,params:t}]})});if(!this.debug)return;console.log(await o.text())}catch(n){console.error("Google Analytics request failed with an exception",n)}}async firePageViewEvent(e,t,n={}){return this.fireEvent("page_view",{page_title:e,page_location:t,...n})}async fireErrorEvent(e={}){return"message"in e&&typeof e.message=="string"&&e.message.includes("Unusual activity has been detected")&&(e.message="Unusual activity has been detected from your device. Try again later."),this.fireEvent("extension_error",e)}},xP=Op.getInstance(),xt=xP;var _u=class{constructor(e,t){this.ERROR_LIMIT=e,this.TIME_FRAME=t,this.errorTimestamps=[],this.isReportingError=!1}canReportError(){let e=Date.now();return this.errorTimestamps=this.errorTimestamps.filter(t=>e-t<this.TIME_FRAME),this.errorTimestamps.length<this.ERROR_LIMIT}reportError(e){if(this.isReportingError||!this.canReportError())return;this.isReportingError=!0;let t;e instanceof ErrorEvent?t={type:"ErrorEvent",message:e.message,source:e.filename,lineno:e.lineno,colno:e.colno,error:e.error}:e instanceof PromiseRejectionEvent?t={type:"PromiseRejectionEvent",message:e.reason.toString()}:t={type:"UnknownEvent",data:e};try{xt.fireErrorEvent(t),this.errorTimestamps.push(Date.now())}catch(n){console.error("Failed to report error:",n)}finally{this.isReportingError=!1}}};var eg=pe(Qh()),vu=pe(_t());var Ip="accessToken",Tp=new eg.default(10*1e3);async function Cp(){let{deviceId:r}=await vu.default.storage.local.get("oai-deviceId");return r||(r=crypto.randomUUID(),await vu.default.storage.local.set({"oai-deviceId":r}),r)}async function na(r,e,t,n){return fetch(`${$r.endpoint}/backend-api${t}`,{method:e,headers:{"Content-Type":"application/json","Oai-Device-Id":await Cp(),"Oai-Language":"en-us",Authorization:`Bearer ${r}`},body:n===void 0?void 0:JSON.stringify(n)})}async function js(){if(Tp.get(Ip))return Tp.get(Ip);let r=await fetch(`${$r.endpoint}/api/auth/session`);if(r.status===403)throw new Error("CLOUDFLARE");let e=await r.json().catch(t=>(xt.fireErrorEvent({message:t}),{}));if(!e.accessToken)throw new Error("UNAUTHORIZED");return Tp.set(Ip,e.accessToken),e.accessToken}async function xu(){let r=await js(),e=await vu.default.runtime.sendMessage({type:"GET_CHAT_REQ_TOKEN",to:"popup"});return(await na(r,"POST","/sentinel/chat-requirements",{p:e})).json()}async function Au(r){return r??=await js(),(await na(r,"GET","/models").then(t=>t.json())).models}var Pu,EP=new Uint8Array(16);function $s(){if(!Pu&&(Pu=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Pu))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Pu(EP)}var $e=[];for(let r=0;r<256;++r)$e.push((r+256).toString(16).slice(1));function Ou(r,e=0){return $e[r[e+0]]+$e[r[e+1]]+$e[r[e+2]]+$e[r[e+3]]+"-"+$e[r[e+4]]+$e[r[e+5]]+"-"+$e[r[e+6]]+$e[r[e+7]]+"-"+$e[r[e+8]]+$e[r[e+9]]+"-"+$e[r[e+10]]+$e[r[e+11]]+$e[r[e+12]]+$e[r[e+13]]+$e[r[e+14]]+$e[r[e+15]]}var tg,Sp,kp=0,Rp=0;function IP(r,e,t){let n=e&&t||0,i=e||new Array(16);r=r||{};let a=r.node||tg,s=r.clockseq!==void 0?r.clockseq:Sp;if(a==null||s==null){let d=r.random||(r.rng||$s)();a==null&&(a=tg=[d[0]|1,d[1],d[2],d[3],d[4],d[5]]),s==null&&(s=Sp=(d[6]<<8|d[7])&16383)}let o=r.msecs!==void 0?r.msecs:Date.now(),u=r.nsecs!==void 0?r.nsecs:Rp+1,l=o-kp+(u-Rp)/1e4;if(l<0&&r.clockseq===void 0&&(s=s+1&16383),(l<0||o>kp)&&r.nsecs===void 0&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");kp=o,Rp=u,Sp=s,o+=122192928e5;let c=((o&268435455)*1e4+u)%4294967296;i[n++]=c>>>24&255,i[n++]=c>>>16&255,i[n++]=c>>>8&255,i[n++]=c&255;let p=o/4294967296*1e4&268435455;i[n++]=p>>>8&255,i[n++]=p&255,i[n++]=p>>>24&15|16,i[n++]=p>>>16&255,i[n++]=s>>>8|128,i[n++]=s&255;for(let d=0;d<6;++d)i[n+d]=a[d];return e||Ou(i)}var Hn=IP;var TP=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Np={randomUUID:TP};function CP(r,e,t){if(Np.randomUUID&&!e&&!r)return Np.randomUUID();r=r||{};let n=r.random||(r.rng||$s)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(let i=0;i<16;++i)e[t+i]=n[i];return e}return Ou(n)}var ia=CP;var rg=pe(_t());async function ng(){return(await rg.default.storage.local.get("deepseek-token"))["deepseek-token"]}function Mp(){return`intercom-HWWAFSESTIME=${Date.now()}; HWWAFSESID=${SP()}; Hm_lvt_${Hn()}=${parseInt(`${Date.now()/1e3}`)},${parseInt(`${Date.now()/1e3}`)},${parseInt(`${Date.now()/1e3}`)}; Hm_lpvt_${Hn()}=${parseInt(`${Date.now()/1e3}`)}; _frid=${Hn()}; _fr_ssid=${Hn()}; _fr_pvid=${Hn()}`}function SP(){let r="0123456789abcdef",e="";for(let t=0;t<18;t++)e+=r[Math.floor(Math.random()*r.length)];return e}async function ig(r,e){if(!e)throw new Error("No token provided");let t=await fetch(r,{headers:{Authorization:`Bearer ${e}`}}),n=await t.json();if(!t.ok)throw new Error(n?.detail?.message||"Unknown Error");return n}async function ag(r){let e=Ct.getConfig("api");return(await e.mapModelsResponse(await ig(e.modelsUrl,r))).some(n=>n.slug==="gpt-4o")}var Ls=pe(_t());function kP(){return(Ls.default.i18n.getUILanguage()||navigator.language||"en").replace(/-.*/,"")}async function sg(){let{model:r}=await Ls.default.storage.local.get({model:$r.fallbackModel}),e=r.startsWith("gpt-4");return await Ls.default.storage.local.get({question:Ls.default.i18n.getMessage(e?"defaultQuestionGPT4":"defaultQuestion"),systemMessage:"",selectedLanguage:kP(),provider:"web",model:r,apiKey:""})}Ae();var Yl="RFC3986",Xl={RFC1738:r=>String(r).replace(/%20/g,"+"),RFC3986:r=>String(r)},H_="RFC1738";var RS=Array.isArray,br=(()=>{let r=[];for(let e=0;e<256;++e)r.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return r})();var tm=1024,G_=(r,e,t,n,i)=>{if(r.length===0)return r;let a=r;if(typeof r=="symbol"?a=Symbol.prototype.toString.call(r):typeof r!="string"&&(a=String(r)),t==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let s="";for(let o=0;o<a.length;o+=tm){let u=a.length>=tm?a.slice(o,o+tm):a,l=[];for(let c=0;c<u.length;++c){let p=u.charCodeAt(c);if(p===45||p===46||p===95||p===126||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||i===H_&&(p===40||p===41)){l[l.length]=u.charAt(c);continue}if(p<128){l[l.length]=br[p];continue}if(p<2048){l[l.length]=br[192|p>>6]+br[128|p&63];continue}if(p<55296||p>=57344){l[l.length]=br[224|p>>12]+br[128|p>>6&63]+br[128|p&63];continue}c+=1,p=65536+((p&1023)<<10|u.charCodeAt(c)&1023),l[l.length]=br[240|p>>18]+br[128|p>>12&63]+br[128|p>>6&63]+br[128|p&63]}s+=l.join("")}return s};function W_(r){return!r||typeof r!="object"?!1:!!(r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer(r))}function rm(r,e){if(RS(r)){let t=[];for(let n=0;n<r.length;n+=1)t.push(e(r[n]));return t}return e(r)}var NS=Object.prototype.hasOwnProperty,Z_={brackets(r){return String(r)+"[]"},comma:"comma",indices(r,e){return String(r)+"["+e+"]"},repeat(r){return String(r)}},wr=Array.isArray,MS=Array.prototype.push,J_=function(r,e){MS.apply(r,wr(e)?e:[e])},jS=Date.prototype.toISOString,Te={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:G_,encodeValuesOnly:!1,format:Yl,formatter:Xl[Yl],indices:!1,serializeDate(r){return jS.call(r)},skipNulls:!1,strictNullHandling:!1};function $S(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof r=="symbol"||typeof r=="bigint"}var nm={};function Y_(r,e,t,n,i,a,s,o,u,l,c,p,d,f,m,h,y,_){let b=r,O=_,v=0,x=!1;for(;(O=O.get(nm))!==void 0&&!x;){let Q=O.get(r);if(v+=1,typeof Q<"u"){if(Q===v)throw new RangeError("Cyclic object value");x=!0}typeof O.get(nm)>"u"&&(v=0)}if(typeof l=="function"?b=l(e,b):b instanceof Date?b=d?.(b):t==="comma"&&wr(b)&&(b=rm(b,function(Q){return Q instanceof Date?d?.(Q):Q})),b===null){if(a)return u&&!h?u(e,Te.encoder,y,"key",f):e;b=""}if($S(b)||W_(b)){if(u){let Q=h?e:u(e,Te.encoder,y,"key",f);return[m?.(Q)+"="+m?.(u(b,Te.encoder,y,"value",f))]}return[m?.(e)+"="+m?.(String(b))]}let C=[];if(typeof b>"u")return C;let R;if(t==="comma"&&wr(b))h&&u&&(b=rm(b,u)),R=[{value:b.length>0?b.join(",")||null:void 0}];else if(wr(l))R=l;else{let Q=Object.keys(b);R=c?Q.sort(c):Q}let q=o?String(e).replace(/\./g,"%2E"):String(e),re=n&&wr(b)&&b.length===1?q+"[]":q;if(i&&wr(b)&&b.length===0)return re+"[]";for(let Q=0;Q<R.length;++Q){let $=R[Q],Qe=typeof $=="object"&&typeof $.value<"u"?$.value:b[$];if(s&&Qe===null)continue;let he=p&&o?$.replace(/\./g,"%2E"):$,dn=wr(b)?typeof t=="function"?t(re,he):re:re+(p?"."+he:"["+he+"]");_.set(r,v);let fn=new WeakMap;fn.set(nm,_),J_(C,Y_(Qe,dn,t,n,i,a,s,o,t==="comma"&&h&&wr(b)?null:u,l,c,p,d,f,m,h,y,fn))}return C}function LS(r=Te){if(typeof r.allowEmptyArrays<"u"&&typeof r.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof r.encodeDotInKeys<"u"&&typeof r.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(r.encoder!==null&&typeof r.encoder<"u"&&typeof r.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=r.charset||Te.charset;if(typeof r.charset<"u"&&r.charset!=="utf-8"&&r.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Yl;if(typeof r.format<"u"){if(!NS.call(Xl,r.format))throw new TypeError("Unknown format option provided.");t=r.format}let n=Xl[t],i=Te.filter;(typeof r.filter=="function"||wr(r.filter))&&(i=r.filter);let a;if(r.arrayFormat&&r.arrayFormat in Z_?a=r.arrayFormat:"indices"in r?a=r.indices?"indices":"repeat":a=Te.arrayFormat,"commaRoundTrip"in r&&typeof r.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let s=typeof r.allowDots>"u"?r.encodeDotInKeys?!0:Te.allowDots:!!r.allowDots;return{addQueryPrefix:typeof r.addQueryPrefix=="boolean"?r.addQueryPrefix:Te.addQueryPrefix,allowDots:s,allowEmptyArrays:typeof r.allowEmptyArrays=="boolean"?!!r.allowEmptyArrays:Te.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof r.charsetSentinel=="boolean"?r.charsetSentinel:Te.charsetSentinel,commaRoundTrip:!!r.commaRoundTrip,delimiter:typeof r.delimiter>"u"?Te.delimiter:r.delimiter,encode:typeof r.encode=="boolean"?r.encode:Te.encode,encodeDotInKeys:typeof r.encodeDotInKeys=="boolean"?r.encodeDotInKeys:Te.encodeDotInKeys,encoder:typeof r.encoder=="function"?r.encoder:Te.encoder,encodeValuesOnly:typeof r.encodeValuesOnly=="boolean"?r.encodeValuesOnly:Te.encodeValuesOnly,filter:i,format:t,formatter:n,serializeDate:typeof r.serializeDate=="function"?r.serializeDate:Te.serializeDate,skipNulls:typeof r.skipNulls=="boolean"?r.skipNulls:Te.skipNulls,sort:typeof r.sort=="function"?r.sort:null,strictNullHandling:typeof r.strictNullHandling=="boolean"?r.strictNullHandling:Te.strictNullHandling}}function im(r,e={}){let t=r,n=LS(e),i,a;typeof n.filter=="function"?(a=n.filter,t=a("",t)):wr(n.filter)&&(a=n.filter,i=a);let s=[];if(typeof t!="object"||t===null)return"";let o=Z_[n.arrayFormat],u=o==="comma"&&n.commaRoundTrip;i||(i=Object.keys(t)),n.sort&&i.sort(n.sort);let l=new WeakMap;for(let d=0;d<i.length;++d){let f=i[d];n.skipNulls&&t[f]===null||J_(s,Y_(t[f],f,o,u,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,l))}let c=s.join(n.delimiter),p=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),c.length>0?p+c:""}var Ei="4.71.0";var X_=!1,Ii,am,FS,qS,US,sm,zS,Ql,om,um,lm,ec,cm;function Q_(r,e={auto:!1}){if(X_)throw new Error(`you must \`import 'openai/shims/${r.kind}'\` before importing anything else from openai`);if(Ii)throw new Error(`can't \`import 'openai/shims/${r.kind}'\` after \`import 'openai/shims/${Ii}'\``);X_=e.auto,Ii=r.kind,am=r.fetch,FS=r.Request,qS=r.Response,US=r.Headers,sm=r.FormData,zS=r.Blob,Ql=r.File,om=r.ReadableStream,um=r.getMultipartRequestOptions,lm=r.getDefaultAgent,ec=r.fileFromPath,cm=r.isFsReadStream}var tc=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function ev({manuallyImported:r}={}){let e=r?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,n,i,a;try{t=fetch,n=Request,i=Response,a=Headers}catch(s){throw new Error(`this environment is missing the following Web Fetch API type: ${s.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:i,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(s,o)=>({...o,body:new tc(s)}),getDefaultAgent:s=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:s=>!1}}Ii||Q_(ev(),{auto:!0});var z=class extends Error{},Pe=class r extends z{constructor(e,t,n,i){super(`${r.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.request_id=i?.["x-request-id"];let a=t;this.error=a,this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,n){let i=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e)return new en({message:n,cause:rc(t)});let a=t?.error;return e===400?new Fa(e,a,n,i):e===401?new qa(e,a,n,i):e===403?new Ua(e,a,n,i):e===404?new za(e,a,n,i):e===409?new Ba(e,a,n,i):e===422?new Ka(e,a,n,i):e===429?new Va(e,a,n,i):e>=500?new Ha(e,a,n,i):new r(e,a,n,i)}},we=class extends Pe{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},en=class extends Pe{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},rr=class extends en{constructor({message:e}={}){super({message:e??"Request timed out."})}},Fa=class extends Pe{constructor(){super(...arguments),this.status=400}},qa=class extends Pe{constructor(){super(...arguments),this.status=401}},Ua=class extends Pe{constructor(){super(...arguments),this.status=403}},za=class extends Pe{constructor(){super(...arguments),this.status=404}},Ba=class extends Pe{constructor(){super(...arguments),this.status=409}},Ka=class extends Pe{constructor(){super(...arguments),this.status=422}},Va=class extends Pe{constructor(){super(...arguments),this.status=429}},Ha=class extends Pe{},Ga=class extends z{constructor(){super("Could not parse response content as the length limit was reached")}},Wa=class extends z{constructor(){super("Could not parse response content as the request was rejected by the content filter")}};var Ti=class r{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let n=r.NEWLINE_CHARS.has(t[t.length-1]||""),i=t.split(r.NEWLINE_REGEXP);return n&&i.pop(),i.length===1&&!n?(this.buffer.push(i[0]),[]):(this.buffer.length>0&&(i=[this.buffer.join("")+i[0],...i.slice(1)],this.buffer=[]),n||(this.buffer=[i.pop()||""]),i)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new z(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new z(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new z("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};Ti.NEWLINE_CHARS=new Set([`
`,"\r"]);Ti.NEWLINE_REGEXP=/\r\n|[\n\r]/g;var _r=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(let s of VS(e,t))if(!a){if(s.data.startsWith("[DONE]")){a=!0;continue}if(s.event===null){let o;try{o=JSON.parse(s.data)}catch(u){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),u}if(o&&o.error)throw new Pe(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(s.data)}catch(u){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),u}if(s.event=="error")throw new Pe(void 0,o.error,o.message,void 0);yield{event:s.event,data:o}}}a=!0}catch(s){if(s instanceof Error&&s.name==="AbortError")return;throw s}finally{a||t.abort()}}return new r(i,t)}static fromReadableStream(e,t){let n=!1;async function*i(){let s=new Ti,o=tv(e);for await(let u of o)for(let l of s.decode(u))yield l;for(let u of s.flush())yield u}async function*a(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(let o of i())s||o&&(yield JSON.parse(o));s=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{s||t.abort()}}return new r(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],n=this.iterator(),i=a=>({next:()=>{if(a.length===0){let s=n.next();e.push(s),t.push(s)}return a.shift()}});return[new r(()=>i(e),this.controller),new r(()=>i(t),this.controller)]}toReadableStream(){let e=this,t,n=new TextEncoder;return new om({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{let{value:a,done:s}=await t.next();if(s)return i.close();let o=n.encode(JSON.stringify(a)+`
`);i.enqueue(o)}catch(a){i.error(a)}},async cancel(){await t.return?.()}})}};async function*VS(r,e){if(!r.body)throw e.abort(),new z("Attempted to iterate over a response with no body");let t=new pm,n=new Ti,i=tv(r.body);for await(let a of HS(i))for(let s of n.decode(a)){let o=t.decode(s);o&&(yield o)}for(let a of n.flush()){let s=t.decode(a);s&&(yield s)}}async function*HS(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,i=new Uint8Array(e.length+n.length);i.set(e),i.set(n,e.length),e=i;let a;for(;(a=GS(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}function GS(r){for(let n=0;n<r.length-2;n++){if(r[n]===10&&r[n+1]===10||r[n]===13&&r[n+1]===13)return n+2;if(r[n]===13&&r[n+1]===10&&n+3<r.length&&r[n+2]===13&&r[n+3]===10)return n+4}return-1}var pm=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,i]=WS(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}};function WS(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}function tv(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var rv=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",nv=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&Ro(r),Ro=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",ZS=r=>nv(r)||rv(r)||cm(r);async function mm(r,e,t){if(r=await r,nv(r))return r;if(rv(r)){let i=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");let a=Ro(i)?[await i.arrayBuffer()]:[i];return new Ql(a,e,t)}let n=await JS(r);if(e||(e=XS(r)??"unknown_file"),!t?.type){let i=n[0]?.type;typeof i=="string"&&(t={...t,type:i})}return new Ql(n,e,t)}async function JS(r){let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(Ro(r))e.push(await r.arrayBuffer());else if(QS(r))for await(let t of r)e.push(t);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${r?.constructor?.name}; props: ${YS(r)}`);return e}function YS(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function XS(r){return dm(r.name)||dm(r.filename)||dm(r.path)?.split(/[\\/]/).pop()}var dm=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},QS=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",hm=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody";var zt=async r=>{let e=await iv(r.body);return um(e,r)},iv=async r=>{let e=new sm;return await Promise.all(Object.entries(r||{}).map(([t,n])=>fm(e,t,n))),e};var fm=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(ZS(t)){let n=await mm(t);r.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>fm(r,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>fm(r,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var tk=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},rk=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},nc;async function cv(r){let{response:e}=r;if(r.options.stream)return Za("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):_r.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let a=await e.json();return Za("response",e.status,e.url,e.headers,a),pv(a,e)}let i=await e.text();return Za("response",e.status,e.url,e.headers,i),i}function pv(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var ic=class r extends Promise{constructor(e,t=cv){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new r(this.responsePromise,async t=>pv(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},ac=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:i,fetch:a}){this.baseURL=e,this.maxRetries=gm("maxRetries",t),this.timeout=gm("timeout",n),this.httpAgent=i,this.fetch=a??am}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ok(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${pk()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async i=>{let a=i&&Ro(i?.body)?new DataView(await i.body.arrayBuffer()):i?.body instanceof DataView?i.body:i?.body instanceof ArrayBuffer?new DataView(i.body):i&&ArrayBuffer.isView(i?.body)?new DataView(i.body.buffer):i?.body;return{method:e,path:t,...i,body:a}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let{method:n,path:i,query:a,headers:s={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:hm(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),l=this.buildURL(i,a);"timeout"in e&&gm("timeout",e.timeout);let c=e.timeout??this.timeout,p=e.httpAgent??this.httpAgent??lm(l),d=c+1e3;typeof p?.options?.timeout=="number"&&d>(p.options.timeout??0)&&(p.options.timeout=d),this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let f=this.buildHeaders({options:e,headers:s,contentLength:u,retryCount:t});return{req:{method:n,...o&&{body:o},headers:f,...p&&{agent:p},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:i}){let a={};n&&(a["content-length"]=n);let s=this.defaultHeaders(e);return uv(a,s),uv(a,t),hm(e.body)&&Ii!=="node"&&delete a["content-type"],lv(s,"x-stainless-retry-count")===void 0&&lv(t,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(i)),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,i){return Pe.generate(e,t,n,i)}request(e,t=null){return new ic(this.makeRequest(e,t))}async makeRequest(e,t){let n=await e,i=n.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);let{req:a,url:s,timeout:o}=this.buildRequest(n,{retryCount:i-t});if(await this.prepareRequest(a,{url:s,options:n}),Za("request",s,n,a.headers),n.signal?.aborted)throw new we;let u=new AbortController,l=await this.fetchWithTimeout(s,a,o,u).catch(rc);if(l instanceof Error){if(n.signal?.aborted)throw new we;if(t)return this.retryRequest(n,t);throw l.name==="AbortError"?new rr:new en({cause:l})}let c=nk(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){let y=`retrying, ${t} attempts remaining`;return Za(`response (error; ${y})`,l.status,s,c),this.retryRequest(n,t,c)}let p=await l.text().catch(y=>rc(y).message),d=uk(p),f=d?void 0:p;throw Za(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,s,c,f),this.makeStatusError(l.status,d,f,c)}return{response:l,options:n,controller:u}}requestAPIList(e,t){let n=this.makeRequest(t,null);return new ym(this,n,e)}buildURL(e,t){let n=ck(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return dv(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new z(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,i){let{signal:a,...s}=t||{};a&&a.addEventListener("abort",()=>i.abort());let o=setTimeout(()=>i.abort(),n);return this.getRequestClient().fetch.call(void 0,e,{signal:i.signal,...s}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let i,a=n?.["retry-after-ms"];if(a){let o=parseFloat(a);Number.isNaN(o)||(i=o)}let s=n?.["retry-after"];if(s&&!i){let o=parseFloat(s);Number.isNaN(o)?i=Date.parse(s)-Date.now():i=o*1e3}if(!(i&&0<=i&&i<60*1e3)){let o=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,o)}return await tn(i),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let a=t-e,s=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return s*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ei}`}},No=class{constructor(e,t,n,i){nc.set(this,void 0),tk(this,nc,e,"f"),this.options=i,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new z("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[i,a]of n)e.url.searchParams.set(i,a);t.query=void 0,t.path=e.url.toString()}return await rk(this,nc,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(nc=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},ym=class extends ic{constructor(e,t,n){super(t,async i=>new n(e,i.response,await cv(i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},nk=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){let n=t.toString();return e[n.toLowerCase()]||e[n]}}),ik={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ue=r=>typeof r=="object"&&r!==null&&!dv(r)&&Object.keys(r).every(e=>fv(ik,e)),ak=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ei,"X-Stainless-OS":sv(Deno.build.os),"X-Stainless-Arch":av(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ei,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ei,"X-Stainless-OS":sv(process.platform),"X-Stainless-Arch":av(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let r=sk();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ei,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ei,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function sk(){if(typeof navigator>"u"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let n=t.exec(navigator.userAgent);if(n){let i=n[1]||0,a=n[2]||0,s=n[3]||0;return{browser:e,version:`${i}.${a}.${s}`}}}return null}var av=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",sv=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),ov,ok=()=>ov??(ov=ak()),uk=r=>{try{return JSON.parse(r)}catch{return}},lk=new RegExp("^(?:[a-z]+:)?//","i"),ck=r=>lk.test(r),tn=r=>new Promise(e=>setTimeout(e,r)),gm=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new z(`${r} must be an integer`);if(e<0)throw new z(`${r} must be a positive integer`);return e},rc=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(r)};var Mo=r=>{if(typeof process<"u")return process.env?.[r]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(r)?.trim()};function dv(r){if(!r)return!0;for(let e in r)return!1;return!0}function fv(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function uv(r,e){for(let t in e){if(!fv(e,t))continue;let n=t.toLowerCase();if(!n)continue;let i=e[t];i===null?delete r[n]:i!==void 0&&(r[n]=i)}}function Za(r,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${r}`,...e)}var pk=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),mv=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",dk=r=>typeof r?.get=="function";var lv=(r,e)=>{let t=e.toLowerCase();if(dk(r)){let n=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(i,a,s)=>a+s.toUpperCase());for(let i of[e,t,e.toUpperCase(),n]){let a=r.get(i);if(a)return a}}for(let[n,i]of Object.entries(r))if(n.toLowerCase()===t)return Array.isArray(i)?(i.length<=1||console.warn(`Received ${i.length} entries for the ${e} header, using the first entry.`),i[0]):i};function jo(r){return r!=null&&typeof r=="object"&&!Array.isArray(r)}var sc=class extends No{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}},fe=class extends No{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}};var k=class{constructor(e){this._client=e}};var Ja=class extends k{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};var Sn=class extends k{constructor(){super(...arguments),this.completions=new Ja(this._client)}};Sn.Completions=Ja;var Ya=class extends k{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};var Xa=class extends k{create(e,t){return this._client.post("/audio/transcriptions",zt({body:e,...t}))}};var Qa=class extends k{create(e,t){return this._client.post("/audio/translations",zt({body:e,...t}))}};var vr=class extends k{constructor(){super(...arguments),this.transcriptions=new Xa(this._client),this.translations=new Qa(this._client),this.speech=new Ya(this._client)}};vr.Transcriptions=Xa;vr.Translations=Qa;vr.Speech=Ya;var kn=class extends k{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/batches",Si,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},Si=class extends fe{};kn.BatchesPage=Si;var ki=class extends k{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/assistants",es,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},es=class extends fe{};ki.AssistantsPage=es;function bm(r){return typeof r.parse=="function"}var Rn=r=>r?.role==="assistant",wm=r=>r?.role==="function",_m=r=>r?.role==="tool";var nr=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},me=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},vm,oc,uc,$o,Lo,lc,Do,rn,Fo,cc,pc,ts,hv,rs=class{constructor(){vm.add(this),this.controller=new AbortController,oc.set(this,void 0),uc.set(this,()=>{}),$o.set(this,()=>{}),Lo.set(this,void 0),lc.set(this,()=>{}),Do.set(this,()=>{}),rn.set(this,{}),Fo.set(this,!1),cc.set(this,!1),pc.set(this,!1),ts.set(this,!1),nr(this,oc,new Promise((e,t)=>{nr(this,uc,e,"f"),nr(this,$o,t,"f")}),"f"),nr(this,Lo,new Promise((e,t)=>{nr(this,lc,e,"f"),nr(this,Do,t,"f")}),"f"),me(this,oc,"f").catch(()=>{}),me(this,Lo,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},me(this,vm,"m",hv).bind(this))},0)}_connected(){this.ended||(me(this,uc,"f").call(this),this._emit("connect"))}get ended(){return me(this,Fo,"f")}get errored(){return me(this,cc,"f")}get aborted(){return me(this,pc,"f")}abort(){this.controller.abort()}on(e,t){return(me(this,rn,"f")[e]||(me(this,rn,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=me(this,rn,"f")[e];if(!n)return this;let i=n.findIndex(a=>a.listener===t);return i>=0&&n.splice(i,1),this}once(e,t){return(me(this,rn,"f")[e]||(me(this,rn,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{nr(this,ts,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){nr(this,ts,!0,"f"),await me(this,Lo,"f")}_emit(e,...t){if(me(this,Fo,"f"))return;e==="end"&&(nr(this,Fo,!0,"f"),me(this,lc,"f").call(this));let n=me(this,rn,"f")[e];if(n&&(me(this,rn,"f")[e]=n.filter(i=>!i.once),n.forEach(({listener:i})=>i(...t))),e==="abort"){let i=t[0];!me(this,ts,"f")&&!n?.length&&Promise.reject(i),me(this,$o,"f").call(this,i),me(this,Do,"f").call(this,i),this._emit("end");return}if(e==="error"){let i=t[0];!me(this,ts,"f")&&!n?.length&&Promise.reject(i),me(this,$o,"f").call(this,i),me(this,Do,"f").call(this,i),this._emit("end")}}_emitFinal(){}};oc=new WeakMap,uc=new WeakMap,$o=new WeakMap,Lo=new WeakMap,lc=new WeakMap,Do=new WeakMap,rn=new WeakMap,Fo=new WeakMap,cc=new WeakMap,pc=new WeakMap,ts=new WeakMap,vm=new WeakSet,hv=function(e){if(nr(this,cc,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new we),e instanceof we)return nr(this,pc,!0,"f"),this._emit("abort",e);if(e instanceof z)return this._emit("error",e);if(e instanceof Error){let t=new z(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new z(String(e)))};function gv(r,e){let t={...r};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function xm(r){return r?.$brand==="auto-parseable-response-format"}function yv(r,{parser:e,callback:t}){let n={...r};return Object.defineProperties(n,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),n}function Ri(r){return r?.$brand==="auto-parseable-tool"}function bv(r,e){return!e||!Am(e)?{...r,choices:r.choices.map(t=>({...t,message:{...t.message,parsed:null,tool_calls:t.message.tool_calls??[]}}))}:qo(r,e)}function qo(r,e){let t=r.choices.map(n=>{if(n.finish_reason==="length")throw new Ga;if(n.finish_reason==="content_filter")throw new Wa;return{...n,message:{...n.message,tool_calls:n.message.tool_calls?.map(i=>wk(e,i))??[],parsed:n.message.content&&!n.message.refusal?bk(e,n.message.content):null}}});return{...r,choices:t}}function bk(r,e){return r.response_format?.type!=="json_schema"?null:r.response_format?.type==="json_schema"?"$parseRaw"in r.response_format?r.response_format.$parseRaw(e):JSON.parse(e):null}function wk(r,e){let t=r.tools?.find(n=>n.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:Ri(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function wv(r,e){if(!r)return!1;let t=r.tools?.find(n=>n.function?.name===e.function.name);return Ri(t)||t?.function.strict||!1}function Am(r){return xm(r.response_format)?!0:r.tools?.some(e=>Ri(e)||e.type==="function"&&e.function.strict===!0)??!1}function _v(r){for(let e of r??[]){if(e.type!=="function")throw new z(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new z(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var gt=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},We,Pm,dc,Om,Em,Im,xv,Tm,vv=10,ns=class extends rs{constructor(){super(...arguments),We.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(wm(e)||_m(e))&&e.content)this._emit("functionCallResult",e.content);else if(Rn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Rn(e)&&e.tool_calls)for(let n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new z("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),gt(this,We,"m",Pm).call(this)}async finalMessage(){return await this.done(),gt(this,We,"m",dc).call(this)}async finalFunctionCall(){return await this.done(),gt(this,We,"m",Om).call(this)}async finalFunctionCallResult(){return await this.done(),gt(this,We,"m",Em).call(this)}async totalUsage(){return await this.done(),gt(this,We,"m",Im).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=gt(this,We,"m",dc).call(this);t&&this._emit("finalMessage",t);let n=gt(this,We,"m",Pm).call(this);n&&this._emit("finalContent",n);let i=gt(this,We,"m",Om).call(this);i&&this._emit("finalFunctionCall",i);let a=gt(this,We,"m",Em).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(s=>s.usage)&&this._emit("totalUsage",gt(this,We,"m",Im).call(this))}async _createChatCompletion(e,t,n){let i=n?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),gt(this,We,"m",xv).call(this,t);let a=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(qo(a,t))}async _runChatCompletion(e,t,n){for(let i of t.messages)this._addMessage(i,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){let i="function",{function_call:a="auto",stream:s,...o}=t,u=typeof a!="string"&&a?.name,{maxChatCompletions:l=vv}=n||{},c={};for(let d of t.functions)c[d.name||d.function.name]=d;let p=t.functions.map(d=>({name:d.name||d.function.name,parameters:d.parameters,description:d.description}));for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let m=(await this._createChatCompletion(e,{...o,function_call:a,functions:p,messages:[...this.messages]},n)).choices[0]?.message;if(!m)throw new z("missing message in ChatCompletion response");if(!m.function_call)return;let{name:h,arguments:y}=m.function_call,_=c[h];if(_){if(u&&u!==h){let x=`Invalid function_call: ${JSON.stringify(h)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:i,name:h,content:x});continue}}else{let x=`Invalid function_call: ${JSON.stringify(h)}. Available options are: ${p.map(C=>JSON.stringify(C.name)).join(", ")}. Please try again`;this._addMessage({role:i,name:h,content:x});continue}let b;try{b=bm(_)?await _.parse(y):y}catch(x){this._addMessage({role:i,name:h,content:x instanceof Error?x.message:String(x)});continue}let O=await _.function(b,this),v=gt(this,We,"m",Tm).call(this,O);if(this._addMessage({role:i,name:h,content:v}),u)return}}async _runTools(e,t,n){let i="tool",{tool_choice:a="auto",stream:s,...o}=t,u=typeof a!="string"&&a?.function?.name,{maxChatCompletions:l=vv}=n||{},c=t.tools.map(f=>{if(Ri(f)){if(!f.$callback)throw new z("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:f.$callback,name:f.function.name,description:f.function.description||"",parameters:f.function.parameters,parse:f.$parseRaw,strict:!0}}}return f}),p={};for(let f of c)f.type==="function"&&(p[f.function.name||f.function.function.name]=f.function);let d="tools"in t?c.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description,strict:f.function.strict}}:f):void 0;for(let f of t.messages)this._addMessage(f,!1);for(let f=0;f<l;++f){let h=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:d,messages:[...this.messages]},n)).choices[0]?.message;if(!h)throw new z("missing message in ChatCompletion response");if(!h.tool_calls?.length)return;for(let y of h.tool_calls){if(y.type!=="function")continue;let _=y.id,{name:b,arguments:O}=y.function,v=p[b];if(v){if(u&&u!==b){let q=`Invalid tool_call: ${JSON.stringify(b)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:i,tool_call_id:_,content:q});continue}}else{let q=`Invalid tool_call: ${JSON.stringify(b)}. Available options are: ${Object.keys(p).map(re=>JSON.stringify(re)).join(", ")}. Please try again`;this._addMessage({role:i,tool_call_id:_,content:q});continue}let x;try{x=bm(v)?await v.parse(O):O}catch(q){let re=q instanceof Error?q.message:String(q);this._addMessage({role:i,tool_call_id:_,content:re});continue}let C=await v.function(x,this),R=gt(this,We,"m",Tm).call(this,C);if(this._addMessage({role:i,tool_call_id:_,content:R}),u)return}}}};We=new WeakSet,Pm=function(){return gt(this,We,"m",dc).call(this).content??null},dc=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(Rn(t)){let{function_call:n,...i}=t,a={...i,content:t.content??null,refusal:t.refusal??null};return n&&(a.function_call=n),a}}throw new z("stream ended without producing a ChatCompletionMessage with role=assistant")},Om=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Rn(t)&&t?.function_call)return t.function_call;if(Rn(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Em=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(wm(t)&&t.content!=null||_m(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(n=>n.role==="assistant"&&n.tool_calls?.some(i=>i.type==="function"&&i.id===t.tool_call_id)))return t.content}},Im=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},xv=function(e){if(e.n!=null&&e.n>1)throw new z("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Tm=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Uo=class r extends ns{static runFunctions(e,t,n){let i=new r,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(e,t,a)),i}static runTools(e,t,n){let i=new r,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,a)),i}_addMessage(e,t=!0){super._addMessage(e,t),Rn(e)&&e.content&&this._emit("content",e.content)}};var Ne={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},Cm=class extends Error{},Sm=class extends Error{};function _k(r,e=Ne.ALL){if(typeof r!="string")throw new TypeError(`expecting str, got ${typeof r}`);if(!r.trim())throw new Error(`${r} is empty`);return vk(r.trim(),e)}var vk=(r,e)=>{let t=r.length,n=0,i=d=>{throw new Cm(`${d} at position ${n}`)},a=d=>{throw new Sm(`${d} at position ${n}`)},s=()=>(p(),n>=t&&i("Unexpected end of input"),r[n]==='"'?o():r[n]==="{"?u():r[n]==="["?l():r.substring(n,n+4)==="null"||Ne.NULL&e&&t-n<4&&"null".startsWith(r.substring(n))?(n+=4,null):r.substring(n,n+4)==="true"||Ne.BOOL&e&&t-n<4&&"true".startsWith(r.substring(n))?(n+=4,!0):r.substring(n,n+5)==="false"||Ne.BOOL&e&&t-n<5&&"false".startsWith(r.substring(n))?(n+=5,!1):r.substring(n,n+8)==="Infinity"||Ne.INFINITY&e&&t-n<8&&"Infinity".startsWith(r.substring(n))?(n+=8,1/0):r.substring(n,n+9)==="-Infinity"||Ne.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(r.substring(n))?(n+=9,-1/0):r.substring(n,n+3)==="NaN"||Ne.NAN&e&&t-n<3&&"NaN".startsWith(r.substring(n))?(n+=3,NaN):c()),o=()=>{let d=n,f=!1;for(n++;n<t&&(r[n]!=='"'||f&&r[n-1]==="\\");)f=r[n]==="\\"?!f:!1,n++;if(r.charAt(n)=='"')try{return JSON.parse(r.substring(d,++n-Number(f)))}catch(m){a(String(m))}else if(Ne.STR&e)try{return JSON.parse(r.substring(d,n-Number(f))+'"')}catch{return JSON.parse(r.substring(d,r.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},u=()=>{n++,p();let d={};try{for(;r[n]!=="}";){if(p(),n>=t&&Ne.OBJ&e)return d;let f=o();p(),n++;try{let m=s();Object.defineProperty(d,f,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Ne.OBJ&e)return d;throw m}p(),r[n]===","&&n++}}catch{if(Ne.OBJ&e)return d;i("Expected '}' at end of object")}return n++,d},l=()=>{n++;let d=[];try{for(;r[n]!=="]";)d.push(s()),p(),r[n]===","&&n++}catch{if(Ne.ARR&e)return d;i("Expected ']' at end of array")}return n++,d},c=()=>{if(n===0){r==="-"&&Ne.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(r)}catch(f){if(Ne.NUM&e)try{return r[r.length-1]==="."?JSON.parse(r.substring(0,r.lastIndexOf("."))):JSON.parse(r.substring(0,r.lastIndexOf("e")))}catch{}a(String(f))}}let d=n;for(r[n]==="-"&&n++;r[n]&&!",]}".includes(r[n]);)n++;n==t&&!(Ne.NUM&e)&&i("Unterminated number literal");try{return JSON.parse(r.substring(d,n))}catch{r.substring(d,n)==="-"&&Ne.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(r.substring(d,r.lastIndexOf("e")))}catch(m){a(String(m))}}},p=()=>{for(;n<t&&` 
\r	`.includes(r[n]);)n++};return s()},km=r=>_k(r,Ne.ALL^Ne.NUM);var is=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},oe=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Ce,nn,as,Nn,Rm,fc,Nm,Mm,jm,mc,$m,Av,ss=class r extends ns{constructor(e){super(),Ce.add(this),nn.set(this,void 0),as.set(this,void 0),Nn.set(this,void 0),is(this,nn,e,"f"),is(this,as,[],"f")}get currentChatCompletionSnapshot(){return oe(this,Nn,"f")}static fromReadableStream(e){let t=new r(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){let i=new r(t);return i._run(()=>i._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createChatCompletion(e,t,n){super._createChatCompletion;let i=n?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),oe(this,Ce,"m",Rm).call(this);let a=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(let s of a)oe(this,Ce,"m",Nm).call(this,s);if(a.controller.signal?.aborted)throw new we;return this._addChatCompletion(oe(this,Ce,"m",mc).call(this))}async _fromReadableStream(e,t){let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),oe(this,Ce,"m",Rm).call(this),this._connected();let i=_r.fromReadableStream(e,this.controller),a;for await(let s of i)a&&a!==s.id&&this._addChatCompletion(oe(this,Ce,"m",mc).call(this)),oe(this,Ce,"m",Nm).call(this,s),a=s.id;if(i.controller.signal?.aborted)throw new we;return this._addChatCompletion(oe(this,Ce,"m",mc).call(this))}[(nn=new WeakMap,as=new WeakMap,Nn=new WeakMap,Ce=new WeakSet,Rm=function(){this.ended||is(this,Nn,void 0,"f")},fc=function(t){let n=oe(this,as,"f")[t.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},oe(this,as,"f")[t.index]=n,n)},Nm=function(t){if(this.ended)return;let n=oe(this,Ce,"m",Av).call(this,t);this._emit("chunk",t,n);for(let i of t.choices){let a=n.choices[i.index];i.delta.content!=null&&a.message?.role==="assistant"&&a.message?.content&&(this._emit("content",i.delta.content,a.message.content),this._emit("content.delta",{delta:i.delta.content,snapshot:a.message.content,parsed:a.message.parsed})),i.delta.refusal!=null&&a.message?.role==="assistant"&&a.message?.refusal&&this._emit("refusal.delta",{delta:i.delta.refusal,snapshot:a.message.refusal}),i.logprobs?.content!=null&&a.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:i.logprobs?.content,snapshot:a.logprobs?.content??[]}),i.logprobs?.refusal!=null&&a.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:i.logprobs?.refusal,snapshot:a.logprobs?.refusal??[]});let s=oe(this,Ce,"m",fc).call(this,a);a.finish_reason&&(oe(this,Ce,"m",jm).call(this,a),s.current_tool_call_index!=null&&oe(this,Ce,"m",Mm).call(this,a,s.current_tool_call_index));for(let o of i.delta.tool_calls??[])s.current_tool_call_index!==o.index&&(oe(this,Ce,"m",jm).call(this,a),s.current_tool_call_index!=null&&oe(this,Ce,"m",Mm).call(this,a,s.current_tool_call_index)),s.current_tool_call_index=o.index;for(let o of i.delta.tool_calls??[]){let u=a.message.tool_calls?.[o.index];u?.type&&(u?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:u.function?.name,index:o.index,arguments:u.function.arguments,parsed_arguments:u.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(u?.type,void 0))}}},Mm=function(t,n){if(oe(this,Ce,"m",fc).call(this,t).done_tool_calls.has(n))return;let a=t.message.tool_calls?.[n];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){let s=oe(this,nn,"f")?.tools?.find(o=>o.type==="function"&&o.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:n,arguments:a.function.arguments,parsed_arguments:Ri(s)?s.$parseRaw(a.function.arguments):s?.function.strict?JSON.parse(a.function.arguments):null})}else a.type},jm=function(t){let n=oe(this,Ce,"m",fc).call(this,t);if(t.message.content&&!n.content_done){n.content_done=!0;let i=oe(this,Ce,"m",$m).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},mc=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");let t=oe(this,Nn,"f");if(!t)throw new z("request ended without sending any chunks");return is(this,Nn,void 0,"f"),is(this,as,[],"f"),xk(t,oe(this,nn,"f"))},$m=function(){let t=oe(this,nn,"f")?.response_format;return xm(t)?t:null},Av=function(t){var n,i,a,s;let o=oe(this,Nn,"f"),{choices:u,...l}=t;o?Object.assign(o,l):o=is(this,Nn,{...l,choices:[]},"f");for(let{delta:c,finish_reason:p,index:d,logprobs:f=null,...m}of t.choices){let h=o.choices[d];if(h||(h=o.choices[d]={finish_reason:p,index:d,message:{},logprobs:f,...m}),f)if(!h.logprobs)h.logprobs=Object.assign({},f);else{let{content:C,refusal:R,...q}=f;Object.assign(h.logprobs,q),C&&((n=h.logprobs).content??(n.content=[]),h.logprobs.content.push(...C)),R&&((i=h.logprobs).refusal??(i.refusal=[]),h.logprobs.refusal.push(...R))}if(p&&(h.finish_reason=p,oe(this,nn,"f")&&Am(oe(this,nn,"f")))){if(p==="length")throw new Ga;if(p==="content_filter")throw new Wa}if(Object.assign(h,m),!c)continue;let{content:y,refusal:_,function_call:b,role:O,tool_calls:v,...x}=c;if(Object.assign(h.message,x),_&&(h.message.refusal=(h.message.refusal||"")+_),O&&(h.message.role=O),b&&(h.message.function_call?(b.name&&(h.message.function_call.name=b.name),b.arguments&&((a=h.message.function_call).arguments??(a.arguments=""),h.message.function_call.arguments+=b.arguments)):h.message.function_call=b),y&&(h.message.content=(h.message.content||"")+y,!h.message.refusal&&oe(this,Ce,"m",$m).call(this)&&(h.message.parsed=km(h.message.content))),v){h.message.tool_calls||(h.message.tool_calls=[]);for(let{index:C,id:R,type:q,function:re,...Q}of v){let $=(s=h.message.tool_calls)[C]??(s[C]={});Object.assign($,Q),R&&($.id=R),q&&($.type=q),re&&($.function??($.function={name:re.name??"",arguments:""})),re?.name&&($.function.name=re.name),re?.arguments&&($.function.arguments+=re.arguments,wv(oe(this,nn,"f"),$)&&($.function.parsed_arguments=km($.function.arguments)))}}}return o},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("chunk",i=>{let a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(let i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(let a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(let a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((a,s)=>t.push({resolve:a,reject:s})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new _r(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function xk(r,e){let{id:t,choices:n,created:i,model:a,system_fingerprint:s,...o}=r,u={...o,id:t,choices:n.map(({message:l,finish_reason:c,index:p,logprobs:d,...f})=>{if(!c)throw new z(`missing finish_reason for choice ${p}`);let{content:m=null,function_call:h,tool_calls:y,..._}=l,b=l.role;if(!b)throw new z(`missing role for choice ${p}`);if(h){let{arguments:O,name:v}=h;if(O==null)throw new z(`missing function_call.arguments for choice ${p}`);if(!v)throw new z(`missing function_call.name for choice ${p}`);return{...f,message:{content:m,function_call:{arguments:O,name:v},role:b,refusal:l.refusal??null},finish_reason:c,index:p,logprobs:d}}return y?{...f,index:p,finish_reason:c,logprobs:d,message:{..._,role:b,content:m,refusal:l.refusal??null,tool_calls:y.map((O,v)=>{let{function:x,type:C,id:R,...q}=O,{arguments:re,name:Q,...$}=x||{};if(R==null)throw new z(`missing choices[${p}].tool_calls[${v}].id
${hc(r)}`);if(C==null)throw new z(`missing choices[${p}].tool_calls[${v}].type
${hc(r)}`);if(Q==null)throw new z(`missing choices[${p}].tool_calls[${v}].function.name
${hc(r)}`);if(re==null)throw new z(`missing choices[${p}].tool_calls[${v}].function.arguments
${hc(r)}`);return{...q,id:R,type:C,function:{...$,name:Q,arguments:re}}})}}:{...f,message:{..._,content:m,role:b,refusal:l.refusal??null},finish_reason:c,index:p,logprobs:d}}),created:i,model:a,object:"chat.completion",...s?{system_fingerprint:s}:{}};return bv(u,e)}function hc(r){return JSON.stringify(r)}var zo=class r extends ss{static fromReadableStream(e){let t=new r(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){let i=new r(null),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(e,t,a)),i}static runTools(e,t,n){let i=new r(t),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,a)),i}};var Bo=class extends k{parse(e,t){return _v(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>qo(n,e))}runFunctions(e,t){return e.stream?zo.runFunctions(this._client,e,t):Uo.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?zo.runTools(this._client,e,t):Uo.runTools(this._client,e,t)}stream(e,t){return ss.createChatCompletion(this._client,e,t)}};var os=class extends k{constructor(){super(...arguments),this.completions=new Bo(this._client)}};(function(r){r.Completions=Bo})(os||(os={}));var M=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Et=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},qe,Lm,xr,gc,ir,Mi,us,Ni,wc,It,yc,bc,Ho,Ko,Vo,Pv,Ov,Ev,Iv,Tv,Cv,Sv,Ar=class r extends rs{constructor(){super(...arguments),qe.add(this),Lm.set(this,[]),xr.set(this,{}),gc.set(this,{}),ir.set(this,void 0),Mi.set(this,void 0),us.set(this,void 0),Ni.set(this,void 0),wc.set(this,void 0),It.set(this,void 0),yc.set(this,void 0),bc.set(this,void 0),Ho.set(this,void 0)}[(Lm=new WeakMap,xr=new WeakMap,gc=new WeakMap,ir=new WeakMap,Mi=new WeakMap,us=new WeakMap,Ni=new WeakMap,wc=new WeakMap,It=new WeakMap,yc=new WeakMap,bc=new WeakMap,Ho=new WeakMap,qe=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("event",i=>{let a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(let i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(let a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(let a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((a,s)=>t.push({resolve:a,reject:s})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();let i=_r.fromReadableStream(e,this.controller);for await(let a of i)M(this,qe,"m",Ko).call(this,a);if(i.controller.signal?.aborted)throw new we;return this._addRun(M(this,qe,"m",Vo).call(this))}toReadableStream(){return new _r(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,i,a){let s=new r;return s._run(()=>s._runToolAssistantStream(e,t,n,i,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createToolAssistantStream(e,t,n,i,a){let s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let o={...i,stream:!0},u=await e.submitToolOutputs(t,n,o,{...a,signal:this.controller.signal});this._connected();for await(let l of u)M(this,qe,"m",Ko).call(this,l);if(u.controller.signal?.aborted)throw new we;return this._addRun(M(this,qe,"m",Vo).call(this))}static createThreadAssistantStream(e,t,n){let i=new r;return i._run(()=>i._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),i}static createAssistantStream(e,t,n,i){let a=new r;return a._run(()=>a._runAssistantStream(e,t,n,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return M(this,yc,"f")}currentRun(){return M(this,bc,"f")}currentMessageSnapshot(){return M(this,ir,"f")}currentRunStepSnapshot(){return M(this,Ho,"f")}async finalRunSteps(){return await this.done(),Object.values(M(this,xr,"f"))}async finalMessages(){return await this.done(),Object.values(M(this,gc,"f"))}async finalRun(){if(await this.done(),!M(this,Mi,"f"))throw Error("Final run was not received.");return M(this,Mi,"f")}async _createThreadAssistantStream(e,t,n){let i=n?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...t,stream:!0},s=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(let o of s)M(this,qe,"m",Ko).call(this,o);if(s.controller.signal?.aborted)throw new we;return this._addRun(M(this,qe,"m",Vo).call(this))}async _createAssistantStream(e,t,n,i){let a=i?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s={...n,stream:!0},o=await e.create(t,s,{...i,signal:this.controller.signal});this._connected();for await(let u of o)M(this,qe,"m",Ko).call(this,u);if(o.controller.signal?.aborted)throw new we;return this._addRun(M(this,qe,"m",Vo).call(this))}static accumulateDelta(e,t){for(let[n,i]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=i;continue}let a=e[n];if(a==null){e[n]=i;continue}if(n==="index"||n==="type"){e[n]=i;continue}if(typeof a=="string"&&typeof i=="string")a+=i;else if(typeof a=="number"&&typeof i=="number")a+=i;else if(jo(a)&&jo(i))a=this.accumulateDelta(a,i);else if(Array.isArray(a)&&Array.isArray(i)){if(a.every(s=>typeof s=="string"||typeof s=="number")){a.push(...i);continue}for(let s of i){if(!jo(s))throw new Error(`Expected array delta entry to be an object but got: ${s}`);let o=s.index;if(o==null)throw console.error(s),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let u=a[o];u==null?a.push(s):a[o]=this.accumulateDelta(u,s)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${i}, accValue: ${a}`);e[n]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,i){return await this._createAssistantStream(t,e,n,i)}async _runToolAssistantStream(e,t,n,i,a){return await this._createToolAssistantStream(n,e,t,i,a)}};Ko=function(e){if(!this.ended)switch(Et(this,yc,e,"f"),M(this,qe,"m",Ev).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":M(this,qe,"m",Sv).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":M(this,qe,"m",Ov).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":M(this,qe,"m",Pv).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Vo=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");if(!M(this,Mi,"f"))throw Error("Final run has not been received");return M(this,Mi,"f")},Pv=function(e){let[t,n]=M(this,qe,"m",Tv).call(this,e,M(this,ir,"f"));Et(this,ir,t,"f"),M(this,gc,"f")[t.id]=t;for(let i of n){let a=t.content[i.index];a?.type=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let i of e.data.delta.content){if(i.type=="text"&&i.text){let a=i.text,s=t.content[i.index];if(s&&s.type=="text")this._emit("textDelta",a,s.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(i.index!=M(this,us,"f")){if(M(this,Ni,"f"))switch(M(this,Ni,"f").type){case"text":this._emit("textDone",M(this,Ni,"f").text,M(this,ir,"f"));break;case"image_file":this._emit("imageFileDone",M(this,Ni,"f").image_file,M(this,ir,"f"));break}Et(this,us,i.index,"f")}Et(this,Ni,t.content[i.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(M(this,us,"f")!==void 0){let i=e.data.content[M(this,us,"f")];if(i)switch(i.type){case"image_file":this._emit("imageFileDone",i.image_file,M(this,ir,"f"));break;case"text":this._emit("textDone",i.text,M(this,ir,"f"));break}}M(this,ir,"f")&&this._emit("messageDone",e.data),Et(this,ir,void 0,"f")}},Ov=function(e){let t=M(this,qe,"m",Iv).call(this,e);switch(Et(this,Ho,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let a of n.step_details.tool_calls)a.index==M(this,wc,"f")?this._emit("toolCallDelta",a,t.step_details.tool_calls[a.index]):(M(this,It,"f")&&this._emit("toolCallDone",M(this,It,"f")),Et(this,wc,a.index,"f"),Et(this,It,t.step_details.tool_calls[a.index],"f"),M(this,It,"f")&&this._emit("toolCallCreated",M(this,It,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Et(this,Ho,void 0,"f"),e.data.step_details.type=="tool_calls"&&M(this,It,"f")&&(this._emit("toolCallDone",M(this,It,"f")),Et(this,It,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},Ev=function(e){M(this,Lm,"f").push(e),this._emit("event",e)},Iv=function(e){switch(e.event){case"thread.run.step.created":return M(this,xr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=M(this,xr,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){let i=Ar.accumulateDelta(t,n.delta);M(this,xr,"f")[e.data.id]=i}return M(this,xr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":M(this,xr,"f")[e.data.id]=e.data;break}if(M(this,xr,"f")[e.data.id])return M(this,xr,"f")[e.data.id];throw new Error("No snapshot available")},Tv=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let i=e.data;if(i.delta.content)for(let a of i.delta.content)if(a.index in t.content){let s=t.content[a.index];t.content[a.index]=M(this,qe,"m",Cv).call(this,a,s)}else t.content[a.index]=a,n.push(a);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Cv=function(e,t){return Ar.accumulateDelta(t,e)},Sv=function(e){switch(Et(this,bc,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Et(this,Mi,e.data,"f"),M(this,It,"f")&&(this._emit("toolCallDone",M(this,It,"f")),Et(this,It,void 0,"f"));break;case"thread.run.cancelling":break}};var ji=class extends k{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,i){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t={},n){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,ls,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}},ls=class extends fe{};ji.MessagesPage=ls;var $i=class extends k{retrieve(e,t,n,i={},a){return ue(i)?this.retrieve(e,t,n,{},i):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:i,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,n={},i){return ue(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,cs,{query:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}},cs=class extends fe{};$i.RunStepsPage=cs;var an=class extends k{constructor(){super(...arguments),this.steps=new $i(this._client)}create(e,t,n){let{include:i,...a}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:i},body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,i){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t={},n){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,ps,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){let i=await this.create(e,t,n);return await this.poll(e,i.id,n)}createAndStream(e,t,n){return Ar.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){let i={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let{data:a,response:s}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...i}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{let u=s.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await tn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,n){return Ar.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,i){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,i){let a=await this.submitToolOutputs(e,t,n,i);return await this.poll(e,a.id,i)}submitToolOutputsStream(e,t,n,i){return Ar.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,i)}},ps=class extends fe{};an.RunsPage=ps;an.Steps=$i;an.RunStepsPage=cs;var Pr=class extends k{constructor(){super(...arguments),this.runs=new an(this._client),this.messages=new ji(this._client)}create(e={},t){return ue(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return Ar.createThreadAssistantStream(e,this._client.beta.threads,t)}};Pr.Runs=an;Pr.RunsPage=ps;Pr.Messages=ji;Pr.MessagesPage=ls;var kv=async r=>{let e=await Promise.allSettled(r),t=e.filter(i=>i.status==="rejected");if(t.length){for(let i of t)console.error(i.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let n=[];for(let i of e)i.status==="fulfilled"&&n.push(i.value);return n};var Li=class extends k{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Mn,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){let i=await this.create(e,t,n);return await this.poll(e,i.id,n)}async poll(e,t,n){let i={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let a=await this.retrieve(e,t,{...n,headers:i}).withResponse(),s=a.data;switch(s.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{let u=a.response.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await tn(o);break;case"failed":case"completed":return s}}}async upload(e,t,n){let i=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:i.id},n)}async uploadAndPoll(e,t,n){let i=await this.upload(e,t,n);return await this.poll(e,i.id,n)}},Mn=class extends fe{};Li.VectorStoreFilesPage=Mn;var ds=class extends k{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){let i=await this.create(e,t);return await this.poll(e,i.id,n)}listFiles(e,t,n={},i){return ue(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Mn,{query:n,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}async poll(e,t,n){let i={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(i["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let{data:a,response:s}=await this.retrieve(e,t,{...n,headers:i}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{let u=s.headers.get("openai-poll-after-ms");if(u){let l=parseInt(u);isNaN(l)||(o=l)}}await tn(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},i){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let a=i?.maxConcurrency??5,s=Math.min(a,t.length),o=this._client,u=t.values(),l=[...n];async function c(d){for(let f of d){let m=await o.files.create({file:f,purpose:"assistants"},i);l.push(m.id)}}let p=Array(s).fill(u).map(c);return await kv(p),await this.createAndPoll(e,{file_ids:l})}};var Or=class extends k{constructor(){super(...arguments),this.files=new Li(this._client),this.fileBatches=new ds(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/vector_stores",fs,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},fs=class extends fe{};Or.VectorStoresPage=fs;Or.Files=Li;Or.VectorStoreFilesPage=Mn;Or.FileBatches=ds;var Bt=class extends k{constructor(){super(...arguments),this.vectorStores=new Or(this._client),this.chat=new os(this._client),this.assistants=new ki(this._client),this.threads=new Pr(this._client)}};Bt.VectorStores=Or;Bt.VectorStoresPage=fs;Bt.Assistants=ki;Bt.AssistantsPage=es;Bt.Threads=Pr;var Di=class extends k{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};var Fi=class extends k{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};var jn=class extends k{create(e,t){return this._client.post("/files",zt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/files",qi,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=30*60*1e3}={}){let i=new Set(["processed","error","deleted"]),a=Date.now(),s=await this.retrieve(e);for(;!s.status||!i.has(s.status);)if(await tn(t),s=await this.retrieve(e),Date.now()-a>n)throw new rr({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return s}},qi=class extends fe{};jn.FileObjectsPage=qi;var Ui=class extends k{list(e,t={},n){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,ms,{query:t,...n})}},ms=class extends fe{};Ui.FineTuningJobCheckpointsPage=ms;var Er=class extends k{constructor(){super(...arguments),this.checkpoints=new Ui(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",hs,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return ue(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,gs,{query:t,...n})}},hs=class extends fe{},gs=class extends fe{};Er.FineTuningJobsPage=hs;Er.FineTuningJobEventsPage=gs;Er.Checkpoints=Ui;Er.FineTuningJobCheckpointsPage=ms;var Ir=class extends k{constructor(){super(...arguments),this.jobs=new Er(this._client)}};Ir.Jobs=Er;Ir.FineTuningJobsPage=hs;Ir.FineTuningJobEventsPage=gs;var zi=class extends k{createVariation(e,t){return this._client.post("/images/variations",zt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",zt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};var $n=class extends k{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Bi,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Bi=class extends sc{};$n.ModelsPage=Bi;var Ki=class extends k{create(e,t){return this._client.post("/moderations",{body:e,...t})}};var ys=class extends k{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,zt({body:t,...n}))}};var Ln=class extends k{constructor(){super(...arguments),this.parts=new ys(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}};Ln.Parts=ys;var Rv,H=class extends ac{constructor({baseURL:e=Mo("OPENAI_BASE_URL"),apiKey:t=Mo("OPENAI_API_KEY"),organization:n=Mo("OPENAI_ORG_ID")??null,project:i=Mo("OPENAI_PROJECT_ID")??null,...a}={}){if(t===void 0)throw new z("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let s={apiKey:t,organization:n,project:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&mv())throw new z(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Di(this),this.chat=new Sn(this),this.embeddings=new Fi(this),this.files=new jn(this),this.images=new zi(this),this.audio=new vr(this),this.moderations=new Ki(this),this.models=new $n(this),this.fineTuning=new Ir(this),this.beta=new Bt(this),this.batches=new kn(this),this.uploads=new Ln(this),this._options=s,this.apiKey=t,this.organization=n,this.project=i}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return im(e,{arrayFormat:"brackets"})}};Rv=H;H.OpenAI=Rv;H.DEFAULT_TIMEOUT=6e5;H.OpenAIError=z;H.APIError=Pe;H.APIConnectionError=en;H.APIConnectionTimeoutError=rr;H.APIUserAbortError=we;H.NotFoundError=za;H.ConflictError=Ba;H.RateLimitError=Va;H.BadRequestError=Fa;H.AuthenticationError=qa;H.InternalServerError=Ha;H.PermissionDeniedError=Ua;H.UnprocessableEntityError=Ka;H.toFile=mm;H.fileFromPath=ec;H.Completions=Di;H.Chat=Sn;H.Embeddings=Fi;H.Files=jn;H.FileObjectsPage=qi;H.Images=zi;H.Audio=vr;H.Moderations=Ki;H.Models=$n;H.ModelsPage=Bi;H.FineTuning=Ir;H.Beta=Bt;H.Batches=kn;H.BatchesPage=Si;H.Uploads=Ln;Oi();Go();ya();yr();Oi();Ta();Wo();En();ht();Cl();El();Wr();Pc();function Zo(r){return typeof r?.parse=="function"}var Oc=class r extends Gi{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){let n=r._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===r.prototype._streamResponseChunks)yield this.invoke(e,t);else{let i=r._convertInputToPromptValue(e).toChatMessages(),[a,s]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...a.metadata,...this.getLsParams(s)},u=await be.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:s,invocation_params:this?.invocationParams(s),batch_size:1},c=await u?.handleChatModelStart(this.toJSON(),[i],a.runId,void 0,l,void 0,void 0,a.runName),p;try{for await(let d of this._streamResponseChunks(i,s,c?.[0])){if(d.message.id==null){let f=c?.at(0)?.runId;f!=null&&d.message._updateId(`run-${f}`)}d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,p?p=p.concat(d):p=d}}catch(d){throw await Promise.all((c??[]).map(f=>f?.handleLLMError(d))),d}await Promise.all((c??[]).map(d=>d?.handleLLMEnd({generations:[[p]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,n){let i=e.map(f=>f.map(Wt)),a={...n.metadata,...this.getLsParams(t)},s=await be.configure(n.callbacks,this.callbacks,n.tags,this.tags,a,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this?.invocationParams(t),batch_size:1},u=await s?.handleChatModelStart(this.toJSON(),i,n.runId,void 0,o,void 0,void 0,n.runName),l=[],c=[];if(!!u?.[0].handlers.find(f=>ho(f)||mo(f))&&i.length===1&&this._streamResponseChunks!==r.prototype._streamResponseChunks)try{let f=await this._streamResponseChunks(i[0],t,u?.[0]),m;for await(let h of f){if(h.message.id==null){let y=u?.at(0)?.runId;y!=null&&h.message._updateId(`run-${y}`)}m===void 0?m=h:m=He(m,h)}if(m===void 0)throw new Error("Received empty response from chat model call.");l.push([m]),await u?.[0].handleLLMEnd({generations:l,llmOutput:{}})}catch(f){throw await u?.[0].handleLLMError(f),f}else{let f=await Promise.allSettled(i.map((m,h)=>this._generate(m,{...t,promptIndex:h},u?.[h])));await Promise.all(f.map(async(m,h)=>{if(m.status==="fulfilled"){let y=m.value;for(let _ of y.generations){if(_.message.id==null){let b=u?.at(0)?.runId;b!=null&&_.message._updateId(`run-${b}`)}_.message.response_metadata={..._.generationInfo,..._.message.response_metadata}}return y.generations.length===1&&(y.generations[0].message.response_metadata={...y.llmOutput,...y.generations[0].message.response_metadata}),l[h]=y.generations,c[h]=y.llmOutput,u?.[h]?.handleLLMEnd({generations:[y.generations],llmOutput:y.llmOutput})}else return await u?.[h]?.handleLLMError(m.reason),Promise.reject(m.reason)}))}let d={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(d,Ia,{value:u?{runIds:u?.map(f=>f.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:i,handledOptions:a}){let s=e.map(y=>y.map(Wt)),o={...a.metadata,...this.getLsParams(i)},u=await be.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1,cached:!0},c=await u?.handleChatModelStart(this.toJSON(),s,a.runId,void 0,l,void 0,void 0,a.runName),p=[],f=(await Promise.allSettled(s.map(async(y,_)=>{let b=r._convertInputToPromptValue(y).toString(),O=await t.lookup(b,n);return O==null&&p.push(_),O}))).map((y,_)=>({result:y,runManager:c?.[_]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),m=[];await Promise.all(f.map(async({result:y,runManager:_},b)=>{if(y.status==="fulfilled"){let O=y.value;return m[b]=O,O.length&&await _?.handleLLMNewToken(O[0].text),_?.handleLLMEnd({generations:[O]})}else return await _?.handleLLMError(y.reason),Promise.reject(y.reason)}));let h={generations:m,missingPromptIndices:p};return Object.defineProperty(h,Ia,{value:c?{runIds:c?.map(y=>y.runId)}:void 0,configurable:!0}),h}async generate(e,t,n){let i;Array.isArray(t)?i={stop:t}:i=t;let a=e.map(f=>f.map(Wt)),[s,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(a,o,s);let{cache:u}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:p}=await this._generateCached({messages:a,cache:u,llmStringKey:l,parsedOptions:o,handledOptions:s}),d={};if(p.length>0){let f=await this._generateUncached(p.map(m=>a[m]),o,s);await Promise.all(f.generations.map(async(m,h)=>{let y=p[h];c[y]=m;let _=r._convertInputToPromptValue(a[y]).toString();return u.update(_,l,m)})),d=f.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){let i=e.map(a=>a.toChatMessages());return this.generate(i,t,n)}async call(e,t,n){return(await this.generate([e.map(Wt)],t,n)).generations[0][0].message}async callPrompt(e,t,n){let i=e.toChatMessages();return this.call(i,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){let i=new Re(e),a=await this.call([i],t,n);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');let n=e,i=t?.name,a=n.description??"A function available to call.",s=t?.method,o=t?.includeRaw;if(s==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=i??"extract",l;Zo(n)?l=[{type:"function",function:{name:u,description:a,parameters:at(n)}}]:("name"in n&&(u=n.name),l=[{type:"function",function:{name:u,description:a,parameters:n}}]);let c=this.bindTools(l),p=Xr.from(h=>{if(!h.tool_calls||h.tool_calls.length===0)throw new Error("No tool calls found in the response.");let y=h.tool_calls.find(_=>_.name===u);if(!y)throw new Error(`No tool call found with name ${u}.`);return y.args});if(!o)return c.pipe(p).withConfig({runName:"StructuredOutput"});let d=Cr.assign({parsed:(h,y)=>p.invoke(h.raw,y)}),f=Cr.assign({parsed:()=>null}),m=d.withFallbacks({fallbacks:[f]});return Yr.from([{raw:c},m]).withConfig({runName:"StructuredOutputRunnable"})}};Jo();Ec();Wi();bs();Zm();Fn();bi();function Ym(r,e){if(r.function===void 0)return;let t;if(e?.partial)try{t=yi(r.function.arguments??"{}")}catch{return}else try{t=JSON.parse(r.function.arguments)}catch(i){throw new Sr([`Function "${r.function.name}" arguments:`,"",r.function.arguments,"","are not valid JSON.",`Error: ${i.message}`].join(`
`))}let n={name:r.function.name,args:t,type:"tool_call"};return e?.returnId&&(n.id=r.id),n}function ux(r){if(r.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:r.id,type:"function",function:{name:r.name,arguments:JSON.stringify(r.args)}}}function lx(r,e){return{name:r.function?.name,args:r.function?.arguments,id:r.id,error:e,type:"invalid_tool_call"}}var Jm=class extends Dn{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let n=e[0].message,i;if(oo(n)&&n.tool_calls?.length?i=n.tool_calls.map(s=>{let{id:o,...u}=s;return this.returnId?{id:o,...u}:u}):n.additional_kwargs.tool_calls!==void 0&&(i=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(o=>Ym(o,{returnId:this.returnId,partial:t}))),!i)return[];let a=[];for(let s of i)if(s!==void 0){let o={type:s.name,args:s.args,id:s.id};Object.defineProperty(o,"name",{get(){return this.type}}),Object.defineProperty(o,"arguments",{get(){return this.args}}),a.push(o)}return a}},eu=class extends Jm{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Sr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let n=(await super.parsePartialResult(e)).filter(a=>a.type===this.keyName),i=n;if(n.length)return this.returnId||(i=n.map(a=>a.args)),this.returnSingle?i[0]:i}async parseResult(e){let n=(await super.parsePartialResult(e,!1)).filter(s=>s.type===this.keyName),i=n;return n.length?(this.returnId||(i=n.map(s=>s.args)),this.returnSingle?this._validateResult(i[0]):await Promise.all(i.map(s=>this._validateResult(s)))):void 0}};yr();var px=Symbol("Let zodToJsonSchema decide on which parser to use"),cx={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},dx=r=>typeof r=="string"?{...cx,basePath:["#"],definitions:{},name:r}:{...cx,basePath:["#"],definitions:{},...r};var tu=r=>"_def"in r?r._def:r;function fx(r){if(!r)return!0;for(let e in r)return!1;return!0}var mx=r=>{let e=dx(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([n,i])=>[tu(i),{def:tu(i),path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function Xm(r,e,t,n){n?.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function te(r,e,t,n,i){r[e]=t,Xm(r,e,n,i)}fr();function hx(){return{}}fr();function gx(r,e){let t={type:"array"};return r.type?._def?.typeName!==w.ZodAny&&(t.items=F(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&te(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&te(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(te(t,"minItems",r.exactLength.value,r.exactLength.message,e),te(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}function yx(r,e){let t={type:"integer",format:"int64"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?te(t,"minimum",n.value,n.message,e):te(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),te(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?te(t,"maximum",n.value,n.message,e):te(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),te(t,"maximum",n.value,n.message,e));break;case"multipleOf":te(t,"multipleOf",n.value,n.message,e);break}return t}function bx(){return{type:"boolean"}}function wx(r,e){return F(r.type._def,e)}var _x=(r,e)=>F(r.innerType._def,e);function Qm(r,e,t){let n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((i,a)=>Qm(r,e,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return RR(r,e)}}var RR=(r,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let n of r.checks)switch(n.kind){case"min":te(t,"minimum",n.value,n.message,e);break;case"max":te(t,"maximum",n.value,n.message,e);break}return t};function vx(r,e){return{...F(r.innerType._def,e),default:r.defaultValue()}}function xx(r,e,t){return e.effectStrategy==="input"?F(r.schema._def,e,t):{}}function Ax(r){return{type:"string",enum:[...r.values]}}var NR=r=>"type"in r&&r.type==="string"?!1:"allOf"in r;function Px(r,e){let t=[F(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),F(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a),n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,i=[];return t.forEach(a=>{if(NR(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let s=a;if("additionalProperties"in a&&a.additionalProperties===!1){let{additionalProperties:o,...u}=a;s=u}else n=void 0;i.push(s)}}),i.length?{allOf:i,...n}:void 0}function Ox(r,e){let t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}fr();var eh,Zi={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(eh===void 0&&(eh=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),eh),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function kc(r,e){let t={type:"string"};function n(i){return e.patternStrategy==="escape"?MR(i):i}if(r.checks)for(let i of r.checks)switch(i.kind){case"min":te(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e);break;case"max":te(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"email":switch(e.emailStrategy){case"format:email":or(t,"email",i.message,e);break;case"format:idn-email":or(t,"idn-email",i.message,e);break;case"pattern:zod":ur(t,Zi.email,i.message,e);break}break;case"url":or(t,"uri",i.message,e);break;case"uuid":or(t,"uuid",i.message,e);break;case"regex":ur(t,i.regex,i.message,e);break;case"cuid":ur(t,Zi.cuid,i.message,e);break;case"cuid2":ur(t,Zi.cuid2,i.message,e);break;case"startsWith":ur(t,RegExp(`^${n(i.value)}`),i.message,e);break;case"endsWith":ur(t,RegExp(`${n(i.value)}$`),i.message,e);break;case"datetime":or(t,"date-time",i.message,e);break;case"date":or(t,"date",i.message,e);break;case"time":or(t,"time",i.message,e);break;case"duration":or(t,"duration",i.message,e);break;case"length":te(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e),te(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"includes":{ur(t,RegExp(n(i.value)),i.message,e);break}case"ip":{i.version!=="v6"&&or(t,"ipv4",i.message,e),i.version!=="v4"&&or(t,"ipv6",i.message,e);break}case"emoji":ur(t,Zi.emoji,i.message,e);break;case"ulid":{ur(t,Zi.ulid,i.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{or(t,"binary",i.message,e);break}case"contentEncoding:base64":{te(t,"contentEncoding","base64",i.message,e);break}case"pattern:zod":{ur(t,Zi.base64,i.message,e);break}}break}case"nanoid":ur(t,Zi.nanoid,i.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var MR=r=>Array.from(r).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),or=(r,e,t,n)=>{r.format||r.anyOf?.some(i=>i.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):te(r,"format",e,t,n)},ur=(r,e,t,n)=>{r.pattern||r.allOf?.some(i=>i.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:Ex(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):te(r,"pattern",Ex(e,n),t,n)},Ex=(r,e)=>{let t=typeof r=="function"?r():r;if(!e.applyRegexFlags||!t.flags)return t.source;let n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},i=n.i?t.source.toLowerCase():t.source,a="",s=!1,o=!1,u=!1;for(let l=0;l<i.length;l++){if(s){a+=i[l],s=!1;continue}if(n.i){if(o){if(i[l].match(/[a-z]/)){u?(a+=i[l],a+=`${i[l-2]}-${i[l]}`.toUpperCase(),u=!1):i[l+1]==="-"&&i[l+2]?.match(/[a-z]/)?(a+=i[l],u=!0):a+=`${i[l]}${i[l].toUpperCase()}`;continue}}else if(i[l].match(/[a-z]/)){a+=`[${i[l]}${i[l].toUpperCase()}]`;continue}}if(n.m){if(i[l]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(i[l]==="$"){a+=`($|(?=[\r
]))`;continue}}if(n.s&&i[l]==="."){a+=o?`${i[l]}\r
`:`[${i[l]}\r
]`;continue}a+=i[l],i[l]==="\\"?s=!0:o&&i[l]==="]"?o=!1:!o&&i[l]==="["&&(o=!0)}try{let l=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return a};function Rc(r,e){if(e.target==="openApi3"&&r.keyType?._def.typeName===w.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((n,i)=>({...n,[i]:F(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",i]})??{}}),{}),additionalProperties:!1};let t={type:"object",additionalProperties:F(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(r.keyType?._def.typeName===w.ZodString&&r.keyType._def.checks?.length){let n=Object.entries(kc(r.keyType._def,e)).reduce((i,[a,s])=>a==="type"?i:{...i,[a]:s},{});return{...t,propertyNames:n}}else if(r.keyType?._def.typeName===w.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};return t}function Ix(r,e){if(e.mapStrategy==="record")return Rc(r,e);let t=F(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=F(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function Tx(r){let e=r.values,n=Object.keys(r.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),i=Array.from(new Set(n.map(a=>typeof a)));return{type:i.length===1?i[0]==="string"?"string":"number":["string","number"],enum:n}}function Cx(){return{not:{}}}function Sx(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var ru={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Rx(r,e){if(e.target==="openApi3")return kx(r,e);let t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in ru&&(!n._def.checks||!n._def.checks.length))){let n=t.reduce((i,a)=>{let s=ru[a._def.typeName];return s&&!i.includes(s)?[...i,s]:i},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){let n=t.reduce((i,a)=>{let s=typeof a._def.value;switch(s){case"string":case"number":case"boolean":return[...i,s];case"bigint":return[...i,"integer"];case"object":if(a._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(n.length===t.length){let i=n.filter((a,s,o)=>o.indexOf(a)===s);return{type:i.length>1?i:i[0],enum:t.reduce((a,s)=>a.includes(s._def.value)?a:[...a,s._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return kx(r,e)}var kx=(r,e)=>{let t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,i)=>F(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function Nx(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:ru[r.innerType._def.typeName],nullable:!0}:{type:[ru[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let n=F(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}let t=F(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Mx(r,e){let t={type:"number"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"int":t.type="integer",Xm(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?te(t,"minimum",n.value,n.message,e):te(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),te(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?te(t,"maximum",n.value,n.message,e):te(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),te(t,"maximum",n.value,n.message,e));break;case"multipleOf":te(t,"multipleOf",n.value,n.message,e);break}return t}function jR(r,e){return e.removeAdditionalStrategy==="strict"?r.catchall._def.typeName==="ZodNever"?r.unknownKeys!=="strict":F(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:r.catchall._def.typeName==="ZodNever"?r.unknownKeys==="passthrough":F(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function jx(r,e){let t={type:"object",...Object.entries(r.shape()).reduce((n,[i,a])=>{if(a===void 0||a._def===void 0)return n;let s=F(a._def,{...e,currentPath:[...e.currentPath,"properties",i],propertyPath:[...e.currentPath,"properties",i]});return s===void 0?n:{properties:{...n.properties,[i]:s},required:a.isOptional()&&!e.openaiStrictMode?n.required:[...n.required,i]}},{properties:{},required:[]}),additionalProperties:jR(r,e)};return t.required.length||delete t.required,t}var $x=(r,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return F(r.innerType._def,e);let t=F(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var Lx=(r,e)=>{if(e.pipeStrategy==="input")return F(r.in._def,e);if(e.pipeStrategy==="output")return F(r.out._def,e);let t=F(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=F(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(i=>i!==void 0)}};function Dx(r,e){return F(r.type._def,e)}function Fx(r,e){let n={type:"array",uniqueItems:!0,items:F(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&te(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&te(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}function qx(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>F(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:F(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>F(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function Ux(){return{not:{}}}function zx(){return{}}var Bx=(r,e)=>F(r.innerType._def,e);function F(r,e,t=!1){let n=e.seen.get(r);if(e.override){let s=e.override?.(r,e,n,t);if(s!==px)return s}if(n&&!t){let s=$R(n,e);if(s!==void 0)return"$ref"in s&&e.seenRefs.add(s.$ref),s}let i={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,i);let a=DR(r,r.typeName,e,t);return a&&FR(r,e,a),i.jsonSchema=a,a}var $R=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"extract-to-root":let t=r.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=r.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:LR(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((n,i)=>e.currentPath[i]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},LR=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")},DR=(r,e,t,n)=>{switch(e){case w.ZodString:return kc(r,t);case w.ZodNumber:return Mx(r,t);case w.ZodObject:return jx(r,t);case w.ZodBigInt:return yx(r,t);case w.ZodBoolean:return bx();case w.ZodDate:return Qm(r,t);case w.ZodUndefined:return Ux();case w.ZodNull:return Sx(t);case w.ZodArray:return gx(r,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return Rx(r,t);case w.ZodIntersection:return Px(r,t);case w.ZodTuple:return qx(r,t);case w.ZodRecord:return Rc(r,t);case w.ZodLiteral:return Ox(r,t);case w.ZodEnum:return Ax(r);case w.ZodNativeEnum:return Tx(r);case w.ZodNullable:return Nx(r,t);case w.ZodOptional:return $x(r,t);case w.ZodMap:return Ix(r,t);case w.ZodSet:return Fx(r,t);case w.ZodLazy:return F(r.getter()._def,t);case w.ZodPromise:return Dx(r,t);case w.ZodNaN:case w.ZodNever:return Cx();case w.ZodEffects:return xx(r,t,n);case w.ZodAny:return hx();case w.ZodUnknown:return zx();case w.ZodDefault:return vx(r,t);case w.ZodBranded:return wx(r,t);case w.ZodReadonly:return Bx(r,t);case w.ZodCatch:return _x(r,t);case w.ZodPipeline:return Lx(r,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(i=>{})(e)}},FR=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t);var Kx=(r,e)=>{let t=mx(e),n=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,i=F(r._def,n===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,n]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(i.title=a);let s=(()=>{if(fx(t.definitions))return;let u={},l=new Set;for(let c=0;c<500;c++){let p=Object.entries(t.definitions).filter(([d])=>!l.has(d));if(p.length===0)break;for(let[d,f]of p)u[d]=F(tu(f),{...t,currentPath:[...t.basePath,t.definitionPath,d]},!0)??{},l.add(d)}return u})(),o=n===void 0?s?{...i,[t.definitionPath]:s}:i:t.nameStrategy==="duplicate-ref"?{...i,...s||t.seenRefs.size?{[t.definitionPath]:{...s,...t.seenRefs.size?{[n]:i}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,n].join("/"),[t.definitionPath]:{...s,[n]:i}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Vx(r,e){return Kx(r,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Hx(r,e,t){return gv({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:Vx(r,{name:e})}},n=>r.parse(JSON.parse(n)))}function Gx(r){return yv({type:"function",function:{name:r.name,parameters:Vx(r.parameters,{name:r.name}),strict:!0,...r.description?{description:r.description}:void 0}},{callback:r.function,parser:e=>r.parameters.parse(JSON.parse(e))})}function on(r){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:n,azureOpenAIBasePath:i,baseURL:a,azureADTokenProvider:s}=r;if((n||s)&&i&&e)return`${i}/${e}`;if(n||s){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return a}yr();yr();ht();function th(r,e){let t=typeof e=="number"?void 0:e;return{name:r.name,description:r.description,parameters:at(r.schema),...t?.strict!==void 0?{strict:t.strict}:{}}}function qR(r){return r!==void 0&&Array.isArray(r.lc_namespace)}function UR(r){return r!==void 0&&Z.isRunnable(r)&&"lc_name"in r.constructor&&typeof r.constructor.lc_name=="function"&&r.constructor.lc_name()==="RunnableToolLike"}function zR(r){return!!r&&typeof r=="object"&&"name"in r&&"schema"in r&&Zo(r.schema)}function Wx(r){return zR(r)||UR(r)||qR(r)}function qn(r){let e;return r.constructor.name===rr.name?(e=new Error(r.message),e.name="TimeoutError"):r.constructor.name===we.name?(e=new Error(r.message),e.name="AbortError"):e=r,e}function Zx(r){if(r)return r==="any"||r==="required"?"required":r==="auto"?"auto":r==="none"?"none":typeof r=="string"?{type:"function",function:{name:r}}:r}function BR(r){return r.anyOf!==void 0&&Array.isArray(r.anyOf)}function Jx(r){let e=["namespace functions {",""];for(let t of r)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Yx(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Yx(r,e){let t=[];for(let[n,i]of Object.entries(r.properties??{}))i.description&&e<2&&t.push(`// ${i.description}`),r.required?.includes(n)?t.push(`${n}: ${Nc(i,e)},`):t.push(`${n}?: ${Nc(i,e)},`);return t.map(n=>" ".repeat(e)+n).join(`
`)}function Nc(r,e){if(BR(r))return r.anyOf.map(t=>Nc(t,e)).join(" | ");switch(r.type){case"string":return r.enum?r.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Yx(r,e+2),"}"].join(`
`);case"array":return r.items?`${Nc(r.items,e)}[]`:"any[]";default:return""}}function Xx(r,e){let t;if(Wx(r)){let n=Gx({name:r.name,parameters:r.schema,description:r.description});n.function.parameters?t={type:n.type,function:{name:n.function.name,description:n.function.description,parameters:n.function.parameters,...e?.strict!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:th(r,e)}}else t=r;return e?.strict!==void 0&&(t.function.strict=e.strict),t}function KR(r){return r.role!=="system"&&r.role!=="assistant"&&r.role!=="user"&&r.role!=="function"&&r.role!=="tool"&&console.warn(`Unknown message role: ${r.role}`),r.role}function t0(r){let e=r._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Gt.isInstance(r))throw new Error("Invalid generic chat message");return KR(r)}default:throw new Error(`Unknown message type: ${e}`)}}function VR(r,e,t){let n=r.tool_calls;switch(r.role){case"assistant":{let i=[],a=[];for(let u of n??[])try{i.push(Ym(u,{returnId:!0}))}catch(l){a.push(lx(u,l.message))}let s={function_call:r.function_call,tool_calls:n};t!==void 0&&(s.__raw_response=e);let o;return e.system_fingerprint&&(o={system_fingerprint:e.system_fingerprint}),new ke({content:r.content||"",tool_calls:i,invalid_tool_calls:a,additional_kwargs:s,response_metadata:o,id:e.id})}default:return new Gt(r.content||"",r.role??"unknown")}}function HR(r,e,t,n){let i=r.role??t,a=r.content??"",s;if(r.function_call?s={function_call:r.function_call}:r.tool_calls?s={tool_calls:r.tool_calls}:s={},n&&(s.__raw_response=e),i==="user")return new vi({content:a});if(i==="assistant"){let o=[];if(Array.isArray(r.tool_calls))for(let u of r.tool_calls)o.push({name:u.function?.name,args:u.function?.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new Ot({content:a,tool_call_chunks:o,additional_kwargs:s,id:e.id})}else return i==="system"?new xi({content:a}):i==="function"?new _i({content:a,additional_kwargs:s,name:r.name}):i==="tool"?new va({content:a,additional_kwargs:s,tool_call_id:r.tool_call_id}):new wi({content:a,role:i})}function Qx(r){return r.map(e=>{let t={role:t0(e),content:e.content};return e.name!=null&&(t.name=e.name),e.additional_kwargs.function_call!=null&&(t.function_call=e.additional_kwargs.function_call,t.content=null),oo(e)&&e.tool_calls?.length?(t.tool_calls=e.tool_calls.map(ux),t.content=null):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function e0(r,e){return Vv(r)?e?.strict!==void 0?{...r,function:{...r.function,strict:e.strict}}:r:Xx(r,e)}var Ji=class extends Oc{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??ie("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??ie("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??ie("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??ie("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??ie("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??ie("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??ie("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return t?.strict!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.bind({tools:e.map(i=>e0(i,{strict:n})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Mc(e.json_schema.schema)?Hx(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let n;e?.strict!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling);let i={};return e?.stream_options!==void 0?i={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(i={stream_options:{include_usage:!0}}),{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(s=>e0(s,{strict:n})):void 0,tool_choice:Zx(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...i,parallel_tool_calls:e?.parallel_tool_calls,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){if(this.model.includes("o1-")){console.warn("[WARNING]: OpenAI o1 models do not yet support token-level streaming. Streaming will yield single chunk.");let l=await this._generate(e,t,n),c=lo(l.generations[0].message);yield new gr({message:c,text:typeof c.content=="string"?c.content:""});return}let i=Qx(e),a={...this.invocationParams(t,{streaming:!0}),messages:i,stream:!0},s;if(a.response_format&&a.response_format.type==="json_schema"){console.warn('OpenAI does not yet support streaming with "response_format" set to "json_schema". Falling back to non-streaming mode.');let l=await this._generate(e,t,n),c=new gr({message:new Ot({...l.generations[0].message}),text:l.generations[0].text,generationInfo:l.generations[0].generationInfo});return yield c,n?.handleLLMNewToken(l.generations[0].text??"",void 0,void 0,void 0,void 0,{chunk:c})}let o=await this.completionWithRetry(a,t),u;for await(let l of o){let c=l?.choices[0];if(l.usage&&(u=l.usage),!c)continue;let{delta:p}=c;if(!p)continue;let d=HR(p,l,s,this.__includeRawResponse);s=p.role??s;let f={prompt:t.promptIndex??0,completion:c.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let m={...f};c.finish_reason!=null&&(m.finish_reason=c.finish_reason,m.system_fingerprint=l.system_fingerprint),this.logprobs&&(m.logprobs=c.logprobs);let h=new gr({message:d,text:d.content,generationInfo:m});yield h,await n?.handleLLMNewToken(h.text??"",f,void 0,void 0,void 0,{chunk:h})}if(u&&(yield new gr({message:new Ot({content:"",usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens}}),text:""})),t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){let i={},a=this.invocationParams(t),s=Qx(e);if(a.stream){let o=this._streamResponseChunks(e,t,n),u={};for await(let m of o){m.message.response_metadata={...m.generationInfo,...m.message.response_metadata};let h=m.generationInfo?.completion??0;u[h]===void 0?u[h]=m:u[h]=u[h].concat(m)}let l=Object.entries(u).sort(([m],[h])=>parseInt(m,10)-parseInt(h,10)).map(([m,h])=>h),{functions:c,function_call:p}=this.invocationParams(t),d=await this.getEstimatedTokenCountFromPrompt(e,c,p),f=await this.getNumTokensFromGenerations(l);return i.promptTokens=d,i.completionTokens=f,i.totalTokens=d+f,{generations:l,llmOutput:{estimatedTokenUsage:i}}}else{let o;t.response_format&&t.response_format.type==="json_schema"?o=await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options}):o=await this.completionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options});let{completion_tokens:u,prompt_tokens:l,total_tokens:c}=o?.usage??{};u&&(i.completionTokens=(i.completionTokens??0)+u),l&&(i.promptTokens=(i.promptTokens??0)+l),c&&(i.totalTokens=(i.totalTokens??0)+c);let p=[];for(let d of o?.choices??[]){let m={text:d.message?.content??"",message:VR(d.message??{role:"assistant"},o,this.__includeRawResponse)};m.generationInfo={...d.finish_reason?{finish_reason:d.finish_reason}:{},...d.logprobs?{logprobs:d.logprobs}:{}},oo(m.message)&&(m.message.usage_metadata={input_tokens:i.promptTokens??0,output_tokens:i.completionTokens??0,total_tokens:i.totalTokens??0}),p.push(m)}return{generations:p,llmOutput:{tokenUsage:i}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let i=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){let a=Jx(t);i+=await this.getNumTokens(a),i+=9}return t&&e.find(a=>a._getType()==="system")&&(i-=4),n==="none"?i+=1:typeof n=="object"&&(i+=await this.getNumTokens(n.name)+4),i}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>n.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)))).reduce((n,i)=>n+i,0)}async getNumTokensFromMessages(e){let t=0,n=0,i=0;this.model==="gpt-3.5-turbo-0301"?(n=4,i=-1):(n=3,i=1);let a=await Promise.all(e.map(async s=>{let o=await this.getNumTokens(s.content),u=await this.getNumTokens(t0(s)),l=s.name!==void 0?i+await this.getNumTokens(s.name):0,c=o+n+u+l,p=s;if(p._getType()==="function"&&(c-=2),p.additional_kwargs?.function_call&&(c+=3),p?.additional_kwargs.function_call?.name&&(c+=await this.getNumTokens(p.additional_kwargs.function_call?.name)),p.additional_kwargs.function_call?.arguments)try{c+=await this.getNumTokens(JSON.stringify(JSON.parse(p.additional_kwargs.function_call?.arguments)))}catch(d){console.error("Error parsing function arguments",d,JSON.stringify(p.additional_kwargs.function_call)),c+=await this.getNumTokens(p.additional_kwargs.function_call?.arguments)}return t+=c,c}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){let n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(i){throw qn(i)}})}async betaParsedCompletionWithRetry(e,t){let n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,n)}catch(i){throw qn(i)}})}_getClientOptions(e){if(!this.client){let n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},i=on(n),a={...this.clientConfig,baseURL:i,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new H(a)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,i,a,s;GR(e)?(n=e.schema,i=e.name,a=e.method,s=e.includeRaw):(n=e,i=t?.name,a=t?.method,s=t?.includeRaw);let o,u;if(t?.strict!==void 0&&a==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(a==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),Mc(n)?u=Xo.fromZodSchema(n):u=new Qo;else if(a==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:i??"extract",description:n.description,schema:n,strict:t?.strict}}}),Mc(n)?u=Xo.fromZodSchema(n):u=new Qo;else{let d=i??"extract";if(Mc(n)){let f=at(n);o=this.bind({tools:[{type:"function",function:{name:d,description:f.description,parameters:f}}],tool_choice:{type:"function",function:{name:d}},...t?.strict!==void 0?{strict:t.strict}:{}}),u=new eu({returnSingle:!0,keyName:d,zodSchema:n})}else{let f;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(f=n,d=n.name):(d=n.title??d,f={name:d,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:f}],tool_choice:{type:"function",function:{name:d}},...t?.strict!==void 0?{strict:t.strict}:{}}),u=new eu({returnSingle:!0,keyName:d})}}if(!s)return o.pipe(u);let l=Cr.assign({parsed:(d,f)=>u.invoke(d.raw,f)}),c=Cr.assign({parsed:()=>null}),p=l.withFallbacks({fallbacks:[c]});return Yr.from([{raw:o},p])}};function Mc(r){return typeof r?.parse=="function"}function GR(r){return r!==void 0&&typeof r.schema=="object"}Jo();Go();Oi();Ta();En();Wo();Cl();El();Wr();var rh=(r,e)=>r.reduce((t,n,i)=>{let a=Math.floor(i/e),s=t[a]||[];return t[a]=s.concat([n]),t},[]);Go();Ca();var jc=class{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new Yt(e??{})}};var nu=class extends jc{constructor(e,t){let n={maxConcurrency:2,...e};super(n),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"dimensions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let i=n?.apiKey??n?.openAIApiKey??ie("OPENAI_API_KEY"),a=n?.azureOpenAIApiKey??ie("AZURE_OPENAI_API_KEY");if(this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!a&&!i&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");let s=n?.azureOpenAIApiInstanceName??ie("AZURE_OPENAI_API_INSTANCE_NAME"),o=(n?.azureOpenAIApiEmbeddingsDeploymentName||n?.azureOpenAIApiDeploymentName)??(ie("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||ie("AZURE_OPENAI_API_DEPLOYMENT_NAME")),u=n?.azureOpenAIApiVersion??ie("AZURE_OPENAI_API_VERSION");if(this.azureOpenAIBasePath=n?.azureOpenAIBasePath??ie("AZURE_OPENAI_BASE_PATH"),this.organization=n?.configuration?.organization??ie("OPENAI_ORGANIZATION"),this.modelName=n?.model??n?.modelName??this.model,this.model=this.modelName,this.batchSize=n?.batchSize??(a?1:this.batchSize),this.stripNewLines=n?.stripNewLines??this.stripNewLines,this.timeout=n?.timeout,this.dimensions=n?.dimensions,this.azureOpenAIApiVersion=u,this.azureOpenAIApiKey=a,this.azureOpenAIApiInstanceName=s,this.azureOpenAIApiDeploymentName=o,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");i=i??""}this.clientConfig={apiKey:i,organization:this.organization,baseURL:t?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params,...t,...e?.configuration}}async embedDocuments(e){let t=rh(this.stripNewLines?e.map(s=>s.replace(/\n/g," ")):e,this.batchSize),n=t.map(s=>{let o={model:this.model,input:s};return this.dimensions&&(o.dimensions=this.dimensions),this.embeddingWithRetry(o)}),i=await Promise.all(n),a=[];for(let s=0;s<i.length;s+=1){let o=t[s],{data:u}=i[s];for(let l=0;l<o.length;l+=1)a.push(u[l].embedding)}return a}async embedQuery(e){let t={model:this.model,input:this.stripNewLines?e.replace(/\n/g," "):e};this.dimensions&&(t.dimensions=this.dimensions);let{data:n}=await this.embeddingWithRetry(t);return n[0].embedding}async embeddingWithRetry(e){if(!this.client){let n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},i=on(n),a={...this.clientConfig,baseURL:i,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new H(a)}let t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(n){throw qn(n)}})}};fr();En();Wo();In();xa();Ea();_l();var nh=class extends Hi{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let n,i;_a(e)?(n=e.id,i=e.args):i=e;let a=G(t);return this.call(i,{...a,configurable:{...a.configurable,tool_call_id:n}})}async call(e,t,n){let i;try{i=await this.schema.parseAsync(e)}catch(f){let m="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(m=`${m}
Details: ${f.message}`),new wa(m,JSON.stringify(e))}let a=Oa(t),o=await(await be.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}))?.handleToolStart(this.toJSON(),typeof i=="string"?i:JSON.stringify(i),a.runId,void 0,void 0,void 0,a.runName);delete a.runId;let u;try{u=await this._call(i,o,a)}catch(f){throw await o?.handleToolError(f),f}let l,c;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[l,c]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else l=u;let p;a&&"configurable"in a&&(p=a.configurable.tool_call_id);let d=WR({content:l,artifact:c,toolCallId:p,name:this.name});return await o?.handleToolEnd(d),d}},$c=class extends nh{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Rt.object({input:Rt.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};function WR(r){let{content:e,artifact:t,toolCallId:n}=r;return n?typeof e=="string"||Array.isArray(e)&&e.every(i=>typeof i=="object")?new Hr({content:e,artifact:t,tool_call_id:n,name:r.name}):new Hr({content:ZR(e),artifact:t,tool_call_id:n,name:r.name}):e}function ZR(r){try{return JSON.stringify(r,null,2)}catch{return`${r}`}}var ih=class extends $c{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??ie("OPENAI_API_KEY"),n=e?.organization??ie("OPENAI_ORGANIZATION"),i={apiKey:t,organization:n,dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new H(i),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(i=>i.url?{type:"image_url",image_url:i.url}:[]).filter(i=>i!==void 0&&i.type==="image_url"&&typeof i.image_url=="string"&&i.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(i=>i.b64_json?{type:"image_url",image_url:{url:i.b64_json}}:[]).filter(i=>i!==void 0&&i.type==="image_url"&&typeof i.image_url=="object"&&"url"in i.image_url&&typeof i.image_url.url=="string"&&i.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let a=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(a)}let n=await this.client.images.generate(t),i="";return this.dallEResponseFormat==="url"?[i]=n.data.map(a=>a.url).filter(a=>a!=="undefined"):[i]=n.data.map(a=>a.b64_json).filter(a=>a!=="undefined"),i}};Object.defineProperty(ih,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});Ze();je();ph();Ae();je();var xs=class{},I0=(r,e)=>{if(e!==void 0)return r[e];let t=Object.keys(r);if(t.length===1)return r[t[0]]},Vc=(r,e)=>{let t=I0(r,e);if(!t){let n=Object.keys(r);throw new Error(`input values have ${n.length} keys, you must specify an input key or pass only 1 key as input`)}return t},dh=(r,e)=>{let t=I0(r,e);if(!t){let n=Object.keys(r);throw new Error(`output values have ${n.length} keys, you must specify an output key or pass only 1 key as output`)}return t};Vr();Oi();var fh=class extends Fe{addUserMessage(e){return this.addMessage(new Re(e))}addAIChatMessage(e){return this.addMessage(new ke(e))}addAIMessage(e){return this.addMessage(new ke(e))}async addMessages(e){for(let t of e)await this.addMessage(t)}clear(){throw new Error("Not implemented.")}},As=class extends fh{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}};var Rr=class extends xs{constructor(e){super(),Object.defineProperty(this,"chatHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnMessages",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chatHistory=e?.chatHistory??new As,this.returnMessages=e?.returnMessages??this.returnMessages,this.inputKey=e?.inputKey??this.inputKey,this.outputKey=e?.outputKey??this.outputKey}async saveContext(e,t){await this.chatHistory.addUserMessage(Vc(e,this.inputKey)),await this.chatHistory.addAIChatMessage(dh(t,this.outputKey))}async clear(){await this.chatHistory.clear()}};var Ps=class extends Rr{constructor(e){super({chatHistory:e?.chatHistory,returnMessages:e?.returnMessages??!1,inputKey:e?.inputKey,outputKey:e?.outputKey}),Object.defineProperty(this,"humanPrefix",{enumerable:!0,configurable:!0,writable:!0,value:"Human"}),Object.defineProperty(this,"aiPrefix",{enumerable:!0,configurable:!0,writable:!0,value:"AI"}),Object.defineProperty(this,"memoryKey",{enumerable:!0,configurable:!0,writable:!0,value:"history"}),this.humanPrefix=e?.humanPrefix??this.humanPrefix,this.aiPrefix=e?.aiPrefix??this.aiPrefix,this.memoryKey=e?.memoryKey??this.memoryKey}get memoryKeys(){return[this.memoryKey]}async loadMemoryVariables(e){let t=await this.chatHistory.getMessages();return this.returnMessages?{[this.memoryKey]:t}:{[this.memoryKey]:ft(t,this.humanPrefix,this.aiPrefix)}}};ou();Qi();Ae();Ze();je();vs();Ze();uh();ht();var Hc=class extends Z{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","documents","transformers"]})}invoke(e,t){return this.transformDocuments(e)}};Bm();var mh=class extends Hc{constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","document_transformers","text_splitters"]}),Object.defineProperty(this,"chunkSize",{enumerable:!0,configurable:!0,writable:!0,value:1e3}),Object.defineProperty(this,"chunkOverlap",{enumerable:!0,configurable:!0,writable:!0,value:200}),Object.defineProperty(this,"keepSeparator",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lengthFunction",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chunkSize=e?.chunkSize??this.chunkSize,this.chunkOverlap=e?.chunkOverlap??this.chunkOverlap,this.keepSeparator=e?.keepSeparator??this.keepSeparator,this.lengthFunction=e?.lengthFunction??(t=>t.length),this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async transformDocuments(e,t={}){return this.splitDocuments(e,t)}splitOnSeparator(e,t){let n;if(t)if(this.keepSeparator){let i=t.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");n=e.split(new RegExp(`(?=${i})`))}else n=e.split(t);else n=e.split("");return n.filter(i=>i!=="")}async createDocuments(e,t=[],n={}){let i=t.length>0?t:[...Array(e.length)].map(()=>({})),{chunkHeader:a="",chunkOverlapHeader:s="(cont'd) ",appendChunkOverlapHeader:o=!1}=n,u=new Array;for(let l=0;l<e.length;l+=1){let c=e[l],p=1,d=null,f=-1;for(let m of await this.splitText(c)){let h=a,y=c.indexOf(m,f+1);if(d===null){let v=this.numberOfNewLines(c,0,y);p+=v}else{let v=f+await this.lengthFunction(d);if(v<y){let x=this.numberOfNewLines(c,v,y);p+=x}else if(v>y){let x=this.numberOfNewLines(c,y,v);p-=x}o&&(h+=s)}let _=this.numberOfNewLines(m),b=i[l].loc&&typeof i[l].loc=="object"?{...i[l].loc}:{};b.lines={from:p,to:p+_};let O={...i[l],loc:b};h+=m,u.push(new lr({pageContent:h,metadata:O})),p+=_,d=m,f=y}}return u}numberOfNewLines(e,t,n){return(e.slice(t,n).match(/\n/g)||[]).length}async splitDocuments(e,t={}){let n=e.filter(s=>s.pageContent!==void 0),i=n.map(s=>s.pageContent),a=n.map(s=>s.metadata);return this.createDocuments(i,a,t)}joinDocs(e,t){let n=e.join(t).trim();return n===""?null:n}async mergeSplits(e,t){let n=[],i=[],a=0;for(let o of e){let u=await this.lengthFunction(o);if(a+u+i.length*t.length>this.chunkSize&&(a>this.chunkSize&&console.warn(`Created a chunk of size ${a}, +
which is longer than the specified ${this.chunkSize}`),i.length>0)){let l=this.joinDocs(i,t);for(l!==null&&n.push(l);a>this.chunkOverlap||a+u+i.length*t.length>this.chunkSize&&a>0;)a-=await this.lengthFunction(i[0]),i.shift()}i.push(o),a+=u}let s=this.joinDocs(i,t);return s!==null&&n.push(s),n}};var uu=class r extends mh{static lc_name(){return"RecursiveCharacterTextSplitter"}constructor(e){super(e),Object.defineProperty(this,"separators",{enumerable:!0,configurable:!0,writable:!0,value:[`

`,`
`," ",""]}),this.separators=e?.separators??this.separators,this.keepSeparator=e?.keepSeparator??!0}async _splitText(e,t){let n=[],i=t[t.length-1],a;for(let l=0;l<t.length;l+=1){let c=t[l];if(c===""){i=c;break}if(e.includes(c)){i=c,a=t.slice(l+1);break}}let s=this.splitOnSeparator(e,i),o=[],u=this.keepSeparator?"":i;for(let l of s)if(await this.lengthFunction(l)<this.chunkSize)o.push(l);else{if(o.length){let c=await this.mergeSplits(o,u);n.push(...c),o=[]}if(!a)n.push(l);else{let c=await this._splitText(l,a);n.push(...c)}}if(o.length){let l=await this.mergeSplits(o,u);n.push(...l)}return n}async splitText(e){return this._splitText(e,this.separators)}static fromLanguage(e,t){return new r({...t,separators:r.getSeparatorsForLanguage(e)})}static getSeparatorsForLanguage(e){if(e==="cpp")return[`
class `,`
void `,`
int `,`
float `,`
double `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="go")return[`
func `,`
var `,`
const `,`
type `,`
if `,`
for `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="java")return[`
class `,`
public `,`
protected `,`
private `,`
static `,`
if `,`
for `,`
while `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="js")return[`
function `,`
const `,`
let `,`
var `,`
class `,`
if `,`
for `,`
while `,`
switch `,`
case `,`
default `,`

`,`
`," ",""];if(e==="php")return[`
function `,`
class `,`
if `,`
foreach `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="proto")return[`
message `,`
service `,`
enum `,`
option `,`
import `,`
syntax `,`

`,`
`," ",""];if(e==="python")return[`
class `,`
def `,`
	def `,`

`,`
`," ",""];if(e==="rst")return[`
===
`,`
---
`,`
***
`,`
.. `,`

`,`
`," ",""];if(e==="ruby")return[`
def `,`
class `,`
if `,`
unless `,`
while `,`
for `,`
do `,`
begin `,`
rescue `,`

`,`
`," ",""];if(e==="rust")return[`
fn `,`
const `,`
let `,`
if `,`
while `,`
for `,`
loop `,`
match `,`
const `,`

`,`
`," ",""];if(e==="scala")return[`
class `,`
object `,`
def `,`
val `,`
var `,`
if `,`
for `,`
while `,`
match `,`
case `,`

`,`
`," ",""];if(e==="swift")return[`
func `,`
class `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do `,`
switch `,`
case `,`

`,`
`," ",""];if(e==="markdown")return[`
## `,`
### `,`
#### `,`
##### `,`
###### `,"```\n\n",`

***

`,`

---

`,`

___

`,`

`,`
`," ",""];if(e==="latex")return[`
\\chapter{`,`
\\section{`,`
\\subsection{`,`
\\subsubsection{`,`
\\begin{enumerate}`,`
\\begin{itemize}`,`
\\begin{description}`,`
\\begin{list}`,`
\\begin{quote}`,`
\\begin{quotation}`,`
\\begin{verse}`,`
\\begin{verbatim}`,`
\\begin{align}`,"$$","$",`

`,`
`," ",""];if(e==="html")return["<body>","<div>","<p>","<br>","<li>","<h1>","<h2>","<h3>","<h4>","<h5>","<h6>","<span>","<table>","<tr>","<td>","<th>","<ul>","<ol>","<header>","<footer>","<nav>","<head>","<style>","<script>","<meta>","<title>"," ",""];if(e==="sol")return[`
pragma `,`
using `,`
contract `,`
interface `,`
library `,`
constructor `,`
type `,`
function `,`
event `,`
modifier `,`
error `,`
struct `,`
enum `,`
if `,`
for `,`
while `,`
do while `,`
assembly `,`

`,`
`," ",""];throw new Error(`Language ${e} is not supported.`)}};ch();vs();je();Qi();Ae();Ae();Ae();Ze();je();vs();var AN=`Given the following conversation and a follow up question, rephrase the follow up question to be a standalone question.

Chat History:
{chat_history}
Follow Up Input: {question}
Standalone question:`,lu=class r extends se{static lc_name(){return"ConversationalRetrievalQAChain"}get inputKeys(){return[this.inputKey,this.chatHistoryKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){super(e),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"question"}),Object.defineProperty(this,"chatHistoryKey",{enumerable:!0,configurable:!0,writable:!0,value:"chat_history"}),Object.defineProperty(this,"retriever",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"questionGeneratorChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"returnGeneratedQuestion",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.retriever=e.retriever,this.combineDocumentsChain=e.combineDocumentsChain,this.questionGeneratorChain=e.questionGeneratorChain,this.inputKey=e.inputKey??this.inputKey,this.returnSourceDocuments=e.returnSourceDocuments??this.returnSourceDocuments,this.returnGeneratedQuestion=e.returnGeneratedQuestion??this.returnGeneratedQuestion}static getChatHistoryString(e){let t;return Array.isArray(e)?(Array.isArray(e[0])&&typeof e[0][0]=="string"?(console.warn(`Passing chat history as an array of strings is deprecated.
Please see https://js.langchain.com/docs/modules/chains/popular/chat_vector_db#externally-managed-memory for more information.`),t=e.flat().map((n,i)=>i%2===0?new Re(n):new ke(n))):t=e,t.map(n=>n._getType()==="human"?`Human: ${n.content}`:n._getType()==="ai"?`Assistant: ${n.content}`:`${n.content}`).join(`
`)):e}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Question key ${this.inputKey} not found.`);if(!(this.chatHistoryKey in e))throw new Error(`Chat history key ${this.chatHistoryKey} not found.`);let n=e[this.inputKey],i=r.getChatHistoryString(e[this.chatHistoryKey]),a=n;if(i.length>0){let l=await this.questionGeneratorChain.call({question:n,chat_history:i},t?.getChild("question_generator")),c=Object.keys(l);if(c.length===1)a=l[c[0]];else throw new Error("Return from llm chain has multiple values, only single values supported.")}let s=await this.retriever.getRelevantDocuments(a,t?.getChild("retriever")),o={question:a,input_documents:s,chat_history:i},u=await this.combineDocumentsChain.call(o,t?.getChild("combine_documents"));return this.returnSourceDocuments&&(u={...u,sourceDocuments:s}),this.returnGeneratedQuestion&&(u={...u,generatedQuestion:a}),u}_chainType(){return"conversational_retrieval_chain"}static async deserialize(e,t){throw new Error("Not implemented.")}serialize(){throw new Error("Not implemented.")}static fromLLM(e,t,n={}){let{questionGeneratorTemplate:i,qaTemplate:a,qaChainOptions:s={type:"stuff",prompt:a?X.fromTemplate(a):void 0},questionGeneratorChainOptions:o,verbose:u,...l}=n,c=lh(e,s),p=X.fromTemplate(o?.template??i??AN),d=new ae({prompt:p,llm:o?.llm??e,verbose:u});return new this({retriever:t,combineDocumentsChain:c,questionGeneratorChain:d,verbose:u,...l})}};Ze();vs();Ze();je();Ae();Ca();Ze();Ze();je();Ae();je();Wi();yr();Wi();Ae();Ze();yr();Ae();Sc();Wi();Wi();je();yr();Ae();je();Ae();function H0(r){return typeof r>"u"||r===null}function SN(r){return typeof r=="object"&&r!==null}function kN(r){return Array.isArray(r)?r:H0(r)?[]:[r]}function RN(r,e){var t,n,i,a;if(e)for(a=Object.keys(e),t=0,n=a.length;t<n;t+=1)i=a[t],r[i]=e[i];return r}function NN(r,e){var t="",n;for(n=0;n<e;n+=1)t+=r;return t}function MN(r){return r===0&&Number.NEGATIVE_INFINITY===1/r}var jN=H0,$N=SN,LN=kN,DN=NN,FN=MN,qN=RN,Se={isNothing:jN,isObject:$N,toArray:LN,repeat:DN,isNegativeZero:FN,extend:qN};function G0(r,e){var t="",n=r.reason||"(unknown reason)";return r.mark?(r.mark.name&&(t+='in "'+r.mark.name+'" '),t+="("+(r.mark.line+1)+":"+(r.mark.column+1)+")",!e&&r.mark.snippet&&(t+=`

`+r.mark.snippet),n+" "+t):n}function pu(r,e){Error.call(this),this.name="YAMLException",this.reason=r,this.mark=e,this.message=G0(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}pu.prototype=Object.create(Error.prototype);pu.prototype.constructor=pu;pu.prototype.toString=function(e){return this.name+": "+G0(this,e)};var bt=pu;function hh(r,e,t,n,i){var a="",s="",o=Math.floor(i/2)-1;return n-e>o&&(a=" ... ",e=n-o+a.length),t-n>o&&(s=" ...",t=n+o-s.length),{str:a+r.slice(e,t).replace(/\t/g,"\u2192")+s,pos:n-e+a.length}}function gh(r,e){return Se.repeat(" ",e-r.length)+r}function UN(r,e){if(e=Object.create(e||null),!r.buffer)return null;e.maxLength||(e.maxLength=79),typeof e.indent!="number"&&(e.indent=1),typeof e.linesBefore!="number"&&(e.linesBefore=3),typeof e.linesAfter!="number"&&(e.linesAfter=2);for(var t=/\r?\n|\r|\0/g,n=[0],i=[],a,s=-1;a=t.exec(r.buffer);)i.push(a.index),n.push(a.index+a[0].length),r.position<=a.index&&s<0&&(s=n.length-2);s<0&&(s=n.length-1);var o="",u,l,c=Math.min(r.line+e.linesAfter,i.length).toString().length,p=e.maxLength-(e.indent+c+3);for(u=1;u<=e.linesBefore&&!(s-u<0);u++)l=hh(r.buffer,n[s-u],i[s-u],r.position-(n[s]-n[s-u]),p),o=Se.repeat(" ",e.indent)+gh((r.line-u+1).toString(),c)+" | "+l.str+`
`+o;for(l=hh(r.buffer,n[s],i[s],r.position,p),o+=Se.repeat(" ",e.indent)+gh((r.line+1).toString(),c)+" | "+l.str+`
`,o+=Se.repeat("-",e.indent+c+3+l.pos)+`^
`,u=1;u<=e.linesAfter&&!(s+u>=i.length);u++)l=hh(r.buffer,n[s+u],i[s+u],r.position-(n[s]-n[s+u]),p),o+=Se.repeat(" ",e.indent)+gh((r.line+u+1).toString(),c)+" | "+l.str+`
`;return o.replace(/\n$/,"")}var zN=UN,BN=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],KN=["scalar","sequence","mapping"];function VN(r){var e={};return r!==null&&Object.keys(r).forEach(function(t){r[t].forEach(function(n){e[String(n)]=t})}),e}function HN(r,e){if(e=e||{},Object.keys(e).forEach(function(t){if(BN.indexOf(t)===-1)throw new bt('Unknown option "'+t+'" is met in definition of "'+r+'" YAML type.')}),this.options=e,this.tag=r,this.kind=e.kind||null,this.resolve=e.resolve||function(){return!0},this.construct=e.construct||function(t){return t},this.instanceOf=e.instanceOf||null,this.predicate=e.predicate||null,this.represent=e.represent||null,this.representName=e.representName||null,this.defaultStyle=e.defaultStyle||null,this.multi=e.multi||!1,this.styleAliases=VN(e.styleAliases||null),KN.indexOf(this.kind)===-1)throw new bt('Unknown kind "'+this.kind+'" is specified for "'+r+'" YAML type.')}var Je=HN;function k0(r,e){var t=[];return r[e].forEach(function(n){var i=t.length;t.forEach(function(a,s){a.tag===n.tag&&a.kind===n.kind&&a.multi===n.multi&&(i=s)}),t[i]=n}),t}function GN(){var r={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},e,t;function n(i){i.multi?(r.multi[i.kind].push(i),r.multi.fallback.push(i)):r[i.kind][i.tag]=r.fallback[i.tag]=i}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(n);return r}function bh(r){return this.extend(r)}bh.prototype.extend=function(e){var t=[],n=[];if(e instanceof Je)n.push(e);else if(Array.isArray(e))n=n.concat(e);else if(e&&(Array.isArray(e.implicit)||Array.isArray(e.explicit)))e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(n=n.concat(e.explicit));else throw new bt("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.forEach(function(a){if(!(a instanceof Je))throw new bt("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(a.loadKind&&a.loadKind!=="scalar")throw new bt("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(a.multi)throw new bt("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),n.forEach(function(a){if(!(a instanceof Je))throw new bt("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var i=Object.create(bh.prototype);return i.implicit=(this.implicit||[]).concat(t),i.explicit=(this.explicit||[]).concat(n),i.compiledImplicit=k0(i,"implicit"),i.compiledExplicit=k0(i,"explicit"),i.compiledTypeMap=GN(i.compiledImplicit,i.compiledExplicit),i};var WN=bh,ZN=new Je("tag:yaml.org,2002:str",{kind:"scalar",construct:function(r){return r!==null?r:""}}),JN=new Je("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(r){return r!==null?r:[]}}),YN=new Je("tag:yaml.org,2002:map",{kind:"mapping",construct:function(r){return r!==null?r:{}}}),XN=new WN({explicit:[ZN,JN,YN]});function QN(r){if(r===null)return!0;var e=r.length;return e===1&&r==="~"||e===4&&(r==="null"||r==="Null"||r==="NULL")}function eM(){return null}function tM(r){return r===null}var rM=new Je("tag:yaml.org,2002:null",{kind:"scalar",resolve:QN,construct:eM,predicate:tM,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function nM(r){if(r===null)return!1;var e=r.length;return e===4&&(r==="true"||r==="True"||r==="TRUE")||e===5&&(r==="false"||r==="False"||r==="FALSE")}function iM(r){return r==="true"||r==="True"||r==="TRUE"}function aM(r){return Object.prototype.toString.call(r)==="[object Boolean]"}var sM=new Je("tag:yaml.org,2002:bool",{kind:"scalar",resolve:nM,construct:iM,predicate:aM,represent:{lowercase:function(r){return r?"true":"false"},uppercase:function(r){return r?"TRUE":"FALSE"},camelcase:function(r){return r?"True":"False"}},defaultStyle:"lowercase"});function oM(r){return 48<=r&&r<=57||65<=r&&r<=70||97<=r&&r<=102}function uM(r){return 48<=r&&r<=55}function lM(r){return 48<=r&&r<=57}function cM(r){if(r===null)return!1;var e=r.length,t=0,n=!1,i;if(!e)return!1;if(i=r[t],(i==="-"||i==="+")&&(i=r[++t]),i==="0"){if(t+1===e)return!0;if(i=r[++t],i==="b"){for(t++;t<e;t++)if(i=r[t],i!=="_"){if(i!=="0"&&i!=="1")return!1;n=!0}return n&&i!=="_"}if(i==="x"){for(t++;t<e;t++)if(i=r[t],i!=="_"){if(!oM(r.charCodeAt(t)))return!1;n=!0}return n&&i!=="_"}if(i==="o"){for(t++;t<e;t++)if(i=r[t],i!=="_"){if(!uM(r.charCodeAt(t)))return!1;n=!0}return n&&i!=="_"}}if(i==="_")return!1;for(;t<e;t++)if(i=r[t],i!=="_"){if(!lM(r.charCodeAt(t)))return!1;n=!0}return!(!n||i==="_")}function pM(r){var e=r,t=1,n;if(e.indexOf("_")!==-1&&(e=e.replace(/_/g,"")),n=e[0],(n==="-"||n==="+")&&(n==="-"&&(t=-1),e=e.slice(1),n=e[0]),e==="0")return 0;if(n==="0"){if(e[1]==="b")return t*parseInt(e.slice(2),2);if(e[1]==="x")return t*parseInt(e.slice(2),16);if(e[1]==="o")return t*parseInt(e.slice(2),8)}return t*parseInt(e,10)}function dM(r){return Object.prototype.toString.call(r)==="[object Number]"&&r%1===0&&!Se.isNegativeZero(r)}var fM=new Je("tag:yaml.org,2002:int",{kind:"scalar",resolve:cM,construct:pM,predicate:dM,represent:{binary:function(r){return r>=0?"0b"+r.toString(2):"-0b"+r.toString(2).slice(1)},octal:function(r){return r>=0?"0o"+r.toString(8):"-0o"+r.toString(8).slice(1)},decimal:function(r){return r.toString(10)},hexadecimal:function(r){return r>=0?"0x"+r.toString(16).toUpperCase():"-0x"+r.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),mM=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function hM(r){return!(r===null||!mM.test(r)||r[r.length-1]==="_")}function gM(r){var e,t;return e=r.replace(/_/g,"").toLowerCase(),t=e[0]==="-"?-1:1,"+-".indexOf(e[0])>=0&&(e=e.slice(1)),e===".inf"?t===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:e===".nan"?NaN:t*parseFloat(e,10)}var yM=/^[-+]?[0-9]+e/;function bM(r,e){var t;if(isNaN(r))switch(e){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===r)switch(e){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===r)switch(e){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(Se.isNegativeZero(r))return"-0.0";return t=r.toString(10),yM.test(t)?t.replace("e",".e"):t}function wM(r){return Object.prototype.toString.call(r)==="[object Number]"&&(r%1!==0||Se.isNegativeZero(r))}var _M=new Je("tag:yaml.org,2002:float",{kind:"scalar",resolve:hM,construct:gM,predicate:wM,represent:bM,defaultStyle:"lowercase"}),vM=XN.extend({implicit:[rM,sM,fM,_M]}),xM=vM,W0=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Z0=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function AM(r){return r===null?!1:W0.exec(r)!==null||Z0.exec(r)!==null}function PM(r){var e,t,n,i,a,s,o,u=0,l=null,c,p,d;if(e=W0.exec(r),e===null&&(e=Z0.exec(r)),e===null)throw new Error("Date resolve error");if(t=+e[1],n=+e[2]-1,i=+e[3],!e[4])return new Date(Date.UTC(t,n,i));if(a=+e[4],s=+e[5],o=+e[6],e[7]){for(u=e[7].slice(0,3);u.length<3;)u+="0";u=+u}return e[9]&&(c=+e[10],p=+(e[11]||0),l=(c*60+p)*6e4,e[9]==="-"&&(l=-l)),d=new Date(Date.UTC(t,n,i,a,s,o,u)),l&&d.setTime(d.getTime()-l),d}function OM(r){return r.toISOString()}var EM=new Je("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:AM,construct:PM,instanceOf:Date,represent:OM});function IM(r){return r==="<<"||r===null}var TM=new Je("tag:yaml.org,2002:merge",{kind:"scalar",resolve:IM}),Ah=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function CM(r){if(r===null)return!1;var e,t,n=0,i=r.length,a=Ah;for(t=0;t<i;t++)if(e=a.indexOf(r.charAt(t)),!(e>64)){if(e<0)return!1;n+=6}return n%8===0}function SM(r){var e,t,n=r.replace(/[\r\n=]/g,""),i=n.length,a=Ah,s=0,o=[];for(e=0;e<i;e++)e%4===0&&e&&(o.push(s>>16&255),o.push(s>>8&255),o.push(s&255)),s=s<<6|a.indexOf(n.charAt(e));return t=i%4*6,t===0?(o.push(s>>16&255),o.push(s>>8&255),o.push(s&255)):t===18?(o.push(s>>10&255),o.push(s>>2&255)):t===12&&o.push(s>>4&255),new Uint8Array(o)}function kM(r){var e="",t=0,n,i,a=r.length,s=Ah;for(n=0;n<a;n++)n%3===0&&n&&(e+=s[t>>18&63],e+=s[t>>12&63],e+=s[t>>6&63],e+=s[t&63]),t=(t<<8)+r[n];return i=a%3,i===0?(e+=s[t>>18&63],e+=s[t>>12&63],e+=s[t>>6&63],e+=s[t&63]):i===2?(e+=s[t>>10&63],e+=s[t>>4&63],e+=s[t<<2&63],e+=s[64]):i===1&&(e+=s[t>>2&63],e+=s[t<<4&63],e+=s[64],e+=s[64]),e}function RM(r){return Object.prototype.toString.call(r)==="[object Uint8Array]"}var NM=new Je("tag:yaml.org,2002:binary",{kind:"scalar",resolve:CM,construct:SM,predicate:RM,represent:kM}),MM=Object.prototype.hasOwnProperty,jM=Object.prototype.toString;function $M(r){if(r===null)return!0;var e=[],t,n,i,a,s,o=r;for(t=0,n=o.length;t<n;t+=1){if(i=o[t],s=!1,jM.call(i)!=="[object Object]")return!1;for(a in i)if(MM.call(i,a))if(!s)s=!0;else return!1;if(!s)return!1;if(e.indexOf(a)===-1)e.push(a);else return!1}return!0}function LM(r){return r!==null?r:[]}var DM=new Je("tag:yaml.org,2002:omap",{kind:"sequence",resolve:$M,construct:LM}),FM=Object.prototype.toString;function qM(r){if(r===null)return!0;var e,t,n,i,a,s=r;for(a=new Array(s.length),e=0,t=s.length;e<t;e+=1){if(n=s[e],FM.call(n)!=="[object Object]"||(i=Object.keys(n),i.length!==1))return!1;a[e]=[i[0],n[i[0]]]}return!0}function UM(r){if(r===null)return[];var e,t,n,i,a,s=r;for(a=new Array(s.length),e=0,t=s.length;e<t;e+=1)n=s[e],i=Object.keys(n),a[e]=[i[0],n[i[0]]];return a}var zM=new Je("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:qM,construct:UM}),BM=Object.prototype.hasOwnProperty;function KM(r){if(r===null)return!0;var e,t=r;for(e in t)if(BM.call(t,e)&&t[e]!==null)return!1;return!0}function VM(r){return r!==null?r:{}}var HM=new Je("tag:yaml.org,2002:set",{kind:"mapping",resolve:KM,construct:VM}),J0=xM.extend({implicit:[EM,TM],explicit:[NM,DM,zM,HM]}),Bn=Object.prototype.hasOwnProperty,Gc=1,Y0=2,X0=3,Wc=4,yh=1,GM=2,R0=3,WM=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,ZM=/[\x85\u2028\u2029]/,JM=/[,\[\]\{\}]/,Q0=/^(?:!|!!|![a-z\-]+!)$/i,eA=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function N0(r){return Object.prototype.toString.call(r)}function Nr(r){return r===10||r===13}function ta(r){return r===9||r===32}function wt(r){return r===9||r===32||r===10||r===13}function Es(r){return r===44||r===91||r===93||r===123||r===125}function YM(r){var e;return 48<=r&&r<=57?r-48:(e=r|32,97<=e&&e<=102?e-97+10:-1)}function XM(r){return r===120?2:r===117?4:r===85?8:0}function QM(r){return 48<=r&&r<=57?r-48:-1}function M0(r){return r===48?"\0":r===97?"\x07":r===98?"\b":r===116||r===9?"	":r===110?`
`:r===118?"\v":r===102?"\f":r===114?"\r":r===101?"\x1B":r===32?" ":r===34?'"':r===47?"/":r===92?"\\":r===78?"\x85":r===95?"\xA0":r===76?"\u2028":r===80?"\u2029":""}function e1(r){return r<=65535?String.fromCharCode(r):String.fromCharCode((r-65536>>10)+55296,(r-65536&1023)+56320)}var tA=new Array(256),rA=new Array(256);for(ea=0;ea<256;ea++)tA[ea]=M0(ea)?1:0,rA[ea]=M0(ea);var ea;function t1(r,e){this.input=r,this.filename=e.filename||null,this.schema=e.schema||J0,this.onWarning=e.onWarning||null,this.legacy=e.legacy||!1,this.json=e.json||!1,this.listener=e.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=r.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function nA(r,e){var t={name:r.filename,buffer:r.input.slice(0,-1),position:r.position,line:r.line,column:r.position-r.lineStart};return t.snippet=zN(t),new bt(e,t)}function j(r,e){throw nA(r,e)}function Zc(r,e){r.onWarning&&r.onWarning.call(null,nA(r,e))}var j0={YAML:function(e,t,n){var i,a,s;e.version!==null&&j(e,"duplication of %YAML directive"),n.length!==1&&j(e,"YAML directive accepts exactly one argument"),i=/^([0-9]+)\.([0-9]+)$/.exec(n[0]),i===null&&j(e,"ill-formed argument of the YAML directive"),a=parseInt(i[1],10),s=parseInt(i[2],10),a!==1&&j(e,"unacceptable YAML version of the document"),e.version=n[0],e.checkLineBreaks=s<2,s!==1&&s!==2&&Zc(e,"unsupported YAML version of the document")},TAG:function(e,t,n){var i,a;n.length!==2&&j(e,"TAG directive accepts exactly two arguments"),i=n[0],a=n[1],Q0.test(i)||j(e,"ill-formed tag handle (first argument) of the TAG directive"),Bn.call(e.tagMap,i)&&j(e,'there is a previously declared suffix for "'+i+'" tag handle'),eA.test(a)||j(e,"ill-formed tag prefix (second argument) of the TAG directive");try{a=decodeURIComponent(a)}catch{j(e,"tag prefix is malformed: "+a)}e.tagMap[i]=a}};function zn(r,e,t,n){var i,a,s,o;if(e<t){if(o=r.input.slice(e,t),n)for(i=0,a=o.length;i<a;i+=1)s=o.charCodeAt(i),s===9||32<=s&&s<=1114111||j(r,"expected valid JSON character");else WM.test(o)&&j(r,"the stream contains non-printable characters");r.result+=o}}function $0(r,e,t,n){var i,a,s,o;for(Se.isObject(t)||j(r,"cannot merge mappings; the provided source object is unacceptable"),i=Object.keys(t),s=0,o=i.length;s<o;s+=1)a=i[s],Bn.call(e,a)||(e[a]=t[a],n[a]=!0)}function Is(r,e,t,n,i,a,s,o,u){var l,c;if(Array.isArray(i))for(i=Array.prototype.slice.call(i),l=0,c=i.length;l<c;l+=1)Array.isArray(i[l])&&j(r,"nested arrays are not supported inside keys"),typeof i=="object"&&N0(i[l])==="[object Object]"&&(i[l]="[object Object]");if(typeof i=="object"&&N0(i)==="[object Object]"&&(i="[object Object]"),i=String(i),e===null&&(e={}),n==="tag:yaml.org,2002:merge")if(Array.isArray(a))for(l=0,c=a.length;l<c;l+=1)$0(r,e,a[l],t);else $0(r,e,a,t);else!r.json&&!Bn.call(t,i)&&Bn.call(e,i)&&(r.line=s||r.line,r.lineStart=o||r.lineStart,r.position=u||r.position,j(r,"duplicated mapping key")),i==="__proto__"?Object.defineProperty(e,i,{configurable:!0,enumerable:!0,writable:!0,value:a}):e[i]=a,delete t[i];return e}function Ph(r){var e;e=r.input.charCodeAt(r.position),e===10?r.position++:e===13?(r.position++,r.input.charCodeAt(r.position)===10&&r.position++):j(r,"a line break is expected"),r.line+=1,r.lineStart=r.position,r.firstTabInLine=-1}function Oe(r,e,t){for(var n=0,i=r.input.charCodeAt(r.position);i!==0;){for(;ta(i);)i===9&&r.firstTabInLine===-1&&(r.firstTabInLine=r.position),i=r.input.charCodeAt(++r.position);if(e&&i===35)do i=r.input.charCodeAt(++r.position);while(i!==10&&i!==13&&i!==0);if(Nr(i))for(Ph(r),i=r.input.charCodeAt(r.position),n++,r.lineIndent=0;i===32;)r.lineIndent++,i=r.input.charCodeAt(++r.position);else break}return t!==-1&&n!==0&&r.lineIndent<t&&Zc(r,"deficient indentation"),n}function Xc(r){var e=r.position,t;return t=r.input.charCodeAt(e),!!((t===45||t===46)&&t===r.input.charCodeAt(e+1)&&t===r.input.charCodeAt(e+2)&&(e+=3,t=r.input.charCodeAt(e),t===0||wt(t)))}function Oh(r,e){e===1?r.result+=" ":e>1&&(r.result+=Se.repeat(`
`,e-1))}function r1(r,e,t){var n,i,a,s,o,u,l,c,p=r.kind,d=r.result,f;if(f=r.input.charCodeAt(r.position),wt(f)||Es(f)||f===35||f===38||f===42||f===33||f===124||f===62||f===39||f===34||f===37||f===64||f===96||(f===63||f===45)&&(i=r.input.charCodeAt(r.position+1),wt(i)||t&&Es(i)))return!1;for(r.kind="scalar",r.result="",a=s=r.position,o=!1;f!==0;){if(f===58){if(i=r.input.charCodeAt(r.position+1),wt(i)||t&&Es(i))break}else if(f===35){if(n=r.input.charCodeAt(r.position-1),wt(n))break}else{if(r.position===r.lineStart&&Xc(r)||t&&Es(f))break;if(Nr(f))if(u=r.line,l=r.lineStart,c=r.lineIndent,Oe(r,!1,-1),r.lineIndent>=e){o=!0,f=r.input.charCodeAt(r.position);continue}else{r.position=s,r.line=u,r.lineStart=l,r.lineIndent=c;break}}o&&(zn(r,a,s,!1),Oh(r,r.line-u),a=s=r.position,o=!1),ta(f)||(s=r.position+1),f=r.input.charCodeAt(++r.position)}return zn(r,a,s,!1),r.result?!0:(r.kind=p,r.result=d,!1)}function n1(r,e){var t,n,i;if(t=r.input.charCodeAt(r.position),t!==39)return!1;for(r.kind="scalar",r.result="",r.position++,n=i=r.position;(t=r.input.charCodeAt(r.position))!==0;)if(t===39)if(zn(r,n,r.position,!0),t=r.input.charCodeAt(++r.position),t===39)n=r.position,r.position++,i=r.position;else return!0;else Nr(t)?(zn(r,n,i,!0),Oh(r,Oe(r,!1,e)),n=i=r.position):r.position===r.lineStart&&Xc(r)?j(r,"unexpected end of the document within a single quoted scalar"):(r.position++,i=r.position);j(r,"unexpected end of the stream within a single quoted scalar")}function i1(r,e){var t,n,i,a,s,o;if(o=r.input.charCodeAt(r.position),o!==34)return!1;for(r.kind="scalar",r.result="",r.position++,t=n=r.position;(o=r.input.charCodeAt(r.position))!==0;){if(o===34)return zn(r,t,r.position,!0),r.position++,!0;if(o===92){if(zn(r,t,r.position,!0),o=r.input.charCodeAt(++r.position),Nr(o))Oe(r,!1,e);else if(o<256&&tA[o])r.result+=rA[o],r.position++;else if((s=XM(o))>0){for(i=s,a=0;i>0;i--)o=r.input.charCodeAt(++r.position),(s=YM(o))>=0?a=(a<<4)+s:j(r,"expected hexadecimal character");r.result+=e1(a),r.position++}else j(r,"unknown escape sequence");t=n=r.position}else Nr(o)?(zn(r,t,n,!0),Oh(r,Oe(r,!1,e)),t=n=r.position):r.position===r.lineStart&&Xc(r)?j(r,"unexpected end of the document within a double quoted scalar"):(r.position++,n=r.position)}j(r,"unexpected end of the stream within a double quoted scalar")}function a1(r,e){var t=!0,n,i,a,s=r.tag,o,u=r.anchor,l,c,p,d,f,m=Object.create(null),h,y,_,b;if(b=r.input.charCodeAt(r.position),b===91)c=93,f=!1,o=[];else if(b===123)c=125,f=!0,o={};else return!1;for(r.anchor!==null&&(r.anchorMap[r.anchor]=o),b=r.input.charCodeAt(++r.position);b!==0;){if(Oe(r,!0,e),b=r.input.charCodeAt(r.position),b===c)return r.position++,r.tag=s,r.anchor=u,r.kind=f?"mapping":"sequence",r.result=o,!0;t?b===44&&j(r,"expected the node content, but found ','"):j(r,"missed comma between flow collection entries"),y=h=_=null,p=d=!1,b===63&&(l=r.input.charCodeAt(r.position+1),wt(l)&&(p=d=!0,r.position++,Oe(r,!0,e))),n=r.line,i=r.lineStart,a=r.position,Ts(r,e,Gc,!1,!0),y=r.tag,h=r.result,Oe(r,!0,e),b=r.input.charCodeAt(r.position),(d||r.line===n)&&b===58&&(p=!0,b=r.input.charCodeAt(++r.position),Oe(r,!0,e),Ts(r,e,Gc,!1,!0),_=r.result),f?Is(r,o,m,y,h,_,n,i,a):p?o.push(Is(r,null,m,y,h,_,n,i,a)):o.push(h),Oe(r,!0,e),b=r.input.charCodeAt(r.position),b===44?(t=!0,b=r.input.charCodeAt(++r.position)):t=!1}j(r,"unexpected end of the stream within a flow collection")}function s1(r,e){var t,n,i=yh,a=!1,s=!1,o=e,u=0,l=!1,c,p;if(p=r.input.charCodeAt(r.position),p===124)n=!1;else if(p===62)n=!0;else return!1;for(r.kind="scalar",r.result="";p!==0;)if(p=r.input.charCodeAt(++r.position),p===43||p===45)yh===i?i=p===43?R0:GM:j(r,"repeat of a chomping mode identifier");else if((c=QM(p))>=0)c===0?j(r,"bad explicit indentation width of a block scalar; it cannot be less than one"):s?j(r,"repeat of an indentation width identifier"):(o=e+c-1,s=!0);else break;if(ta(p)){do p=r.input.charCodeAt(++r.position);while(ta(p));if(p===35)do p=r.input.charCodeAt(++r.position);while(!Nr(p)&&p!==0)}for(;p!==0;){for(Ph(r),r.lineIndent=0,p=r.input.charCodeAt(r.position);(!s||r.lineIndent<o)&&p===32;)r.lineIndent++,p=r.input.charCodeAt(++r.position);if(!s&&r.lineIndent>o&&(o=r.lineIndent),Nr(p)){u++;continue}if(r.lineIndent<o){i===R0?r.result+=Se.repeat(`
`,a?1+u:u):i===yh&&a&&(r.result+=`
`);break}for(n?ta(p)?(l=!0,r.result+=Se.repeat(`
`,a?1+u:u)):l?(l=!1,r.result+=Se.repeat(`
`,u+1)):u===0?a&&(r.result+=" "):r.result+=Se.repeat(`
`,u):r.result+=Se.repeat(`
`,a?1+u:u),a=!0,s=!0,u=0,t=r.position;!Nr(p)&&p!==0;)p=r.input.charCodeAt(++r.position);zn(r,t,r.position,!1)}return!0}function L0(r,e){var t,n=r.tag,i=r.anchor,a=[],s,o=!1,u;if(r.firstTabInLine!==-1)return!1;for(r.anchor!==null&&(r.anchorMap[r.anchor]=a),u=r.input.charCodeAt(r.position);u!==0&&(r.firstTabInLine!==-1&&(r.position=r.firstTabInLine,j(r,"tab characters must not be used in indentation")),!(u!==45||(s=r.input.charCodeAt(r.position+1),!wt(s))));){if(o=!0,r.position++,Oe(r,!0,-1)&&r.lineIndent<=e){a.push(null),u=r.input.charCodeAt(r.position);continue}if(t=r.line,Ts(r,e,X0,!1,!0),a.push(r.result),Oe(r,!0,-1),u=r.input.charCodeAt(r.position),(r.line===t||r.lineIndent>e)&&u!==0)j(r,"bad indentation of a sequence entry");else if(r.lineIndent<e)break}return o?(r.tag=n,r.anchor=i,r.kind="sequence",r.result=a,!0):!1}function o1(r,e,t){var n,i,a,s,o,u,l=r.tag,c=r.anchor,p={},d=Object.create(null),f=null,m=null,h=null,y=!1,_=!1,b;if(r.firstTabInLine!==-1)return!1;for(r.anchor!==null&&(r.anchorMap[r.anchor]=p),b=r.input.charCodeAt(r.position);b!==0;){if(!y&&r.firstTabInLine!==-1&&(r.position=r.firstTabInLine,j(r,"tab characters must not be used in indentation")),n=r.input.charCodeAt(r.position+1),a=r.line,(b===63||b===58)&&wt(n))b===63?(y&&(Is(r,p,d,f,m,null,s,o,u),f=m=h=null),_=!0,y=!0,i=!0):y?(y=!1,i=!0):j(r,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),r.position+=1,b=n;else{if(s=r.line,o=r.lineStart,u=r.position,!Ts(r,t,Y0,!1,!0))break;if(r.line===a){for(b=r.input.charCodeAt(r.position);ta(b);)b=r.input.charCodeAt(++r.position);if(b===58)b=r.input.charCodeAt(++r.position),wt(b)||j(r,"a whitespace character is expected after the key-value separator within a block mapping"),y&&(Is(r,p,d,f,m,null,s,o,u),f=m=h=null),_=!0,y=!1,i=!1,f=r.tag,m=r.result;else if(_)j(r,"can not read an implicit mapping pair; a colon is missed");else return r.tag=l,r.anchor=c,!0}else if(_)j(r,"can not read a block mapping entry; a multiline key may not be an implicit key");else return r.tag=l,r.anchor=c,!0}if((r.line===a||r.lineIndent>e)&&(y&&(s=r.line,o=r.lineStart,u=r.position),Ts(r,e,Wc,!0,i)&&(y?m=r.result:h=r.result),y||(Is(r,p,d,f,m,h,s,o,u),f=m=h=null),Oe(r,!0,-1),b=r.input.charCodeAt(r.position)),(r.line===a||r.lineIndent>e)&&b!==0)j(r,"bad indentation of a mapping entry");else if(r.lineIndent<e)break}return y&&Is(r,p,d,f,m,null,s,o,u),_&&(r.tag=l,r.anchor=c,r.kind="mapping",r.result=p),_}function u1(r){var e,t=!1,n=!1,i,a,s;if(s=r.input.charCodeAt(r.position),s!==33)return!1;if(r.tag!==null&&j(r,"duplication of a tag property"),s=r.input.charCodeAt(++r.position),s===60?(t=!0,s=r.input.charCodeAt(++r.position)):s===33?(n=!0,i="!!",s=r.input.charCodeAt(++r.position)):i="!",e=r.position,t){do s=r.input.charCodeAt(++r.position);while(s!==0&&s!==62);r.position<r.length?(a=r.input.slice(e,r.position),s=r.input.charCodeAt(++r.position)):j(r,"unexpected end of the stream within a verbatim tag")}else{for(;s!==0&&!wt(s);)s===33&&(n?j(r,"tag suffix cannot contain exclamation marks"):(i=r.input.slice(e-1,r.position+1),Q0.test(i)||j(r,"named tag handle cannot contain such characters"),n=!0,e=r.position+1)),s=r.input.charCodeAt(++r.position);a=r.input.slice(e,r.position),JM.test(a)&&j(r,"tag suffix cannot contain flow indicator characters")}a&&!eA.test(a)&&j(r,"tag name cannot contain such characters: "+a);try{a=decodeURIComponent(a)}catch{j(r,"tag name is malformed: "+a)}return t?r.tag=a:Bn.call(r.tagMap,i)?r.tag=r.tagMap[i]+a:i==="!"?r.tag="!"+a:i==="!!"?r.tag="tag:yaml.org,2002:"+a:j(r,'undeclared tag handle "'+i+'"'),!0}function l1(r){var e,t;if(t=r.input.charCodeAt(r.position),t!==38)return!1;for(r.anchor!==null&&j(r,"duplication of an anchor property"),t=r.input.charCodeAt(++r.position),e=r.position;t!==0&&!wt(t)&&!Es(t);)t=r.input.charCodeAt(++r.position);return r.position===e&&j(r,"name of an anchor node must contain at least one character"),r.anchor=r.input.slice(e,r.position),!0}function c1(r){var e,t,n;if(n=r.input.charCodeAt(r.position),n!==42)return!1;for(n=r.input.charCodeAt(++r.position),e=r.position;n!==0&&!wt(n)&&!Es(n);)n=r.input.charCodeAt(++r.position);return r.position===e&&j(r,"name of an alias node must contain at least one character"),t=r.input.slice(e,r.position),Bn.call(r.anchorMap,t)||j(r,'unidentified alias "'+t+'"'),r.result=r.anchorMap[t],Oe(r,!0,-1),!0}function Ts(r,e,t,n,i){var a,s,o,u=1,l=!1,c=!1,p,d,f,m,h,y;if(r.listener!==null&&r.listener("open",r),r.tag=null,r.anchor=null,r.kind=null,r.result=null,a=s=o=Wc===t||X0===t,n&&Oe(r,!0,-1)&&(l=!0,r.lineIndent>e?u=1:r.lineIndent===e?u=0:r.lineIndent<e&&(u=-1)),u===1)for(;u1(r)||l1(r);)Oe(r,!0,-1)?(l=!0,o=a,r.lineIndent>e?u=1:r.lineIndent===e?u=0:r.lineIndent<e&&(u=-1)):o=!1;if(o&&(o=l||i),(u===1||Wc===t)&&(Gc===t||Y0===t?h=e:h=e+1,y=r.position-r.lineStart,u===1?o&&(L0(r,y)||o1(r,y,h))||a1(r,h)?c=!0:(s&&s1(r,h)||n1(r,h)||i1(r,h)?c=!0:c1(r)?(c=!0,(r.tag!==null||r.anchor!==null)&&j(r,"alias node should not have any properties")):r1(r,h,Gc===t)&&(c=!0,r.tag===null&&(r.tag="?")),r.anchor!==null&&(r.anchorMap[r.anchor]=r.result)):u===0&&(c=o&&L0(r,y))),r.tag===null)r.anchor!==null&&(r.anchorMap[r.anchor]=r.result);else if(r.tag==="?"){for(r.result!==null&&r.kind!=="scalar"&&j(r,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+r.kind+'"'),p=0,d=r.implicitTypes.length;p<d;p+=1)if(m=r.implicitTypes[p],m.resolve(r.result)){r.result=m.construct(r.result),r.tag=m.tag,r.anchor!==null&&(r.anchorMap[r.anchor]=r.result);break}}else if(r.tag!=="!"){if(Bn.call(r.typeMap[r.kind||"fallback"],r.tag))m=r.typeMap[r.kind||"fallback"][r.tag];else for(m=null,f=r.typeMap.multi[r.kind||"fallback"],p=0,d=f.length;p<d;p+=1)if(r.tag.slice(0,f[p].tag.length)===f[p].tag){m=f[p];break}m||j(r,"unknown tag !<"+r.tag+">"),r.result!==null&&m.kind!==r.kind&&j(r,"unacceptable node kind for !<"+r.tag+'> tag; it should be "'+m.kind+'", not "'+r.kind+'"'),m.resolve(r.result,r.tag)?(r.result=m.construct(r.result,r.tag),r.anchor!==null&&(r.anchorMap[r.anchor]=r.result)):j(r,"cannot resolve a node with !<"+r.tag+"> explicit tag")}return r.listener!==null&&r.listener("close",r),r.tag!==null||r.anchor!==null||c}function p1(r){var e=r.position,t,n,i,a=!1,s;for(r.version=null,r.checkLineBreaks=r.legacy,r.tagMap=Object.create(null),r.anchorMap=Object.create(null);(s=r.input.charCodeAt(r.position))!==0&&(Oe(r,!0,-1),s=r.input.charCodeAt(r.position),!(r.lineIndent>0||s!==37));){for(a=!0,s=r.input.charCodeAt(++r.position),t=r.position;s!==0&&!wt(s);)s=r.input.charCodeAt(++r.position);for(n=r.input.slice(t,r.position),i=[],n.length<1&&j(r,"directive name must not be less than one character in length");s!==0;){for(;ta(s);)s=r.input.charCodeAt(++r.position);if(s===35){do s=r.input.charCodeAt(++r.position);while(s!==0&&!Nr(s));break}if(Nr(s))break;for(t=r.position;s!==0&&!wt(s);)s=r.input.charCodeAt(++r.position);i.push(r.input.slice(t,r.position))}s!==0&&Ph(r),Bn.call(j0,n)?j0[n](r,n,i):Zc(r,'unknown document directive "'+n+'"')}if(Oe(r,!0,-1),r.lineIndent===0&&r.input.charCodeAt(r.position)===45&&r.input.charCodeAt(r.position+1)===45&&r.input.charCodeAt(r.position+2)===45?(r.position+=3,Oe(r,!0,-1)):a&&j(r,"directives end mark is expected"),Ts(r,r.lineIndent-1,Wc,!1,!0),Oe(r,!0,-1),r.checkLineBreaks&&ZM.test(r.input.slice(e,r.position))&&Zc(r,"non-ASCII line breaks are interpreted as content"),r.documents.push(r.result),r.position===r.lineStart&&Xc(r)){r.input.charCodeAt(r.position)===46&&(r.position+=3,Oe(r,!0,-1));return}if(r.position<r.length-1)j(r,"end of the stream or a document separator is expected");else return}function iA(r,e){r=String(r),e=e||{},r.length!==0&&(r.charCodeAt(r.length-1)!==10&&r.charCodeAt(r.length-1)!==13&&(r+=`
`),r.charCodeAt(0)===65279&&(r=r.slice(1)));var t=new t1(r,e),n=r.indexOf("\0");for(n!==-1&&(t.position=n,j(t,"null byte is not allowed in input")),t.input+="\0";t.input.charCodeAt(t.position)===32;)t.lineIndent+=1,t.position+=1;for(;t.position<t.length-1;)p1(t);return t.documents}function d1(r,e,t){e!==null&&typeof e=="object"&&typeof t>"u"&&(t=e,e=null);var n=iA(r,t);if(typeof e!="function")return n;for(var i=0,a=n.length;i<a;i+=1)e(n[i])}function f1(r,e){var t=iA(r,e);if(t.length!==0){if(t.length===1)return t[0];throw new bt("expected a single document in the stream, but found more")}}var m1=d1,h1=f1,aA={loadAll:m1,load:h1},sA=Object.prototype.toString,oA=Object.prototype.hasOwnProperty,Eh=65279,g1=9,du=10,y1=13,b1=32,w1=33,_1=34,wh=35,v1=37,x1=38,A1=39,P1=42,uA=44,O1=45,Jc=58,E1=61,I1=62,T1=63,C1=64,lA=91,cA=93,S1=96,pA=123,k1=124,dA=125,Ye={};Ye[0]="\\0";Ye[7]="\\a";Ye[8]="\\b";Ye[9]="\\t";Ye[10]="\\n";Ye[11]="\\v";Ye[12]="\\f";Ye[13]="\\r";Ye[27]="\\e";Ye[34]='\\"';Ye[92]="\\\\";Ye[133]="\\N";Ye[160]="\\_";Ye[8232]="\\L";Ye[8233]="\\P";var R1=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],N1=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function M1(r,e){var t,n,i,a,s,o,u;if(e===null)return{};for(t={},n=Object.keys(e),i=0,a=n.length;i<a;i+=1)s=n[i],o=String(e[s]),s.slice(0,2)==="!!"&&(s="tag:yaml.org,2002:"+s.slice(2)),u=r.compiledTypeMap.fallback[s],u&&oA.call(u.styleAliases,o)&&(o=u.styleAliases[o]),t[s]=o;return t}function j1(r){var e,t,n;if(e=r.toString(16).toUpperCase(),r<=255)t="x",n=2;else if(r<=65535)t="u",n=4;else if(r<=4294967295)t="U",n=8;else throw new bt("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+t+Se.repeat("0",n-e.length)+e}var $1=1,fu=2;function L1(r){this.schema=r.schema||J0,this.indent=Math.max(1,r.indent||2),this.noArrayIndent=r.noArrayIndent||!1,this.skipInvalid=r.skipInvalid||!1,this.flowLevel=Se.isNothing(r.flowLevel)?-1:r.flowLevel,this.styleMap=M1(this.schema,r.styles||null),this.sortKeys=r.sortKeys||!1,this.lineWidth=r.lineWidth||80,this.noRefs=r.noRefs||!1,this.noCompatMode=r.noCompatMode||!1,this.condenseFlow=r.condenseFlow||!1,this.quotingType=r.quotingType==='"'?fu:$1,this.forceQuotes=r.forceQuotes||!1,this.replacer=typeof r.replacer=="function"?r.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function D0(r,e){for(var t=Se.repeat(" ",e),n=0,i=-1,a="",s,o=r.length;n<o;)i=r.indexOf(`
`,n),i===-1?(s=r.slice(n),n=o):(s=r.slice(n,i+1),n=i+1),s.length&&s!==`
`&&(a+=t),a+=s;return a}function _h(r,e){return`
`+Se.repeat(" ",r.indent*e)}function D1(r,e){var t,n,i;for(t=0,n=r.implicitTypes.length;t<n;t+=1)if(i=r.implicitTypes[t],i.resolve(e))return!0;return!1}function Yc(r){return r===b1||r===g1}function mu(r){return 32<=r&&r<=126||161<=r&&r<=55295&&r!==8232&&r!==8233||57344<=r&&r<=65533&&r!==Eh||65536<=r&&r<=1114111}function F0(r){return mu(r)&&r!==Eh&&r!==y1&&r!==du}function q0(r,e,t){var n=F0(r),i=n&&!Yc(r);return(t?n:n&&r!==uA&&r!==lA&&r!==cA&&r!==pA&&r!==dA)&&r!==wh&&!(e===Jc&&!i)||F0(e)&&!Yc(e)&&r===wh||e===Jc&&i}function F1(r){return mu(r)&&r!==Eh&&!Yc(r)&&r!==O1&&r!==T1&&r!==Jc&&r!==uA&&r!==lA&&r!==cA&&r!==pA&&r!==dA&&r!==wh&&r!==x1&&r!==P1&&r!==w1&&r!==k1&&r!==E1&&r!==I1&&r!==A1&&r!==_1&&r!==v1&&r!==C1&&r!==S1}function q1(r){return!Yc(r)&&r!==Jc}function cu(r,e){var t=r.charCodeAt(e),n;return t>=55296&&t<=56319&&e+1<r.length&&(n=r.charCodeAt(e+1),n>=56320&&n<=57343)?(t-55296)*1024+n-56320+65536:t}function fA(r){var e=/^\n* /;return e.test(r)}var mA=1,vh=2,hA=3,gA=4,Os=5;function U1(r,e,t,n,i,a,s,o){var u,l=0,c=null,p=!1,d=!1,f=n!==-1,m=-1,h=F1(cu(r,0))&&q1(cu(r,r.length-1));if(e||s)for(u=0;u<r.length;l>=65536?u+=2:u++){if(l=cu(r,u),!mu(l))return Os;h=h&&q0(l,c,o),c=l}else{for(u=0;u<r.length;l>=65536?u+=2:u++){if(l=cu(r,u),l===du)p=!0,f&&(d=d||u-m-1>n&&r[m+1]!==" ",m=u);else if(!mu(l))return Os;h=h&&q0(l,c,o),c=l}d=d||f&&u-m-1>n&&r[m+1]!==" "}return!p&&!d?h&&!s&&!i(r)?mA:a===fu?Os:vh:t>9&&fA(r)?Os:s?a===fu?Os:vh:d?gA:hA}function z1(r,e,t,n,i){r.dump=function(){if(e.length===0)return r.quotingType===fu?'""':"''";if(!r.noCompatMode&&(R1.indexOf(e)!==-1||N1.test(e)))return r.quotingType===fu?'"'+e+'"':"'"+e+"'";var a=r.indent*Math.max(1,t),s=r.lineWidth===-1?-1:Math.max(Math.min(r.lineWidth,40),r.lineWidth-a),o=n||r.flowLevel>-1&&t>=r.flowLevel;function u(l){return D1(r,l)}switch(U1(e,o,r.indent,s,u,r.quotingType,r.forceQuotes&&!n,i)){case mA:return e;case vh:return"'"+e.replace(/'/g,"''")+"'";case hA:return"|"+U0(e,r.indent)+z0(D0(e,a));case gA:return">"+U0(e,r.indent)+z0(D0(B1(e,s),a));case Os:return'"'+K1(e)+'"';default:throw new bt("impossible error: invalid scalar style")}}()}function U0(r,e){var t=fA(r)?String(e):"",n=r[r.length-1]===`
`,i=n&&(r[r.length-2]===`
`||r===`
`),a=i?"+":n?"":"-";return t+a+`
`}function z0(r){return r[r.length-1]===`
`?r.slice(0,-1):r}function B1(r,e){for(var t=/(\n+)([^\n]*)/g,n=function(){var l=r.indexOf(`
`);return l=l!==-1?l:r.length,t.lastIndex=l,B0(r.slice(0,l),e)}(),i=r[0]===`
`||r[0]===" ",a,s;s=t.exec(r);){var o=s[1],u=s[2];a=u[0]===" ",n+=o+(!i&&!a&&u!==""?`
`:"")+B0(u,e),i=a}return n}function B0(r,e){if(r===""||r[0]===" ")return r;for(var t=/ [^ ]/g,n,i=0,a,s=0,o=0,u="";n=t.exec(r);)o=n.index,o-i>e&&(a=s>i?s:o,u+=`
`+r.slice(i,a),i=a+1),s=o;return u+=`
`,r.length-i>e&&s>i?u+=r.slice(i,s)+`
`+r.slice(s+1):u+=r.slice(i),u.slice(1)}function K1(r){for(var e="",t=0,n,i=0;i<r.length;t>=65536?i+=2:i++)t=cu(r,i),n=Ye[t],!n&&mu(t)?(e+=r[i],t>=65536&&(e+=r[i+1])):e+=n||j1(t);return e}function V1(r,e,t){var n="",i=r.tag,a,s,o;for(a=0,s=t.length;a<s;a+=1)o=t[a],r.replacer&&(o=r.replacer.call(t,String(a),o)),(ln(r,e,o,!1,!1)||typeof o>"u"&&ln(r,e,null,!1,!1))&&(n!==""&&(n+=","+(r.condenseFlow?"":" ")),n+=r.dump);r.tag=i,r.dump="["+n+"]"}function K0(r,e,t,n){var i="",a=r.tag,s,o,u;for(s=0,o=t.length;s<o;s+=1)u=t[s],r.replacer&&(u=r.replacer.call(t,String(s),u)),(ln(r,e+1,u,!0,!0,!1,!0)||typeof u>"u"&&ln(r,e+1,null,!0,!0,!1,!0))&&((!n||i!=="")&&(i+=_h(r,e)),r.dump&&du===r.dump.charCodeAt(0)?i+="-":i+="- ",i+=r.dump);r.tag=a,r.dump=i||"[]"}function H1(r,e,t){var n="",i=r.tag,a=Object.keys(t),s,o,u,l,c;for(s=0,o=a.length;s<o;s+=1)c="",n!==""&&(c+=", "),r.condenseFlow&&(c+='"'),u=a[s],l=t[u],r.replacer&&(l=r.replacer.call(t,u,l)),ln(r,e,u,!1,!1)&&(r.dump.length>1024&&(c+="? "),c+=r.dump+(r.condenseFlow?'"':"")+":"+(r.condenseFlow?"":" "),ln(r,e,l,!1,!1)&&(c+=r.dump,n+=c));r.tag=i,r.dump="{"+n+"}"}function G1(r,e,t,n){var i="",a=r.tag,s=Object.keys(t),o,u,l,c,p,d;if(r.sortKeys===!0)s.sort();else if(typeof r.sortKeys=="function")s.sort(r.sortKeys);else if(r.sortKeys)throw new bt("sortKeys must be a boolean or a function");for(o=0,u=s.length;o<u;o+=1)d="",(!n||i!=="")&&(d+=_h(r,e)),l=s[o],c=t[l],r.replacer&&(c=r.replacer.call(t,l,c)),ln(r,e+1,l,!0,!0,!0)&&(p=r.tag!==null&&r.tag!=="?"||r.dump&&r.dump.length>1024,p&&(r.dump&&du===r.dump.charCodeAt(0)?d+="?":d+="? "),d+=r.dump,p&&(d+=_h(r,e)),ln(r,e+1,c,!0,p)&&(r.dump&&du===r.dump.charCodeAt(0)?d+=":":d+=": ",d+=r.dump,i+=d));r.tag=a,r.dump=i||"{}"}function V0(r,e,t){var n,i,a,s,o,u;for(i=t?r.explicitTypes:r.implicitTypes,a=0,s=i.length;a<s;a+=1)if(o=i[a],(o.instanceOf||o.predicate)&&(!o.instanceOf||typeof e=="object"&&e instanceof o.instanceOf)&&(!o.predicate||o.predicate(e))){if(t?o.multi&&o.representName?r.tag=o.representName(e):r.tag=o.tag:r.tag="?",o.represent){if(u=r.styleMap[o.tag]||o.defaultStyle,sA.call(o.represent)==="[object Function]")n=o.represent(e,u);else if(oA.call(o.represent,u))n=o.represent[u](e,u);else throw new bt("!<"+o.tag+'> tag resolver accepts not "'+u+'" style');r.dump=n}return!0}return!1}function ln(r,e,t,n,i,a,s){r.tag=null,r.dump=t,V0(r,t,!1)||V0(r,t,!0);var o=sA.call(r.dump),u=n,l;n&&(n=r.flowLevel<0||r.flowLevel>e);var c=o==="[object Object]"||o==="[object Array]",p,d;if(c&&(p=r.duplicates.indexOf(t),d=p!==-1),(r.tag!==null&&r.tag!=="?"||d||r.indent!==2&&e>0)&&(i=!1),d&&r.usedDuplicates[p])r.dump="*ref_"+p;else{if(c&&d&&!r.usedDuplicates[p]&&(r.usedDuplicates[p]=!0),o==="[object Object]")n&&Object.keys(r.dump).length!==0?(G1(r,e,r.dump,i),d&&(r.dump="&ref_"+p+r.dump)):(H1(r,e,r.dump),d&&(r.dump="&ref_"+p+" "+r.dump));else if(o==="[object Array]")n&&r.dump.length!==0?(r.noArrayIndent&&!s&&e>0?K0(r,e-1,r.dump,i):K0(r,e,r.dump,i),d&&(r.dump="&ref_"+p+r.dump)):(V1(r,e,r.dump),d&&(r.dump="&ref_"+p+" "+r.dump));else if(o==="[object String]")r.tag!=="?"&&z1(r,r.dump,e,a,u);else{if(o==="[object Undefined]")return!1;if(r.skipInvalid)return!1;throw new bt("unacceptable kind of an object to dump "+o)}r.tag!==null&&r.tag!=="?"&&(l=encodeURI(r.tag[0]==="!"?r.tag.slice(1):r.tag).replace(/!/g,"%21"),r.tag[0]==="!"?l="!"+l:l.slice(0,18)==="tag:yaml.org,2002:"?l="!!"+l.slice(18):l="!<"+l+">",r.dump=l+" "+r.dump)}return!0}function W1(r,e){var t=[],n=[],i,a;for(xh(r,t,n),i=0,a=n.length;i<a;i+=1)e.duplicates.push(t[n[i]]);e.usedDuplicates=new Array(a)}function xh(r,e,t){var n,i,a;if(r!==null&&typeof r=="object")if(i=e.indexOf(r),i!==-1)t.indexOf(i)===-1&&t.push(i);else if(e.push(r),Array.isArray(r))for(i=0,a=r.length;i<a;i+=1)xh(r[i],e,t);else for(n=Object.keys(r),i=0,a=n.length;i<a;i+=1)xh(r[n[i]],e,t)}function Z1(r,e){e=e||{};var t=new L1(e);t.noRefs||W1(r,t);var n=r;return t.replacer&&(n=t.replacer.call({"":n},"",n)),ln(t,0,n,!0,!0)?t.dump+`
`:""}var J1=Z1,Y1={dump:J1};function Ih(r,e){return function(){throw new Error("Function yaml."+r+" is removed in js-yaml 4. Use yaml."+e+" instead, which is now safe by default.")}}var X1=aA.load,yX=aA.loadAll,bX=Y1.dump;var wX=Ih("safeLoad","load"),_X=Ih("safeLoadAll","loadAll"),vX=Ih("safeDump","dump");Ze();je();ou();je();Ae();Vr();je();En();ht();In();var Qc=class extends Z{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e?.callbacks,this.tags=e?.tags??[],this.metadata=e?.metadata??{},this.verbose=e?.verbose??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,G(t))}async getRelevantDocuments(e,t){let n=G(Oa(t)),a=await(await be.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}))?.handleRetrieverStart(this.toJSON(),e,n.runId,void 0,void 0,void 0,n.runName);try{let s=await this._getRelevantDocuments(e,a);return await a?.handleRetrieverEnd(s),s}catch(s){throw await a?.handleRetrieverError(s),s}}};Vr();var hu=class extends Qc{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t?.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t?.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}},ep=class extends Fe{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,n=void 0,i=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,n)).map(s=>s[0])}async similaritySearchWithScore(e,t=4,n=void 0,i=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,n)}static fromTexts(e,t,n,i){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,n){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,n,i,a,s){if(typeof e=="number")return new hu({vectorStore:this,k:e,filter:t,tags:[...i??[],this._vectorstoreType()],metadata:a,verbose:s,callbacks:n});{let o={vectorStore:this,k:e?.k,filter:e?.filter,tags:[...e?.tags??[],this._vectorstoreType()],metadata:e?.metadata,verbose:e?.verbose,callbacks:e?.callbacks,searchType:e?.searchType};return e?.searchType==="mmr"?new hu({...o,searchKwargs:e.searchKwargs}):new hu({...o})}}};function yA(r,e){let t=0,n=0,i=0;for(let a=0;a<r.length;a++)t+=r[a]*e[a],n+=r[a]*r[a],i+=e[a]*e[a];return t/(Math.sqrt(n)*Math.sqrt(i))}function bA(r,e){let t=0,n=0,i=0;for(let a=0;a<r.length;a++)t+=r[a]*e[a],n+=r[a]*r[a],i+=e[a]*e[a];return t/(Math.sqrt(n)*Math.sqrt(i))}function tj(r,e,t){if(r.length===0||r[0].length===0||e.length===0||e[0].length===0)return[[]];if(r[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[r.length,r[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return r.map(n=>e.map(i=>t(n,i)).map(i=>Number.isNaN(i)?0:i))}function wA(r,e){return tj(r,e,bA)}function _A(r,e,t=.5,n=4){if(Math.min(n,e.length)<=0)return[];let i=Array.isArray(r[0])?r:[r],a=wA(i,e)[0],s=rj(a).maxIndex,o=[e[s]],u=[s];for(;u.length<Math.min(n,e.length);){let l=-1/0,c=-1,p=wA(e,o);a.forEach((d,f)=>{if(u.includes(f))return;let m=Math.max(...p[f]),h=t*d-(1-t)*m;h>l&&(l=h,c=f)}),o.push(e[c]),u.push(c)}return u}function rj(r){if(r.length===0)return{maxIndex:-1,maxValue:NaN};let e=r[0],t=0;for(let n=1;n<r.length;n+=1)r[n]>e&&(t=n,e=r[n]);return{maxIndex:t,maxValue:e}}var tp=class r extends ep{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...n}={}){super(e,n),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??yA}async addDocuments(e){let t=e.map(({pageContent:n})=>n);return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){let n=e.map((i,a)=>({content:t[a].pageContent,embedding:i,metadata:t[a].metadata,id:t[a].id}));this.memoryVectors=this.memoryVectors.concat(n)}async _queryVectors(e,t,n){let i=s=>{if(!n)return!0;let o=new lr({metadata:s.metadata,pageContent:s.content,id:s.id});return n(o)};return this.memoryVectors.filter(i).map((s,o)=>({similarity:this.similarity(e,s.embedding),index:o,metadata:s.metadata,content:s.content,embedding:s.embedding,id:s.id})).sort((s,o)=>s.similarity>o.similarity?-1:0).slice(0,t)}async similaritySearchVectorWithScore(e,t,n){return(await this._queryVectors(e,t,n)).map(s=>[new lr({metadata:s.metadata,pageContent:s.content,id:s.id}),s.similarity])}async maxMarginalRelevanceSearch(e,t){let n=await this.embeddings.embedQuery(e),i=await this._queryVectors(n,t.fetchK??20,t.filter),a=i.map(o=>o.embedding);return _A(n,a,t.lambda,t.k).map(o=>new lr({metadata:i[o].metadata,pageContent:i[o].content,id:i[o].id}))}static async fromTexts(e,t,n,i){let a=[];for(let s=0;s<e.length;s+=1){let o=Array.isArray(t)?t[s]:t,u=new lr({pageContent:e[s],metadata:o});a.push(u)}return r.fromDocuments(a,n,i)}static async fromDocuments(e,t,n){let i=new this(t,n);return await i.addDocuments(e),i}static async fromExistingIndex(e,t){return new this(e,t)}};var Th=pe(_t());var rp=class extends nu{constructor(t,n){super(t,n);this.memory={}}async init(t){this.sourceHash=await Lr(t)}async embedDocuments(t){if(await this.restoreMemory(),this.memory[this.sourceHash])return this.memory[this.sourceHash];let n=await super.embedDocuments(t);return await this.updateMemory(n),n}async restoreMemory(){let{embeddings:t}=await Th.default.storage.local.get({embeddings:{}});this.memory=t}updateMemory(t){return this.memory[this.sourceHash]=t,Th.default.storage.local.set({embeddings:this.memory})}};var gu=class r{static{this._instances={}}constructor(e,t){this.callback=t,this.text=e}static async getInstance(e,t,n){let i=await Lr(e);return r._instances[i]?r._instances[i].config=t:(r._instances[i]=new r(e,n),r._instances[i].config=t,await r._instances[i].init()),r._instances[i]}async init(){let t=await new uu({chunkSize:2e3}).createDocuments([this.text]),n=new rp({openAIApiKey:this.config?.apiKey});await n.init(this.text),this.vectorStore=await tp.fromDocuments(t,n),this.memory=new Ps({memoryKey:"chat_history",inputKey:"question",outputKey:"text",returnMessages:!0})}async chain(){let e=this.callback,t="",n=new Ji({openAIApiKey:this.config.apiKey,modelName:this.config.model,streaming:!0,callbacks:[{handleLLMNewToken(a){t+=a,e(t)},handleLLMEnd(){t="",e("",{end:!0})},handleLLMError(a){t="",e("",{error:a.message})},handleLLMStart(){e("",{start:!0})}}]}),i=new Ji({openAIApiKey:this.config.apiKey});return this.vectorStore||await this.init(),lu.fromLLM(n,this.vectorStore.asRetriever(),{returnSourceDocuments:!0,memory:this.memory,questionGeneratorChainOptions:{llm:i},qaChainOptions:{type:"stuff",prompt:this.template}})}get template(){let e=Hh(this.config.selectedLanguage),t=`Use the following pieces of context to answer the users question. Translate your answer to ${e}.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}`,n=[Ut.fromTemplate(t),Ge.fromTemplate(`{question} Answer in ${e}`)];return ot.fromMessages(n)}static async destroy(e){let t=await Lr(e);r._instances[t]&&delete r._instances[t]}};var Nh=pe(_t());function vA(r){let e,t,n,i,a,s,o;return u(),{feed:l,reset:u};function u(){e=!0,t="",n=0,i=-1,a=void 0,s=void 0,o=""}function l(p){t=t?t+p:p,e&&nj(t)&&(t=t.slice(xA.length)),e=!1;let d=t.length,f=0,m=!1;for(;f<d;){m&&(t[f]===`
`&&++f,m=!1);let h=-1,y=i,_;for(let b=n;h<0&&b<d;++b)_=t[b],_===":"&&y<0?y=b-f:_==="\r"?(m=!0,h=b-f):_===`
`&&(h=b-f);if(h<0){n=d-f,i=y;break}else n=0,i=-1;c(t,f,y,h),f+=h+1}f===d?t="":f>0&&(t=t.slice(f))}function c(p,d,f,m){if(m===0){o.length>0&&(r({type:"event",id:a,event:s||void 0,data:o.slice(0,-1)}),o="",a=void 0),s=void 0;return}let h=f<0,y=p.slice(d,d+(h?m:f)),_=0;h?_=m:p[d+f+1]===" "?_=f+2:_=f+1;let b=d+_,O=m-_,v=p.slice(b,b+O).toString();if(y==="data")o+=v?"".concat(v,`
`):`
`;else if(y==="event")s=v;else if(y==="id"&&!v.includes("\0"))a=v;else if(y==="retry"){let x=parseInt(v,10);Number.isNaN(x)||r({type:"reconnect-interval",value:x})}}}var xA=[239,187,191];function nj(r){return xA.every((e,t)=>r.charCodeAt(t)===e)}var ij=typeof global=="object"&&global&&global.Object===Object&&global,np=ij;var aj=typeof self=="object"&&self&&self.Object===Object&&self,sj=np||aj||Function("return this")(),Xe=sj;var oj=Xe.Symbol,Cs=oj;var AA=Object.prototype,uj=AA.hasOwnProperty,lj=AA.toString,yu=Cs?Cs.toStringTag:void 0;function cj(r){var e=uj.call(r,yu),t=r[yu];try{r[yu]=void 0;var n=!0}catch{}var i=lj.call(r);return n&&(e?r[yu]=t:delete r[yu]),i}var PA=cj;var pj=Object.prototype,dj=pj.toString;function fj(r){return dj.call(r)}var OA=fj;var mj="[object Null]",hj="[object Undefined]",EA=Cs?Cs.toStringTag:void 0;function gj(r){return r==null?r===void 0?hj:mj:EA&&EA in Object(r)?PA(r):OA(r)}var cn=gj;function yj(r){return r!=null&&typeof r=="object"}var Ss=yj;var bj=Array.isArray,IA=bj;function wj(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var ip=wj;var _j="[object AsyncFunction]",vj="[object Function]",xj="[object GeneratorFunction]",Aj="[object Proxy]";function Pj(r){if(!ip(r))return!1;var e=cn(r);return e==vj||e==xj||e==_j||e==Aj}var ap=Pj;var Oj=Xe["__core-js_shared__"],sp=Oj;var TA=function(){var r=/[^.]+$/.exec(sp&&sp.keys&&sp.keys.IE_PROTO||"");return r?"Symbol(src)_1."+r:""}();function Ej(r){return!!TA&&TA in r}var CA=Ej;var Ij=Function.prototype,Tj=Ij.toString;function Cj(r){if(r!=null){try{return Tj.call(r)}catch{}try{return r+""}catch{}}return""}var pn=Cj;var Sj=/[\\^$.*+?()[\]{}|]/g,kj=/^\[object .+?Constructor\]$/,Rj=Function.prototype,Nj=Object.prototype,Mj=Rj.toString,jj=Nj.hasOwnProperty,$j=RegExp("^"+Mj.call(jj).replace(Sj,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Lj(r){if(!ip(r)||CA(r))return!1;var e=ap(r)?$j:kj;return e.test(pn(r))}var SA=Lj;function Dj(r,e){return r?.[e]}var kA=Dj;function Fj(r,e){var t=kA(r,e);return SA(t)?t:void 0}var Mr=Fj;var qj=Mr(Xe,"WeakMap"),op=qj;var Uj=9007199254740991;function zj(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=Uj}var up=zj;function Bj(r){return r!=null&&up(r.length)&&!ap(r)}var RA=Bj;var Kj=Object.prototype;function Vj(r){var e=r&&r.constructor,t=typeof e=="function"&&e.prototype||Kj;return r===t}var lp=Vj;var Hj="[object Arguments]";function Gj(r){return Ss(r)&&cn(r)==Hj}var Ch=Gj;var NA=Object.prototype,Wj=NA.hasOwnProperty,Zj=NA.propertyIsEnumerable,Jj=Ch(function(){return arguments}())?Ch:function(r){return Ss(r)&&Wj.call(r,"callee")&&!Zj.call(r,"callee")},MA=Jj;function Yj(){return!1}var jA=Yj;var DA=typeof exports=="object"&&exports&&!exports.nodeType&&exports,$A=DA&&typeof module=="object"&&module&&!module.nodeType&&module,Xj=$A&&$A.exports===DA,LA=Xj?Xe.Buffer:void 0,Qj=LA?LA.isBuffer:void 0,e$=Qj||jA,FA=e$;var t$="[object Arguments]",r$="[object Array]",n$="[object Boolean]",i$="[object Date]",a$="[object Error]",s$="[object Function]",o$="[object Map]",u$="[object Number]",l$="[object Object]",c$="[object RegExp]",p$="[object Set]",d$="[object String]",f$="[object WeakMap]",m$="[object ArrayBuffer]",h$="[object DataView]",g$="[object Float32Array]",y$="[object Float64Array]",b$="[object Int8Array]",w$="[object Int16Array]",_$="[object Int32Array]",v$="[object Uint8Array]",x$="[object Uint8ClampedArray]",A$="[object Uint16Array]",P$="[object Uint32Array]",ce={};ce[g$]=ce[y$]=ce[b$]=ce[w$]=ce[_$]=ce[v$]=ce[x$]=ce[A$]=ce[P$]=!0;ce[t$]=ce[r$]=ce[m$]=ce[n$]=ce[h$]=ce[i$]=ce[a$]=ce[s$]=ce[o$]=ce[u$]=ce[l$]=ce[c$]=ce[p$]=ce[d$]=ce[f$]=!1;function O$(r){return Ss(r)&&up(r.length)&&!!ce[cn(r)]}var qA=O$;function E$(r){return function(e){return r(e)}}var UA=E$;var zA=typeof exports=="object"&&exports&&!exports.nodeType&&exports,bu=zA&&typeof module=="object"&&module&&!module.nodeType&&module,I$=bu&&bu.exports===zA,Sh=I$&&np.process,T$=function(){try{var r=bu&&bu.require&&bu.require("util").types;return r||Sh&&Sh.binding&&Sh.binding("util")}catch{}}(),kh=T$;var BA=kh&&kh.isTypedArray,C$=BA?UA(BA):qA,KA=C$;function S$(r,e){return function(t){return r(e(t))}}var VA=S$;var k$=VA(Object.keys,Object),HA=k$;var R$=Object.prototype,N$=R$.hasOwnProperty;function M$(r){if(!lp(r))return HA(r);var e=[];for(var t in Object(r))N$.call(r,t)&&t!="constructor"&&e.push(t);return e}var GA=M$;var j$=Mr(Xe,"Map"),cp=j$;var $$=Mr(Xe,"DataView"),pp=$$;var L$=Mr(Xe,"Promise"),dp=L$;var D$=Mr(Xe,"Set"),fp=D$;var WA="[object Map]",F$="[object Object]",ZA="[object Promise]",JA="[object Set]",YA="[object WeakMap]",XA="[object DataView]",q$=pn(pp),U$=pn(cp),z$=pn(dp),B$=pn(fp),K$=pn(op),ra=cn;(pp&&ra(new pp(new ArrayBuffer(1)))!=XA||cp&&ra(new cp)!=WA||dp&&ra(dp.resolve())!=ZA||fp&&ra(new fp)!=JA||op&&ra(new op)!=YA)&&(ra=function(r){var e=cn(r),t=e==F$?r.constructor:void 0,n=t?pn(t):"";if(n)switch(n){case q$:return XA;case U$:return WA;case z$:return ZA;case B$:return JA;case K$:return YA}return e});var QA=ra;var V$="[object Map]",H$="[object Set]",G$=Object.prototype,W$=G$.hasOwnProperty;function Z$(r){if(r==null)return!0;if(RA(r)&&(IA(r)||typeof r=="string"||typeof r.splice=="function"||FA(r)||KA(r)||MA(r)))return!r.length;var e=QA(r);if(e==V$||e==H$)return!r.size;if(lp(r))return!GA(r).length;for(var t in r)if(W$.call(r,t))return!1;return!0}var Rh=Z$;async function*eP(r){let e=r.getReader();try{for(;;){let{done:t,value:n}=await e.read();if(t)return;yield n}}finally{e.releaseLock()}}async function ks(r,e){let{onMessage:t,...n}=e,i=await fetch(r,n);if(!i.ok){let s=await i.json().catch(()=>({}));throw new Error(Rh(s)?`${i.status} ${i.statusText}`:s.message||s.detail?.message||s.detail||s.message||s?.error?.message,{cause:s})}if((i.headers.get("Content-Type")||"").includes("text/event-stream")){let s=vA(o=>{o.type==="event"&&t(o.data)});if(!i.body)throw new Error("No response body");for await(let o of eP(i.body)){let u=new TextDecoder().decode(o);s.feed(u)}}else return i.json()}var jr=class{constructor(e,t){this.token=e,this.model=t}async generateAPIanswer({signal:e,endPoint:t,body:n,onMessage:i}){return ks(t,{method:"POST",signal:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:n,onMessage:i})}};var tP=0,mp=class extends jr{constructor(t,n){super(t,n);this.userFeatures=[];this.config=Ct.getConfig("web"),console.log("ChatGPTProvider.model",n)}async fetchModels(){return Au(this.token)}async removeConversation(t){await na(this.token,"PATCH","/conversation/"+t,{is_visible:!1})}async getModelName(){if(this.model)return this.model;try{let t=await this.fetchModels();return console.log("models",t),t[0].slug}catch(t){return console.error(t),"text-davinci-002-render"}}async registerWebSocket(){return na(this.token,"POST","/register-websocket").then(t=>t.json())}async getUserFeatures(){return(await na(this.token,"GET","/accounts/check/v4-2023-04-27").then(n=>n.json())).accounts.default.features}async formBody(t,n){let i=await this.getModelName();return JSON.stringify({action:"next",arkose_token:n,messages:[{id:ia(),author:{role:"user"},content:{content_type:"text",parts:[t.prompt]}}].filter(Boolean),model:i,parent_message_id:ia(),is_visible:!0,force_nulligen:!1,force_paragen:!1,force_paragen_model_slug:"",force_rate_limit:!1,suggestions:[],conversation_mode:{kind:"primary_assistant"}})}formMessageHandler(t,n){return i=>{let a,s;if(typeof i=="string")a=i;else try{let l=JSON.parse(i.data);s=l.sequenceId,l.body?a=atob(l.body):a=atob(l.data.body),a=a.substring(6)}catch{return}if(/\[DONE\]/.test(a)){t.signal?.aborted||t.onEvent({type:"done"}),n(),this.webSocketClient?.socket?.close();return}let o;try{o=JSON.parse(a)}catch{return}if(o.error)return this.removeConversation(o.conversation_id),this.handleError(o.error,t,n);if(o?.type=="title_generation"&&this.removeConversation(o.conversation_id),o.message?.author?.role==="user")return;let u=o.message?.content?.parts?.[0];u===""&&this.webSocketClient?.socket&&s&&this.webSocketClient?.socket.send(`{"type":"sequenceAck","sequenceId":${s}}`),u&&(t.signal?.aborted||t.onEvent({type:"answer",data:{text:u,messageId:o.message.id,conversationId:o.conversation_id}}))}}async generateAnswer(t){console.log("chatgpt",t);let n=()=>{tP=Date.now()};t.signal?.addEventListener("abort",n,{once:!0}),tP+3e3>Date.now()&&await new Promise(l=>setTimeout(l,3e3));try{this.userFeatures=await this.getUserFeatures()}catch{this.userFeatures=[]}this.userFeatures.includes("shared_websocket")?this.responseMode="websocket":this.responseMode="stream";let i=await xu(),a,s,o=i.token;if(i.arkose?.required&&(a=await Nh.default.runtime.sendMessage({type:"ARKOSE_TOKEN_REFRESH",data:{retryCount:hp,arkoseDx:i.arkose.dx},to:"popup"})),i.proofofwork?.required&&(s=await Nh.default.runtime.sendMessage({type:"GET_PROOF_TOKEN",data:{seed:i.proofofwork.seed,difficulty:i.proofofwork.difficulty},to:"popup"})),this.responseMode==="websocket"){let{wss_url:l}=await this.registerWebSocket();this.webSocketClient=new Mh(l)}let u=this.formMessageHandler(t,n);return this.webSocketClient?.setOnMessage(u),await ks(`${this.config.endpoint}/backend-api/conversation`,{signal:t.signal,body:await this.formBody(t,a),method:"POST",headers:{accept:"text/event-stream","Content-Type":"application/json","Oai-Device-Id":await Cp(),"Oai-Language":"en-us",Authorization:`Bearer ${this.token}`,...a?{"Openai-Sentinel-Arkose-Token":a}:{},"Openai-Sentinel-Chat-Requirements-Token":o,...s?{"Openai-Sentinel-Proof-Token":s}:{}},onMessage:u}),{cleanup:n}}handleError(t,n,i){if(/Conversation\snot\sfound/i.test(t)){n.signal?.aborted||n.onEvent({type:"done"}),i(),this.webSocketClient?.socket?.close();return}xt.fireErrorEvent({message:t}),n.signal?.aborted||n.onEvent({type:"error",data:t})}},Mh=class{constructor(e){this.socket=new WebSocket(e,"json.reliable.webpubsub.azure.v1")}setOnMessage(e){this.socket.onmessage=e}};var gp=class extends jr{constructor(e,t){super(e,t),this.config=Ct.getConfig("deepseek-api")}async generateConversationAnswers(e){let t="",n=JSON.stringify({messages:[e.systemMessage&&{role:"system",content:e.systemMessage},{role:"user",content:e.prompt}].filter(Boolean),model:this.model,stream:!0}),i=a=>{if(a==="[DONE]"){e.signal.aborted||e.onEvent({type:"done"});return}try{let s=JSON.parse(a),o=s.choices[0].delta.content||"";if(s.message?.author?.role==="user")return;t+=o,e.signal.aborted||e.onEvent({type:"answer",data:{text:t,messageId:s.id,conversationId:s.id}})}catch(s){console.error(s);return}};return await this.generateAPIanswer({signal:e.signal,endPoint:this.config.endpoint,body:n,onMessage:i}),{}}async generateAnswer(e){if(!this.config.models.find(n=>n.model===this.model))throw new Error("Unknown model");return this.generateConversationAnswers(e)}};var jh=pe(_t());async function rP(r,e){try{if(!r||!e){let i=await jh.default.storage.local.get({"deepseek-login":"","deepseek-password":""});r=i["deepseek-login"],e=i["deepseek-password"]}let t=await fetch(Rs.loginUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,password:e,mobile:"",area_code:"",device_id:"",os:"web"})}),n=await t.json();if(t.ok&&n?.data?.user){let i=n.data.user.token;return await jh.default.storage.local.set({"deepseek-token":i,"deepseek-login":r,"deepseek-password":e}),{token:i}}else return{error:"Invalid username or password"}}catch(t){return console.error("Login error",t),{error:"An error occurred during login"}}}var nP=pe(_t()),$h=class{constructor(){this.offset=0;this.cachedUint8Memory=null;this.cachedTextEncoder=new TextEncoder}encodeString(e,t,n){if(!n){let u=this.cachedTextEncoder.encode(e),l=t(u.length,1)>>>0;return this.getCachedUint8Memory().subarray(l,l+u.length).set(u),this.offset=u.length,l}let i=e.length,a=t(i,1)>>>0,s=this.getCachedUint8Memory(),o=0;for(;o<i;o++){let u=e.charCodeAt(o);if(u>127)break;s[a+o]=u}if(o!==i){o>0&&(e=e.slice(o)),a=n(a,i,o+e.length*3,1)>>>0;let u=this.cachedTextEncoder.encodeInto(e,this.getCachedUint8Memory().subarray(a+o,a+o+e.length*3));o+=u.written,a=n(a,o+e.length*3,o,1)>>>0}return this.offset=o,a}getCachedUint8Memory(){return(this.cachedUint8Memory===null||this.cachedUint8Memory.byteLength===0)&&(this.cachedUint8Memory=new Uint8Array(this.wasmInstance.memory.buffer)),this.cachedUint8Memory}calculateHash(e,t,n,i,a){if(e!=="DeepSeekHashV1")throw new Error("Unsupported algorithm: "+e);let s=`${n}_${a}_`;try{let o=this.wasmInstance.__wbindgen_add_to_stack_pointer(-16),u=this.encodeString(t,this.wasmInstance.__wbindgen_export_0,this.wasmInstance.__wbindgen_export_1),l=this.offset,c=this.encodeString(s,this.wasmInstance.__wbindgen_export_0,this.wasmInstance.__wbindgen_export_1),p=this.offset;this.wasmInstance.wasm_solve(o,u,l,c,p,i);let d=new DataView(this.wasmInstance.memory.buffer),f=d.getInt32(o+0,!0),m=d.getFloat64(o+8,!0);return f===0?void 0:m}finally{this.wasmInstance.__wbindgen_add_to_stack_pointer(16)}}async init(){let e={wbg:{}},t=nP.default.runtime.getURL("wasm/sha3_wasm_bg.wasm");console.log(t);let n=await fetch(t),{instance:i}=await WebAssembly.instantiateStreaming(n,e);return this.wasmInstance=i.exports,this.wasmInstance}},iP=$h;var aP=0,yp=class extends jr{constructor(t,n){super(t,n);this.headers={accept:"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","Content-Type":"application/json",Origin:"https://chat.deepseek.com",Pragma:"no-cache",Referer:"https://chat.deepseek.com/","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin","sec-ch-ua":'"Google Chrome";v="119", "Chromium";v="119", "Not?A_Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Linux"',"x-app-version":"20241129.1"};this.config=Ct.getConfig("deepseek-chat")}async request(t,n,i,a,s=!0){let o=new AbortController,u=setTimeout(()=>o.abort(),15e3);try{let l=await fetch(t,{method:n,headers:{Authorization:`Bearer ${this.token}`,...this.headers,...a},...i&&{body:JSON.stringify(i)},signal:o.signal});if(!l.ok){let p=await l.text();throw new Error(`Request failed with status ${l.status}: ${p}`)}let c=await l.json();if(typeof c.code=="number"&&isFinite(c.code)){if(c.code===0)return c.data;if(c.code===40003&&s){let p=await rP();if(p&&"token"in p)return this.token=p.token,this.request(t,n,i,a,!1);throw new Error("Login failed, please check your credentials.")}else throw new Error(`[deepseek]: ${c.msg||"Unknown error"}`)}return c}finally{clearTimeout(u)}}async createSession(){let t=await this.request(this.config.endpoint+"api/v0/chat_session/create","POST",{agent:"chat"}),{biz_data:n}=t;if(!n)throw new Error("Chat session creation failed");return n.id}async getChallengeResponse(t){let n=await this.request(this.config.endpoint+"api/v0/chat/create_pow_challenge","POST",{target_path:t},{Cookie:Mp()}),{biz_data:i}=n;if(!i||!i.challenge)throw new Error("No challenge in biz_data");return i.challenge}async removeConversation(t){await this.request(this.config.endpoint+"api/v0/chat_session/delete","POST",{chat_session_id:t})}async formBody(t){return JSON.stringify({chat_session_id:t.conversationId??ia(),parent_message_id:null,prompt:t.prompt,ref_file_ids:[],search_enabled:!1,thinking_enabled:this.model==="deepseek-reasoner"})}formMessageHandler(t,n){let i="",a=t.conversationId??"",s="";return o=>{if(o.trim()==="[DONE]"){this.removeConversation(a),t.signal?.aborted||t.onEvent({type:"done"}),n();return}try{let u=JSON.parse(o);if(u.code)return this.handleError(u.msg,t,n);if(!u||!u.choices||!u.choices[0])return;!i&&u.message_id&&(i=u.message_id),!a&&u.conversation_id&&(a=u.conversation_id);let l=u.choices[0].delta;if(!l)return;if(u.choices[0].finish_reason==="context_length_exceeded")throw new Error("The message you submitted was too long");if(l.content=="The server is busy. Please try again later.")return this.handleError(l.content,t,n);l.content&&l.type==="text"&&(s+=l.content),t.signal?.aborted||t.onEvent({type:"answer",data:{text:s,messageId:i,conversationId:a}}),u.choices[0].finish_reason==="stop"&&(this.removeConversation(a),t.signal?.aborted||t.onEvent({type:"done"}),n())}catch(u){throw this.removeConversation(a),n(),u}}}async answerChallenge(t,n){let{algorithm:i,challenge:a,salt:s,difficulty:o,expire_at:u,signature:l}=t,c=new iP;await c.init();let p=c.calculateHash(i,a,s,o,u),d=JSON.stringify({algorithm:i,challenge:a,salt:s,answer:p,signature:l,target_path:n});return btoa(d)}async generateAnswer(t){let n=()=>{aP=Date.now()};t.signal?.addEventListener("abort",n,{once:!0}),aP+3e3>Date.now()&&await new Promise(u=>setTimeout(u,3e3)),t.conversationId=await this.createSession();let i=this.formMessageHandler(t,n),a=await this.getChallengeResponse("/api/v0/chat/completion"),s=await this.answerChallenge(a,"/api/v0/chat/completion"),o=await ks(`${this.config.endpoint}api/v0/chat/completion`,{signal:t.signal,body:await this.formBody(t),method:"POST",headers:{...this.headers,Authorization:`Bearer ${this.token}`,Cookie:Mp(),"X-Ds-Pow-Response":s},onMessage:i});return o&&"code"in o&&this.handleError(o.msg,t,n),{cleanup:n}}handleError(t,n,i){if(xt.fireErrorEvent({message:t}),!n.signal?.aborted)throw new Error(t)}};var bp=class extends jr{constructor(e,t){super(e,t),this.config=Ct.getConfig("api")}async generateLegacyAnswers(e){let t="",n=JSON.stringify({model:this.model,stream:!0,prompt:e.prompt,max_tokens:100}),i=a=>{if(a==="[DONE]"){e.signal.aborted||e.onEvent({type:"done"});return}try{let s=JSON.parse(a);t+=s.choices[0].text||"",e.signal.aborted||e.onEvent({type:"answer",data:{text:t,messageId:s.id,conversationId:s.id}})}catch(s){console.error(s)}};return await this.generateAPIanswer({signal:e.signal,endPoint:"https://api.openai.com/v1/completions",body:n,onMessage:i}),{}}async generateConversationAnswers(e){let t="",n=JSON.stringify({messages:[e.systemMessage&&{role:"system",content:e.systemMessage},{role:"user",content:e.prompt}].filter(Boolean),model:this.model,stream:!0}),i=a=>{if(a==="[DONE]"){e.signal.aborted||e.onEvent({type:"done"});return}try{let s=JSON.parse(a),o=s.choices[0].delta.content||"";if(s.message?.author?.role==="user")return;t+=o,e.signal.aborted||e.onEvent({type:"answer",data:{text:t,messageId:s.id,conversationId:s.id}})}catch(s){console.error(s);return}};return await this.generateAPIanswer({signal:e.signal,endPoint:this.config.endpoint,body:n,onMessage:i}),{}}async generateAnswer(e){let t=this.config.models.find(n=>n.model===this.model);if(!t)throw new Error("Unknown model");return t.endpoint.endsWith("/v1/chat/completions")?(console.log("generateConversationAnswers"),this.generateConversationAnswers(e)):(console.log("generateLegacyAnswers"),this.generateLegacyAnswers(e))}};var wp=pe(_t());async function sP(r){let e=await Lr(r),{[e]:t}=await wp.default.storage.session.get(e).catch(()=>({}));return t}async function Lh(r,e){let t=await Lr(r);return wp.default.storage.session.set({[t]:e}).catch(()=>({}))}async function oP(r){let e=await Lr(r);return wp.default.storage.session.remove(e).catch(()=>({}))}var _p={};function Dh(r){let e=_p[r];e&&(e.abort(),delete _p[r])}async function uP(r,e){let t=await Ms(),n;switch(t.provider){case"web":let c=await js();n=new mp(c,t.model);break;case"api":n=new bp(t.apiKey,t.model);break;case"deepseek-api":n=new gp(t.apiKey,t.model);break;case"deepseek-chat":n=new yp(await ng(),t.model);break;default:throw new Error(`Unknown provider ${t.provider}`)}let i=`${e.systemMessage??""}${e.question}`,a=new AbortController;_p[i]=a;let s;r.onDisconnect.addListener(()=>{Dh(i),s&&s()});let o=await sP(i);if(o){r.postMessage(o),r.postMessage({type:"done"});return}xt.fireEvent("summary_requested");let u;s=(await n.generateAnswer({prompt:e.question,systemMessage:e.systemMessage,signal:a.signal,async onEvent(c){switch(c.type){case"answer":{u=c;break}case"done":{u&&await Lh(i,u);break}default:throw new Error(`Unknown event type ${c.type}`)}return r.postMessage(c)}})).cleanup}async function Y$(r,e){let t=await sg();if(t.provider!=="api")throw new Error("Unfortunately this functionality is only working with OpenAI provider");xt.fireEvent("question_asked");let n=new AbortController;_p[e.text]=n;let i=(o,u)=>{r.postMessage({type:"answer",data:{tokens:o,states:u}})},s=await(await(await gu.getInstance(e.text,t,i)).chain()).call({question:e.question,signal:n.signal});if(s&&Array.isArray(s.sourceDocuments)){let o={type:"answer",data:{text:s.sourceDocuments[0].pageContent,conversationId:"0",messageId:"0"}};await Lh(s.text,o)}r.onDisconnect.addListener(()=>{Dh(e.text),gu.destroy(e.text)})}var hp=0;function die(){hp++}de.default.runtime.onConnect.addListener(r=>{r.onMessage.addListener(async(e,t)=>{let n=e;if(!(typeof n!="object"||n===null))try{switch(n.type){case"summarize":hp=0,await uP(t,{question:n.question,systemMessage:n.systemMessage,type:n.type});break;case"summarize-retry":await uP(t,{question:n.question,systemMessage:n.systemMessage,type:n.type});break;case"answer":await Y$(t,{text:n.text,question:n.question,type:n.type});break;default:throw new Error("Unknown message type")}}catch(i){if(i instanceof DOMException&&i.name==="AbortError")return;if(i instanceof Error){if(/The message\s+you\s+submitted\s+was\s+too\s+long/i.test(i.message)){t.postMessage({type:"increaseTolerance"});return}xt.fireErrorEvent({message:i.message}),t.postMessage({type:"error",data:i.message,context:i?.cause})}else xt.fireErrorEvent({message:"Unknown error",error:i}),t.postMessage({type:"error",data:String(i)})}})});de.default.runtime.onMessage.addListener((r,e,t)=>{if(r?.to!=="background")return!1;switch(r.type){case"OPEN_OPTIONS_PAGE":{de.default.runtime.openOptionsPage();break}case"GET_ACCESS_TOKEN":return js().then(n=>{t(n)}).catch(n=>{t(void 0)}),!0;case"GET_CHAT_REQUIREMENTS":return xu().then(n=>{t(n)}),!0;case"RETRY":{let n=`${r.systemMessage??""}${r.question}`;Dh(n),oP(n);break}case"SEEK_TO_TIME":{de.default.tabs.update(r.tabId,{url:r.link});break}case"REPORT_ERROR":{Fh.reportError(r.errorEvent);break}case"GET_MODELS":return Au().then(n=>{t(n)}),!0}return!1});de.default.runtime.onInstalled.addListener(async r=>{if(r.reason==="install"&&de.default.tabs.create({url:"welcome/index.html"}),r.reason==="install"&&de.default.runtime.setUninstallURL(Kh),r.previousVersion)switch(r.previousVersion){case"1.0.4":case"1.0.5":case"1.0.6":{let{provider:e}=await de.default.storage.local.get("provider");(e==="gpt3"||e==="chatgpt")&&await de.default.storage.local.set({provider:"free",model:null,"provider:gpt3":null,"provider:chatgpt":null});break}case"1.3.6":await de.default.storage.local.set({backgroundAnnouncements:"question-upgrade"});break}de.default.contextMenus.create({id:"summarizeSelectionItem",title:de.default.i18n.getMessage("summarizeText"),contexts:["selection"]}),X$(),de.default.alarms.create("gpt-4o-alarm",{delayInMinutes:1,periodInMinutes:60*24})});async function X$(){let r=await de.default.tabs.query({windowType:"normal"});for(let e of r)e.id&&e.url&&!e.url.startsWith("edge")&&!e.url.startsWith("chrome")&&!e.url.startsWith("https://chrome.google.com/webstore")&&await de.default.scripting.executeScript({target:{tabId:e.id,allFrames:!1},files:["content-script/index.js"]}).catch(t=>{})}de.default.action.onClicked.addListener(async r=>{if(r.url?.startsWith("file:")){if(!await de.default.permissions.request({permissions:["scripting"],origins:["file://*"]})){console.warn("User did not grant file access");return}await de.default.scripting.executeScript({target:{tabId:r.id},files:["content-script/index.js"]})}r.id&&await de.default.tabs.sendMessage(r.id,{type:"OPEN_POPUP",to:"content-script"})});de.default.contextMenus.onClicked.addListener(function(r,e){r.menuItemId==="summarizeSelectionItem"&&e?.id&&de.default.tabs.sendMessage(e.id,{type:"SUMMARIZE_TEXT",to:"content-script"})});var Fh=new _u(5,60*1e3);addEventListener("error",r=>Fh.reportError(r));addEventListener("unhandledrejection",r=>Fh.reportError(r));de.default.alarms.onAlarm.addListener(async r=>{if(r.name==="gpt-4o-alarm"){let e=await Ms();e.provider==="api"&&(e.model==="gpt-4"||e.model==="gpt-4-1106-preview")&&e.apiKey!==""&&await ag(e.apiKey)&&await de.default.storage.local.set({model:"gpt-4o"})}});})();
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

mustache/mustache.mjs:
  (*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

js-yaml/dist/js-yaml.mjs:
  (*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT *)

lodash-es/lodash.js:
  (**
   * @license
   * Lodash (Custom Build) <https://lodash.com/>
   * Build: `lodash modularize exports="es" -o ./`
   * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
   * Released under MIT license <https://lodash.com/license>
   * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
   * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
   *)
*/
